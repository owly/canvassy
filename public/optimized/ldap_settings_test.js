define(["i18n!accounts","jquery","str/htmlEscape","jquery.ajaxJSON","jqueryui/dialog"],function(a,b,c){function d(){e(),b("#test_ldap_dialog").dialog({title:a.t("test_ldap_dialog_title","Test LDAP Settings"),width:500}),ENV.LDAP_TESTS[0].js_function()}function e(){b.each(ENV.LDAP_TESTS,function(a,c){b("#ldap_"+c.test_type+"_result").html(""),b("#ldap_"+c.test_type+"_help .server_error").remove(),b("#ldap_"+c.test_type+"_help").hide()}),b("#ldap_login_result").html(""),b("#ldap_login_form").hide()}function f(){b("#ldap_test_login").attr("disabled","true").attr("value",a.t("testing","Testing...")),b("#ldap_login_result").html("<img src='/images/ajax-loader.gif'/>");var d=b("#ldap_test_login_user").val(),e=b("#ldap_test_login_pass").val();b.post(ENV.LOGIN_TEST_URL,{username:d,password:e,authenticity_token:ENV.AUTHENTICITY_TOKEN},function(d){var e=!0,f="";b.each(d,function(a,c){c.ldap_login_test||(e=!1),c.errors&&b.each(c.errors,function(a,c){b.each(c,function(a,b){f+=b})})}),e?(b("#ldap_login_help_error").hide(),b("#ldap_login_result").html("<h4 style='color:green'>"+c(a.t("test_ldap_result_ok","OK"))+"</h4>"),b("#ldap_test_login").attr("disabled","").attr("value",a.t("test_login","Test Login"))):(b("#ldap_login_result").html("<h4 style='color:red'>"+c(a.t("test_ldap_result_failed","Failed"))+"</h4>"),b("#ldap_login_help").show(),b("#ldap_test_login").attr("disabled","").attr("value",a.t("retry_login","Retry Login")),b("#ldap_login_help_error").text(f))})}b.each(ENV.LDAP_TESTS,function(d,e){e.js_function=function(){b("#ldap_"+e.test_type+"_result").html("<img src='/images/ajax-loader.gif'/>"),b.getJSON(e.url,function(f){var g=!0,j="";b.each(f,function(a,b){b["ldap_"+e.test_type+"_test"]||(g=!1,b.errors[0]&&b.errors[0]["ldap_"+e.test_type+"_test"]&&(j=b.errors[0]["ldap_"+e.test_type+"_test"]))}),g?(b("#ldap_"+e.test_type+"_result").html("<h4 style='color:green'>"+c(a.t("test_ldap_result_ok","OK"))+"</h4>"),ENV.LDAP_TESTS[d+1]?ENV.LDAP_TESTS[d+1].js_function():b("#ldap_login_form").show("blind")):(b("#ldap_"+e.test_type+"_result").html("<h4 style='color:red'>"+c(a.t("test_ldap_result_failed","Failed"))+"</h4>"),b("#ldap_"+e.test_type+"_help").show(),$server_error=b("<p></p>").addClass("server_error").css("color","red").text(j),b("#ldap_"+e.test_type+"_help").append($server_error),b.each(ENV.LDAP_TESTS.slice(d+1),function(d,e){b("#ldap_"+e.test_type+"_result").html("<h4 style='color:red'>"+c(a.t("test_ldap_result_canceled","Canceled"))+"</h4>")}),b("#ldap_login_result").html("<h4 style='color:red'>"+c(a.t("test_ldap_result_canceled","Canceled"))+"</h4>"))})}}),b(document).ready(function(){b(".test_ldap_link").click(function(a){a.preventDefault(),d()}),b(".ldap_test_close").click(function(a){a.preventDefault(),b("#test_ldap_dialog").dialog("close")}),b("#ldap_test_login_form").submit(function(a){a.preventDefault(),f()})})})