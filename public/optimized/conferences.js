define(["INST","i18n!conferences","jquery","underscore","jst/conferences/newConference","jst/conferences/concludedConference","jst/conferences/editConferenceForm","jst/conferences/userSettingOptions","jquery.ajaxJSON","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.keycodes","jquery.loadingImg","compiled/jquery.rails_flash_notifications","jquery.templateData"],function(a,b,c,d,e,f,g,h){c(document).ready(function(){var a=function(a){return a.has_actions=a.permissions.edit||a.permissions["delete"],a.join_url=a.url+"/join",a.close_url=a.url+"/close",a.show_end=a.permissions.initiate&&a.started_at&&a.long_running,$conference_row=c(e(a)),$conference_row.data("conference",a),$conference_row},i=function(a){return a.has_actions=a.permissions["delete"],a.recording=a.recordings[0],$conference_row=c(f(a)),$conference_row.data("conference",a),$conference_row},j=function(a,b){var d=b=="editing",e=!d,f=e;return k(a),a.http_method=e?"POST":"PUT",$form=c(g({settings:{is_editing:d,is_adding:e,disable_duration_changes:(a.long_running||d)&&a.started_at,auth_token:ENV.AUTHENTICITY_TOKEN},conferenceData:a,users:ENV.users,conferenceTypes:ENV.conference_type_details.map(function(b){return{name:b.name,type:b.type,selected:a.conference_type===b.type}}),inviteAll:f})),$form},k=function(a){var b;d.each(ENV.conference_type_details,function(c){d.each(c.settings,function(c){c.isBoolean=c["type"]=="boolean";if(c.isBoolean){var d=a.user_settings[c.field];d===b&&(d=c["default"]),c.checked=d}})})},l=function(a,b){var e=d.select(ENV.conference_type_details,function(a){return a.type===b});e.length>0&&(e=e[0]),c(".web_conference_user_settings").html(h({settings:e.settings,conference:a}))},m=function(){c("#new-conference-list .conference:visible").length<=0?c(".no-new-conferences").show():c(".no-new-conferences").hide(),c("#concluded-conference-list .conference:visible").length<=0?c(".no-concluded-conferences").show():c(".no-concluded-conferences").hide()};d.each(ENV.current_conferences,function(b){c("#new-conference-list").append(a(b))}),d.each(ENV.concluded_conferences,function(a){c("#concluded-conference-list").append(i(a))}),m(),c("#add_conference_form").dialog({autoOpen:!1,width:"auto",title:b.t("new_conference_title","New Conference")}).data("dialog"),c.screenReaderFlashMessage(b.t("notifications.inaccessible","Warning: This page contains third-party content which is not accessible to screen readers."),2e4),c("body").on("click","#add_conference_form .cancel_button",function(){c("#add_conference_form").dialog("close")}),c("body").on("change","#add_conference_form select",function(){var a=c("#add_conference_form").data("conference"),b=c("#web_conference_conference_type").val();l(a,b)}),c("body").on("change",".all_users_checkbox",function(){c(this).is(":checked")?c("#members_list").slideUp():c("#members_list").slideDown()}),c(".conference-wrapper h2 a").on("click",function(a){var b=c(this).children("i");b.hasClass("icon-arrow-down")?b.removeClass("icon-arrow-down").addClass("icon-arrow-right"):b.removeClass("icon-arrow-right").addClass("icon-arrow-down")}),c("body").on("change","#web_conference_long_running",function(){c(this).is(":checked")?c("#web_conference_duration").prop("disabled",!0).val(""):c("#web_conference_duration").prop("disabled",!1).val(c("#web_conference_duration").data("restore-value"))}),c("body").on("click",".edit_conference_link, .new-conference-btn",function(e){e.preventDefault();var f=c(this).hasClass("edit_conference_link"),g=c("#add_conference_form"),h=c(this).closest(".conference");f||(h=a(JSON.parse(JSON.stringify(ENV.default_conference))));var i=h.data("conference");i.duration==null?i.restore_duration=ENV.default_conference.duration:i.restore_duration=i.duration,g.data("editing-conf",h),f?(g.dialog({title:b.t("update_conference_title","Update Conference")}),g.html(j(i,"editing")),g.find("#members_list").show().find(":checkbox").attr("checked",!1).end().end().find(".all_users_checkbox").attr("checked",!1),d.each(i.user_ids,function(a){g.find("#members_list .member.user_"+a).find(":checkbox").attr("checked",!0)})):(g.html(j(i,"adding")),g.dialog({title:b.t("new_conference_title","New Conference")}),g.find(".all_users_checkbox").attr("checked",!0).end().find("#members_list").hide().find(":checkbox").attr("checked",!1)),l(i,i.conference_type),g.find("form").formSubmit({object_name:"web_conference",beforeSubmit:function(a){var b=g.data("editing-conf");return g.dialog("close"),f?b.loadingImage():c("#new-conference-list").loadingImage(),b},success:function(b,d){c("#no_conferences_message").slideUp(),d.loadingImage("remove"),d.html(a(b).html()),d.data("conference",b),f||(c("#new-conference-list").loadingImage("remove"),c("#new-conference-list").prepend(d),m())},error:function(a,b){b&&(b.loadingImage("remove"),b.remove()),g.dialog("open")}}),g.data("conference",i),g.find("#web_conference_conference_type").trigger("change"),g.find(".all_users_checkbox").trigger("change"),g.dialog("open")}),c("body").on("click",".delete_conference_link",function(a){a.preventDefault(),c(this).parents(".conference").confirmDelete({url:c(this).attr("href"),message:b.t("confirm.delete","Are you sure you want to delete this conference?"),success:function(){c(this).slideUp(function(){c(this).remove(),m()})}})}),c(document).fragmentChange(function(a,b){(match=b.match(/^#conference_\d+$/))&&c(match[0]).find(".edit_conference_link").click()}),c("body").on("click",".close_conference_link",function(a){a.preventDefault();var d=c(this).closest(".conference");confirm(b.t("confirm.close","Are you sure you want to end this conference?\n\nYou will not be able to reopen it."))&&(d.loadingImage(),d.find(".close_conference_link, .join_conference_link, .edit_conference_link").hide(),c.ajaxJSON(c(this).attr("href"),"POST",{},function(a){d.loadingImage("remove"),d.slideUp(function(){d.remove(),m()}),c("#concluded-conference-list").prepend(i(a)),m()}))}),c(".external_url").click(function(a){a.preventDefault();var d=b.t("loading_urls_message","Loading, please wait..."),e=c(this),f=e.text();if(f==d)return;e.text(d),c.ajaxJSON(e.attr("href"),"GET",{},function(a){e.text(f);if(a.length==0)c.flashError(b.t("no_urls_error","Sorry, it looks like there aren't any %{type} pages for this conference yet.",{type:e.attr("name")}));else if(a.length>1){$box=c(document.createElement("DIV")),$box.append(c("<p />").text(b.t("multiple_urls_message","There are multiple %{type} pages available for this conference. Please select one:",{type:e.attr("name")})));for(var d=0;d<a.length;d++)$a=c("<a />",{href:a[d].url||e.attr("href")+"&url_id="+a[d].id,target:"_blank"}),$a.text(a[d].name),$box.append($a).append("<br>");$box.dialog({width:425,minWidth:425,minHeight:215,resizable:!0,height:"auto",title:e.text()})}else window.open(a[0].url)})})})})