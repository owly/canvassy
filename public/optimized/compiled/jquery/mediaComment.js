(function(){define(["i18n!media_comments","underscore","vendor/jquery.ba-tinypubsub","vendor/mediaelement-and-player","jquery"],function(a,b,c,d,e){var f,g,h,i,j,k,l,m;return k=function(){return e("body").hasClass("ie9")},l=function(){var a;return a=navigator.userAgent.toLowerCase(),a.match(/ip(hone|od|ad)/i)||a.match(/android/i)},h=function(){return l()},g=550,f=448,e.extend(d.MediaElementDefaults,{pluginPath:"/images/mediaelement/",defaultVideoWidth:g,defaultVideoHeight:f}),e.extend(d.MepDefaults,{mode:k()?"shim":"auto_plugin",success:function(a,b){if(a.pluginType==="flash")return a.play()}}),d.MepDefaults.features.push("googleanalytics"),j=function(a){var c;return c=new e.Deferred,e.getJSON("/media_objects/"+a+"/info",function(a){var e,f,g;return e=b.map(a.media_sources,function(a){return"<source type='"+a.content_type+"' src='"+a.url+"' />"}),f=b.map(a.media_tracks,function(a){var b;return b=d.language.codes[a.locale]||a.locale,"<track kind='"+a.kind+"' label='"+b+"' src='"+a.url+"' srclang='"+a.locale+"' />"}),g=b.map(a.media_sources,function(a){return a.content_type}),c.resolve({sources:e,tracks:f,types:g,can_add_captions:a.can_add_captions})}),c},i=function(a){var b,c,d,f,g,i;return d=a.sourcesAndTracks,c=a.mediaType,b=a.height,i=a.width,g=c==="video"?"video":"audio",c==="audio"&&d.types[0].match(/^video\//)&&!h()&&(g="video",a.mediaPlayerOptions.isVideo=!1,a.mediaPlayerOptions.videoHeight=30,b=30),f=d.sources.concat(d.tracks).join(""),e("<"+g+" "+(c==="video"?"width='"+i+"' height='"+b+"'":"")+" controls>"+f+"</"+g+">")},m={create:function(a,b,d,f){var g,h=this;return e("#media_recorder_container").removeAttr("id"),this.attr("id","media_recorder_container"),c.unsubscribe("media_comment_created"),c.subscribe("media_comment_created",function(a){return b.call(void 0,a.id,a.mediaType)}),g={modal:!1,defaultTitle:f},e.isFunction(d)&&(g.close=d.bind(this)),e.mediaComment.init(a,g)},show_inline:function(b,c,d){var f,h,k,l,m;return c==null&&(c="video"),f=e(this).closest(".instructure_file_link_holder").andSelf().first(),f.text(a.t("loading","Loading media...")),m=function(b){var d,e;return e=Math.min(f.closest("div,p,table").width()||g,g),d=Math.round(e/336*240),j(b).done(function(g){var h,j,k;return g.sources.length?(j={can_add_captions:g.can_add_captions,mediaCommendId:b,googleAnalyticsTitle:b},h=i({sourcesAndTracks:g,mediaPlayerOptions:j,mediaType:c,height:d,width:e}),h.appendTo(f.html("")),k=new MediaElementPlayer(h,j),h.data("mediaelementplayer",k)):f.text(a.t("media_still_converting","Media is currently being converted, please try again in a little bit."))})},b==="maybe"?(h=d.replace(/\/download.*/,""),k=function(){return f.text(a.t("messages.file_failed_to_load","This media file failed to load"))},l=function(a){var b;return((b=a.attachment)!=null?b.media_entry_id:void 0)!=="maybe"?(f.text(""),m(a.attachment.media_entry_id)):k()},e.ajaxJSON(h,"GET",{},l,k)):m(b)},show:function(b,c){var d,f,h,k,l,m;return f=e(this),(h=f.data("media_comment_dialog"))?h.dialog("open"):(l=35,c=c||"video",k=c==="video"?426:180,m=c==="video"?g:400,d=e('<div style="overflow: hidden; padding: 0;" />'),c==="audio"&&d.css("padding-top","120px"),d.dialog({title:a.t("titles.play_comment","Play Media Comment"),width:m,height:k,modal:!1,resizable:!1,close:function(){return f.data("mediaelementplayer").pause()}}),d.disableWhileLoading(j(b).done(function(e){var g,h;return e.sources.length?(h={can_add_captions:e.can_add_captions,mediaCommendId:b,googleAnalyticsTitle:b},g=i({sourcesAndTracks:e,mediaPlayerOptions:h,mediaType:c,height:k-l,width:m}),g.appendTo(d.html("")),f.data({mediaelementplayer:new MediaElementPlayer(g,h),media_comment_dialog:d})):d.text(a.t("media_still_converting","Media is currently being converted, please try again in a little bit."))})))}},e.fn.mediaComment=function(a){return INST.kalturaSettings?(m[a].apply(this,Array.prototype.slice.call(arguments,1)),this):console.log("Kaltura has not been enabled for this account")}})}).call(this)