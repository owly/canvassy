(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["i18n!notification_preferences","jquery","underscore","compiled/userSettings","compiled/notifications/NotificationGroupMappings","jst/profiles/notification_preferences","jst/profiles/notifications/_policy_cell","jquery.disableWhileLoading","jquery.ajaxJSON","compiled/jquery.rails_flash_notifications","jqueryui/tooltip"],function(b,c,d,e,f,g,h){var i;return i=function(){function e(d){var e,g,h,i;this.options=d,this.initGrid=a(this.initGrid,this),this.setupEventBindings=a(this.setupEventBindings,this),this.saveNewCellValue=a(this.saveNewCellValue,this),this.policyCellHtml=a(this.policyCellHtml,this),this.buildTable=a(this.buildTable,this),this.findButtonDataForCode=a(this.findButtonDataForCode,this),this.communicationEventGroups=a(this.communicationEventGroups,this),this.hideButtonsExceptCell=a(this.hideButtonsExceptCell,this),this.buildPolicyCellsHtml=a(this.buildPolicyCellsHtml,this),this.cellButtonsHide=a(this.cellButtonsHide,this),this.buttonData=[{code:"immediately",icon:"icon-check",text:b.t("frequencies.immediately","ASAP"),title:b.t("frequencies.title.right_away","Notify me right away")},{code:"daily",icon:"icon-clock",text:b.t("frequencies.daily","Daily"),title:b.t("frequencies.title.daily","Send daily summary")},{code:"weekly",icon:"icon-calendar-month",text:b.t("frequencies.weekly","Weekly"),title:b.t("frequencies.title.weekly","Send weekly summary")},{code:"never",icon:"icon-x",text:b.t("frequencies.never","Never"),title:b.t("frequencies.title.never","Do not send me anything")}],this.updateUrl=this.options.update_url,this.channels=this.options.channels||[],this.categories=this.options.categories||[],this.policies=this.options.policies||[],i=this.channels;for(g=0,h=i.length;g<h;g++)e=i[g],e.name=function(){switch(e.type){case"email":return b.t("communication.email.display","Email Address");case"sms":return b.t("communication.sms.display","Cell Number");case"twitter":return b.t("communication.twitter.display","Twitter");case"facebook":return b.t("communication.facebook.display","Facebook")}}();this.mappings=new f,this.$notificationSaveStatus=c("#notifications_save_status"),this.initGrid()}return e.prototype.cellButtonsShow=function(a,b){var c,d,e,f;b==null&&(b=!0),a.addClass("show-buttons"),f=a.find(".event-option-selection"),c=a.find(".event-option-buttons"),f.hide(),c.show();if(b){e=a.find(".frequency:checked"),d=a.find("label[for="+e.attr("id")+"]");if(d)return d.focus()}},e.prototype.cellButtonsHide=function(a,b){var c,d;b==null&&(b=!0),a.removeClass("show-buttons"),d=a.find(".event-option-selection"),c=a.find(".event-option-buttons"),c.hide(),d.show();if(b)return d.find("a:first").focus()},e.prototype.buildPolicyCellsHtml=function(a){var b,c,e,f;return c=function(){var c,g,h,i;h=this.channels,i=[];for(c=0,g=h.length;c<g;c++)b=h[c],f=d.find(this.policies,function(c){return c.channel_id===b.id&&c.category===a.category}),e="never",f&&(e=f.frequency),i.push(this.policyCellHtml(a,b.id,e));return i}.call(this),c.join("")},e.prototype.hideButtonsExceptCell=function(a){var b,d,e,f,g,h;g=c("#notification-preferences td.comm-event-option.show-buttons"),h=[];for(e=0,f=g.length;e<f;e++)d=g[e],b=c(d),b!==a?b.find(":focus").length===0?h.push(this.cellButtonsHide(b,!1)):h.push(void 0):h.push(void 0);return h},e.prototype.communicationEventGroups=function(){var a,b,c,e,f,g,h,i,j,k;f=[],k=this.mappings.groups;for(e in k){h=k[e],c=[];for(i=0,j=h.length;i<j;i++)b=h[i],a=d.find(this.categories,function(a){return a.category===b}),a&&(g={title:a.display_name,description:a.category_description,policyCells:this.buildPolicyCellsHtml(a)},a.option&&(g.checkName=a.option.name,g.checkedState=a.option.value,g.checkLabel=a.option.label,g.checkID=a.option.id),c.push(g));c.length>0&&f.push({name:this.mappings.getGroupDisplayName(e),items:c})}return f},e.prototype.findButtonDataForCode=function(a){return d.find(this.buttonData,function(b){return b.code===a})},e.prototype.buildTable=function(){return c("#notification-preferences").append(g({touch:INST.browser.touch,channels:this.channels,eventGroups:this.communicationEventGroups()})),c("#notification-preferences .category-name.show-popover").tooltip({position:{my:"left center",at:"right+20 center",collision:"none none"},tooltipClass:"popover left middle horizontal"}),c("tbody th[scope=row]").css("min-width",c("h3.group-name").width()),this.setupEventBindings(),null},e.prototype.policyCellHtml=function(a,b,c){var e;return c==null&&(c="never"),d.each(this.buttonData,function(c){return c.active=!1,c.coordinate="cat_"+a.id+"_ch_"+b,c.id=""+c.coordinate+"_"+c.code}),e=this.findButtonDataForCode(c),e.active=!0,h({touch:INST.browser.touch,category:a.category,channelId:b,selected:e,allButtons:this.buttonData})},e.prototype.saveNewCellValue=function(a,d){var e,f,g,h,i=this;return e=this.findButtonDataForCode(d),a.attr("data-selection",d),a.find("a.change-selection i").attr("class",e.icon),a.find("a.change-selection span.img-text").text(e.text),f=a.attr("data-category"),g=a.attr("data-channelId"),h={category:f,channel_id:g,frequency:d},this.$notificationSaveStatus.disableWhileLoading(c.ajaxJSON(this.updateUrl,"PUT",h,null,function(a){return c.flashError(b.t("communication.errors.saving_preferences_failed","Oops! Something broke.  Please try again"))}),this.spinOpts)},e.prototype.setupEventBindings=function(){var a,d=this;return a=c("#notification-preferences"),a.find(".event-option-buttons").buttonset(),INST.browser.touch||(a.find(".notification-prefs-table").on({mouseenter:function(a){return d.cellButtonsShow(c(a.currentTarget),!1)},mouseleave:function(a){return d.cellButtonsHide(c(a.currentTarget),!1)}},".comm-event-option"),a.find(".notification-prefs-table a.change-selection").on("click",function(a){var b;return a.preventDefault(),b=c(a.currentTarget).closest("td"),d.hideButtonsExceptCell(b),d.cellButtonsShow(b,!0)})),a.find(".frequency").on("change",function(a){var b,e,f;return e=c(a.currentTarget),b=e.closest("td"),f=e.attr("data-value"),d.saveNewCellValue(b,f)}),a.find(".mobile-select").on("change",function(a){var b,e,f;return e=c(a.currentTarget),b=c(a.currentTarget).closest("td"),f=e.find("option:selected").val(),d.saveNewCellValue(b,f)}),a.find(".user-pref-check").on("change",function(a){var e,f,g;return e=c(a.currentTarget),f=e.attr("checked")==="checked",g={user:{}},g.user[e.attr("name")]=f,d.$notificationSaveStatus.disableWhileLoading(c.ajaxJSON(d.updateUrl,"PUT",g,null,function(a){return c.flashError(b.t("communication.errors.saving_preferences_failed","Oops! Something broke.  Please try again"))}),d.spinOpts)}),null},e.prototype.spinOpts={length:4,radius:5,width:3},e.prototype.initGrid=function(){return this.buildTable(),null},e}()})}).call(this)