(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=[].slice,c=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};define(["compiled/gradebook2/TotalColumnHeaderView","compiled/util/round","compiled/views/InputFilterView","i18n!gradebook2","compiled/gradebook2/GRADEBOOK_TRANSLATIONS","jquery","underscore","compiled/grade_calculator","compiled/userSettings","vendor/spin","compiled/multi_grid","compiled/SubmissionDetailsDialog","compiled/gradebook2/AssignmentGroupWeightsDialog","compiled/gradebook2/SubmissionCell","compiled/gradebook2/GradebookHeaderMenu","str/htmlEscape","jst/gradebook_uploads_form","jst/gradebook2/section_to_show_menu","jst/gradebook2/column_header","jst/gradebook2/group_total_cell","jst/gradebook2/row_student_name","jst/_avatar","jquery.ajaxJSON","jquery.instructure_date_and_time","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","vendor/jquery.ba-tinypubsub","jqueryui/mouse","jqueryui/position","jqueryui/sortable","compiled/jquery.kylemenu","compiled/jquery/fixDialogButtons"],function(d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x){var y;return y=function(){function A(c){var d,e=this;this.options=c,this.setAssignmentWarnings=a(this.setAssignmentWarnings,this),this.initGrid=a(this.initGrid,this),this.onUserFilterInput=a(this.onUserFilterInput,this),this.initHeader=a(this.initHeader,this),this.onGridBlur=a(this.onGridBlur,this),this.hoverMinimizedCell=a(this.hoverMinimizedCell,this),this.unminimizeColumn=a(this.unminimizeColumn,this),this.minimizeColumn=a(this.minimizeColumn,this),this.fixColumnReordering=a(this.fixColumnReordering,this),this.unhighlightColumns=a(this.unhighlightColumns,this),this.highlightColumn=a(this.highlightColumn,this),this.calculateStudentGrade=a(this.calculateStudentGrade,this),this.groupTotalFormatter=a(this.groupTotalFormatter,this),this.staticCellFormatter=a(this.staticCellFormatter,this),this.cellFormatter=a(this.cellFormatter,this),this.updateSubmissionsFromExternal=a(this.updateSubmissionsFromExternal,this),this.updateSubmission=a(this.updateSubmission,this),this.gotSubmissionsChunk=a(this.gotSubmissionsChunk,this),this.getSubmissionsChunks=a(this.getSubmissionsChunks,this),this.buildRows=a(this.buildRows,this),this.handleAssignmentMutingChange=a(this.handleAssignmentMutingChange,this),this.rowFilter=a(this.rowFilter,this),this.wrapColumnSortFn=a(this.wrapColumnSortFn,this),this.makeCompareAssignmentCustomOrderFn=a(this.makeCompareAssignmentCustomOrderFn,this),this.compareAssignmentDueDates=a(this.compareAssignmentDueDates,this),this.compareAssignmentPositions=a(this.compareAssignmentPositions,this),this.makeColumnSortFn=a(this.makeColumnSortFn,this),this.arrangeColumnsBy=a(this.arrangeColumnsBy,this),this.setArrangementTogglersVisibility=a(this.setArrangementTogglersVisibility,this),this.storeCustomColumnOrder=a(this.storeCustomColumnOrder,this),this.setStoredSortOrder=a(this.setStoredSortOrder,this),this.getStoredSortOrder=a(this.getStoredSortOrder,this),this.gotChunkOfStudents=a(this.gotChunkOfStudents,this),this.gotSections=a(this.gotSections,this),this.gotAssignmentGroups=a(this.gotAssignmentGroups,this),this.chunk_start=0,this.students={},this.rows=[],this.sortFn=function(a){return a.sortable_name},this.assignmentsToHide=l.contextGet("hidden_columns")||[],this.sectionToShow=l.contextGet("grading_show_only_section"),this.show_attendance=l.contextGet("show_attendance"),this.include_ungraded_assignments=l.contextGet("include_ungraded_assignments"),this.userFilterRemovedRows=[],this.show_concluded_enrollments=l.contextGet("show_concluded_enrollments"),this.options.course_is_concluded&&(this.show_concluded_enrollments=!0),i.subscribe("assignment_group_weights_changed",this.buildRows),i.subscribe("assignment_muting_toggled",this.handleAssignmentMutingChange),i.subscribe("submissions_updated",this.updateSubmissionsFromExternal),d=this.show_concluded_enrollments?"students_url_with_concluded_enrollments":"students_url",i.when(i.ajaxJSON(this.options[d],"GET"),i.ajaxJSON(this.options.assignment_groups_url,"GET",{},this.gotAssignmentGroups),i.ajaxJSON(this.options.sections_url,"GET",{},this.gotSections)).then(function(a){var c,f,g,h,j,k,l,m,n;m=a[0],l=a[1],n=a[2],e.gotChunkOfStudents(m),k=n.getResponseHeader("Link"),g=k.match(/<[^>]+>; *rel="last"/);if(g==null){e.gotAllStudents();return}return h=g[0].match(/page=(\d+)/)[1],h=parseInt(h,10),f=function(a){return i.ajaxJSON(e.options[d],"GET",{page:a})},c=function(){var a,b;b=[];for(j=a=2;2<=h?a<=h:a>=h;j=2<=h?++a:--a)b.push(f(j));return b}(),i.when.apply(i,c).then(function(){var a,d,f,g,h,i;a=1<=arguments.length?b.call(arguments,0):[];if(c.length===1)e.gotChunkOfStudents(a[0]);else for(g=0,h=a.length;g<h;g++)i=a[g],m=i[0],d=i[1],f=i[2],e.gotChunkOfStudents(m);return e.gotAllStudents()})}),this.spinner=new m,i(this.spinner.spin().el).css({opacity:.5,top:"55px",left:"50%"}).addClass("use-css-transitions-for-show-hide").appendTo("#main")}var y,z;return z={assignment:{min:10,default_max:200,max:400},assignmentGroup:{min:35,default_max:200,max:400},total:{min:85,max:100}},y=2,A.prototype.gotAssignmentGroups=function(a){var b,c,d,e,f;this.assignmentGroups={},this.assignments={},new p({context:this.options,assignmentGroups:a}),f=[];for(d=0,e=a.length;d<e;d++)c=a[d],s(c),this.assignmentGroups[c.id]=c,f.push(function(){var a,d,e,f;e=c.assignments,f=[];for(a=0,d=e.length;a<d;a++)b=e[a],s(b),b.assignment_group=c,b.due_at&&(b.due_at=i.parseFromISO(b.due_at)),f.push(this.assignments[b.id]=b);return f}.call(this));return f},A.prototype.gotSections=function(a){var b,c,d;this.sections={};for(c=0,d=a.length;c<d;c++)b=a[c],s(b),this.sections[b.id]=b;return this.sections_enabled=a.length>1},A.prototype.gotChunkOfStudents=function(a){var b,c,d,e,f,g,h,i;i=[];for(f=0,g=a.length;f<g;f++)c=a[f],b=c.user,b.enrollment=c,(d=this.students)[h=b.id]||(d[h]=s(b)),(e=this.students[b.id]).sections||(e.sections=[]),i.push(this.students[b.id].sections.push(c.course_section_id));return i},A.prototype.gotAllStudents=function(){var a,b,c,d,e,f,g,h,j;h=this.students;for(b in h){f=h[b],f.computed_current_score||(f.computed_current_score=0),f.computed_final_score||(f.computed_final_score=0),f.secondary_identifier=f.sis_login_id||f.login_id,this.sections_enabled&&(c=function(){var a,b,c,e;c=f.sections,e=[];for(a=0,b=c.length;a<b;a++)d=c[a],this.sections[d]&&e.push(this.sections[d].name);return e}.call(this),e=i.toSentence(c.sort())),f.display_name=x({avatar_image_url:f.avatar_url,display_name:f.name,url:f.enrollment.grades.html_url,sectionNames:e}),j=this.assignments;for(b in j)a=j[b],f[g="assignment_"+b]||(f[g]={assignment_id:b,user_id:f.id});this.rows.push(f)}return this.initGrid(),this.buildRows(),this.getSubmissionsChunks(),this.initHeader()},A.prototype.defaultSortType="assignment_group",A.prototype.getStoredSortOrder=function(){return l.contextGet("sort_grade_columns_by")||{sortType:this.defaultSortType}},A.prototype.setStoredSortOrder=function(a){return a.sortType===this.defaultSortType?l.contextRemove("sort_grade_columns_by"):l.contextSet("sort_grade_columns_by",a)},A.prototype.storeCustomColumnOrder=function(){var a,b,c;return c={sortType:"custom",customOrder:[]},b=this.gradeGrid.getColumns(),a=j.filter(b,function(a){return a.type==="assignment"}),c.customOrder=j.map(a,function(a){return a.object.id}),this.setStoredSortOrder(c)},A.prototype.setArrangementTogglersVisibility=function(a){return this.$columnArrangementTogglers.each(function(){return i(this).closest("li").showIf(i(this).data("arrangeColumnsBy")!==a.sortType)})},A.prototype.arrangeColumnsBy=function(a){var b;return this.setArrangementTogglersVisibility(a),this.setStoredSortOrder(a),b=this.gradeGrid.getColumns(),b.sort(this.makeColumnSortFn(a)),this.gradeGrid.setColumns(b),this.fixColumnReordering(),this.buildRows()},A.prototype.makeColumnSortFn=function(a){var b;return b=function(){switch(a.sortType){case"assignment_group":return this.compareAssignmentPositions;case"due_date":return this.compareAssignmentDueDates;case"custom":return this.makeCompareAssignmentCustomOrderFn(a);default:throw"unhandled column sort condition"}}.call(this),this.wrapColumnSortFn(b)},A.prototype.compareAssignmentPositions=function(a,b){var c,d;return c=a.object.assignment_group.position-b.object.assignment_group.position,d=a.object.position-b.object.position,c*1e6+d},A.prototype.compareAssignmentDueDates=function(a,b){var c,d,e,f;return c=((e=a.object.due_at)!=null?e.timestamp:void 0)||Number.MAX_VALUE,d=((f=b.object.due_at)!=null?f.timestamp:void 0)||Number.MAX_VALUE,c===d?a.object.name===b.object.name?0:a.object.name>b.object.name?1:-1:c-d},A.prototype.makeCompareAssignmentCustomOrderFn=function(a){var b,c,d,e,f,g,h=this;d={},c=0,g=a.customOrder;for(e=0,f=g.length;e<f;e++)b=g[e],d[String(b)]=c,c+=1;return function(a,b){var c,e;return c=d[String(a.object.id)],e=d[String(b.object.id)],c!=null&&e!=null?c-e:c!=null&&e==null?-1:e!=null?1:h.compareAssignmentPositions(a,b)}},A.prototype.wrapColumnSortFn=function(a){var b=this;return function(b,c){return c.type==="total_grade"?-1:b.type==="total_grade"?1:c.type==="assignment_group"&&b.type!=="assignment_group"?-1:b.type==="assignment_group"&&c.type!=="assignment_group"?1:b.type==="assignment_group"&&c.type==="assignment_group"?b.object.position-c.object.position:a(b,c)}},A.prototype.rowFilter=function(a){var b;return!this.sectionToShow||(b=this.sectionToShow,c.call(a.sections,b)>=0)},A.prototype.handleAssignmentMutingChange=function(a){var b,c;return c=this.gradeGrid.getColumnIndex("assignment_"+a.id),b=this.gradeGrid.getColumns()[c],b.name=this.assignmentHeaderHtml(a),this.gradeGrid.setColumns(this.gradeGrid.getColumns()),this.fixColumnReordering(),this.buildRows()},A.prototype.buildRows=function(){var a,b,c,d,e,f,g,h,i,j,k;this.rows.length=0,d={},h=this.gradeGrid.getColumns();for(c in h){a=h[c];if(""+((i=a.object)!=null?i.submission_types:void 0)!="attendance")continue;a.unselectable=!this.show_attendance,a.cssClass=this.show_attendance?"":"completely-hidden",this.$grid.find("[id*='"+a.id+"']").showIf(this.show_attendance)}j=this.students;for(c in j)e=j[c],e.row=-1,this.rowFilter(e)&&(this.rows.push(e),this.calculateStudentGrade(e),d[e.id]=this.sortFn(e));this.rows.sort(function(a,b){return d[a.id]<d[b.id]?-1:d[a.id]>d[b.id]?1:0}),k=this.rows;for(b=f=0,g=k.length;f<g;b=++f)e=k[b],e.row=b;return this.multiGrid.invalidate()},A.prototype.getSubmissionsChunks=function(){var a,b,c,d,e,f,g;a=function(){var a,c;a=this.students,c=[];for(b in a)d=a[b],c.push(d);return c}.call(this),g=[];for(;;){f=a.slice(this.chunk_start,this.chunk_start+this.options.chunk_size);if(!f.length){this.allSubmissionsLoaded=!0;break}c={student_ids:function(){var a,b,c;c=[];for(a=0,b=f.length;a<b;a++)e=f[a],c.push(e.id);return c}(),response_fields:["id","user_id","url","score","grade","submission_type","submitted_at","assignment_id","grade_matches_current_submission","attachments","late"]},i.ajaxJSON(this.options.submissions_url,"GET",c,this.gotSubmissionsChunk),g.push(this.chunk_start+=this.options.chunk_size)}return g},A.prototype.gotSubmissionsChunk=function(a){var b,c,d,e,f,g,h,i;for(e=0,g=a.length;e<g;e++){b=a[e],c=this.students[b.user_id],i=b.submissions;for(f=0,h=i.length;f<h;f++)d=i[f],this.updateSubmission(d);c.loaded=!0,this.multiGrid.invalidateRow(c.row),this.calculateStudentGrade(c)}return this.multiGrid.render()},A.prototype.updateSubmission=function(a){var b;return b=this.students[a.user_id],a.submitted_at&&(a.submitted_at=i.parseFromISO(a.submitted_at)),b["assignment_"+a.assignment_id]=a},A.prototype.updateSubmissionsFromExternal=function(a,b){var c,d,e,f,g,h,j,k,l,m,n,o,p,q,r;c=this.gradeGrid.getActiveCell(),g=i(this.gradeGrid.getActiveCellNode()).hasClass("editable"),f=this.gradeGrid.getColumns(),r=[];for(n=0,p=a.length;n<p;n++){l=a[n],k=this.students[l.user_id],h="assignment_"+l.assignment_id;for(j=o=0,q=f.length;o<q;j=++o)e=f[j],e.id===h&&(d=j);m=c!=null&&g&&c.row===k.row&&c.cell===d,this.updateSubmission(l),this.calculateStudentGrade(k),m||this.gradeGrid.updateCell(k.row,d),r.push(this.updateRowTotals(k.row))}return r},A.prototype.updateRowTotals=function(a){var b,c,d,e,f,g;d=this.gradeGrid.getColumns(),g=[];for(c=e=0,f=d.length;e<f;c=++e)b=d[c],b.type!=="assignment"?g.push(this.gradeGrid.updateCell(a,c)):g.push(void 0);return g},A.prototype.cellFormatter=function(a,b,c){var d;return this.rows[a].loaded?c==null?this.staticCellFormatter(a,b,"-"):(d=this.assignments[c.assignment_id],d==null?this.staticCellFormatter(a,b,""):d.grading_type==="points"&&d.points_possible?q.out_of.formatter(a,b,c,d):(q[d.grading_type]||q).formatter(a,b,c,d)):this.staticCellFormatter(a,b,"")},A.prototype.staticCellFormatter=function(a,b,c){return"<div class='cell-content gradebook-cell'>"+c+"</div>"},A.prototype.groupTotalFormatter=function(a,b,c,d,f){var g,h,i;return c==null?"":(h=Math.round(c.score/c.possible*1e3)/10,isNaN(h)&&(h=0),c.possible&&this.options.grading_standard&&d.type==="total_grade"&&(g=k.letter_grade(this.options.grading_standard,h)),i={score:e(c.score,y),possible:e(c.possible,y),letterGrade:g,percentage:h},d.type==="total_grade"&&(i.warning=this.totalGradeWarning,i.lastColumn=!0,i.showPointsNotPercent=this.showPointTotals),w(i))},A.prototype.calculateStudentGrade=function(a){var b,c,d,e,f,g,h,i,j,l,m,n,o;if(a.loaded){b=this.include_ungraded_assignments?"final":"current",g=function(){var b;b=[];for(d in a)h=a[d],d.match(/^assignment_(?!group)/)&&b.push(h);return b}(),e=k.calculate(g,this.assignmentGroups,this.options.group_weighting_scheme),n=e.group_sums;for(i=0,l=n.length;i<l;i++){c=n[i],a["assignment_group_"+c.group.id]=c[b],o=c[b].submissions;for(j=0,m=o.length;j<m;j++)f=o[j],f.submission.drop=f.drop}return a.total_grade=e[b],this.addDroppedClass(a)}},A.prototype.addDroppedClass=function(a){var b,c,d,e,f,g,h,i;d=function(){var b;b=[];for(f in a)c=a[f],f.match(/assignment_\d+/)&&c.drop!=null&&b.push(f);return b}(),e={},e[a.row]={};for(h=0,i=d.length;h<i;h++)b=d[h],e[a.row][b]="dropped";return g="dropsForRow"+a.row,this.gradeGrid.removeCellCssStyles(g),this.gradeGrid.addCellCssStyles(g,e)},A.prototype.highlightColumn=function(a){var b;return isNaN(a)&&(b=a.currentTarget.className.match(/c\d+/),b&&(a=b.toString().replace("c",""))),this.$grid.find(".slick-header-column:eq("+a+")").addClass("hovered-column")},A.prototype.unhighlightColumns=function(){return this.$grid.find(".hovered-column").removeClass("hovered-column")},A.prototype.fixColumnReordering=function(){var a,b,c,d,e,f,g,h=this;return a=i("#gradebook_grid").find(".slick-header-columns"),f=a.sortable("option","items"),e='> *:not([id*="assignment_group"]):not([id*="total_grade"])',(d=function(){var b;return a.sortable("option","items",e),b=i(f,a).not(i(e,a)),b.data("sortable-item",null)})(),(c=function(){return a.find(".assignment_header_drop").click(function(a){var b;return b=i(a.target),b.data("gradebookHeaderMenu")||b.data("gradebookHeaderMenu",new r(h.assignments[b.data("assignmentId")],b,h)),!1})})(),g=a.sortable("option","stop"),(b=function(){return a.sortable("option","stop",function(e,h){var i;return a.sortable("option","items",f),i=g.apply(this,arguments),d(),c(),b(),i})})()},A.prototype.minimizeColumn=function(a){var b,c;return b=a.index(),c=this.gradeGrid.getColumns()[b],c.cssClass=(c.cssClass||"").replace(" minimized","")+" minimized",c.unselectable=!0,c.unminimizedName=c.name,c.name="",c.minimized=!0,this.$grid.find(".l"+b).add(a).addClass("minimized"),this.assignmentsToHide.push(c.id),l.contextSet("hidden_columns",j.uniq(this.assignmentsToHide))},A.prototype.unminimizeColumn=function(a){var b,c;return b=a.index(),c=this.gradeGrid.getColumns()[b],c.cssClass=(c.cssClass||"").replace(" minimized",""),c.unselectable=!1,c.name=c.unminimizedName,c.minimized=!1,this.$grid.find(".l"+b).add(a).removeClass("minimized"),a.find(".slick-column-name").html(c.name),this.assignmentsToHide=i.grep(this.assignmentsToHide,function(a){return a!==c.id}),l.contextSet("hidden_columns",j.uniq(this.assignmentsToHide))},A.prototype.hoverMinimizedCell=function(a){var b,c,d,e,f,j,k,l=this;return b=i(a.currentTarget).removeClass("hover"),d=this.gradeGrid.getColumns()[b.index()],c=d.object,f=b.offset(),e=[c.name],b.hasClass("slick-cell")?(j=this.rows[this.gradeGrid.getCellFromEvent(a).row][d.id],c.points_possible!=null?e.push(""+((k=j.score)!=null?k:"--")+" / "+c.points_possible):j.score!=null&&e.push(j.score),Array.prototype.push.apply(e,i.map(q.classesBasedOnSubmission(j,c),function(a){return h["#submission_tooltip_"+a]}))):c.points_possible!=null&&e.push(g.t("points_out_of","out of %{points_possible}",{points_possible:c.points_possible})),b.data("tooltip",i("<span />",{"class":"gradebook-tooltip",css:{left:f.left-15,top:f.top,zIndex:1e4,display:"block"},html:e.join("<br />")}).appendTo("body").css("top",function(a,b){return parseInt(b)-i(this).outerHeight()}))},A.prototype.unhoverMinimizedCell=function(a){var b;if(b=i(this).data("tooltip"))return a.toElement===b[0]?b.mouseleave(function(){return b.remove()}):b.remove()},A.prototype.fixMaxHeaderWidth=function(){return this.$grid.find(".slick-header-columns").width(1e6)},A.prototype.onGridBlur=function(a){if(a.target.className.match(/cell|slick/)||!this.gradeGrid.getActiveCell)return;if(a.target.className==="grade"&&this.gradeGrid.getCellEditor()instanceof q.out_of)return;return this.gradeGrid.getEditorLock().commitCurrentEdit()},A.prototype.onGridInit=function(){var a,b,c=this;return b={},i(this.spinner.el).remove(),i("#gradebook_wrapper").show(),this.$grid=a=i("#gradebook_grid").fillWindowWithMe({alsoResize:"#gradebook_students_grid",onResize:function(){return c.multiGrid.resizeCanvas()}}).delegate(".slick-cell",{"mouseenter.gradebook focusin.gradebook":this.highlightColumn,"mouseleave.gradebook focusout.gradebook":this.unhighlightColumns,"mouseenter focusin":function(b){return a.find(".hover, .focus").removeClass("hover focus"),i(this).addClass(b.type==="mouseenter"?"hover":"focus")},"mouseleave focusout":function(){return i(this).removeClass("hover focus")}}).delegate(".gradebook-cell-comment","click.gradebook",function(a){var b;return a.preventDefault(),b=i(a.currentTarget).data(),o.open(c.assignments[b.assignmentId],c.students[b.userId],c.options)}).delegate(".minimized",{mouseenter:this.hoverMinimizedCell,mouseleave:this.unhoverMinimizedCell}),this.options.gradebook_is_editable&&this.$grid.addClass("editable"),this.fixMaxHeaderWidth(),i("#gradebook_grid .slick-resizable-handle").live("drag",function(a,b){return c.$grid.find(".slick-header-column").each(function(a,b){var d,e;d=i(b),e=c.gradeGrid.getColumns()[a];if(d.outerWidth()<=minimumAssignmentColumWidth){if(!e.minimized)return c.minimizeColumn(d)}else if(e.minimized)return c.unminimizeColumn(d)})}),i(document).trigger("gridready")},A.prototype.initHeader=function(){var a,b,c,e,h,k,m,n,o,p,q=this;if(this.sections_enabled){e=g.t("all_sections","All Sections"),m=[{name:e,checked:!this.sectionToShow}],p=this.sections;for(h in p)k=p[h],m.push({name:k.name,id:h,checked:this.sectionToShow===h});a=i(u({sections:m})),(o=function(){return i("#section_being_shown").html(q.sectionToShow?q.sections[q.sectionToShow].name:e)})(),i("#section_to_show").after(a).show().kyleMenu(),a.bind("menuselect",function(b,c){return q.sectionToShow=Number(a.find('[aria-checked="true"] input[name="section_to_show_radio"]').val())||void 0,l[q.sectionToShow?"contextSet":"contextRemove"]("grading_show_only_section",q.sectionToShow),o(),q.buildRows()})}return b=i("#gradebook_settings").next(),i.each(["show_attendance","include_ungraded_assignments","show_concluded_enrollments"],function(a,c){return b.find("#"+c).prop("checked",!!q[c]).change(function(a){return c==="show_concluded_enrollments"&&q.options.course_is_concluded&&q.show_concluded_enrollments?(i("#"+c).prop("checked",!0),b.menu("refresh"),alert(g.t("concluded_course_error_message","This is a concluded course, so only concluded enrollments are available."))):(q[c]=i(a.target).is(":checked"),l.contextSet(c,q[c]),c==="show_concluded_enrollments"&&window.location.reload(),c==="show_attendance"&&q.gradeGrid.setColumns(q.getVisibleGradeGridColumns()),q.buildRows())})}),j.detect(this.assignments,function(a){return""+a.submission_types=="attendance"})||b.find("#show_attendance").closest("li").hide(),this.$columnArrangementTogglers=i("#gradebook-toolbar [data-arrange-columns-by]").bind("click",function(a){var b;return a.preventDefault(),b={sortType:i(a.currentTarget).data("arrangeColumnsBy")},q.arrangeColumnsBy(b)}),this.arrangeColumnsBy(this.getStoredSortOrder()),i("#gradebook_settings").show().kyleMenu(),c=null,b.find(".gradebook_upload_link").click(function(a){var b;return a.preventDefault(),c||(b={download_gradebook_csv_url:""+q.options.context_url+"/gradebook.csv",action:""+q.options.context_url+"/gradebook_uploads",authenticityToken:ENV.AUTHENTICITY_TOKEN},c=i(t(b)).dialog({bgiframe:!0,autoOpen:!1,modal:!0,width:720,resizable:!1}).fixDialogButtons()),c.dialog("open")}),b.find(".student_names_toggle").click(function(a){var b;return b=i(".grid-canvas"),b.toggleClass("hide-students"),b.hasClass("hide-students")?i(this).text(g.t("show_student_names","Show Student Names")):i(this).text(g.t("hide_student_names","Hide Student Names"))}),this.userFilter=new f({el:".gradebook_filter input"}),this.userFilter.on("input",this.onUserFilterInput),this.showPointTotals=this.setPointTotals(l.contextGet("show_point_totals")),n=new d({showingPoints:function(){return q.showPointTotals},toggleShowingPoints:this.togglePointsOrPercentTotals.bind(this),weightedGroups:this.weightedGroups.bind(this)}),n.render()},A.prototype.weightedGroups=function(){return this.options.group_weighting_scheme==="percent"},A.prototype.setPointTotals=function(a){return this.showPointTotals=this.weightedGroups()?!1:a},A.prototype.togglePointsOrPercentTotals=function(){return this.setPointTotals(!this.showPointTotals),l.contextSet("show_point_totals",this.showPointTotals),this.gradeGrid.invalidate()},A.prototype.onUserFilterInput=function(a){var b,c,d,e,f,g,h,i,k=this;j.each(this.multiGrid.data,function(a){if(a.beforeFilteredRow!=null)return a.row=a.beforeFilteredRow,delete a.beforeFilteredRow}),j.each(this.userFilterRemovedRows.reverse(),function(a){return k.multiGrid.data.splice(a.index,0,a.data)}),this.userFilterRemovedRows=[];if(a!==""){e=["name","login_id","short_name","sortable_name"],b=this.multiGrid.data.length;while(b--)f=this.multiGrid.data[b],d=j.any(e,function(b){var c;return(c=f[b])!=null?c.match(new RegExp(a,"i")):void 0}),d||(c={index:b,data:this.multiGrid.data.splice(b,1)[0]},this.userFilterRemovedRows.push(c))}i=this.multiGrid.data;for(b=g=0,h=i.length;g<h;b=++g)f=i[b],f.beforeFilteredRow=f.row,f.row=b;return this.multiGrid.invalidate()},A.prototype.getVisibleGradeGridColumns=function(){var a,b,c,d,e,f;b=[],f=this.allAssignmentColumns;for(d=0,e=f.length;d<e;d++)a=f[d],c=""+a.object.submission_types,c==="not_graded"||c==="attendance"&&!this.show_attendance||b.push(a);return b.concat(this.aggregateColumns)},A.prototype.assignmentHeaderHtml=function(a){return v({assignment:a,href:a.html_url,showPointsPossible:a.points_possible!=null})},A.prototype.initGrid=function(){var a,b,d,e,f,h,j,k,l,m,o,p,r,s,t,u=this;return a=i('<span style="padding:10px" />').appendTo("#content"),s=function(b,c,d){var e;return e=Math.max(a.text(b).outerWidth(),c),Math.min(e,d)},this.setAssignmentWarnings(),this.parentColumns=[{id:"student",name:g.t("student_name","Student Name"),field:"display_name",width:150,cssClass:"meta-cell",resizable:!1,sortable:!0},{id:"secondary_identifier",name:g.t("secondary_id","Secondary ID"),field:"secondary_identifier",width:100,cssClass:"meta-cell secondary_identifier_cell",resizable:!1,sortable:!0}],this.allAssignmentColumns=function(){var a,f,g=this;a=this.assignments,f=[];for(k in a)b=a[k],o=b&&b.grading_type==="points"&&b.points_possible!=null&&q.out_of,l=o?70:90,e="assignment_"+k,d={id:e,field:e,name:this.assignmentHeaderHtml(b),object:b,formatter:this.cellFormatter,editor:o||q[b.grading_type]||q,minWidth:z.assignment.min,maxWidth:z.assignment.max,width:s(b.name,l,z.assignment.default_max),sortable:!0,toolTip:b.name,type:"assignment"},c.call(this.assignmentsToHide,e)>=0&&(d.width=10,function(a){return i(document).bind("gridready",function(){return g.minimizeColumn(g.$grid.find("[id*='"+a+"']"))}).unbind("gridready.render").bind("gridready.render",function(){return g.gradeGrid.invalidate()})}(e)),f.push(d);return f}.call(this),this.aggregateColumns=function(){var a,b;a=this.assignmentGroups,b=[];for(k in a)h=a[k],j=""+h.name,h.group_weight!=null&&(p=g.toPercentage(h.group_weight,{precision:2}),j+="<div class='assignment-points-possible'>\n  "+g.t("percent_of_grade","%{percentage} of grade",{percentage:p})+"\n</div>"),b.push({id:"assignment_group_"+k,field:"assignment_group_"+k,formatter:this.groupTotalFormatter,name:j,toolTip:h.name,object:h,minWidth:z.assignmentGroup.min,maxWidth:z.assignmentGroup.max,width:s(h.name,z.assignmentGroup.min,z.assignmentGroup.default_max),cssClass:"meta-cell assignment-group-cell",sortable:!0,type:"assignment_group"});return b}.call(this),t=g.t("total","Total"),this.aggregateColumns.push({id:"total_grade",field:"total_grade",formatter:this.groupTotalFormatter,name:""+t+"\n<div id=total_column_header></div>",toolTip:t,minWidth:z.total.min,maxWidth:z.total.max,width:s("Total",z.total.min,z.total.max),cssClass:"total-cell",sortable:!0,type:"total_grade"}),a.remove(),m=i.extend({enableCellNavigation:!1,enableColumnReorder:!1,enableAsyncPostRender:!0,asyncPostRenderDelay:1,autoEdit:!0,rowHeight:35,headerHeight:38},this.options),f=[{selector:"#gradebook_students_grid",columns:this.parentColumns},{selector:"#gradebook_grid",columns:this.getVisibleGradeGridColumns(),options:{enableCellNavigation:!0,editable:this.options.gradebook_is_editable,syncColumnCellResize:!0,enableColumnReorder:!0}}],this.multiGrid=new n(this.rows,m,f,1),this.gradeGrid=this.multiGrid.grids[1],this.gradeGrid.onCellChange.subscribe(function(a,b){return u.calculateStudentGrade(b.item),u.gradeGrid.invalidate()}),i("body").on("click",this.onGridBlur),r=function(a){var b,c,d,e,f;u.rows.sort(a),f=u.rows;for(b=d=0,e=f.length;d<e;b=++d)c=f[b],c.row=b,u.addDroppedClass(c);return u.multiGrid.invalidate()},this.gradeGrid.onSort.subscribe(function(a,b){return r(function(a,c){var d,e,f,g;return d=(f=a[b.sortCol.field])!=null?f.score:void 0,e=(g=c[b.sortCol.field])!=null?g.score:void 0,!d&&d!==0&&(d=-99999999999),!e&&e!==0&&(e=-99999999999),b.sortAsc?e-d:d-e})}),this.multiGrid.grids[0].onSort.subscribe(function(a,b){var c;return c={display_name:"sortable_name",secondary_identifier:"secondary_identifier"}[b.sortCol.field],r(function(a,d){var e;return e=a[c]<d[c]?-1:a[c]>d[c]?1:0,b.sortAsc?e:0-e})}),this.multiGrid.parent_grid.onKeyDown.subscribe(function(){return!1}),this.multiGrid.parent_grid.onColumnsReordered.subscribe(this.storeCustomColumnOrder),this.onGridInit()},A.prototype.setAssignmentWarnings=function(){var a,b,c,d,e,f,h,k,l,m;if(this.weightedGroups()){d=j.filter(this.assignmentGroups,function(a){var b;return b=j.inject(a.assignments,function(a,b){return a+(b.points_possible||0)},0),b===0});for(f=0,k=d.length;f<k;f++){b=d[f],m=b.assignments;for(h=0,l=m.length;h<l;h++)a=m[h],a.invalid=!0}if(d.length>0)return c=function(){var a,c,e;e=[];for(a=0,c=d.length;a<c;a++)b=d[a],e.push(b.name);return e}(),this.totalGradeWarning=g.t("invalid_assignment_groups_warning",{one:"Score does not include %{groups} because it has                  no points possible",other:"Score does not include %{groups} because they have                    no points possible"},{groups:i.toSentence(c),count:c.length})}else{e=j.inject(this.assignments,function(a,b){return a+(b.points_possible||0)},0);if(e===0)return this.totalGradeWarning=g.t("no_assignments_have_points_warning","Can't compute score until an assignment has points possible")}},A}()})}).call(this)