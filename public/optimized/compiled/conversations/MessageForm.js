(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["i18n!conversations","underscore","compiled/util/shortcut","jst/conversations/MessageForm","jst/conversations/addAttachment"],function(b,c,d,e,f){var g;return g=function(){function g(b,c,d){this.pane=b,this.canAddNotesFor=c,this.options=d,this.recipientIdsChanged=a(this.recipientIdsChanged,this),this.$form=$(e(this.options)),this.$mediaComment=this.$form.find(".media_comment"),this.$mediaCommentId=this.$form.find("input[name=media_comment_id]"),this.$mediaCommentType=this.$form.find("input[name=media_comment_type]"),this.$addMediaComment=this.$form.find(".action_media_comment"),this.$attachments=this.$form.find(".attachment_list")}return d(g,"pane","resize"),g.prototype.initialize=function(){var a,b=this;if(this.tokenInput=this.$form.find(".recipients").data("token_input"))this.tokenInput.$fakeInput.css("width","100%"),this.options.user_id&&(a={user_id:this.options.user_id,from_conversation_id:this.options.from_conversation_id},$.ajaxJSON(this.tokenInput.selector.url,"GET",a,function(a){if(a.length)return b.tokenInput.addToken({value:a[0].id,text:a[0].name,data:a[0]})}));this.initializeActions();if(!$(document.activeElement).filter(":input").length&&window.location.hash!=="")return this.$form.find(":input:visible:first").focus()},g.prototype.initializeActions=function(){var a=this;return this.tokenInput&&(this.tokenInput.change=this.recipientIdsChanged),this.$form.formSubmit({fileUpload:function(){return a.$form.find(".file_input:visible").length>0},preparedFileUpload:!0,context_code:"user_"+ENV.current_user_id,folder_id:this.options.folderId,intent:"message",formDataTarget:"url",disableWhileLoading:!0,required:["body"],property_validations:{token_capture:function(){if(a.tokenInput&&!a.tokenInput.tokenValues().length)return b.t("errors.field_is_required","This field is required")}},handle_files:function(a,b){var c;return b.attachment_ids=function(){var b,d,e;e=[];for(b=0,d=a.length;b<d;b++)c=a[b],e.push(c.attachment.id);return e}(),b},onSubmit:function(b,c){return a.request=b,a.pane.addingMessage(a.messageData(c),a.request)}})},g.prototype.recipientIdsChanged=function(a){var b;return a.length>1||((b=a[0])!=null?b.match(/^(course|group)_/):void 0)?this.toggleOptions({user_note:!1,group_conversation:!0}):this.toggleOptions({user_note:this.canAddNotesFor(a[0]),group_conversation:!1}),this.resize()},g.prototype.addAttachment=function(){var a,b=this;return a=$(f()),this.$attachments.append(a),a.slideDown("fast",function(){return b.resize()})},g.prototype.removeAttachment=function(a){var b,c=this;return b=a.closest(".attachment"),b.slideUp("fast",function(){return c.resize(),b.remove()})},g.prototype.addToken=function(a){var b;b=this.$form.find(".recipients").data("token_input");if(b)return b.addToken(a)},g.prototype.addMediaComment=function(){var a=this;return this.$mediaComment.mediaComment("create","any",function(b,c){return a.$mediaCommentId.val(b),a.$mediaCommentType.val(c),a.$mediaComment.show(),a.$addMediaComment.hide()})},g.prototype.removeMediaComment=function(){return this.$mediaCommentId.val(""),this.$mediaCommentType.val(""),this.$mediaComment.hide(),this.$addMediaComment.show()},g.prototype.messageData=function(a){var b;return b=this.options.conversation?Math.max(this.options.conversation.get("audience").length,1):c.reduce(this.tokenInput.$tokens.find('input[name="recipients[]"]'),function(a,b){var c;return a+((c=$(b).closest("li").data("user_count"))!=null?c:1)},0),{recipient_count:b,message:{body:a.body}}},g.prototype.resetForParticipant=function(a){if(this.canAddNotesFor(a))return this.toggleOptions({user_note:!0})},g.prototype.toggleOptions=function(a){var b,c,d,e;e=[];for(d in a)c=a[d],b=this.$form.find("."+d+"_info"),b.showIf(c),c?e.push(void 0):e.push(b.find("input[name="+d+"]").prop("checked",!1));return e},g.prototype.toggle=function(a){return this.$form[a?"addClass":"removeClass"]("disabled")},g.prototype.height=function(){return this.$form.outerHeight(!0)},g.prototype.refresh=function(a){return this.$form.find(".audience").html(a),this.resize()},g.prototype.destroy=function(){var a=this;return this.$form.hideErrors(),this.$form.css({position:"absolute",zIndex:-1}),$.when(this.request).then(function(){return a.$form.remove()})},g}()})}).call(this)