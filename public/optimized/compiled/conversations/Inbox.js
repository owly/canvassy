(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};define(["i18n!conversations","underscore","str/htmlEscape","compiled/conversations/introSlideshow","compiled/conversations/ConversationsPane","compiled/conversations/MessageFormPane","compiled/conversations/audienceList","compiled/util/contextList","compiled/widget/ContextSearch","compiled/str/TextHelper","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.disableWhileLoading","compiled/jquery.rails_flash_notifications","compiled/jquery/offsetFrom","media_comments","vendor/jquery.ba-hashchange","vendor/jquery.elastic","jqueryui/position"],function(c,d,e,f,g,h,i,j,k,l){return function(){function k(b){this.options=b,this.updateView=a(this.updateView,this),this.initializeMenus=a(this.initializeMenus,this),this.canAddNotesFor=a(this.canAddNotesFor,this),this.render=a(this.render,this),this.currentUser=this.options.USER,this.contexts=this.options.CONTEXTS,this.userCache={},this.userCache[this.currentUser.id]=this.currentUser,$(this.render)}return k.prototype.render=function(){this.$inbox=$("#inbox"),this.minHeight=parseInt(this.$inbox.css("min-height").replace("px","")),this.$conversations=$("#conversations"),this.$messages=$("#messages"),this.$messageList=this.$messages.find("ul.messages"),this.$others=$('<div class="others" id="others_popup" />'),this.initializeHelp(),this.initializeForms(),this.initializeMenus(),this.initializeMessageActions(),this.initializeTokenInputs(),this.initializeConversationsPane(),this.initializeMessageFormPane(),this.initializeAutoResize(),this.initializeHashChange();if(this.options.SHOW_INTRO)return f()},k.prototype.filters=function(){var a;return(a=this.conversations.baseData().filter)!=null?a:[]},k.prototype.htmlAudience=function(a,b){var f,g,h,j,k;return b==null&&(b={}),a==null&&(a=(k=this.conversations.active())!=null?k.attributes:void 0),a==null?e(c.t("headings.new_message","New Message")):(g=b.filters=b.highlightFilters?this.filters():[],f=function(){var b,c,e,f;e=a.audience,f=[];for(b=0,c=e.length;b<c;b++)h=e[b],f.push({id:h,name:this.userCache[h].name,activeFilter:d.include(g,"user_"+h)});return f}.call(this),j=i(f,b),f.length&&(j+=" <em>"+this.htmlContextList(a.audience_contexts,b)+"</em>"),j)},k.prototype.htmlContextList=function(a,b){return b==null&&(b={}),a={courses:d.keys(a.courses),groups:d.keys(a.groups)},j(a,this.contexts,b)},k.prototype.htmlNameForUser=function(a,b){var c,d;return b==null&&(b={courses:a.common_courses,groups:a.common_groups}),e(a.name)+(((c=b.courses)!=null?c.length:void 0)||((d=b.groups)!=null?d.length:void 0)?" <em>"+this.htmlContextList(b)+"</em>":"")},k.prototype.canAddNotesFor=function(a){var c,d,e,f,g,h;if(!this.options.NOTES_ENABLED)return!1;e=typeof a=="object"?a:this.userCache[a];if(e==null)return!1;f=e.common_courses;for(c in f){d=f[c];if(b.call(d,"StudentEnrollment")>=0&&(this.options.CAN_ADD_NOTES_FOR_ACCOUNT||((g=this.contexts.courses[c])!=null?(h=g.permissions)!=null?h.manage_user_notes:void 0:void 0)))return!0}return!1},k.prototype.loadConversation=function(a,b,c){var d,e=this;return this.$messageList.removeClass("private").hide().html(""),(typeof $conversation!="undefined"&&$conversation!==null?$conversation.hasClass("private"):void 0)&&this.$messageList.addClass("private"),this.resetMessageForm(a),this.toggleMessageActions(!1),a==null?c():(d=a.url(),this.$messageList.show().disableWhileLoading($.ajaxJSON(d,"GET",{},function(a){var b,d,f,g,h,i,j,k,l;e.conversations.updateItems([a]);if(!e.conversations.isActive(a.id))return;j=a.participants;for(f=0,h=j.length;f<h;f++){d=j[f];if((k=e.userCache[d.id])!=null?!!k.avatar_url:!!void 0)continue;e.userCache[d.id]=d,d.htmlName=e.htmlNameForUser(d)}a["private"]&&(d=function(){var b,c,e,f;e=a.participants,f=[];for(b=0,c=e.length;b<c;b++)d=e[b],d.id!==this.currentUser.id&&f.push(d);return f}.call(e)[0])&&e.formPane.resetForParticipant(d),e.resize(),e.$messages.show(),l=a.messages;for(g=0,i=l.length;g<i;g++)b=l[g],e.$messageList.append(e.buildMessage(b));return e.$messageList.show(),c()})))},k.prototype.resetMessageForm=function(a){var b;return $("#action_compose_message").toggleClass("active",a==null),b=this.conversations.baseData(),this.formPane.reset(d.extend({},this.currentHashData(),{conversation:a,audience:this.htmlAudience(null,{linkToContexts:!0,highlightFilters:!0}),addRecipientsEnabled:a!=null&&!a.get("private"),mediaCommentsEnabled:this.options.MEDIA_COMMENTS_ENABLED,filter:b.filter,scope:b.scope}))},k.prototype.updatedConversation=function(a){var b;this.formPane.refresh(this.htmlAudience(null,{linkToContexts:!0,highlightFilters:!0}));if(!a.length)return;this.conversations.updateItems(a);if(a.length===1){b=a[0],this.conversations.isActive(b.id)&&this.buildMessage(b.messages[0]).prependTo(this.$messageList).slideDown("fast");if(b.visible)return this.updateHashData({id:b.id})}},k.prototype.deselectMessages=function(){return this.$messageList.find("li.selected").removeClass("selected")},k.prototype.addMessage=function(a){return this.toggleMessageActions(!1),this.buildMessage(a).prependTo(this.$messageList).slideDown("fast")},k.prototype.buildMessage=function(a){var b,d,f,g,h,i,j,k,m,n,o,p,q,r,s,t,u,v,w,x,y=this;if(a.submission)return this.buildSubmission(a);f=$("#message_blank").clone(!0).attr("id","message_"+a.id),f.data("id",a.id),f.addClass(a.generated?"generated":a.author_id===this.currentUser.id?"self":"other"),f.addClass("forwardable"),m=this.userCache[a.author_id],(j=m!=null?m.avatar_url:void 0)&&f.prepend($("<img />").attr("src",j).addClass("avatar")),m&&(s=m.htmlName)==null&&(m.htmlName=this.htmlNameForUser(m)),n=(t=m!=null?m.name:void 0)!=null?t:c.t("unknown_user","Unknown user"),f.find(".audience").html((m!=null?m.htmlName:void 0)||e(n)),f.find("span.date").text($.parseFromISO(a.created_at).datetime_formatted),f.find("p").html(l.formatMessage(a.body)),f.find("a.show_quoted_text_link").click(function(a){var b,c;b=$(a.currentTarget),c=b.parents(".quoted_text_holder").children(".quoted_text");if(c.length)return event.stopPropagation(),event.preventDefault(),c.show(),b.hide()}),g=f.find("a.send_private_message"),g.on("click",function(b){return b.preventDefault(),b.stopPropagation(),m=y.userCache[a.author_id],$("#action_compose_message").trigger("click"),y.addUserTokenCb&&clearTimeout(y.addUserTokenCb),y.addUserTokenCb=setTimeout(function(){return delete y.addUserTokenCb,y.formPane.form.addToken({value:m.id,text:m.name,data:m})},100)});if((u=a.forwarded_messages)!=null?u.length:void 0){h=$('<ul class="messages"></ul>'),v=a.forwarded_messages;for(o=0,q=v.length;o<q;o++)k=v[o],h.append(this.buildMessage(k));f.append(h)}h=f.find("ul.message_attachments").first().detach(),d=h.find(".media_object_blank").detach(),b=h.find(".attachment_blank").detach();if(a.media_comment!=null||((w=a.attachments)!=null?w.length:void 0)){f.append(h),a.media_comment!=null&&h.append(this.buildMediaObject(d,a.media_comment));if(a.attachments!=null){x=a.attachments;for(p=0,r=x.length;p<r;p++)i=x[p],h.append(this.buildAttachment(b,i))}}return f},k.prototype.buildMediaObject=function(a,b){var c;return c=a.clone(!0).attr("id","media_comment_"+b.media_id),c.find("span.title").html(e(b.display_name)),c.find("span.media_comment_id").html(e(b.media_id)),c.find(".instructure_inline_media_comment").data("media_comment_type",b.media_type),c},k.prototype.buildAttachment=function(a,b){var c,d,f=this;return c=a.clone(!0).attr("id","attachment_"+b.id),c.data("id",b.id),c.find("span.title").html(e(b.display_name)),d=c.find("a"),d.attr("href",b.url),d.click(function(a){return a.stopPropagation()}),c},k.prototype.buildSubmission=function(a){var b,d,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=this;i=$("#submission_blank").clone(!0).attr("id",a.id),i.data("id",a.id),a=a.submission,j=i.find("ul"),f=j.find("li.header"),l=$.replaceTags(f.find("a").attr("href"),{course_id:a.assignment.course_id,assignment_id:a.assignment_id,id:a.user_id}),f.find("a").attr("href",l),q=this.userCache[a.user_id],q&&(t=q.htmlName)==null&&(q.htmlName=this.htmlNameForUser(q)),r=(u=q!=null?q.name:void 0)!=null?u:c.t("unknown_user","Unknown user"),f.find(".title").html(e(a.assignment.name)),f.find("span.date").text(a.submitted_at?$.parseFromISO(a.submitted_at).datetime_formatted:c.t("not_applicable","N/A")),f.find(".audience").html((q!=null?q.htmlName:void 0)||e(r)),a.score&&a.assignment.points_possible?p=""+a.score+" / "+a.assignment.points_possible:p=(v=a.score)!=null?v:c.t("not_scored","no score"),f.find(".score").html(p),d=j.find(".comment").detach(),n=0,o=4;for(m=s=w=a.submission_comments.length-1;s>=0;m=s+=-1){k=a.submission_comments[m];if(n>=10)break;n++,b=this.buildSubmissionComment(d,k),n>o&&b.hide(),j.append(b)}return h=j.find(".more").detach(),n>o&&(g=h.clone(!0),g.find(".hidden").text(n-o),g.attr("title",e(c.t("titles.expand_inline","Show more comments"))),g.click(function(a){var b;return b=$(a.currentTarget),i=b.closest(".submission"),i.find(".more:hidden").show(),b.hide(),i.find(".comment:hidden").slideDown("fast"),x.resize(),!1}),j.append(g)),a.submission_comments.length>n&&(h.find("a").attr("href",l).attr("target","_blank"),h.find(".hidden").text(a.submission_comments.length-n),h.attr("title",e(c.t("titles.view_submission","Open submission in new window."))),a.submission_comments.length>o&&h.hide(),j.append(h)),i},k.prototype.buildSubmissionComment=function(a,b){var d,f,g,h,i,j;return d=a.clone(!0),g=this.userCache[b.author_id],(f=g!=null?g.avatar_url:void 0)&&d.prepend($("<img />").attr("src",f).addClass("avatar")),g&&(i=g.htmlName)==null&&(g.htmlName=this.htmlNameForUser(g)),h=(j=g!=null?g.name:void 0)!=null?j:c.t("unknown_user","Unknown user"),d.find(".audience").html((g!=null?g.htmlName:void 0)||e(h)),d.find("span.date").text($.parseFromISO(b.created_at).datetime_formatted),d.find("p").html(e(b.comment).replace(/\n/g,"<br />")),d},k.prototype.closeMenus=function(){return $("#actions .menus > li, #conversation_actions, #conversations .actions").removeClass("selected")},k.prototype.openMenu=function(a){var b,c;this.closeMenus();if(!a.hasClass("disabled"))return b=a.parent("li, span").addClass("selected").find("div"),c=-(b.parent().position().left+b.parent().outerWidth()/2)+6,c<-(b.outerWidth()/2)&&(c=-(b.outerWidth()/2)),b.css("margin-left",c+"px")},k.prototype.resize=function(a){var b=this;return a==null&&(a=0),this.resizeCb&&clearTimeout(this.resizeCb),this.resizeCb=setTimeout(function(){var a;return delete b.resizeCb,a=$(window).height()-$("#header").outerHeight(!0)-($("#wrapper-container").outerHeight(!0)-$("#wrapper-container").height())-($("#main").outerHeight(!0)-$("#main").height())-$("#breadcrumbs").outerHeight(!0)-$("#footer").outerHeight(!0),a<b.minHeight&&(a=b.minHeight),$(document.body).toggleClass("too_small",a<=b.minHeight),b.$inbox.height(a),b.$messageList.height(a-b.formPane.height()),b.conversations.resize(a)},a)},k.prototype.toggleMessageActions=function(a){return a!=null?(this.$messageList.find("> li").removeClass("selected"),this.$messageList.find("> li :checkbox").attr("checked",!1)):a=!!this.$messageList.find("li.selected").length,$("#action_forward").parent().showIf(a&&this.$messageList.find("li.selected.forwardable").length),a?$("#message_actions").slideDown(100):$("#message_actions").slideUp(100),this.formPane.toggle(a)},k.prototype.updateHashData=function(a){var b,c;b=$.extend(this.currentHashData(),a),c=$.encodeToHex(JSON.stringify(b));if(c!==location.hash.substring(1))return location.hash=c,$(document).triggerHandler("document_fragment_change",c)},k.prototype.initializeHelp=function(){var a=this;return $("#help_crumb").click(function(a){return a.preventDefault(),f()})},k.prototype.prepareTextareas=function(a){var b=this;return a.elastic(),a.keypress(function(a){if(a.which===13&&a.shiftKey)return $(a.target).closest("form").submit(),!1})},k.prototype.initializeForms=function(){var a=this;return this.$addForm=$("#add_recipients_form"),this.$forwardForm=$("#forward_message_form"),this.prepareTextareas(this.$forwardForm.find("textarea")),this.$addForm.submit(function(b){var c;return c=!!a.$addForm.find(".token_input li").length,c||b.stopImmediatePropagation(),c}),this.$addForm.formSubmit({disableWhileLoading:!0,success:function(b){return a.updatedConversation(b),a.$addForm.dialog("close")},error:function(b){return a.$addForm.dialog("close")}}),this.$forwardForm.submit(function(b){var c;return c=!!a.$forwardForm.find("#forward_body").val()&&!!a.$forwardForm.find(".token_input li").length,c||b.stopImmediatePropagation(),c}),this.$forwardForm.formSubmit({disableWhileLoading:!0,success:function(b){return a.updatedConversation(b),a.$forwardForm.dialog("close")},error:function(b){return a.$forwardForm.dialog("close")}}),this.$messageList.click(function(b){var c;if(!$(b.target).closest("a.instructure_inline_media_comment, .mejs-container").length)return c=$(b.target).closest("#messages > ul > li"),c.hasClass("generated")||(c.toggleClass("selected"),c.find("> :checkbox").attr("checked",c.hasClass("selected"))),a.toggleMessageActions()})},k.prototype.initializeMenus=function(){var a=this;return $(".menus > li > a").click(function(b){return b.preventDefault(b),a.openMenu($(b.currentTarget))}).focus(function(b){return a.openMenu($(b.currentTarget))}),$(document).bind("mousedown",function(b){$(b.target).closest("#others_popup").length||a.$others.hide();if(!$(b.target).closest(".menus > li, #conversation_actions, #conversations .actions").length)return a.closeMenus()}),this.$menuViews=$("#menu_views"),this.$menuViewsList=this.$menuViews.parent(),this.$menuViewsList.find("li a").click(function(b){var c;a.closeMenus();if(c=$(b.target).closest("li").data("scope"))return b.preventDefault(),a.updateHashData({scope:c})}),$("#conversations ul, #create_message_form").on("click",".others",function(b){var c,d,e;return d=$(b.currentTarget),c=d.closest("li").offsetParent(),e=d.offsetFrom(c),a.$others.empty().append(d.find("> span").clone()).css({left:e.left,top:e.top+d.height()+c.scrollTop(),fontSize:d.css("fontSize")}),c.append(a.$others.show()),!1})},k.prototype.setScope=function(a){var b,c;return c=this.$menuViewsList.find("li"),c.removeClass("checked"),b=c.filter("[data-scope="+a+"]"),b.length||(b=c.filter("[data-scope=inbox]")),b.addClass("checked"),this.$menuViews.text(b.text())},k.prototype.initializeMessageActions=function(){var a=this;return $("#message_actions").find("a").click(function(a){return a.preventDefault()}),$("#cancel_bulk_message_action").click(function(){return a.toggleMessageActions(!1)}),$("#action_delete").click(function(b){var d,e,f;e=a.conversations.active();if(e==null)return;d=a.$messageList.find(".selected"),f=d.length>1?c.t("confirm.delete_messages","Are you sure you want to delete your copy of these messages? This action cannot be undone."):c.t("confirm.delete_message","Are you sure you want to delete your copy of this message? This action cannot be undone.");if(confirm(f))return d.fadeOut("fast"),a.conversations.action($(b.currentTarget),{conversationId:e.id,data:{remove:function(){var a,b,c;c=[];for(a=0,b=d.length;a<b;a++)f=d[a],c.push($(f).data("id"));return c}()},success:function(){return a.toggleMessageActions(!1)},error:function(){return d.show()}})}),$("#action_forward").click(function(b){var d;if(a.conversations.active()==null)return;return a.$forwardForm.find("input[name!=authenticity_token], textarea").val("").change(),d=a.$forwardForm.find("ul.messages").first(),d.html(""),d.html(a.$messageList.find("> li.selected.forwardable").clone(!0).removeAttr("id").removeClass("self")),d.find("> li").removeClass("selected odd").find("> :checkbox").attr("checked",!0).attr("name","forwarded_message_ids[]").val(function(){return $(this).closest("li").data("id")}),d.find("> li").last().addClass("last"),a.$forwardForm.css("max-height",$(window).height()-300+"px").dialog({position:"center",height:"auto",width:510,title:c.t("title.forward_messages","Forward Messages"),buttons:[{text:c.t("#buttons.cancel","Cancel"),click:function(){return $(this).dialog("close")}},{text:c.t("buttons.send_message","Send"),click:function(){return $(this).submit()},"class":"btn-primary"}],open:function(){return a.$forwardForm.attr({action:"/conversations?"+$.param(a.conversations.baseData())})},close:function(){return $("#forward_recipients").data("token_input").$input.blur()}})}),$("#action_compose_message").click(function(b){return b.preventDefault(),a.updateHashData({id:null})})},k.prototype.addRecipients=function(a){var b=this;if(this.conversations.active()==null)return;return this.$addForm.attr("action",a.prop("href")).dialog({width:420,title:c.t("title.add_recipients","Add Recipients"),buttons:[{text:c.t("buttons.add_people","Add People"),click:function(){return b.$addForm.submit()}},{text:c.t("#buttons.cancel","Cancel"),click:function(){return b.$addForm.dialog("close")}}],open:function(){var a;return a=$("#add_recipients").data("token_input"),a.baseExclude=b.conversations.active().get("audience"),b.$addForm.find("input[name!=authenticity_token]").val("").change()},close:function(){return $("#add_recipients").data("token_input").$input.blur()}})},k.prototype.initializeTokenInputs=function(a){var b,d,e,f=this;b=c.t("enrollments_everyone","Everyone"),e=c.t("select_all","Select All"),(a!=null?a:$(document)).find(".recipients").contextSearch({contexts:this.contexts,added:function(a,b,d){var e,g,h;a.id=""+a.id,d&&a.rootId&&b.append("<input type='hidden' name='tags[]' value='"+a.rootId+"'>"),d&&a.type&&(b.addClass(a.type),a.user_count!=null&&(b.addClass("details"),e=$("<span />"),e.text(c.t("people_count","person",{count:a.user_count})),b.append(e),b.data("user_count",a.user_count)));if(!a.id.match(/^(course|group)_/))return a=$.extend({},a),delete a.avatar_url,g=(h=f.userCache[a.id])!=null?h:{},f.userCache[a.id]=$.extend(g,a)},canToggle:function(a){var b;return a.type==="user"||((b=a.permissions)!=null?b.send_messages_all:void 0)},selector:{showToggles:!0,includeEveryoneOption:function(a,c){var d;if((d=a.context)!=null?d.match(/^(course|section)_\d+$/):void 0)return b},includeSelectAllOption:function(a,b){var c,d,f;if(((c=a.context)!=null?c.match(/^((course|section)_\d+_.*|group_\d+)$/):void 0)&&((d=a.context)!=null?!d.match(/^(course|section)_\d+$/):!void 0)&&((f=a.context)!=null?!f.match(/^course_\d+_(groups|sections)$/):!void 0)&&b.data("user_data").permissions.send_messages_all)return e},baseData:{permissions:["send_messages_all"]}}});if(a)return;return this.filterNameMap={},$("#context_tags").contextSearch({contexts:this.contexts,prefixUserIds:!0,added:function(a,b,c){return b.prevAll().remove()},tokenWrapBuffer:80,selector:{includeEveryoneOption:function(a,c){var d;if((d=a.context)!=null?d.match(/^course_\d+$/):void 0)return b},includeFilterOption:function(a){var b,d;if((b=a.context)!=null?b.match(/^course_\d+$/):void 0)return c.t("filter_by_course","Filter by this course");if((d=a.context)!=null?d.match(/^group_\d+$/):void 0)return c.t("filter_by_group","Filter by this group")},baseData:{synthetic_contexts:1,types:["course","user","group"],include_inactive:!0}}}),d=$("#context_tags").data("token_input"),d.change=function(a){var b,c;return b=function(){var a,b,e,f;e=d.tokenPairs(),f=[];for(a=0,b=e.length;a<b;a++)c=e[a],this.filterNameMap[c[0]]=c[1],f.push(c[0]);return f}.call(f),f.updateHashData({filter:b})}},k.prototype.initializeConversationsPane=function(){return this.conversations=new g(this,this.$conversations)},k.prototype.initializeMessageFormPane=function(){return this.formPane=new h(this,{folderId:this.options.FOLDER_ID})},k.prototype.addedMessageForm=function(a){return this.prepareTextareas(a.find("textarea")),this.initializeTokenInputs(a)},k.prototype.initializeAutoResize=function(){var a=this;return $(window).resize(function(){return a.resize(50)}),this.resize()},k.prototype.currentHashData=function(){var a,b;try{a=$.parseJSON($.decodeFromHex(location.hash.substring(1)))||{}}catch(c){b=c,a={}}return a},k.prototype.updateView=function(a){var b,c,d;a==null&&(a=!1),c=location.hash,b=this.currentHashData(),b.force=a;if(b.filter){b.filter=function(){var a,c,e,f;e=b.filter,f=[];for(a=0,c=e.length;a<c;a++)d=e[a],this.filterNameMap[d]&&f.push(d);return f}.call(this);if(!b.filter.length)return this.updateHashData({filter:null})}return this.setScope(b.scope),this.conversations.updateView(b)},k.prototype.initializeHashChange=function(){var a=this;return $(window).bind("hashchange",function(){return a.updateView()}).triggerHandler("hashchange")},k}()})}).call(this)