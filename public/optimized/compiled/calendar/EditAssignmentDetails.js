(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["jquery","compiled/calendar/commonEventFactory","jst/calendar/editAssignment","jst/calendar/editAssignmentOverride","jst/calendar/genericSelectOptions","jquery.instructure_date_and_time","jquery.instructure_forms","jquery.instructure_misc_helpers"],function(b,c,d,e,f){var g;return g=function(){function g(c,f,g,h){var i;this.event=f,this.contextChangeCB=g,this.closeCB=h,this.formSubmit=a(this.formSubmit,this),this.setupTimeAndDatePickers=a(this.setupTimeAndDatePickers,this),this.contextChange=a(this.contextChange,this),this.setContext=a(this.setContext,this),this.moreOptionsClick=a(this.moreOptionsClick,this),this.activate=a(this.activate,this),this.currentContextInfo=null,i=this.event.override?e:d,this.form=b(i({title:this.event.title,contexts:this.event.possibleContexts()})),b(c).append(this.form),this.setupTimeAndDatePickers(),this.form.submit(this.formSubmit),this.form.find(".more_options_link").click(this.moreOptionsClick),this.form.find("select.context_id").change(this.contextChange),this.form.find("select.context_id").triggerHandler("change",!1),this.event.isNewEvent()||(this.form.find(".context_select").hide(),this.form.attr("method","PUT"),this.form.attr("action",b.replaceTags(this.event.contextInfo.assignment_url,"id",this.event.object.id)))}return g.prototype.contextInfoForCode=function(a){var b,c,d,e;e=this.event.possibleContexts();for(c=0,d=e.length;c<d;c++){b=e[c];if(b.asset_string===a)return b}return null},g.prototype.activate=function(){var a;this.form.find("select.context_id").change();if((a=this.event.assignment)!=null?a.assignment_group_id:void 0)return this.form.find(".assignment_group_select .assignment_group").val(this.event.assignment.assignment_group_id)},g.prototype.moreOptionsClick=function(a){var c,d,e;return a.preventDefault(),e=b(a.target).attr("href").split("#"),c=this.form.getFormData({object_name:"assignment"}),d={},c.title&&(d.title=c.title),c.due_at&&(d.due_at=c.due_at),c.assignment_group_id&&(d.assignment_group_id=c.assignment_group_id),d.return_to=window.location.href,e[0]+="?"+b.param(d),window.location.href=e.join("#")},g.prototype.setContext=function(a){return this.form.find("select.context_id").val(a).triggerHandler("change",!1)},g.prototype.contextChange=function(a,c){var d,e,g;if(this.ignoreContextChange)return;e=b(a.target).val(),this.currentContextInfo=this.contextInfoForCode(e),this.event.contextInfo=this.currentContextInfo;if(this.currentContextInfo===null)return;return c!==!1&&this.contextChangeCB(e),d={collection:this.currentContextInfo.assignment_groups},this.form.find(".assignment_group").html(f(d)),this.form.attr("action",this.currentContextInfo.create_assignment_url),g=this.event.assignment?""+this.event.assignment.html_url+"/edit":this.currentContextInfo.new_assignment_url,this.form.find(".more_options_link").attr("href",g)},g.prototype.setupTimeAndDatePickers=function(){var a,b;this.form.find(".datetime_field").datetime_field(),b=this.event.startDate(),a=this.event.endDate();if(this.event.allDay)return this.form.find(".datetime_field").val(b.toString("MMM d, yyyy")).change();if(b)return this.form.find(".datetime_field").val(b.toString("MMM d, yyyy h:mmtt")).change()},g.prototype.formSubmit=function(a){var b;return a.preventDefault(),b=this.form.getFormData(),b["assignment[due_at]"]!=null?this.submitAssignment(b):this.submitOverride(b)},g.prototype.submitAssignment=function(a){var d,e,f,g,h;return e=a["assignment[due_at]"],e===""?d=null:d=this.form.find("#assignment_due_at").data("date"),h={"assignment[name]":this.form.find("#assignment_title").val(),"assignment[due_at]":d?b.dateToISO8601UTC(b.unfudgeDateForProfileTimezone(d)):"","assignment[assignment_group_id]":this.form.find(".assignment_group").val()},this.event.isNewEvent()?(g={assignment:{title:h["assignment[name]"],due_at:d?b.dateToISO8601UTC(d):null,context_code:this.form.find(".context_id").val()}},f=c(g,this.event.possibleContexts()),f.save(h)):(this.event.title=h["assignment[name]"],this.event.start=d,this.event.save(h)),this.closeCB()},g.prototype.submitOverride=function(a){var c,d;return c=a["assignment_override[due_at]"],c=c===""?null:this.form.find("#assignment_override_due_at").data("date"),d={"assignment_override[due_at]":c?b.dateToISO8601UTC(b.unfudgeDateForProfileTimezone(c)):""},this.event.start=c,this.event.save(d),this.closeCB()},g}()})}).call(this)