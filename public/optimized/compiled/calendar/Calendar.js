(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["i18n!calendar","jquery","underscore","compiled/userSettings","compiled/util/hsvToRgb","jst/calendar/calendarApp","compiled/calendar/EventDataSource","compiled/calendar/commonEventFactory","compiled/calendar/ShowEventDetailsDialog","compiled/calendar/EditEventDetailsDialog","compiled/calendar/Scheduler","compiled/calendar/CalendarDefaults","vendor/fullcalendar","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","vendor/jquery.ba-tinypubsub","jqueryui/button"],function(b,c,d,e,f,g,h,i,j,k,l,m){var n;return n=function(){function p(e,f,h,i,j){var k,n,o,p,q,r,s,t,u=this;this.contexts=f,this.manageContexts=h,this.dataSource=i,this.options=j,this.dataFromDocumentHash=a(this.dataFromDocumentHash,this),this.loadView=a(this.loadView,this),this.refetchEvents=a(this.refetchEvents,this),this.ajaxEnded=a(this.ajaxEnded,this),this.ajaxStarted=a(this.ajaxStarted,this),this.visibleContextListChanged=a(this.visibleContextListChanged,this),this.updateOverrides=a(this.updateOverrides,this),this.eventSaveFailed=a(this.eventSaveFailed,this),this.eventSaved=a(this.eventSaved,this),this.eventSaving=a(this.eventSaving,this),this.eventDeleted=a(this.eventDeleted,this),this.eventDeleting=a(this.eventDeleting,this),this.reloadClick=a(this.reloadClick,this),this.fragmentChange=a(this.fragmentChange,this),this.drop=a(this.drop,this),this.viewDisplay=a(this.viewDisplay,this),this.dayClick=a(this.dayClick,this),this.eventClick=a(this.eventClick,this),this.addEventClick=a(this.addEventClick,this),this.eventResize=a(this.eventResize,this),this.eventDrop=a(this.eventDrop,this),this.eventResizeStart=a(this.eventResizeStart,this),this.eventDragStart=a(this.eventDragStart,this),this.eventAfterRender=a(this.eventAfterRender,this),this.eventRender=a(this.eventRender,this),this.windowResize=a(this.windowResize,this),this.getEvents=a(this.getEvents,this),this.contextCodes=function(){var a,b,c;c=[];for(a=0,b=f.length;a<b;a++)k=f[a],c.push(k.asset_string);return c}(),this.visibleContextList=[],this.displayAppointmentEvents=null,this.activateEvent=(s=this.options)!=null?s.activateEvent:void 0,this.activeAjax=0,c.subscribe({"CommonEvent/eventDeleting":this.eventDeleting,"CommonEvent/eventDeleted":this.eventDeleted,"CommonEvent/eventSaving":this.eventSaving,"CommonEvent/eventSaved":this.eventSaved,"CommonEvent/eventSaveError":this.eventSaveFailed,"Calendar/visibleContextListChanged":this.visibleContextListChanged,"EventDataSource/ajaxStarted":this.ajaxStarted,"EventDataSource/ajaxEnded":this.ajaxEnded,"Calendar/refetchEvents":this.refetchEvents,"CommonEvent/assignmentSaved":this.updateOverrides}),r='\'<span class="agenda-col-wrapper">\n  <span class="day-num">\'d\'</span>\n  <span class="day-and-month">\n    <span class="day-name">\'dddd\'</span><br />\n    <span class="month-name">\'MMM\'</span>\n  </span>\n</span>\'',p=d.defaults({header:{left:"prev,today,next,title",center:"",right:""},editable:!0,columnFormat:{month:"dddd",week:r},buttonText:{today:b.t("today","Today")},defaultEventMinutes:60,slotMinutes:30,firstHour:7,droppable:!0,dropAccept:".undated_event",events:this.getEvents,eventRender:this.eventRender,eventAfterRender:this.eventAfterRender,eventDragStart:this.eventDragStart,eventDrop:this.eventDrop,eventClick:this.eventClick,eventResize:this.eventResize,eventResizeStart:this.eventResizeStart,dayClick:this.dayClick,addEventClick:this.addEventClick,titleFormat:{week:"MMM d[ yyyy]{ '&ndash;'[ MMM] d, yyyy}"},viewDisplay:this.viewDisplay,windowResize:this.windowResize,drop:this.drop},m),n=this.dataFromDocumentHash(),!n.view_start&&((t=this.options)!=null?t.viewStart:void 0)&&(n.view_start=this.options.viewStart,location.hash=c.encodeToHex(JSON.stringify(n))),n.view_start&&(o=c.fullCalendar.parseISO8601(n.view_start),o&&(p.year=o.getFullYear(),p.month=o.getMonth(),p.date=o.getDate())),this.el=c(e).html(g({calendar2Only:this.options.calendar2Only,showScheduler:this.options.showScheduler})),n.view_name==="week"&&(n.view_name="agendaWeek");if(n.view_name==="month"||n.view_name==="agendaWeek")q=n.view_name==="agendaWeek"?"week":"month",c("#"+q).click(),p.defaultView=n.view_name;n.show&&n.show!==""&&(this.visibleContextList=n.show.split(",")),this.calendar=this.el.find("div.calendar").fullCalendar(p),c(document).fragmentChange(this.fragmentChange),this.el.find("#calendar_views").buttonset().find("input").change(function(a){return u.loadView(c(a.target).attr("id"))}),this.$refresh_calendar_link=this.el.find("#refresh_calendar_link").click(this.reloadClick),this.$create_new_event_link=this.el.find("#create_new_event_link").click(this.addEventClick),this.colorizeContexts(),this.scheduler=new l(".scheduler-wrapper",this),this.options.showScheduler&&this.dataSource.getAppointmentGroups(!1,function(a){var b,c,d,e;c=0;for(d=0,e=a.length;d<e;d++)b=a[d],b.requiring_action&&(c+=1);return u.el.find("#calendar-header .counter-badge").toggle(c>0).text(c)}),window.setTimeout(function(){if(n.view_name==="scheduler"){c("#scheduler").click();if(n.appointment_group_id)return u.scheduler.viewCalendarForGroupId(n.appointment_group_id)}})}var h,n,o;return p.prototype.getEvents=function(a,b,d){var e,f=this;return e=function(a){var b,c,d,e,g,h,i;c={};if(a.length>0){for(d=g=h=a.length-1;h<=0?g<=0:g>=0;d=h<=0?++g:--g)b=a[d],e=!0,c[b.id]?e=!1:b.isAppointmentGroupEvent()&&(f.displayAppointmentEvents?f.displayAppointmentEvents.id===((i=b.calendarEvent)!=null?i.appointment_group_id:void 0)?e=!!b.calendarEvent.reserve_url:e=!b.calendarEvent.reserve_url:b.calendarEvent.reserve_url?b.calendarEvent.child_events_count>0&&!b.calendarEvent.reserved&&b.can_edit?e=!0:e=!1:e=!0),e||a.splice(d,1),c[b.id]=!0;return a}return a},this.dataSource.getEvents(c.unfudgeDateForProfileTimezone(a),c.unfudgeDateForProfileTimezone(b),this.visibleContextList,function(a){return f.displayAppointmentEvents?f.dataSource.getEventsForAppointmentGroup(f.displayAppointmentEvents,function(b){var c,f,g,h,i;for(f=0,h=a.length;f<h;f++)c=a[f],c.removeClass("current-appointment-group");for(g=0,i=b.length;g<i;g++)c=b[g],c.addClass("current-appointment-group");return d(e(a.concat(b)))}):d(e(a))})},p.prototype.closeEventPopups=function(){return c(".event-details").each(function(){var a;a=c(this).data("showEventDetailsDialog");if(a)return a.close()})},p.prototype.windowResize=function(a){return this.closeEventPopups()},p.prototype.eventRender=function(a,d,e){var f,g,h,i;return f=c(d),a.isAppointmentGroupEvent()&&this.displayAppointmentEvents&&this.displayAppointmentEvents.id===a.calendarEvent.appointment_group_id&&(h="Available",a.calendarEvent.available_slots>0&&(h=""+a.calendarEvent.available_slots+" Available"),a.calendarEvent.available_slots===0&&(h="Filled"),a.calendarEvent.reserved===!0&&(h="Reserved"),f.find(".fc-event-title").text(h)),i=!a.endDate()||a.startDate().getTime()===a.endDate().getTime()?this.calendar.fullCalendar("formatDate",a.startDate(),"h:mmtt"):this.calendar.fullCalendar("formatDates",a.startDate(),a.endDate(),"h:mmtt{ â€“ h:mmtt}"),g=a.eventType.match(/assignment/)?b.t("event_assignment_title","Assignment Title: "):b.t("event_event_title","Event Title: "),f.attr("title",c.trim(""+i+"\n"+f.find(".fc-event-title").text()+"\n\n"+b.t("calendar_title","Calendar:")+" "+a.contextInfo.name)),f.find(".fc-event-inner").prepend(c("<span class='screenreader-only'>"+b.t("calendar_title","Calendar:")+" "+a.contextInfo.name+"</span>")),f.find(".fc-event-title").prepend(c("<span class='screenreader-only'>"+g+"</span>")),!0},p.prototype.eventAfterRender=function(a,c,d){var e,f;a.isDueAtMidnight()&&c.find(".fc-event-time").html(this.calendar.fullCalendar("formatDate",a.startDate(),"h(:mm)t")),a.eventType.match(/assignment/)&&d.name==="agendaWeek"&&c.height("").find(".ui-resizable-handle").remove(),a.eventType.match(/assignment/)&&c.find(".fc-event-time").html(b.t("labels.due","due"));if(a.eventType==="calendar_event"&&((e=this.options)!=null?e.activateEvent:void 0)&&a.id==="calendar_event_"+((f=this.options)!=null?f.activateEvent:void 0))return this.options.activateEvent=null,this.eventClick(a,{currentTarget:c,pageX:c.offset().left+parseInt(c.width()/2)},d)},p.prototype.eventDragStart=function(a,b,c,d){return this.closeEventPopups()},p.prototype.eventResizeStart=function(a,b,c,d){return this.closeEventPopups()},p.prototype.eventDrop=function(a,b,c,d,e,f,g,h){var i;if(a.eventType==="assignment"&&d){e();return}return a.eventType==="assignment"&&a.isDueAtMidnight()&&c===0&&a.start.setMinutes(59),a.eventType==="calendar_event"&&d&&(a.allDay=!0),a.end&&a.endDate()&&(i=a.endDate().getTime()-a.startDate().getTime(),a.end=new Date(a.start.getTime()+i)),a.saveDates(null,e)},p.prototype.eventResize=function(a,b,c,d,e,f,g){return a.saveDates(null,d)},p.prototype.addEventClick=function(a,b,c){var f,g;if(this.displayAppointmentEvents)return;return g=e.get("checked_calendar_codes")||d.pluck(this.contexts,"asset_string"),f=d.filter(this.contexts,function(a){return d.contains(g,a.asset_string)}),a=i(null,f),(new k(a)).show()},p.prototype.eventClick=function(a,b,d){var e,f;e=c(b.currentTarget);if(!e.hasClass("event_pending"))return f=new j(a),e.data("showEventDetailsDialog",f),f.show(b)},p.prototype.dayClick=function(a,b,c,f){var g,h,j;if(this.displayAppointmentEvents)return;return h=e.get("checked_calendar_codes")||d.pluck(this.contexts,"asset_string"),g=d.filter(this.contexts,function(a){return d.contains(h,a.asset_string)}),j=i(null,g),j.allDay=b,j.date=a,(new k(j)).show()},p.prototype.updateFragment=function(a){var b,d,e;b=this.dataFromDocumentHash();for(d in a)e=a[d],b[d]=e;return location.replace("#"+c.encodeToHex(JSON.stringify(b)))},p.prototype.viewDisplay=function(a){return this.updateFragment({view_start:c.dateToISO8601UTC(a.start)})},p.prototype.drop=function(a,b,d,e){var f,g,h,i;g=c(e.helper).data("event-id"),f=c("[data-event-id="+g+"]").data("calendarEvent"),i=function(){return console.log("could not save date on undated event")};if(f){f.start=a,f.addClass("event_pending");if(f.eventType==="assignment"&&b){i();return}return f.eventType==="assignment"&&f.isDueAtMidnight()&&minuteDelta===0&&f.start.setMinutes(59),f.eventType==="calendar_event"&&b&&(f.allDay=!0),f.end&&f.endDate()&&(h=f.endDate().getTime()-f.startDate().getTime(),f.end=new Date(f.start.getTime()+h)),this.calendar.fullCalendar("renderEvent",f),f.saveDates(null,i)}},p.prototype.fragmentChange=function(a,b){var d,e,f,g;d=this.dataFromDocumentHash(),f=(g=this.calendar)!=null?g.fullCalendar("getView"):void 0;if(!f||!!c.isEmptyObject(d))return;(d.view_name==="month"||d.view_name==="agendaWeek")&&d.view_name!==f.name&&this.calendar.fullCalendar("changeView",d.view_name);if(d.view_start&&d.view_start!==c.dateToISO8601UTC(f.start)){e=c.fullCalendar.parseISO8601(d.view_start);if(e)return this.calendar.fullCalendar("gotoDate",e)}},p.prototype.reloadClick=function(a){a.preventDefault();if(this.activeAjax===0)return this.dataSource.clearCache(),this.currentView==="scheduler"&&this.scheduler.loadData(),this.calendar.fullCalendar("refetchEvents")},p.prototype.eventDeleting=function(a){return a.addClass("event_pending"),this.calendar.fullCalendar("updateEvent",a)},p.prototype.eventDeleted=function(a){return this.calendar.fullCalendar("removeEvents",a.id)},p.prototype.eventSaving=function(a){if(!a.start)return;return a.addClass("event_pending"),a.isNewEvent()?this.calendar.fullCalendar("renderEvent",a):this.calendar.fullCalendar("updateEvent",a)},p.prototype.eventSaved=function(a){return a.removeClass("event_pending"),delete a._id,this.calendar.fullCalendar("refetchEvents"),this.closeEventPopups()},p.prototype.eventSaveFailed=function(a){return a.removeClass("event_pending"),a.isNewEvent()?this.calendar.fullCalendar("removeEvents",a.id):this.calendar.fullCalendar("updateEvent",a)},p.prototype.updateOverrides=function(a){return d.each(this.dataSource.cache.contexts[a.contextCode()].events,function(b,c){if(c.match(/override/)&&a.assignment.id===b.assignment.id)return b.updateAssignmentTitle(a.title)})},p.prototype.visibleContextListChanged=function(a){return this.visibleContextList=a,this.calendar.fullCalendar("refetchEvents")},p.prototype.ajaxStarted=function(){return this.activeAjax+=1,this.$refresh_calendar_link.addClass("loading")},p.prototype.ajaxEnded=function(){this.activeAjax-=1;if(!this.activeAjax)return this.$refresh_calendar_link.removeClass("loading")},p.prototype.refetchEvents=function(){return this.calendar.fullCalendar("refetchEvents")},p.prototype.gotoDate=function(a){return this.calendar.fullCalendar("gotoDate",a)},p.prototype.loadView=function(a){return this.updateFragment({view_name:a}),a!=="scheduler"?(this.currentView=a,this.calendar.removeClass("scheduler-mode"),this.displayAppointmentEvents=null,this.scheduler.hide(),this.$create_new_event_link.show(),this.calendar.show(),this.calendar.fullCalendar("refetchEvents"),this.calendar.fullCalendar("changeView",a==="week"?"agendaWeek":"month")):(this.currentView="scheduler",this.calendar.addClass("scheduler-mode"),this.$create_new_event_link.hide(),this.calendar.hide(),this.scheduler.show())},h=c("<div />").appendTo("body"),o=[43,5,205,85,289,63,230,186,115,330],n=function(a,b,c){var d;return d=f(a,b,c),"rgb("+d.join(" ,")+")"},p.prototype.colorizeContexts=function(){var a,b,c,d,e,f,g,i,j,k,l,m,p;return l=[30,96],b=l[0],a=l[1],m=[60,40],k=m[0],j=m[1],p=[70,70],i=p[0],g=p[1],d=function(){var d,h,l,m;l=this.contextCodes,m=[];for(f=d=0,h=l.length;d<h;f=++d)c=l[f],e=o[f%o.length],m.push(".group_"+c+"{           color: "+n(e,k,j)+";           border-color: "+n(e,i,g)+";           background-color: "+n(e,b,a)+";        }");return m}.call(this),h.html("<style>"+d.join("")+"</style>")},p.prototype.dataFromDocumentHash=function(){var a,b;a={};try{a=c.parseJSON(c.decodeFromHex(location.hash.substring(1)))||{}}catch(d){b=d,a={}}return a},p}()})}).call(this)