(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["Backbone","underscore","i18n!discussions.reply","jquery","compiled/models/Entry","str/htmlEscape","jst/discussions/_reply_attachment","compiled/fn/preventDefault","tinymce.editor_box"],function(b,c,d,e,f,g,h,i){var j;return j=function(){function b(b,c){var d=this;this.view=b,this.options=c!=null?c:{},this.onPostReplyError=a(this.onPostReplyError,this),this.onPostReplySuccess=a(this.onPostReplySuccess,this),this.submit=a(this.submit,this),this.hideNotification=a(this.hideNotification,this),this.hide=a(this.hide,this),this.el=this.view.$(".discussion-reply-action:first"),this.discussionEntry=this.el.closest(".discussion_entry"),this.discussionEntry.length===0&&(this.discussionEntry=this.el.closest(".entry")),this.form=this.discussionEntry.find("form:first").submit(i(this.submit)),this.textArea=this.getEditingElement(),this.form.find(".cancel_button").click(this.hide),this.form.on("click",".toggle-wrapper a",function(a){return a.preventDefault(),d.textArea.editorBox("toggle")}),this.form.delegate(".alert .close","click",i(this.hideNotification)),this.editing=!1}return b.prototype.toggle=function(){return this.editing?this.hide():this.edit()},b.prototype.edit=function(){var a=this;return this.form.addClass("replying"),this.discussionEntry.addClass("replying"),this.textArea.editorBox({tinyOptions:{width:"100%"}}),this.options.focus&&setTimeout(function(){return a.textArea.editorBox("focus")},20),this.editing=!0,this.trigger("edit",this)},b.prototype.hide=function(){return this.content=this.textArea._justGetCode(),this.textArea._removeEditor(),this.form.removeClass("replying"),this.discussionEntry.removeClass("replying"),this.textArea.val(this.content),this.editing=!1,this.trigger("hide",this)},b.prototype.hideNotification=function(){return this.view.model.set("notification","")},b.prototype.submit=function(){var a;return this.hide(),this.textArea._setContentCode(""),this.view.model.set("notification","<div class='alert alert-info'>"+d.t("saving_reply","Saving reply...")+"</div>"),a=new f(this.getModelAttributes()),a.save(null,{success:this.onPostReplySuccess,error:this.onPostReplyError,multipart:a.get("attachment"),proxyAttachment:!0}),this.hide(),this.removeAttachments()},b.prototype.getEditingElement=function(){return this.view.$(".reply-textarea:first")},b.prototype.getModelAttributes=function(){var a;return a=(new Date).getTime(),{summary:e("<div/>").html(this.content).text(),message:this.content,parent_id:this.options.topLevel?null:this.view.model.get("id"),user_id:ENV.current_user_id,created_at:a,updated_at:a,attachment:this.form.find("input[type=file]")[0],"new":!0}},b.prototype.onPostReplySuccess=function(a){return this.view.model.set("notification",""),this.trigger("save",a)},b.prototype.onPostReplyError=function(a){return this.view.model.set("notification","<div class='alert alert-info'>"+d.t("error_saving_reply","*An error occured*, please post your reply again later",{wrapper:"<strong>$1</strong>"})+"</div>"),this.textArea.val(a.get("message")),this.edit()},b.prototype.addAttachment=function(a){return this.form.find("ul.discussion-reply-attachments").append(h()),this.form.find("a.discussion-reply-add-attachment").hide()},b.prototype.removeAttachment=function(a){return a.closest("ul.discussion-reply-attachments li").remove(),this.form.find("a.discussion-reply-add-attachment").show()},b.prototype.removeAttachments=function(){return this.form.find("ul.discussion-reply-attachments").empty(),this.form.find("a.discussion-reply-add-attachment").show()},b}(),c.extend(j.prototype,b.Events),j})}).call(this)