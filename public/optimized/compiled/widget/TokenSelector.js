(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["jquery","underscore","compiled/widget/TokenSelectorList","compiled/collections/RecipientCollection","jquery.instructure_misc_helpers","compiled/jquery/scrollIntoView"],function(b,c,d,e){return function(){function f(c,d,e){var f=this;this.input=c,this.url=d,this.options=e!=null?e:{},this.select=a(this.select,this),this.close=a(this.close,this),this.click=a(this.click,this),this.mouseDown=a(this.mouseDown,this),this.mouseMove=a(this.mouseMove,this),this.autoSelectFirst=a(this.autoSelectFirst,this),this.stack=[],this.cache={},this.$container=b("<div />").addClass("autocomplete_menu"),this.$menu=b("<div />"),this.$container.append(b("<div />").append(this.$menu)),this.$container.css("top",0).css("left",0),this.mode="input",b("body").append(this.$container),this.reposition=function(){var a;return a=f.input.bottomOffset(),f.$container.css("top",a.top),f.$container.css("left",a.left)},b(window).resize(this.reposition),this.close()}return f.prototype.autoSelectFirst=function(a){a==null&&(a=this.list);if(a===this.list&&this.selection==null)return this.select(a.first(),!0)},f.prototype.browse=function(a){if(this.uiLocked)return;return this.clear(),this.close(),this.open(),this.list=this.listForQuery(this.preparePost(a)),this.list.appendTo(this.$menu),this.autoSelectFirst(),!0},f.prototype.mouseMove=function(a){var c;if(this.uiLocked)return;return c=b(a.target).closest("li"),c.hasClass("selectable")||(c=null),this.select(c)},f.prototype.mouseDown=function(a){var b=this;return setTimeout(function(){return b.input.focus()},0)},f.prototype.click=function(a){if(this.uiLocked)return;return this.mouseMove(a),this.selection&&(b(a.target).closest("a.expand").length?this.selectionExpanded()?this.collapse():this.expandSelection():this.selectionToggleable()&&b(a.target).closest("a.toggle").length?this.toggleSelection():this.selectionExpanded()?this.collapse():this.selectionExpandable()?this.expandSelection():(this.toggleSelection(!0),this.clear(),this.close())),this.input.focus()},f.prototype.captureKeyDown=function(a){var b,d,e;b=(d=(e=a.originalEvent)!=null?e.keyIdentifier:void 0)!=null?d:a.which;if(this.uiLocked)return!0;if(this.$menu.find(".no-results").length>0&&c.include([13,"Enter"],b))return a.preventDefault();switch(b){case"Backspace":case"U+0008":case 8:if(this.input.val()==="")return this.listExpanded()?this.collapse():this.$menu.is(":visible")?this.close():this.input.removeLastToken(),!0;break;case"Tab":case"U+0009":case 9:this.selection&&(this.selectionToggleable()||!this.selectionExpandable())&&this.toggleSelection(!0),this.clear(),this.close();if(this.selection)return!0;break;case"Enter":case 13:if(this.selectionExpanded())return this.collapse(),!0;if(this.selectionExpandable()&&!this.selectionToggleable())return this.expandSelection(),!0;return this.selection&&(this.toggleSelection(!0),this.clear()),this.close(),!0;case"Shift":case 16:return!1;case"Esc":case"U+001B":case 27:return this.$menu.is(":visible")?(this.close(),!0):!1;case"U+0020":case 32:if(this.selectionToggleable()&&this.mode==="menu")return this.toggleSelection(),!0;break;case"Left":case 37:if(this.listExpanded()&&this.input.caret()===0)return this.selectionExpanded()||this.input.val()===""?this.collapse():this.select(this.list.first()),!0;break;case"Up":case 38:return this.selectPrev(),!0;case"Right":case 39:if(this.input.caret()===this.input.val().length&&this.expandSelection())return!0;break;case"Down":case 40:return this.selectNext(),!0;case"U+002B":case 187:case 107:if(this.selectionToggleable()&&this.mode==="menu")return this.toggleSelection(!0),!0;break;case"U+002D":case 189:case 109:if(this.selectionToggleable()&&this.mode==="menu")return this.toggleSelection(!1),!0}return this.mode="input",this.updateSearch(),!1},f.prototype.open=function(){return this.$container.show(),this.reposition()},f.prototype.close=function(){var a,b,c,d,e,f,g,h;this.uiLocked=!1,this.$container.hide(),(f=this.list)!=null&&f.remove(),g=this.stack;for(b=d=0,e=g.length;d<e;b=++d)h=g[b],a=h[0],c=h[1],c.remove();return this.list=null,this.stack=[],this.$menu.css("left",0),this.select(null),this.input.selectorClosed()},f.prototype.clear=function(){return clearTimeout(this.timeout),this.input.val(""),this.select(null)},f.prototype.blur=function(){var a=this;return setTimeout(function(){if(!(a.input.hasFocus()||a.$container.find(":focus").length>0))return a.close()},0)},f.prototype.listExpanded=function(){return this.stack.length?!0:!1},f.prototype.parent=function(){return this.listExpanded()?this.stack[this.stack.length-1][0]:null},f.prototype.selectionExpanded=function(){var a,b;return(a=(b=this.selection)!=null?b.hasClass("expanded"):void 0)!=null?a:!1},f.prototype.selectionExpandable=function(){var a,b;return(a=(b=this.selection)!=null?b.hasClass("expandable"):void 0)!=null?a:!1},f.prototype.selectionToggleable=function(a){var b;return a==null&&(a=this.selection),((b=a!=null?a.hasClass("toggleable"):void 0)!=null?b:!1)&&!this.selectionExpanded()},f.prototype.expandSelection=function(){var a,b=this;return!this.selectionExpandable()||!!this.selectionExpanded()?!1:(this.stack.push([this.selection,this.list]),this.clear(),this.$menu.css("width",(this.stack.length+1)*100+"%"),this.uiLocked=!0,a=this.listForQuery(this.preparePost()),a.insertAfter(this.list),this.$menu.animate({left:"-="+this.$menu.parent().css("width")},"fast",function(){return b.list.hide(function(){return b.list=a,b.autoSelectFirst(),b.uiLocked=!1})}))},f.prototype.collapse=function(){var a,b,c,d=this;return this.listExpanded()?(c=this.stack.pop(),a=c[0],b=c[1],this.uiLocked=!0,b.restore(),this.$menu.animate({left:"+="+this.$menu.parent().css("width")},"fast",function(){return d.list.remove(),d.list=b,d.input.val(d.list.query.search),d.select(a),d.uiLocked=!1})):!1},f.prototype.toggleSelection=function(a,b,c){var d,e;b==null&&(b=this.selection),c==null&&(c=!1);if(a==null&&!this.selectionToggleable(b))return!1;d=b.data("id"),a==null&&(a=!b.hasClass("on")),a?(this.selectionToggleable(b)&&!c&&b.addClass("on"),this.input.addToken({value:d,text:(e=b.data("text"))!=null?e:b.text(),noClear:!0,data:b.data("user_data")})):(c||b.removeClass("on"),this.input.removeToken({value:d}));if(!c)return this.updateSelectAll(b)},f.prototype.updateSelectAll=function(a,b){var c,d,e,f=this;b==null&&(b=0),e=a.data("user_data").selectAll,d=b?this.stack[this.stack.length-b][1]:this.list;if(!d.canSelectAll())return;d.updateSelectAll(e,function(a,b){return f.toggleSelection(a,b,!0)});if(b<this.stack.length){b++,c=this.stack[this.stack.length-b][0];if(this.selectionToggleable(c))return d.selectAllActive()?c.addClass("on"):c.removeClass("on"),this.updateSelectAll(c,b)}},f.prototype.select=function(a,b){var c;b==null&&(b=!1);if((a!=null?a[0]:void 0)===((c=this.selection)!=null?c[0]:void 0))return;this.selection=(a!=null?a.length:void 0)?(a.focus(),a.scrollIntoView({ignore:{border:!0}}),a):null;if(!b)return this.mode=a?"menu":"input"},f.prototype.selectNext=function(a){var b;a==null&&(a=!1),this.select(this.selection?this.selection.next().length?this.selection.next():this.selection.parent("ul").next().length?this.selection.parent("ul").next().find("li").first():null:this.list.first(),a);if((b=this.selection)!=null?b.hasClass("message"):void 0)return this.selectNext(a)},f.prototype.selectPrev=function(){var a,b;this.select(this.selection?((a=this.selection)!=null?a.prev().length:void 0)?this.selection.prev():this.selection.parent("ul").prev().length?this.selection.parent("ul").prev().find("li").last():null:this.list.last());if((b=this.selection)!=null?b.hasClass("message"):void 0)return this.selectPrev()},f.prototype.updateSearch=function(){var a=this;return clearTimeout(this.timeout),this.select(null),this.timeout=setTimeout(function(){var b;b=a.listForQuery(a.preparePost());if(b!==a.list){if(b.query.search!==""||!!a.listExpanded())return a.list?(b.insertAfter(a.list),a.list.remove()):(a.open(),b.appendTo(a.$menu)),a.list=b,a.autoSelectFirst();if(a.$menu.is(":visible"))return a.close()}},100)},f.prototype.preparePost=function(a){var c,d,e;return c=b.extend({},(d=this.options.baseData)!=null?d:{},a!=null?a:{},{search:this.input.val().replace(/^\s+|\s+$/g,"")}),(e=c.exclude)==null&&(c.exclude=[]),c.exclude=c.exclude.concat(this.input.baseExclude),this.listExpanded()?c.context=this.parent().data("id"):c.exclude=c.exclude.concat(this.input.tokenValues()),c},f.prototype.collectionForQuery=function(a){var b,c;return b=JSON.stringify(a),this.cache[b]==null&&(c=new e,c.url=this.url,c.fetch({data:a}),this.cache[b]=c),this.cache[b]},f.prototype.listForQuery=function(a){var b,e,f,g=this;return e=this.collectionForQuery(a),f=new d({selector:this,parent:this.parent(),ancestors:function(){var a,c,d,e;d=this.stack,e=[];for(a=0,c=d.length;a<c;a++)b=d[a],e.push(b[0].data("id"));return e}.call(this),collection:e,query:a}),f.render(),e.atLeastOnePageFetched||e.on("fetch",c.once(function(){return g.autoSelectFirst(f)})),f},f.prototype.teardown=function(){return this.$container.remove()},f}()})}).call(this)