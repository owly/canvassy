(function(){define(["underscore"],function(a){var b,c;return c=function(b,c){var d,e;return e=[],d=[],a(b).each(function(a){return(c(a)?e:d).push(a)}),[e,d]},b=function(){function b(){}return b.calculate=function(b,c,d){var e,f=this;return e={},e.group_sums=a(c).map(function(a){return{group:a,current:f.create_group_sum(a,b,!0),"final":f.create_group_sum(a,b,!1)}}),e.current=this.calculate_total(e.group_sums,!0,d),e["final"]=this.calculate_total(e.group_sums,!1,d),e},b.create_group_sum=function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=this;return e=function(a,b){var c,d,e,f;d={};for(e=0,f=a.length;e<f;e++)c=a[e],d[c[b]]=c;return d},h=a(b.assignments).filter(function(b){return!a.isEqual(b.submission_types,["not_graded"])}),f=e(h,"id"),c=a(c).filter(function(a){return f[a.assignment_id]!=null}),d||(o=a(c).map(function(a){return a.assignment_id.toString()}),j=a.difference(a.keys(f),o),g=a(j).map(function(a){var b;return b={assignment_id:a,score:null}}),c.push.apply(c,g)),q=e(c,"assignment_id"),p=a(c).map(function(a){var b;return b={total:s.parse(f[a.assignment_id].points_possible),score:s.parse(a.score),submitted:a.score!=null&&a.score!=="",submission:a}}),l=d?a(p).filter(function(a){return a.submitted}):p,i=this.dropAssignments(l,b.rules),r=a.reduce(i,function(a,b){var c,d,e,f;return d=a[0],f=a[1],c=b.score,e=b.total,[d+s.parse(c),f+e]},[0,0]),n=r[0],k=r[1],m={possible:k,score:n,submission_count:a(p).filter(function(a){return a.submitted}).length,submissions:a(p).map(function(a){var b;return b={drop:a.drop,percent:s.parse(a.score/a.total),possible:a.total,score:s.parse(a.score),submission:a.submission,submitted:a.submitted}})}},b.dropAssignments=function(b,d){var e,f,g,h,i,j,k,l,m,n,o,p,q;d||(d={}),g=d.drop_lowest||0,f=d.drop_highest||0,m=d.never_drop||[];if(!g&&!f)return b;m.length>0?(q=c(b,function(b){return a.indexOf(m,parseInt(b.submission.assignment_id))>=0}),e=q[0],b=q[1]):e=[];if(b.length===0)return e;g>=b.length&&(g=b.length-1),g+f>=b.length&&(f=0),j=b.length-g,k=j-f,b.sort(function(a,b){return a.submission.assignment_id-b.submission.assignment_id}),i=function(){var a,c,d;d=[];for(a=0,c=b.length;a<c;a++)n=b[a],n.total>0&&d.push(n.total);return d}().length>0,l=i?this.dropPointed(b,e,j,k):this.dropUnpointed(b,j,k),l.push.apply(l,e),h=a.difference(b,l);for(o=0,p=h.length;o<p;o++)n=h[o],n.drop=!0;return l},b.dropUnpointed=function(b,c,d){var e;return e=b.sort(function(a,b){return a.score-b.score}),a.chain(e).last(c).first(d).value()},b.dropPointed=function(b,d,e,f){var g,h,i,j,k,l=this;return k=function(){var a,c,d;d=[];for(a=0,c=b.length;a<c;a++)j=b[a],d.push(j.total);return d}(),i=Math.max.apply(Math,k),g=function(b,e,f){var g,h,k,m,n,o,p,q,r,t,u,v,w,x;e<=0&&(e=1);if(b.length<=e)return b;g=b.concat(d),v=c(g,function(a){return a.total===0}),t=v[0],n=v[1],k=function(){var a,b,c;c=[];for(a=0,b=n.length;a<b;a++)j=n[a],c.push(j.score/j.total);return c}().sort(function(a,b){return a-b}),o=l.estimateQHigh(n,t,k),p=k[0],q=(p+o)/2,h=function(b,c){var g,h,i,k,l,m,n;return n=a(c).map(function(a){var c;return c=a.score-b*a.total,[c,a]}),l=n.sort(f),g=l.slice(0,e),k=a.reduce(g,function(a,b){var c,d;return c=b[0],d=b[1],a+c},0),h=function(){var a,b,c,d;d=[];for(a=0,b=g.length;a<b;a++)c=g[a],m=c[0],j=c[1],d.push(j);return d}(),i=a.reduce(d,function(a,c){return a+c.score-b*c.total},0),[k+i,h]},w=h(q,b),u=w[0],m=w[1],r=1/(2*e*Math.pow(i,2));while(!(o-p<r)){u<0?o=q:p=q,q=(p+o)/2;if(q===o||q===p)break;x=h(q,b),u=x[0],m=x[1]}return m},h=g(b,e,function(a,b){var c,d,e,f;return c=a[0],e=a[1],d=b[0],f=b[1],d-c}),h=g(h,f,function(a,b){var c,d,e,f;return c=a[0],e=a[1],d=b[0],f=b[1],c-d})},b.estimateQHigh=function(b,c,d){var e,f,g,h,i;return c.length>0?(g=a(b).reduce(function(a,b){return a+b.total},0),e=Math.max(g,a(b).reduce(function(a,b){return a+b.score},0)),i=a(c).reduce(function(a,b){return a+b.score},0),f=e+i,f/g):h=d[d.length-1]},b.calculate_total=function(b,c,d){var e,f,g,h,i,j,k,l;return e=c?"current":"final",b=a(b).map(function(a){return a[e].weight=a.group.group_weight,a[e]}),d==="percent"?(i=a(b).filter(function(a){return a.possible}),f=a.reduce(i,function(a,b){return a+b.score/b.possible*b.weight},0),g=a.reduce(i,function(a,b){var c;return c=b.weight,a+c},0),g===0?f=null:g<100&&(f*=100/g),j={score:f&&Math.round(f*10)/10,possible:100}):(l=a.reduce(b,function(a,b){var c,d,e,f;return c=a[0],d=a[1],f=b.score,e=b.possible,[c+f,d+e]},[0,0]),k=l[0],h=l[1],j={score:k,possible:h})},b.parse=function(a){var b;return b=parseFloat(a),b&&isFinite(b)?b:0},b.letter_grade=function(b,c){var d,e;return c<0&&(c=0),e=a(b).filter(function(a,d){return c>=a[1]*100||d===b.length-1}),d=e[0],d[0]},b}()})}).call(this)