(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a},d=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};define(["i18n!discussions","jquery","underscore","Backbone","compiled/util/BackoffPoller","compiled/arr/walk","compiled/arr/erase","jquery.ajaxJSON"],function(b,e,f,g,h,i,j){var k,l,m,n;return m=f.each,l={avatar_image_url:null,display_name:b.t("uknown_author","Unknown Author"),id:null},k=function(b){function f(){return this.parseNewEntry=a(this.parseNewEntry,this),this.parseEntry=a(this.parseEntry,this),n=f.__super__.constructor.apply(this,arguments),n}return c(f,b),f.prototype.defaults={view:[],entries:[],new_entries:[],unread_entries:[],forced_entries:[]},f.prototype.url=function(){return""+this.get("root_url")+"?include_new_entries=1"},f.prototype.fetch=function(a){var b,c=this;return a==null&&(a={}),b=new h(this.url(),function(b,d){return d.status===503?"continue":d.status!==200?"abort":(c.set(c.parse(b,200,d)),typeof a.success=="function"&&a.success(c,b),"stop")},{handleErrors:!0,initialDelay:!1,baseInterval:2e3,maxAttempts:12,backoffFactor:1.6}),b.start()},f.prototype.markAllAsRead=function(){return e.ajaxJSON(ENV.DISCUSSION.MARK_ALL_READ_URL,"PUT",{forced_read_state:!1}),this.setAllReadState("read")},f.prototype.markAllAsUnread=function(){return e.ajaxJSON(ENV.DISCUSSION.MARK_ALL_UNREAD_URL,"DELETE",{forced_read_state:!1}),this.setAllReadState("unread")},f.prototype.setAllReadState=function(a){return m(this.flattened,function(b){return b.read_state=a})},f.prototype.parse=function(a,b,c){return this.data=a,this.data.entries=[],this.flattened={},this.lastRoot=null,this.participants={},this.flattenParticipants(),i(this.data.view,"replies",this.parseEntry),m(this.data.new_entries,this.parseNewEntry),delete this.lastRoot,this.data},f.prototype.flattenParticipants=function(){var a,b,c,d,e;d=this.data.participants,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(this.participants[a.id]=a);return e},f.prototype.setEntryAuthor=function(a){return a.user_id!=null?a.author=this.participants[a.user_id]:a.author=l},f.prototype.parseEntry=function(a){var b,c,e;this.flattened[a.id]=a,b=this.flattened[a.parent_id],a.parent=b;if(c=a.id,d.call(this.data.unread_entries,c)>=0)a.read_state="unread";if(e=a.id,d.call(this.data.forced_entries,e)>=0)a.forced_read_state=!0;return this.setEntryAuthor(a),a.editor_id!=null&&(a.editor=this.participants[a.editor_id]),a.parent_id!=null?(a.root_entry=this.lastRoot,a.root_entry_id=this.lastRoot.id):(this.lastRoot=a,this.data.entries.push(a)),a},f.prototype.parseNewEntry=function(a){var b,c;this.flattened[a.id]=a,b=this.flattened[a.parent_id],this.setEntryAuthor(a);if(b!=null){((c=b.replies)!=null?c:b.replies=[]).push(a),a.parent=b;while(b.parent)b=b.parent;return a.root_entry=b,a.root_entry_id=b.id}return this.data.entries.push(a)},f.prototype.maybeRemove=function(a){var b;if(a.deleted&&!a.replies)return((b=a.parent)!=null?b.replies:void 0)!=null&&j(a.parent.replies,a),delete this.flattened[a.id]},f}(g.Model)})}).call(this)