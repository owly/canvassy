(function(){var a={}.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};define(["i18n!discussions","jquery","underscore","Backbone","jquery.ajaxJSON"],function(a,c,d,e){var f,g;return f=function(f){function h(){return g=h.__super__.constructor.apply(this,arguments),g}return b(h,f),h.prototype.defaults={id:null,parent_id:null,message:a.t("no_content","No Content"),user_id:null,read_state:"read",forced_read_state:!1,created_at:null,updated_at:null,deleted:!1,attachment:null,replies:[],canAttach:ENV.DISCUSSION.PERMISSIONS.CAN_ATTACH,"new":!1,highlight:!1},h.prototype.computedAttributes=["canModerate","canReply","speedgraderUrl","inlineReplyLink",{name:"allowsSideComments",deps:["parent_id","deleted"]},{name:"allowsThreadedReplies",deps:["deleted"]},{name:"showBoxReplyLink",deps:["allowsSideComments"]},{name:"collapsable",deps:["replies","allowsSideComments","allowsThreadedReplies"]},{name:"summary",deps:["message"]}],h.prototype.read=function(){return""+ENV.DISCUSSION.ENTRY_ROOT_URL+"?ids[]="+this.get("id")},h.prototype.create=function(){var a;return this.set("author",ENV.DISCUSSION.CURRENT_USER),a=this.get("parent_id"),a===null?ENV.DISCUSSION.ROOT_REPLY_URL:ENV.DISCUSSION.REPLY_URL.replace(/:entry_id/,a)},h.prototype["delete"]=function(){return ENV.DISCUSSION.DELETE_URL.replace(/:id/,this.get("id"))},h.prototype.update=function(){return ENV.DISCUSSION.DELETE_URL.replace(/:id/,this.get("id"))},h.prototype.sync=function(a,b,c){return c==null&&(c={}),c.url=this[a](),e.sync(a,this,c)},h.prototype.parse=function(a){return d.isArray(a)?a[0]:a},h.prototype.toJSON=function(){var a;return a=h.__super__.toJSON.apply(this,arguments),d.pick(a,"id","parent_id","message","user_id","read_state","forced_read_state","created_at","updated_at","deleted","attachment","replies","author")},h.prototype.canModerate=function(){var a;return a=this.get("user_id")===ENV.DISCUSSION.CURRENT_USER.id,a&&ENV.DISCUSSION.PERMISSIONS.CAN_MANAGE_OWN||ENV.DISCUSSION.PERMISSIONS.MODERATE},h.prototype.canReply=function(){return this.get("deleted")?!1:ENV.DISCUSSION.PERMISSIONS.CAN_REPLY?!0:!1},h.prototype.inlineReplyLink=function(){return ENV.DISCUSSION.THREADED&&(this.allowsThreadedReplies()||this.allowsSideComments())?!0:!1},h.prototype.allowsThreadedReplies=function(){return this.get("deleted")?!1:ENV.DISCUSSION.PERMISSIONS.CAN_REPLY?ENV.DISCUSSION.THREADED?!0:!1:!1},h.prototype.allowsSideComments=function(){return this.get("deleted")?!1:ENV.DISCUSSION.PERMISSIONS.CAN_REPLY?ENV.DISCUSSION.THREADED?!1:this.get("parent_id")?!1:!0:!1},h.prototype.showBoxReplyLink=function(){return this.allowsSideComments()},h.prototype.collapsable=function(){return this.hasChildren()||this.allowsSideComments()||this.allowsThreadedReplies()},h.prototype.speedgraderUrl=function(){if(ENV.DISCUSSION.SPEEDGRADER_URL_TEMPLATE)return ENV.DISCUSSION.SPEEDGRADER_URL_TEMPLATE.replace(/%22%3Astudent_id%22/,this.get("user_id"))},h.prototype.summary=function(){return this.escapeDiv||(this.escapeDiv=c("<div/>")),this.escapeDiv.html(this.get("message")).text()},h.prototype.markAsRead=function(){var a;return this.set("read_state","read"),a=ENV.DISCUSSION.MARK_READ_URL.replace(/:id/,this.get("id")),c.ajaxJSON(a,"PUT")},h.prototype.markAsUnread=function(){var a;return this.set({read_state:"unread",forced_read_state:!0}),a=ENV.DISCUSSION.MARK_UNREAD_URL.replace(/:id/,this.get("id")),c.ajaxJSON(a,"DELETE",{forced_read_state:!0})},h.prototype.hasChildren=function(){return this.get("replies").length>0},h}(e.Model)})}).call(this)