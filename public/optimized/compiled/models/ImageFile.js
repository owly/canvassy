(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a},d=[].slice;define(["i18n!images","underscore","compiled/models/File","use!vendor/FileAPI/FileAPI.min"],function(b,e,f,g){var h,i;return h=function(f){function h(){return this.present=a(this.present,this),this.save=a(this.save,this),i=h.__super__.constructor.apply(this,arguments),i}return c(h,f),h.prototype.initialize=function(a,b){var c;return a==null&&(a={}),b==null&&(b={}),this.validations={maxSize:32e3,width:100,height:100,types:["jpeg","png","gif"]},e.extend(this.validations,(c=b.validations)!=null?c:{}),h.__super__.initialize.apply(this,arguments)},h.prototype.loadFile=function(){var a,b,c=this;this.valid=!1,b=g.getFiles(this.get("file"))[0];if(!b)return;return a=$.Deferred(),g.filterFiles([b],function(b,d){return c.validateFile(b,d,a)},function(){}),a.then(function(){var a;return a=1<=arguments.length?d.call(arguments,0):[],c.trigger.apply(c,["loaded"].concat(d.call(a)))},function(a){return c.error=a,c.trigger("load_failed",a)})},h.prototype.validateFile=function(a,c,d){var e;return e=a.type.replace(/^image\//,""),a.type===e?d.reject(b.t("not_an_image","Selected file is not an image")):this.validations.types!=null&&this.validations.types.indexOf(e)<0?d.reject(b.t("invalid_file_type","Invalid file type %{type}. Allowed types include: %{type_list}",{type:e,type_list:this.validations.types.join(", ")})):this.validations.width==null||this.validations.height==null||c.width===this.validations.width&&c.height===this.validations.height?this.validations.maxSize&&a.size>this.validations.maxSize?d.reject(b.t("invalid_file_size","Image file size is too large (max %{max} bytes, got %{actual})",{actual:a.size,max:this.validations.maxSize})):this.validations.backgroundColor?this.validateBackground(a,c,d):(this.valid=!0,d.resolve(a,c)):d.reject(b.t("invalid_dimensions","Invalid image dimensions (got %{actual}, expected: %{expected})",{actual:""+c.width+"x"+c.height,expected:""+this.validations.width+"x"+this.validations.height}))},h.prototype.validateBackground=function(a,c,d){var f=this;return g.Image(a).preview(a.width,a.height).get(function(g,h){return g?d.reject(b.t("error_checking_color","Error checking image color")):e.any(f.cornerColors(h),function(a){return a!==f.validations.backgroundColor})?d.reject(b.t("invalid_background_color","Background color must be %{color}",{color:f.validations.backgroundColor})):(f.valid=!0,d.resolve(a,c))})},h.prototype.cornerColors=function(a){var b;return b=a.getContext("2d"),[this.rgbToHex.apply(this,b.getImageData(0,0,1,1).data),this.rgbToHex.apply(this,b.getImageData(a.width-1,0,1,1).data),this.rgbToHex.apply(this,b.getImageData(a.width-1,a.height-1,1,1).data),this.rgbToHex.apply(this,b.getImageData(0,a.height-1,1,1).data)]},h.prototype.toHex=function(a){var b;return b=a.toString(16),b.length===1&&(b="0"+b),b},h.prototype.rgbToHex=function(a,b,c){return"#"+this.toHex(a)+this.toHex(b)+this.toHex(c)},h.prototype.save=function(){return this.valid!=null?this.valid?h.__super__.save.apply(this,arguments):!1:this.load().then(this.save)},h.prototype.present=function(){return e.extend(h.__super__.present.apply(this,arguments),this.validations,{error:this.error,valid:this.valid})},h}(f)})}).call(this)