(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["i18n!editor","jquery","underscore","str/htmlEscape","compiled/fn/preventDefault","compiled/views/DialogBaseView","jst/tinymce/InsertUpdateImageView"],function(b,d,e,f,g,h,i){var j,k;return j=function(f){function g(){return this.update=a(this.update,this),this.onFileLinkDblclick=a(this.onFileLinkDblclick,this),this.constrainProportions=a(this.constrainProportions,this),k=g.__super__.constructor.apply(this,arguments),k}return c(g,f),g.prototype.template=i,g.prototype.events={'change [name="image[width]"]':"constrainProportions",'change [name="image[height]"]':"constrainProportions","click .flickrImageResult, .treeFile":"onFileLinkClick",'change [name="image[src]"]':"onImageUrlChange","tabsshow .imageSourceTabs":"onTabsshow","dblclick .flickrImageResult, .treeFile":"onFileLinkDblclick"},g.prototype.dialogOptions={width:625,title:b.t("titles.insert_edit_image","Insert / Edit Image")},g.prototype.initialize=function(a,b){this.editor=a,this.$editor=d("#"+this.editor.id),this.prevSelection=this.editor.selection.getBookmark(),this.$selectedNode=d(b),g.__super__.initialize.apply(this,arguments),this.render(),this.show();if(this.$selectedNode.prop("nodeName")==="IMG")return this.setSelectedImage({src:this.$selectedNode.attr("src"),alt:this.$selectedNode.attr("alt"),width:this.$selectedNode.width(),height:this.$selectedNode.height()})},g.prototype.afterRender=function(){return this.$(".imageSourceTabs").tabs()},g.prototype.onTabsshow=function(a,b){var c,f=this;c=function(a){var c;if(f[""+b.panel.id+"IsLoaded"])return;return f[""+b.panel.id+"IsLoaded"]=!0,c=d.Deferred(),d(b.panel).disableWhileLoading(c),a(c.resolve)};switch(b.panel.id){case"tabUploaded":return c(function(a){return require(["compiled/views/FileBrowserView","compiled/util/mimeClass"],function(c,d){var f;return f=e.compact(e.map(d.mimeClasses,function(a,b){if(a==="image")return b})),(new c({contentTypes:f})).render().$el.appendTo(b.panel),a()})});case"tabFlickr":return c(function(a){return require(["compiled/views/FindFlickrImageView"],function(c){return(new c).render().$el.appendTo(b.panel),a()})})}},g.prototype.setAspectRatio=function(){var a,b;return b=Number(this.$("[name='image[width]']").val()),a=Number(this.$("[name='image[height]']").val()),b&&a?this.aspectRatio=b/a:delete this.aspectRatio},g.prototype.constrainProportions=function(a){var b;b=Number(d(a.target).val());if(this.aspectRatio&&(b||b===0))return d(a.target).is('[name="image[height]"]')?this.$('[name="image[width]"]').val(Math.round(b*this.aspectRatio)):this.$('[name="image[height]"]').val(Math.round(b/this.aspectRatio))},g.prototype.setSelectedImage=function(a){var b,c,f,g,h,i=this;a==null&&(a={});for(c in a)h=a[c],this.$("[name='image["+c+"]']").val(h);return b=d.Deferred(),g=function(d){var f,g,j;f=d.target,j=e.defaults(a,{width:f.width,height:f.height});for(c in j)h=j[c],i.$("[name='image["+c+"]']").val(h);return g=j.width&&j.height,i.setAspectRatio(),b.resolve(j)},f=function(a){var b,d,e;b=a.target,d={width:"",height:""},e=[];for(c in d)h=d[c],e.push(i.$("[name='image["+c+"]']").val(h));return e},this.$img=d("<img>",a).load(g).error(f),b},g.prototype.getAttributes=function(){var a,b,c,d,e,f,g,h,i;b={},h=["width","height"];for(d=0,f=h.length;d<f;d++)a=h[d],c=Number(this.$("[name='image["+a+"]']").val()),c&&c>0&&(b[a]=c);i=["src","alt"];for(e=0,g=i.length;e<g;e++)a=i[e],c=this.$("[name='image["+a+"]']").val(),c&&(b[a]=c);return b},g.prototype.onFileLinkClick=function(a){var b;return a.preventDefault(),this.$(".active").removeClass("active").parent().removeAttr("aria-selected"),b=d(a.currentTarget).addClass("active"),b.parent().attr("aria-selected",!0),this.flickr_link=b.attr("data-linkto"),this.setSelectedImage({src:b.attr("data-fullsize"),alt:b.attr("title")})},g.prototype.onFileLinkDblclick=function(a){return this.update()},g.prototype.onImageUrlChange=function(a){return this.flickr_link=null,this.setSelectedImage({src:d(a.currentTarget).val()})},g.prototype.generateImageHtml=function(){var a;return a=this.editor.dom.createHTML("img",this.getAttributes()),this.flickr_link&&(a="<a href='"+this.flickr_link+"'>"+a+"</a>"),a},g.prototype.update=function(){return this.editor.selection.moveToBookmark(this.prevSelection),this.$editor.editorBox("insert_code",this.generateImageHtml()),this.editor.focus(),this.close()},g}(h)})}).call(this)