(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["i18n!discussion_topics","compiled/views/ValidatedFormView","compiled/views/assignments/AssignmentGroupSelector","compiled/views/assignments/GradingTypeSelector","compiled/views/assignments/GroupCategorySelector","compiled/views/assignments/PeerReviewsSelector","underscore","jst/DiscussionTopics/EditView","wikiSidebar","str/htmlEscape","compiled/models/DiscussionTopic","compiled/models/Announcement","compiled/models/Assignment","jquery","compiled/fn/preventDefault","compiled/views/calendar/MissingDateDialogView","compiled/tinymce","tinymce.editor_box","jquery.instructure_misc_helpers","compiled/jquery.rails_flash_notifications"],function(b,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){var s,t;return s=function(l){function s(){return this.validateBeforeSave=a(this.validateBeforeSave,this),this.submit=a(this.submit,this),this.updateAssignment=a(this.updateAssignment,this),this.renderPeerReviewOptions=a(this.renderPeerReviewOptions,this),this.renderGroupCategoryOptions=a(this.renderGroupCategoryOptions,this),this.renderGradingTypeOptions=a(this.renderGradingTypeOptions,this),this.renderAssignmentGroupOptions=a(this.renderAssignmentGroupOptions,this),this.render=a(this.render,this),this.isAnnouncement=a(this.isAnnouncement,this),this.isTopic=a(this.isTopic,this),t=s.__super__.constructor.apply(this,arguments),t}return c(s,l),s.prototype.template=j,s.prototype.tagName="form",s.prototype.className="form-horizontal no-margin",s.prototype.dontRenableAfterSaveSuccess=!0,s.prototype.els={"#availability_options":"$availabilityOptions","#use_for_grading":"$useForGrading"},s.prototype.events=i.extend(s.prototype.events,{"click .removeAttachment":"removeAttachment","change #use_for_grading":"toggleAvailabilityOptions"}),s.optionProperty("permissions"),s.prototype.initialize=function(a){return this.assignment=this.model.get("assignment"),this.dueDateOverrideView=a.views["js-assignment-overrides"],this.model.on("sync",function(){return window.location=this.get("html_url")}),s.__super__.initialize.apply(this,arguments)},s.prototype.isTopic=function(){return this.model.constructor===m},s.prototype.isAnnouncement=function(){return this.model.constructor===n},s.prototype.toJSON=function(){var a;return a=i.extend(s.__super__.toJSON.apply(this,arguments),this.options,{showAssignment:!!this.assignmentGroupCollection,useForGrading:this.model.get("assignment")!=null,isTopic:this.isTopic(),isAnnouncement:this.isAnnouncement(),contextIsCourse:this.options.contextType==="courses",canAttach:this.permissions.CAN_ATTACH,canModerate:this.permissions.CAN_MODERATE,isLargeRoster:(typeof ENV!="undefined"&&ENV!==null?ENV.IS_LARGE_ROSTER:void 0)||!1}),a.assignment=a.assignment.toView(),a},s.prototype.render=function(){var a;return s.__super__.render.apply(this,arguments),k.inited||(k.init(),p.scrollSidebar()),a=this.$("textarea[name=message]").attr("id",i.uniqueId("discussion-topic-message")),i.defer(function(){return a.editorBox(),p(".rte_switch_views_link").click(q(function(){return a.editorBox("toggle")}))}),k.attachToEditor(a),k.show(),this.assignmentGroupCollection&&(this.assignmentGroupFetchDfd||(this.assignmentGroupFetchDfd=this.assignmentGroupCollection.fetch())).done(this.renderAssignmentGroupOptions),i.defer(this.renderGradingTypeOptions),i.defer(this.renderGroupCategoryOptions),i.defer(this.renderPeerReviewOptions),this.$(".datetime_field").datetime_field(),this},s.prototype.renderAssignmentGroupOptions=function(){return this.assignmentGroupSelector=new e({el:"#assignment_group_options",assignmentGroups:this.assignmentGroupCollection.toJSON(),parentModel:this.assignment,nested:!0}),this.assignmentGroupSelector.render()},s.prototype.renderGradingTypeOptions=function(){return this.gradingTypeSelector=new f({el:"#grading_type_options",parentModel:this.assignment,nested:!0,preventNotGraded:!0}),this.gradingTypeSelector.render()},s.prototype.renderGroupCategoryOptions=function(){return this.groupCategorySelector=new g({el:"#group_category_options",parentModel:this.assignment,groupCategories:ENV.GROUP_CATEGORIES,nested:!0}),this.groupCategorySelector.render()},s.prototype.renderPeerReviewOptions=function(){return this.peerReviewSelector=new h({el:"#peer_review_options",parentModel:this.assignment,nested:!0}),this.peerReviewSelector.render()},s.prototype.getFormData=function(){var a,c;return c=s.__super__.getFormData.apply(this,arguments),c.title||(c.title=b.t("default_discussion_title","No Title")),c.discussion_type=c.threaded?"threaded":"side_comment",c.podcast_enabled||(c.podcast_has_student_posts=!1),a=c.assignment,delete c.assignment,(a!=null?a.set_assignment:void 0)?(c.set_assignment=!0,c.assignment=this.updateAssignment(a),c.delayed_post_at="",c.lock_at=""):c.assignment={set_assignment:!1},this.saveOpts={multipart:!!c.attachment,proxyAttachment:!0},c},s.prototype.updateAssignment=function(a){var b,c;if(typeof ENV!="undefined"&&ENV!==null?!ENV.IS_LARGE_ROSTER:!void 0)a=this.groupCategorySelector.filterFormData(a);return this.dueDateOverrideView.updateOverrides(),c=this.dueDateOverrideView.getDefaultDueDate(),a.lock_at=(c!=null?c.get("lock_at"):void 0)||null,a.unlock_at=(c!=null?c.get("unlock_at"):void 0)||null,a.due_at=(c!=null?c.get("due_at"):void 0)||null,a.assignment_overrides=this.dueDateOverrideView.getOverrides(),b=this.model.get("assignment"),b||(b=new o),b.set(a)},s.prototype.removeAttachment=function(){return this.model.set("attachments",[]),this.$el.append('<input type="hidden" name="remove_attachment" >'),this.$(".attachmentRow").remove(),this.$('[name="attachment"]').show()},s.prototype.submit=function(a){var b,c,e=this;return a.preventDefault(),a.stopPropagation(),this.dueDateOverrideView.containsSectionsWithoutOverrides()?(c=this.dueDateOverrideView.sectionsWithoutOverrides(),b=new r({validationFn:function(){return c},labelFn:function(a){return a.get("name")},success:function(){var a;return b.$dialog.dialog("close").remove(),(a=e.model.get("assignment"))!=null&&a.setNullDates(),d.prototype.submit.call(e)}}),b.cancel=function(a){return b.$dialog.dialog("close").remove()},b.render()):s.__super__.submit.apply(this,arguments)},s.prototype.fieldSelectors=i.extend({},e.prototype.fieldSelectors,g.prototype.fieldSelectors),s.prototype.validateBeforeSave=function(a,b){var c;if(this.isTopic()&&a.set_assignment){this.assignmentGroupSelector!=null&&(b=this.assignmentGroupSelector.validateBeforeSave(a,b));if(typeof ENV!="undefined"&&ENV!==null?!ENV.IS_LARGE_ROSTER:!void 0)b=this.groupCategorySelector.validateBeforeSave(a,b);c={assignment_overrides:this.dueDateOverrideView.getAllDates(a.assignment.toJSON())},b=this.dueDateOverrideView.validateBeforeSave(c,b)}else this.model.set("assignment",{set_assignment:!1});return b},s.prototype.showErrors=function(a){return delete a.assignmentOverrides,s.__super__.showErrors.call(this,a)},s.prototype.toggleAvailabilityOptions=function(){return this.$useForGrading.is(":checked")?this.$availabilityOptions.hide():this.$availabilityOptions.show()},s}(d)})}).call(this)