(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["i18n!profile","underscore","compiled/views/DialogBaseView","jst/profiles/avatarDialog","jst/profiles/avatar","compiled/util/BackoffPoller"],function(b,d,e,f,g,h){var i,j;return i=function(e){function i(){return this.onUpdate=a(this.onUpdate,this),this.updateAvatar=a(this.updateAvatar,this),this.onAvatarLoad=a(this.onAvatarLoad,this),this.onPoll=a(this.onPoll,this),j=i.__super__.constructor.apply(this,arguments),j}return c(i,e),i.prototype.template=f,i.prototype.url="/api/v1/users/self/avatars",i.prototype.pollThumbnails=!1,i.prototype.events={"click .img":"selectAvatar","click .add_pic_link":"toggleAddForm"},i.prototype.els={"#add_pic_form":"$form"},i.prototype.messages={cancel:b.t("#buttons.cancel","Cancel"),selectImage:b.t("buttons.select_image","Select Image"),selectProfile:b.t("titles.select_profile_pic","Select Profile Pic"),selectingImage:b.t("buttons.selecting_image","Selecting Image..."),selectImage:b.t("buttons.select_image","Select Image"),addingFile:b.t("buttons.adding_file","Adding File..."),addFile:b.t("buttons.add_file","Add File"),addFailed:b.t("errors.adding_file_failed","Adding File Failed")},i.prototype.dialogOptions=function(){return{buttons:[{text:this.messages.cancel,click:this.cancel},{text:this.messages.selectImage,"class":"btn-primary select_button",click:this.updateAvatar}],height:300,title:this.messages.selectProfile,width:500}},i.prototype.initialize=function(){return this.thumbnailPoller=new h(this.url,this.onPoll),i.__super__.initialize.apply(this,arguments)},i.prototype.show=function(){return this.rendered||this.initContent(),this.selectButton().prop("disabled",!0),i.__super__.show.apply(this,arguments)},i.prototype.initContent=function(){return this.loadAvatars(),this.render(),this.initializeForm(),this.rendered=!0},i.prototype.loadAvatars=function(){return $.ajaxJSON(this.url,"GET",{},this.onAvatarLoad)},i.prototype.onPoll=function(a){var b,c,d,e,f,g;e={},b=this.$el.find("img.pending"),d=0;for(f=0,g=a.length;f<g;f++)c=a[f],c.pending||(e[c.token]=c.url);return b.each(function(){var a,b;a=$(this),b=e[a.data("token")];if(b!==null)return a.removeClass("pending").attr("src",b),d++}),d===b.length?"stop":d>0?"reset":"continue"},i.prototype.onAvatarLoad=function(a){var b,c,d;if(a!=null?!a.length:!void 0)return;this.$el.addClass("loaded").find("h3").remove();for(c=0,d=a.length;c<d;c++)b=a[c],this.drawAvatar(b);if(this.pollThumbnails)return this.thumbnailPoller.start()},i.prototype.drawAvatar=function(a){var b,c;return c=d.extend({classNames:""},a),a.pending&&(c.classNames="pending",c.url="/images/ajax-loader.gif"),c.alt=c.title=a.display_name||a.type,b=$(g(c)),b.find("img")[0].onerror=b.remove.bind(b,null),this.$el.find(".profile_pic_list .clear").before(b)},i.prototype.selectAvatar=function(a){if(/pending/.test(a.target.className))return;return this.$el.find(".img.selected").removeClass("selected"),$(a.currentTarget).addClass("selected"),this.selectButton().prop("disabled",!1)},i.prototype.updateAvatar=function(a){var b,c,d;d="/api/v1/users/self",b=this.$el.find(".selected img"),c={"user[avatar][token]":b.data("token")},this.selectButton().prop("disabled",!0).text(this.messages.selectingImage);if(!b.length)return;return $.ajaxJSON(d,"PUT",c,this.onUpdate)},i.prototype.onUpdate=function(a){var b,c;return c=$(".profile_pic_link img, .profile-link img"),b=this.$el.find(".selected img").attr("src"),this.selectButton().prop("disabled",!1).text(this.messages.selectImage),a.avatar_url==="/images/no_pic.gif"&&(a.avatar_url="/images/dotted_pic.png"),c.attr("src",b),this.close()},i.prototype.selectButton=function(){return this.$selectButton||(this.$selectButton=this.$el.parent().find(".select_button"))},i.prototype.addFileButton=function(){return this.$addFileButton||(this.$addFileButton=this.$form.find("button"))},i.prototype.initializeForm=function(){var a=this;return this.$form.formSubmit({fileUpload:!0,fileUploadOptions:{preparedFileUpload:!0,upload_only:!0,singleFile:!0,context_code:ENV.context_asset_string,folder_id:ENV.folder_id,formDataTarget:"uploadDataUrl"},object_name:"attachment",required:["uploaded_data"],beforeSubmit:function(){var b,c;return a.addFileButton().prop("disabled",!0).text(a.messages.addingFile),c=$('<span class="img"><img alt="" /></span>'),b=c.find("img").attr("src","/images/ajax-loader.gif"),b.addClass("pending"),a.$el.find(".profile_pic_list .clear").before(c),c},success:function(b,c){var d,e,f;e=b.attachment,f=b.avatar,a.addFileButton().prop("disabled",!1).text(a.messages.addFile);if(c)return d=c.find("img"),d.data({type:"attachment",token:f.token}).attr("alt",e.display_name),d[0].onerror=function(){return d.attr("src","/images/dotted_pic.png")},a.thumbnailPoller.start().then(function(){return d.click()})},error:function(b,c){a.addFileButton().prop("disabled",!1).text(a.messages.addFailed);if(c)return c.remove()}})},i.prototype.toggleAddForm=function(a){return this.$form.slideToggle()},i}(e)})}).call(this)