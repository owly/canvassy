(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["jquery","underscore","Backbone","i18n!registration","compiled/registration/registrationErrors","jquery.instructure_forms","jquery.ajaxJSON"],function(b,d,e,f,g){var h,i;return h=function(d){function e(){return this.logOutAndRefresh=a(this.logOutAndRefresh,this),this.logOut=a(this.logOut,this),this.enroll=a(this.enroll,this),this.enrollErrors=a(this.enrollErrors,this),this.errorFormatter=a(this.errorFormatter,this),this.normalizeData=a(this.normalizeData,this),this.success=a(this.success,this),this.beforeSubmit=a(this.beforeSubmit,this),this.changeAction=a(this.changeAction,this),i=e.__super__.constructor.apply(this,arguments),i}return c(e,d),e.prototype.events={"change input[name=initial_action]":"changeAction","click #logout_link":"logOutAndRefresh"},e.prototype.initialize=function(a){return this.options=a!=null?a:{},this.enrollUrl=this.$el.attr("action"),this.action=this.initialAction=this.$el.find("input[type=hidden][name=initial_action]").val(),this.$el.formSubmit({beforeSubmit:this.beforeSubmit,success:this.success,errorFormatter:this.errorFormatter,disableWhileLoading:"spin_on_success"})},e.prototype.changeAction=function(a){return this.action=b(a.target).val(),this.$el.find(".user_info").hide(),this.$el.find("#"+this.action+"_user_info").show(),this.$el.find("#submit_button").css({visibility:"visible"})},e.prototype.beforeSubmit=function(a){return this.action?this.options.confirmEnrollmentUrl&&this.action==="enroll"?(window.location=this.options.confirmEnrollmentUrl,!1):(this.normalizeData(a),this.$el.attr("action",function(){switch(this.action){case"create":return"/users";case"log_in":return"/login";case"enroll":return this.enrollUrl}}.call(this))):!1},e.prototype.success=function(a){var b;return this.action==="enroll"?(b=window.location.search,b=b?""+b+"&":"?",b+="enrolled=1",this.initialAction==="create"&&(b+="&just_created=1"),window.location.search=b):this.enroll()},e.prototype.normalizeData=function(a){var b,c;return this.action==="log_in"&&(a["pseudonym_session[unique_id]"]=(b=a["pseudonym[unique_id]"])!=null?b:"",a["pseudonym_session[password]"]=(c=a["pseudonym[password]"])!=null?c:""),a},e.prototype.errorFormatter=function(a){var b;return b=function(){switch(this.action){case"create":return g(a);case"log_in":return this.loginErrors(a);case"enroll":return this.enrollErrors(g(a))}}.call(this),b},e.prototype.loginErrors=function(a){var b;return a=a.base,b=a[a.length-1].message,{"pseudonym[password]":b}},e.prototype.enrollErrors=function(a){var b;return a["user[self_enrollment_code]"]&&((b=a["pseudonym[unique_id]"])==null&&(a["pseudonym[unique_id]"]=[]),a["pseudonym[unique_id]"].push(a["user[self_enrollment_code]"][0]),delete a["user[self_enrollment_code]"]),this.action=this.initialAction,this.logOut(),a},e.prototype.enroll=function(){return this.action="enroll",this.$el.submit()},e.prototype.logOut=function(a){return a==null&&(a=!1),b.ajaxJSON("/logout","POST",{},function(){if(a)return location.reload(!0)})},e.prototype.logOutAndRefresh=function(a){return a.preventDefault(),this.logOut(!0)},e}(e.View)})}).call(this)