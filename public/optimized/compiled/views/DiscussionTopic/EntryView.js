(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["underscore","i18n!discussions","compiled/discussions/MarkAsReadWatcher","compiled/arr/walk","Backbone","compiled/collections/EntryCollection","jst/discussions/_entry_content","jst/discussions/_deleted_entry","jst/discussions/entry_with_replies","jst/discussions/entryStats","compiled/discussions/Reply","compiled/discussions/EntryEditor","str/htmlEscape","vendor/jquery.ba-tinypubsub","compiled/str/convertApiUserContent","jst/_avatar","jst/discussions/_reply_form"],function(b,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r,s,t;return s=p.publish,r=function(g){function i(){return this.renderTree=a(this.renderTree,this),this.toggleDeleted=a(this.toggleDeleted,this),this.toggleReadState=a(this.toggleReadState,this),t=i.__super__.constructor.apply(this,arguments),t}return c(i,g),i.instances={},i.collapseRootEntries=function(){return b.each(this.instances,function(a){if(!a.model.get("parent"))return a.collapse()})},i.expandRootEntries=function(){return b.each(this.instances,function(a){if(!a.model.get("parent"))return a.expand()})},i.setAllReadState=function(a){return b.each(this.instances,function(b){return b.model.set("read_state",a)})},i.prototype.els={".discussion_entry:first":"$entryContent",".replies:first":"$replies",".headerBadges:first":"$headerBadges",".discussion-read-state-btn:first":"$readStateToggle"},i.prototype.events={"click .loadDescendants":"loadDescendants","click [data-event]":"handleDeclarativeEvent"},i.prototype.defaults={treeView:null,descendants:2,children:5,showMoreDescendants:2},i.prototype.template=k,i.prototype.tagName="li",i.prototype.className="entry",i.prototype.initialize=function(){return i.__super__.initialize.apply(this,arguments),this.constructor.instances[this.cid]=this,this.$el.attr("id","entry-"+this.model.get("id")),this.model.on("change:deleted",this.toggleDeleted),this.model.on("change:read_state",this.toggleReadState),this.model.on("change:editor",this.render),this.model.on("change:editor",function(a){return a.trigger("edited")})},i.prototype.toggleRead=function(a){return a.preventDefault(),this.model.get("read_state")==="read"?this.model.markAsUnread():this.model.markAsRead(),i.trigger("readStateChanged",this.model,this)},i.prototype.handleDeclarativeEvent=function(a){var b,c;b=$(a.currentTarget),c=b.data("event");if(this.bypass(a))return;return a.stopPropagation(),a.preventDefault(),this[c](a,b)},i.prototype.bypass=function(a){var b,c,d;return c=$(a.target),c.data("bypass")!=null?!0:(b=$(a.target).closest(".admin-links").length,d=$(a.target).data("event"),b&&!d?!0:!1)},i.prototype.toJSON=function(){var a;return a=this.model.attributes,a.edited_at=$.parseFromISO(a.updated_at).datetime_formatted,a.editor?(a.editor_name=a.editor.display_name,a.editor_href='href="'+a.editor.html_url+'"'):(a.editor_name=d.t("unknown","Unknown"),a.editor_href=""),a},i.prototype.toggleReadState=function(a,b){return this.setToggleTooltip(),this.$entryContent.toggleClass("unread",b==="unread"),this.$entryContent.toggleClass("read",b==="read")},i.prototype.toggleCollapsed=function(a,b){return this.addedCountsToHeader||this.addCountsToHeader(),this.$el.toggleClass("collapsed")},i.prototype.expand=function(){return this.$el.removeClass("collapsed")},i.prototype.collapse=function(){return this.addedCountsToHeader||this.addCountsToHeader(),this.$el.addClass("collapsed")},i.prototype.addCountsToHeader=function(){var a,b;return b=this.countPosterity(),a="<div class='new-and-total-badge'>\n  <span class=\"new-items\">"+b.unread+'</span>\n  <span class="total-items">'+b.total+"</span>\n</div>",this.$headerBadges.append(l({stats:b})),this.addedCountsToHeader=!0},i.prototype.toggleDeleted=function(a,b){this.$entryContent.toggleClass("deleted-discussion-entry",b);if(b)return this.model.set("updated_at",(new Date).toISOString()),this.model.set("editor",ENV.current_user)},i.prototype.setToggleTooltip=function(){var a;return a=this.model.get("read_state")==="unread"?d.t("mark_as_read","Mark as Read"):d.t("mark_as_unread","Mark as Unread"),this.$readStateToggle.attr("title",a)},i.prototype.afterRender=function(){var a;return i.__super__.afterRender.apply(this,arguments),this.options.collapsed&&this.collapse(),this.setToggleTooltip(),this.model.get("read_state")==="unread"&&!this.model.get("forced_read_state")&&!ENV.DISCUSSION.MANUAL_MARK_AS_READ&&((a=this.readMarker)==null&&(this.readMarker=new e(this)),e.checkForVisibleEntries()),s("userContent/change")},i.prototype.filter=i.prototype.afterRender,i.prototype.renderTree=function(a){var b,c,d,e,f;a==null&&(a={});if(this.treeView!=null)return;return f=this.model.get("replies"),d=(a.descendants||this.options.descendants)-1,b=a.children||this.options.children,c=new h(f,{perPage:b}),e=c.getPageAsCollection(0),this.treeView=new this.options.treeView({el:this.$replies[0],descendants:d,collection:e,threaded:this.options.threaded,showMoreDescendants:this.options.showMoreDescendants}),this.treeView.render()},i.prototype.renderDescendantsLink=function(){var a;return a=this.countPosterity(),this.descendantsLink=$("<div/>"),this.descendantsLink.html(l({stats:a,showMore:!0})),this.descendantsLink.addClass("showMore loadDescendants"),this.$replies.append(this.descendantsLink)},i.prototype.countPosterity=function(){var a;return a={unread:0,total:0},this.model.attributes.replies==null?a:(f(this.model.attributes.replies,"replies",function(b){return b.read_state==="unread"&&a.unread++,a.total++}),a)},i.prototype.loadDescendants=function(a){return a.stopPropagation(),a.preventDefault(),this.renderTree({children:this.options.children,descendants:this.options.showMoreDescendants})},i.prototype.remove=function(){var a;if(confirm(d.t("are_your_sure_delete","Are you sure you want to delete this entry?")))return this.model.set("deleted",!0),this.model.destroy(),a=j(this.toJSON()),this.$(".entry_content:first").html(a)},i.prototype.edit=function(){var a;(a=this.editor)==null&&(this.editor=new n(this));if(!this.editor.editing)return this.editor.edit()},i.prototype.addReply=function(a,b){var c,d=this;return(c=this.reply)==null&&(this.reply=new m(this,{focus:!0})),this.model.set("notification",""),this.reply.edit(),this.reply.on("save",function(a){return d.renderTree(),d.treeView.collection.add(a),d.treeView.collection.fullCollection.add(a),d.trigger("addReply"),i.trigger("addReply",a)})},i.prototype.addReplyAttachment=function(a,b){return a.preventDefault(),this.reply.addAttachment(b)},i.prototype.removeReplyAttachment=function(a,b){return a.preventDefault(),this.reply.removeAttachment(b)},i.prototype.format=function(a,b){return a==="message"?(b=q(b),this.$el.find(".message").removeClass("enhanced"),s("userContent/change"),b):a==="notification"?b:o(b)},i}(g.View),b.extend(r,g.Events)})}).call(this)