(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["i18n!course_settings","jquery","underscore","compiled/views/DialogBaseView","compiled/views/courses/roster/RosterDialogMixin","jst/courses/roster/EditSectionsView","jst/courses/roster/section","compiled/widget/ContextSearch","str/htmlEscape","compiled/jquery.rails_flash_notifications","jquery.disableWhileLoading"],function(b,d,e,f,g,h,i,j,k){var l,m;return l=function(f){function j(){return this.update=a(this.update,this),m=j.__super__.constructor.apply(this,arguments),m}return c(j,f),j.mixin(g),j.prototype.events={"click #user_sections li a":"removeSection"},j.prototype.dialogOptions={id:"edit_sections",title:b.t("titles.section_enrollments","Section Enrollments")},j.prototype.render=function(){return this.$el.html(h({sectionsUrl:ENV.SEARCH_URL})),this.setupContextSearch(),this},j.prototype.setupContextSearch=function(){var a,c,d,f,g,h,j,k,l=this;this.$("#section_input").contextSearch({contexts:ENV.CONTEXTS,placeholder:b.t("edit_sections_placeholder","Enter a section name"),added:function(a,b,c){return l.$("#user_sections").append(b)},selector:{baseData:{type:"section",context:"course_"+ENV.course.id+"_sections",exclude:e.map(this.model.sectionEditableEnrollments(),function(a){return"section_"+a.course_section_id})},noExpand:!0,browser:{data:{per_page:100,type:"section",search_all_contexts:!0}}}}),d=this.$("#section_input").data("token_input"),d.$fakeInput.css("width","100%"),d.tokenValues=function(){var a,b,c,e;c=l.$("#user_sections input"),e=[];for(a=0,b=c.length;a<b;a++)d=c[a],e.push(d.value);return e},a=this.$("#user_sections"),j=this.model.sectionEditableEnrollments(),k=[];for(g=0,h=j.length;g<h;g++)c=j[g],(f=ENV.CONTEXTS.sections[c.course_section_id])?k.push(a.append(i({id:f.id,name:f.name,role:c.role}))):k.push(void 0);return k},j.prototype.update=function(a){var c,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=this;a.preventDefault(),i=this.model.findEnrollmentByRole(this.model.currentRole),c=e.map(this.model.sectionEditableEnrollments(),function(a){return a.course_section_id}),n=e.map(d("#user_sections").find("input"),function(a){return parseInt(d(a).val().split("_")[1])}),m=e.reject(n,function(a){return e.include(c,a)}),l=[],g=[];for(q=0,s=m.length;q<s;q++)k=m[q],p="/api/v1/sections/"+k+"/enrollments",f={enrollment:{user_id:this.model.get("id"),type:i.type,limit_privileges_to_course_section:i.limit_priveleges_to_course_section}},i.role!==i.type&&(f.enrollment.role=i.role),g.push(d.ajaxJSON(p,"POST",f,function(a){return l.push(a)}));o=e.difference(c,n),j=e.filter(this.model.sectionEditableEnrollments(),function(a){return e.include(o,a.course_section_id)});for(r=0,t=j.length;r<t;r++)h=j[r],p=""+ENV.COURSE_ROOT_URL+"/unenroll/"+h.id,g.push(d.ajaxJSON(p,"DELETE"));return this.disable(d.when.apply(d,g).done(function(){return u.updateEnrollments(l,j),d.flashMessage(b.t("flash.sections","Section enrollments successfully updated"))}).fail(function(){return d.flashError(b.t("flash.sectionError","Something went wrong updating the user's sections. Please try again later."))}).always(function(){return u.close()}))},j.prototype.removeSection=function(a){var b;b=d(a.currentTarget).closest("li");if(b.closest("ul").children().length>1)return b.remove()},j}(f)})}).call(this)