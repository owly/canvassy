(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["i18n!outcomes","jquery","underscore","Backbone","compiled/models/Outcome","compiled/models/OutcomeGroup","compiled/views/outcomes/OutcomesDirectoryView","compiled/views/outcomes/FindDirectoryView"],function(b,d,e,f,g,h,i,j){var k,l,m;return l=void 0,k=function(f){function k(){return this.findDialog=a(this.findDialog,this),this.renderDir=a(this.renderDir,this),this.goBack=a(this.goBack,this),this.clearOutcomeSelection=a(this.clearOutcomeSelection,this),this.refreshSelection=a(this.refreshSelection,this),this.selectDir=a(this.selectDir,this),this.addAndSelect=a(this.addAndSelect,this),m=k.__super__.constructor.apply(this,arguments),m}return c(k,f),k.prototype.directoryWidth=200,k.prototype.entryHeight=30,k.prototype.events={"click .outcome-level":"clickOutcomeLevel"},k.prototype.initialize=function(a){return this.readOnly=a.readOnly,this.selectFirstItem=a.selectFirstItem,this.directories=[],this.cachedDirectories={},this.$sidebar=this.$el.parent(),this.$sidebar.width(this.directoryWidth),(this.rootOutcomeGroup=a.rootOutcomeGroup)?this.addDirFor(this.rootOutcomeGroup):this.addDir(a.directoryView),this.render()},k.prototype.clickOutcomeLevel=function(a){var b,c;b=a.target===a.currentTarget;if(!b)return;return c=d(a.target).data("view"),this.selectDir(c)},k.prototype.addDirFor=function(a){var b,c,d;return this.cachedDirectories[a.id]?b=this.cachedDirectories[a.id]:(d=e.last(this.directories),c=a.get("directoryClass")||i,b=new c({outcomeGroup:a,parent:d,readOnly:this.readOnly,selectFirstItem:this.selectFirstItem}),this.firstDir=!1),this.addDir(b)},k.prototype.addDir=function(a){return a.outcomeGroup&&(this.cachedDirectories[a.outcomeGroup.id]=a),a.off("select"),a.on("select",this.selectDir),a.sidebar=this,a.clearSelection(),this.directories.push(a),this.updateSidebarWidth(),this.renderDir(a),a},k.prototype.addAndSelect=function(a){var b;return a instanceof g?a.outcomeGroup=this.selectedGroup().toJSON():a.set("parent_outcome_group",this.selectedGroup().toJSON()),b=this._findLastDir(function(a){return!a.selectedModel||a.selectedModel instanceof g}),a instanceof g?b.outcomes.add(a):b.groups.add(a),this._scrollToDir(e.indexOf(this.directories,b),a),a.trigger("select")},k.prototype.selectDir=function(a,b){var c,d,f,g,i,j,k;if(b&&a===this.selectedDir()&&b===((k=this.selectedDir())!=null?k.prevSelectedModel:void 0))return;return i=a?a:this.directories[0],i&&!b&&i.clearSelection(),d=e.indexOf(this.directories,i),c=this.directories.splice(d+1,this.directories.length-(d+1)),e.each(c,function(a){return a.remove()}),f=b instanceof h&&!b.isNew(),f&&this.addDirFor(b),this.updateSidebarWidth(),g=f?d+1:d,this._scrollToDir(g,b),j=b,this.goingBack&&(i.parent?j=i.outcomeGroup:j=null),this.trigger("select",j,this.directories)},k.prototype.refreshSelection=function(a){var b;b=this.selectedDir();if(a===b.selectedModel)return b.clearSelection(),a.trigger("select")},k.prototype.selectedDir=function(){return this._findLastDir(function(a){return a.selectedModel})},k.prototype.selectedModel=function(){var a;return(a=this.selectedDir())!=null?a.selectedModel:void 0},k.prototype.selectedGroup=function(){var a;return a=null,this._findLastDir(function(b){if(b.selectedModel instanceof h)return a=b.selectedModel}),a||this.rootOutcomeGroup},k.prototype.clearOutcomeSelection=function(){return e.last(this.directories).clearOutcomeSelection()},k.prototype.goBack=function(){var a;return this.goingBack=!0,this.selectedModel()instanceof h?this.selectDir(this.selectedDir()):(a=e.indexOf(this.directories,this.selectedDir()),this.selectDir(this.directories[a-1])),this.goingBack=!1},k.prototype.updateSidebarWidth=function(){var a;return a=this.directories.length===1?this.directoryWidth+1:this.directoryWidth*2+2,this.$el.css({width:this.directoryWidth*this.directories.length+this.directories.length}),this.$sidebar.animate({width:a})},k.prototype.renderDir=function(a){return this.$el.append(a.render().el)},k.prototype.render=function(){return this.$el.empty(),e.each(this.directories,this.renderDir),this},k.prototype.findDialog=function(a){return l||(l=new a({title:b.t("titles.find_outcomes","Find Outcomes"),selectedGroup:this.selectedGroup(),directoryView:new j({outcomeGroup:this.selectedGroup()})}),l.on("import",this.addAndSelect,this)),l.show()},k.prototype.dirForGroup=function(a){return e.find(this.directories,function(b){return b.outcomeGroup===a})||this.addDirFor(a)},k.prototype._scrollToDir=function(a,b){var c,d;return c=(this.directoryWidth+1)*(b instanceof g?a-1:a),this.$sidebar.animate({scrollLeft:c},{duration:200}),d=(this.entryHeight+1)*e.indexOf(this.directories[a].views(),e.find(this.directories[a].views(),function(a){return a.model===b})),this.directories[a].$el.animate({scrollTop:d},{duration:200})},k.prototype._findLastDir=function(a){return e.find(e.clone(this.directories).reverse(),a)||e.last(this.directories)},k}(f.View)})}).call(this)