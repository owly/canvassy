(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["compiled/views/DiscussionTopics/DiscussionsSettingsView","compiled/views/DiscussionTopics/UserSettingsView","i18n!discussion_topics","underscore","jst/announcements/IndexView","compiled/views/PaginatedView","compiled/views/DiscussionTopics/SummaryView","compiled/collections/AnnouncementsCollection"],function(b,d,e,f,g,h,i,j){var k,l;return k=function(h){function k(){return this.handleSortUpdate=a(this.handleSortUpdate,this),this.modelMeetsFilterRequirements=a(this.modelMeetsFilterRequirements,this),this.toggleActionsForSelectedDiscussions=a(this.toggleActionsForSelectedDiscussions,this),this.fetchedLastPage=a(this.fetchedLastPage,this),this.fetchedNextPage=a(this.fetchedNextPage,this),this.addDiscussionTopicToList=a(this.addDiscussionTopicToList,this),this.renderList=a(this.renderList,this),l=k.__super__.constructor.apply(this,arguments),l}return c(k,h),k.prototype.template=g,k.prototype.el="#content",k.prototype.events={"change #onlyUnread, #onlyGraded, #searchTerm":"handleFilterChange","input #searchTerm":"handleFilterChange","keyup #searchTerm":"handleFilterChange",sortupdate:"handleSortUpdate","change #lock":"toggleLockingSelectedTopics","click #delete":"destroySelectedTopics","click #edit_discussions_settings":"toggleSettingsView"},k.prototype.initialize=function(){return k.__super__.initialize.apply(this,arguments),this.attachCollection(),this.render()},k.prototype.attachCollection=function(){var a=this;return this.collection.on("remove",function(){if(!a.collection.length)return a.render()}),this.collection.on("reset",this.render),this.collection.on("add",this.renderList),this.collection.on("fetch:next",this.fetchedNextPage),this.collection.on("fetched:last",this.fetchedLastPage),this.collection.on("change:selected",this.toggleActionsForSelectedDiscussions)},k.prototype.afterRender=function(){return this.$("#discussionsFilter").buttonset(),this.renderList(),this.toggleActionsForSelectedDiscussions(),this},k.prototype.toggleSettingsView=function(){return this.settingsView||(this.settingsView=this.options.permissions.change_settings?new b:new d),this.settingsView.toggle()},k.prototype.renderList=function(){var a,b,c;a=this.$(".discussionTopicIndexList").empty(),c=!f.any(this.collection.map(this.addDiscussionTopicToList)),this.$(".nothingMatchedFilter").toggle(c&&!this.collection.fetchingNextPage),b=!c&&!this.activeFilters.length&&!this.isShowingAnnouncements()&&this.options.permissions.moderate;if(b)return a.sortable({axis:"y",cancel:"a",containment:a,cursor:"ns-resize",handle:".discussion-drag-handle",tolerance:"pointer"});if(a.is(":ui-sortable"))return a.sortable("destroy")},k.prototype.addDiscussionTopicToList=function(a){var b;if(this.modelMeetsFilterRequirements(a))return b=new i({model:a,permissions:this.options.permissions}),this.$(".discussionTopicIndexList").append(b.render().el)},k.prototype.fetchedNextPage=function(){var a;return a=this.$(".discussionTopicIndexList"),this.collection.length&&!a.length?this.render():this.renderList()},k.prototype.fetchedLastPage=function(){this.lastPageFetched=!0;if(!this.collection.length)return this.render()},k.prototype.toggleActionsForSelectedDiscussions=function(){var a,b,c,d;d=this.selectedTopics(),b=d.length>0,a=this.$("#actionsForSelectedDiscussions").toggle(b);if(b)return c=f.any(d,function(a){return a.get("locked")}),a.find("#lock").prop("checked",c).button({text:!1,icons:{primary:"ui-icon-locked"}}),a.find("#delete").button({text:!1,icons:{primary:"ui-icon-trash"}}),a.buttonset()},k.prototype.toggleLockingSelectedTopics=function(){var a;return a=this.$("#lock").is(":checked"),f.invoke(this.selectedTopics(),"updateOneAttribute","locked",a)},k.prototype.destroySelectedTopics=function(){var a,b;b=this.selectedTopics(),a=this.isShowingAnnouncements()?e.t("confirm_delete_announcement",{one:"Are you sure you want to delete this announcement?",other:"Are you sure you want to delete these %{count} announcements?"},{count:b.length}):e.t("confirm_delete_discussion_topic",{one:"Are you sure you want to delete this discussion topic?",other:"Are you sure you want to delete these %{count} discussion topics?"},{count:b.length});if(confirm(a))return f(b).invoke("destroy"),this.toggleActionsForSelectedDiscussions()},k.prototype.selectedTopics=function(){return this.collection.filter(function(a){return a.selected})},k.prototype.modelMeetsFilterRequirements=function(a){var b=this;return f.all(this.activeFilters(),function(c,d){return c.call(a,b[d])})},k.prototype.handleSortUpdate=function(a,b){var c,d;return c=b.item.data("id"),d=b.item.next(".discussion-topic").data("id"),this.collection.get(c).positionAfter(d)},k.prototype.activeFilters=function(){var a,b,c,d;c={},d=this.filters;for(b in d)a=d[b],this[b]&&(c[b]=a);return c},k.prototype.handleFilterChange=function(a){var b,c;b=a.target,c=b.type==="checkbox"?b.checked:b.value;if(this[b.id]!==c)return this[b.id]=c,this.renderList(),this.collection.trigger("aBogusEventToCauseYouToFetchNextPageIfNeeded")},k.prototype.filters={onlyGraded:function(){return this.get("assignment_id")},onlyUnread:function(){return this.get("read_state")==="unread"||this.get("unread_count")},searchTerm:function(a){var b,c,d,e,g;return d=a.match(/\w+/ig),b="("+f.uniq(d).join("|")+")",c=new RegExp(b,"igm"),((e=this.get("author"))!=null?(g=e.display_name)!=null?g.match(c):void 0:void 0)||this.get("title").match(c)||this.summary().match(c)}},k.prototype.isShowingAnnouncements=function(){return this.collection.constructor===j},k.prototype.toJSON=function(){var a,b,c;return c=this.collection.url().replace("/api/v1","")+"/new",this.isShowingAnnouncements()&&(c=(c+"?is_announcement=true").replace(this.collection._stringToAppendToURL,"")),b=f.pick(this,f.keys(this.filters)),a=f.pick(this.collection,["atLeastOnePageFetched","length"]),f.extend({new_topic_url:c,options:this.options,showingAnnouncements:this.isShowingAnnouncements(),lastPageFetched:this.lastPageFetched},b,a)},k}(h)})}).call(this)