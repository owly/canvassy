(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["underscore","Backbone","compiled/models/Group","compiled/models/User","compiled/collections/CollaboratorCollection","jst/collaborations/collaborator"],function(b,d,e,f,g,h){var i,j,k,l,m,n;return k=b.extend,l=b.filter,m=b.map,j=d.View,i=function(b){function d(){return this.onFetch=a(this.onFetch,this),this.publishCollection=a(this.publishCollection,this),this.deselectCollaborator=a(this.deselectCollaborator,this),this.render=a(this.render,this),n=d.__super__.constructor.apply(this,arguments),n}return c(d,b),d.prototype.events={"click li a":"removeCollaborator","click .remove-all":"removeAll"},d.prototype.initialize=function(){return this.collection=this.createCollection(),this.cacheElements(),this.attachEvents()},d.prototype.createCollection=function(){return new g},d.prototype.cacheElements=function(){return this.$list=this.$el.find("ul"),this.$removeBtn=this.$el.find(".remove-button"),this.$instructions=this.$el.find(".member-instructions")},d.prototype.attachEvents=function(){return this.collection.on("add remove reset",this.render).on("reset",this.onFetch).on("remove",this.deselectCollaborator)},d.prototype.render=function(){var a,b=this;return this.options.currentUser&&this.removeCurrentUser(),this.updateElementVisibility(),a=this.collection.map(function(a){return h(k(a.toJSON(),{type:a.modelType||a.get("type"),id:a.get("collaborator_id")||a.get("id"),name:a.get("sortable_name")||a.get("name"),selected:!0}))}),this.$list.html(a.join("")),this.currentIndex!=null&&this.hasFocus&&this.updateFocus(),this.hasFocus=!1},d.prototype.updateFocus=function(){var a;return a=$(this.$el.find("li").get(this.currentIndex)).find("a"),a.length===0&&(a=$(this.$el.find("li").get(this.currentIndex-1)).find("a")),a.length===0&&(a=this.$el.parents(".collaborator-picker").find(".list-wrapper:first ul:visible")),a.focus()},d.prototype.removeCollaborator=function(a){var b;return a.preventDefault(),b=$(a.currentTarget).data("id"),this.currentIndex=$(a.target).parent().index(),this.hasFocus=!0,this.collection.remove(b)},d.prototype.removeAll=function(a){return a.preventDefault(),this.collection.remove(this.collection.models)},d.prototype.updateElementVisibility=function(){return this.collection.length===0?(this.$removeBtn.hide(),this.$instructions.show()):(this.$removeBtn.show(),this.$instructions.hide())},d.prototype.deselectCollaborator=function(a){return a.modelType==null&&(a=this.typecastMember(a)),this.trigger("collection:remove",a)},d.prototype.typecastMember=function(a){var b;return b=k(a.toJSON(),{id:a.get("collaborator_id")}),a.get("type")==="user"?new f(k(b,{sortable_name:b.name})):new e(b)},d.prototype.publishCollection=function(a){var b,c;return c=a.filter(function(a){return a.get("type")==="user"}),b=a.filter(function(a){return a.get("type")==="group"}),this.trigger("collection:reset","user",m(c,this.typecastMember)),this.trigger("collection:reset","group",m(b,this.typecastMember))},d.prototype.onFetch=function(){var a;this.publishCollection(this.collection),a=this.getNextPage(this.currentXHR.getResponseHeader("Link"));if(a)return this.collection.url=a,this.currentXHR=this.collection.fetch({add:!0}),$.when(this.currentXHR).then(this.onFetch)},d.prototype.getNextPage=function(a){var b;return b=l(a.split(","),function(a){return a.match(/next/)})[0],b?b.match(/http[^>]+/)[0]:!1},d.prototype.removeCurrentUser=function(){return this.collection.remove(this.options.currentUser,{silent:!0})},d}(j)})}).call(this)