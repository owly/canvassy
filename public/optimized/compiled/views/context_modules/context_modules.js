(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};define(["Backbone","jquery","i18n!context_modules","jquery.loadingImg"],function(b,d,e){var f,g;return f=function(b){function f(){return this.onKeyDown=a(this.onKeyDown,this),this.error=a(this.error,this),this.success=a(this.success,this),this.toggleWorkflowState=a(this.toggleWorkflowState,this),g=f.__super__.constructor.apply(this,arguments),g}return c(f,b),f.optionProperty("modules"),f.prototype.toggleWorkflowState=function(a){var b,c,e=this;return a.preventDefault(),this.$context_module=d(a.target).parents(".context_module"),b=this.$context_module.data("module-url"),this.workflow_state=this.$context_module.data("workflow-state"),c={url:b,type:"PUT",beforeSend:function(){return e.$context_module.loadingImage()},success:this.success,error:this.error},this.setRequestPublishOptions(c),d.ajax(c)},f.prototype.success=function(a){return this.$context_module.data("workflow-state",a.context_module.workflow_state),a.context_module.workflow_state==="unpublished"?this.addUnpublishAttributes():this.addPublishAttributes(),this.$context_module.loadingImage("remove")},f.prototype.error=function(a){return alert("This module could not be published"),this.$context_module.loadingImage("remove")},f.prototype.setRequestPublishOptions=function(a){return this.workflow_state==="active"?a.data="unpublish=1":a.data="publish=1"},f.prototype.addUnpublishAttributes=function(){return this.$context_module.find(".workflow-state-action").text(e.t("context_modules.publish","Publish")),this.$context_module.find(".workflow-state-icon").addClass("publish-module-link").removeClass("unpublish-module-link"),this.$context_module.find(".draft-text").removeClass("hide"),this.$context_module.addClass("unpublished_module")},f.prototype.addPublishAttributes=function(){return this.$context_module.find(".workflow-state-action").text(e.t("context_module.unpublish","Unpublish")),this.$context_module.find(".workflow-state-icon").addClass("unpublish-module-link").removeClass("publish-module-link"),this.$context_module.find(".draft-text").addClass("hide"),this.$context_module.removeClass("unpublished_module")},f.prototype.keyCodes={32:"Space",38:"UpArrow",40:"DownArrow"},f.prototype.moduleSelector="div.context_module",f.prototype.itemSelector="table.context_module_item",f.prototype.initialize=function(){return this.$contextModules=d("#context_modules"),this.$contextModules.parent().on("keydown",this.onKeyDown)},f.prototype.onKeyDown=function(a){var b,c;b=d(a.target),c="on"+this.keyCodes[a.keyCode]+"Key";if(this[c])return a.preventDefault(),this[c].call(this,a,b)},f.prototype.getFocusedElement=function(a){var b;return b=a.parents(this.itemSelector).first(),this.empty(b)||(a=b),a.is(this.itemSelector)||(b=a.parents(this.moduleSelector).first(),this.empty(b)||(a=b),a.is(this.moduleSelector)||(a=this.$contextModules)),a},f.prototype.onUpArrowKey=function(a,b){var c,d,e;c=this.getFocusedElement(b);if(c.is(this.itemSelector)){e=c.prev(this.itemSelector);if(this.empty(e)||this.$contextModules.data("dragModule"))e=c.parents(this.moduleSelector).first()}else c.is(this.moduleSelector)&&(this.$contextModules.data("dragItem")?e=this.$contextModules.data("dragItemModule"):(e=c.prev(this.moduleSelector),this.empty(e)?e=this.$contextModules:this.$contextModules.data("dragModule")||(d=e.find(this.itemSelector).last(),this.empty(d)||(e=d))));if(e&&!this.empty(e))return e.focus()},f.prototype.onDownArrowKey=function(a,b){var c,d,e;c=this.getFocusedElement(b);if(c.is(this.itemSelector))d=c.next(this.itemSelector),this.empty(d)&&!this.$contextModules.data("dragItem")&&(e=c.parents(this.moduleSelector).first(),d=e.next(this.moduleSelector));else if(c.is(this.moduleSelector)){d=c.find(this.itemSelector).first();if(this.empty(d)||this.$contextModules.data("dragModule"))d=c.next(this.moduleSelector)}else d=this.$contextModules.find(this.moduleSelector).first();if(d&&!this.empty(d))return d.focus()},f.prototype.onSpaceKey=function(a,b){var c,d,e,f;e=this.getFocusedElement(b);if(c=this.$contextModules.data("dragItem"))return e.is(c)||(f=this.$contextModules.data("dragItemModule"),e.is(this.itemSelector)&&!this.empty(e.parents(f))?e.after(c):f.find(".items").prepend(c),modules.updateModuleItemPositions(null,{item:c.parent()})),c.attr("aria-grabbed",!1),this.$contextModules.data("dragItem",null),this.$contextModules.data("dragItemModule",null),c.focus();if(d=this.$contextModules.data("dragModule"))return e.is(this.itemSelector)&&(e=e.parents(this.moduleSelector).first()),e.is(d)||(this.empty(e)||e.is(this.$contextModules)?this.$contextModules.prepend(d):e.after(d),modules.updateModulePositions()),d.attr("aria-grabbed",!1),this.$contextModules.data("dragModule",null),d.focus();if(!e.is(this.$contextModules))return e.attr("aria-grabbed",!0),e.is(this.itemSelector)?(this.$contextModules.data("dragItem",e),this.$contextModules.data("dragItemModule",e.parents(this.moduleSelector).first())):e.is(this.moduleSelector)&&this.$contextModules.data("dragModule",e),e.blur(),e.focus()},f.prototype.empty=function(a){return a.length===0},f}(b.View)})}).call(this)