define(["compiled/editor/stocktiny","i18n!editor","jquery","str/htmlEscape","jquery.dropdownList","jquery.instructure_misc_helpers","jqueryui/dialog","jquery.instructure_misc_plugins"],function(a,b,c,d){var e={embed_from_external_tool:b.t("embed_from_external_tool",'"Embed content from External Tool"'),more_external_tools:INST.htmlEscape(b.t("more_external_tools","More External Tools"))};a.create("tinymce.plugins.InstructureExternalTools",{init:function(a,b){function g(b){var f=Math.max(Math.min(c(window).height()-100,550),100);d||(d=c('<div id="external_tool_button_dialog" style="padding: 0; overflow-y: hidden;"/>').hide().html("<div class='teaser' style='width: 800px; margin-bottom: 10px; display: none;'></div><iframe id='external_tool_button_frame' style='width: 800px; height: "+f+"px; border: 0;' src='/images/ajax-loader-medium-444.gif' borderstyle='0'/>").appendTo("body").dialog({autoOpen:!1,width:"auto",resizable:!0,close:function(){d.find("iframe").attr("src","/images/ajax-loader-medium-444.gif")},title:e.embed_from_external_tool}).bind("dialogresize",function(){c(this).find("iframe").add(".fix_for_resizing_over_iframe").height(c(this).height()).width(c(this).width())}).bind("dialogresizestop",function(){c(".fix_for_resizing_over_iframe").remove()}).bind("dialogresizestart",function(){c(this).find("iframe").each(function(){c('<div class="fix_for_resizing_over_iframe" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e7}).css(c(this).offset()).appendTo("body")})}).bind("selection",function(b,e){var f=d.data("editor")||a;if(e.return_type=="lti_launch_url")if(c("#external_tool_retrieve_url").attr("href")){var g=c.replaceTags(c("#external_tool_retrieve_url").attr("href"),"url",e.url);c("#"+a.id).editorBox("create_link",{url:g,title:e.title,text:e.text})}else console.log("cannot embed basic lti links in this context");else if(e.return_type=="image_url"){var h=c("<div/>").append(c("<img/>",{src:e.url,alt:e.alt}).css({width:e.width,height:e.height})).html();c("#"+a.id).editorBox("insert_code",h)}else if(e.return_type=="url")c("#"+a.id).editorBox("create_link",{url:e.url,title:e.title,text:e.text,target:e.target=="_blank"?"_blank":null});else if(e.return_type=="file")c("#"+a.id).editorBox("create_link",{url:e.url,title:e.filename,text:e.filename});else if(e.return_type=="iframe"){var h=c("<div/>").append(c("<iframe/>",{src:e.url,title:e.title}).css({width:e.width,height:e.height})).html();c("#"+a.id).editorBox("insert_code",h)}else e.return_type=="rich_content"?c("#"+a.id).editorBox("insert_code",e.html):e.return_type=="error"&&e.message?alert(e.message):console.log("unrecognized embed type: "+e.return_type);c("#external_tool_button_dialog iframe").attr("src","about:blank"),c("#external_tool_button_dialog").dialog("close")})),d.dialog("option","title","Embed content from "+b.name),d.dialog("close").dialog("option","width",b.width||800).dialog("option","height",b.height||f||400).dialog("open"),d.triggerHandler("dialogresize"),d.data("editor",a);var g=c.replaceTags(c("#context_external_tool_resource_selection_url").attr("href"),"id",b.id);if(g===null||typeof g=="undefined"){var h=ENV.context_asset_string.split("_");g="/"+h[0]+"s/"+h[1]+"/external_tools/"+b.id+"/resource_selection?editor=1"}d.find("iframe").attr("src",g)}if(!window||!window.INST||!window.INST.editorButtons||!window.INST.editorButtons.length)return;var d=null,f=[];for(var h in INST.editorButtons){var i=INST.editorButtons[h];INST.editorButtons.length>INST.maxVisibleEditorButtons&&h>=INST.maxVisibleEditorButtons-1?f.push(i):function(b){a.addCommand("instructureExternalButton"+b.id,function(){g(b)}),a.addButton("instructure_external_button_"+b.id,{title:b.name,cmd:"instructureExternalButton"+b.id,image:b.icon_url,"class":"instructure_external_tool_button"})}(i)}f.length&&(a.addCommand("instructureExternalButtonClump",function(){var b={};for(var d in f)(function(a){b["<img src='"+f[a].icon_url+"'/>&nbsp;"+f[a].name]=function(){g(f[a])}})(d);c("#"+a.id+"_instructure_external_button_clump").dropdownList({options:b})}),a.addButton("instructure_external_button_clump",{title:e.more_external_tools,cmd:"instructureExternalButtonClump",image:"/images/downtick.png"}))},getInfo:function(){return{longname:"InstructureExternalTools",author:"Brian Whitmer",authorurl:"http://www.instructure.com",infourl:"http://www.instructure.com",version:a.majorVersion+"."+a.minorVersion}}}),a.PluginManager.add("instructure_external_tools",a.plugins.InstructureExternalTools)})