define(["compiled/editor/stocktiny","i18n!editor","jquery","str/htmlEscape","jqueryui/dialog","jquery.instructure_misc_helpers"],function(a,b,c,d){function m(){e=c("<div/>",{html:l.instructions+"<form id='instructure_embed_prompt_form' style='margin-top: 5px;'><table class='formtable'><tr><td>"+l.url+"</td><td><input type='text' class='prompt' style='width: 250px;' value='http://'/></td></tr><tr><td class='nobr'>"+l.alt_text+"</td><td><input type='text' class='alt_text' style='width: 150px;' value=''/></td></tr><tr><td colspan='2' style='text-align: right;'><input type='submit' class='btn' value='Embed Image'/></td></tr></table></form><div class='actions'></div>"}).hide(),h=e.find(".alt_text"),i=e.find(".actions"),g=e.find(".prompt"),j=c("<a/>",{"class":"flickr_search_link",text:l.search_flickr,href:"#"}),g.bind("keyup",p),i.delegate(".embed_image_link","click",o),j.click(n),e.append(j).find("#instructure_embed_prompt_form").submit(o),c("body").append(e),e.dialog({autoOpen:!1,width:425,title:l.embed_external,open:function(){g.select()}}),k=!0}function n(a){a.preventDefault(),e.dialog("close"),c.findImageForService("flickr_creative_commons",function(a){var b=INST.htmlEscape(a.title),c='<a href="'+a.link_url+'"><img src="'+a.image_url+'" title="'+b+'"alt="'+b+'" style="max-width: 500; max-height: 500"></a>';e.dialog("close"),f.editorBox("insert_code",c)})}function o(a){var b=INST.htmlEscape(h.val()||""),c=INST.htmlEscape(g.val());a.preventDefault(),f.editorBox("insert_code","<img src='"+c+"' alt='"+b+"'/>"),e.dialog("close")}function p(a){var b=g.val();return b.match(/\.(gif|png|jpg|jpeg)$/)?r(b):q()}function q(){i.empty()}function r(a){var b=c("<div/>"),d=c("<img/>");b.css("textAlign","center").text(l.loading),i.empty(),i.append(b),d.attr({src:a,title:l.click_to_embed}).addClass("embed_image_link").css("cursor","pointer").bind({load:function(){var a=d[0];d.height(a.height<200?a.height:100),b.empty().append(d)},error:function(){b.text(l.image_not_found)}})}function s(){var a=c(tinyMCE.get(f.attr("id")).selection.getContent());a.length?(h.val(a.attr("alt")),g.val(a.attr("src"))):(h.val(""),g.val(""))}var e,f,g,h,i,j,k=!1,l={click_to_embed:b.t("click_to_embed","Click to embed the image"),instructions:INST.htmlEscape(b.t("instructions","Paste or type the URL of the image you'd like to embed:")),url:INST.htmlEscape(b.t("url","URL:")),alt_text:INST.htmlEscape(b.t("alt_text","Alternate Text:")),search_flickr:b.t("search_flickr","Search flickr creative commons"),loading:b.t("loading","Loading..."),embed_external:b.t("embed_external","Embed External Image"),embed_image:INST.htmlEscape(b.t("embed_image","Embed Image")),image_not_found:b.t("image_not_found","Image not found, please try a new URL")};a.create("tinymce.plugins.InstructureEmbed",{init:function(a,b){var d=c("#"+a.id);a.addCommand("instructureEmbed",function(a){k||m(),f=d,s(),e.dialog("open"),a==="flickr"&&j.click()})},getInfo:function(){return{longname:"InstructureEmbed",author:"Brian Whitmer",authorurl:"http://www.instructure.com",infourl:"http://www.instructure.com",version:a.majorVersion+"."+a.minorVersion}}}),a.PluginManager.add("instructure_embed",a.plugins.InstructureEmbed)})