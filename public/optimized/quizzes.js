define(["i18n!quizzes","underscore","jquery","calcCmd","str/htmlEscape","str/pluralize","wikiSidebar","compiled/views/assignments/DueDateList","compiled/views/assignments/DueDateOverride","compiled/models/Quiz","compiled/models/DueDateList","compiled/collections/SectionCollection","compiled/views/calendar/MissingDateDialogView","compiled/editor/MultipleChoiceToggle","compiled/str/TextHelper","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.keycodes","jquery.loadingImg","compiled/jquery.rails_flash_notifications","jquery.templateData","supercalc","compiled/tinymce","tinymce.editor_box","vendor/jquery.placeholder","vendor/jquery.scrollTo","jqueryui/sortable","jqueryui/tabs"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function t(a){var b=0,c=a.length,d=null,e=["due_at","lock_at","unlock_at"];for(b;b<c;b++){d=a[b];for(var f in e){var g=e[f];if(!e.hasOwnProperty(f))continue;d[g]?d[g]=d[g].toUTCString():d[g]=""}delete d.unlock_at_overridden,delete d.lock_at_overridden,delete d.all_day_date,delete d.due_at_overridden,delete d.all_day}}function y(b){var d=c(".question_holder:visible").length+1,e=c.extend({},x.defaultQuestionData,{question_name:a.t("default_quesiton_name","Question")},b),f=c("#question_template").clone(!0);f.attr("id","").find(".question").attr("id","question_new"),f.fillTemplateData({data:e,except:["answers"]}),f.find(".original_question_text").fillFormData(e),e.answers&&(e.answer_count=e.answers.length,b.answer_type=e.answer_type,e.anwer_type=x.answerTypeDetails(e.question_type));for(var g=0;g<e.answer_count;g++){var h=g==0?100:0,i={answer_weight:h};e.answers&&e.answers[g]&&c.extend(i,e.answers[g]),f.find(".answers").append(z(i))}return f.toggleClass("group",!!b&&!!b.quiz_group_id),f.show(),f}function z(b,d){b.answer_weight=b.weight||b.answer_weight,b.answer_comment=b.comments||b.answer_comment,b.answer_text=b.text||b.answer_text,b.answer_html=b.html||b.answer_html,b.answer_comment_html=b.comments_html||b.answer_comment_html,b.answer_match_left=b.left||b.answer_match_left,b.answer_match_left_html=b.left_html||b.answer_match_left_html,b.answer_match_right=b.right||b.answer_match_right,b.answer_exact=b.exact||b.answer_exact,b.answer_error_margin=b.answer_error_margin||b.margin,b.answer_range_start=b.start||b.answer_range_start,b.answer_range_end=b.end||b.answer_range_end;var e=c.extend({},x.defaultAnswerData,b),f=c("#answer_template").clone(!0).attr("id",""),g=e.answer_type;return g=="numerical_answer"&&(g="numerical_"+e.numerical_answer_type),f.addClass("answer_for_"+b.blank_id),f.find(".answer_type").hide().filter("."+g).show(),f.find("div.answer_text").showIf(!b.answer_html),f.find("div.answer_match_left").showIf(!b.answer_match_left_html),f.find("div.answer_match_left_html").showIf(b.answer_match_left_html),delete e.answer_type,e.answer_weight=parseFloat(e.answer_weight),isNaN(e.answer_weight)&&(e.answer_weight=0),f.fillFormData({answer_text:e.answer_text}),f.fillTemplateData({data:e,htmlValues:["answer_html","answer_match_left_html","answer_comment_html"]}),(!e.answer_comment||e.answer_comment==""||e.answer_comment==a.t("answer_comments","Answer comments"))&&f.find(".answer_comment_holder").hide(),e.answer_weight==100?f.addClass("correct_answer"):e.answer_weight>0?f.addClass("correct_answer"):e.answer_weight<0&&f.addClass("negative_answer"),f.show(),f}function A(a){var b=c.extend({},x.defaultAnswerData,a),d=c("#form_answer_template").clone(!0).attr("id","");return d.find(".answer_type").hide().filter("."+b.answer_type).show(),b.answer_weight=parseFloat(b.answer_weight),isNaN(b.answer_weight)&&(b.answer_weight=0),x.updateFormAnswer(d,b,!0),d.find("input[placeholder]").placeholder(),d.show(),d}function B(a){var b=c("#questions"),d={questions:[],points_possible:0},e=b.find(".question");return a&&(e=a),e.each(function(a){var b=c(this),e=b.getTemplateData({textValues:["question_name","question_points","question_type","answer_selection_type","assessment_question_id","correct_comments","incorrect_comments","neutral_comments","matching_answer_incorrect_matches","equation_combinations","equation_formulas"],htmlValues:["question_text","text_before_answers","text_after_answers","correct_comments_html","incorrect_comments_html","neutral_comments_html"]});e=c.extend(e,b.find(".original_question_text").getFormData()),e.assessment_question_bank_id=c(".question_bank_id").text()||"",e.text_before_answers&&(e.question_text=e.text_before_answers);var f=[];b.find(".matching_answer_incorrect_matches_list li").each(function(){f.push(c(this).text())}),e.matching_answer_incorrect_matches=f.join("\n");var g=c.extend({},d.defaultQuestionData,e);g.answers=[];var h={},i=!1;if(g.question_type=="multiple_dropdowns_question"||g.question_type=="fill_in_multiple_blanks_question")i=!0,b.find(".blank_id_select option").each(function(){h[c(this).text()]=!0});g.question_type!="calculated_question"?b.find(".text > .answers .answer").each(function(){var a=c(this),b=a.getTemplateData({textValues:["answer_exact","answer_error_margin","answer_range_start","answer_range_end","answer_weight","numerical_answer_type","blank_id","id","match_id","answer_text","answer_match_left","answer_match_right","answer_comment"],htmlValues:["answer_html","answer_match_left_html","answer_comment_html"]}),e=c.extend({},d.defaultAnswerData,b);if(i&&e.blank_id&&!h[e.blank_id])return;g.answers.push(e)}):(g.formulas=[],b.find(".formulas_holder .formulas_list > div").each(function(){g.formulas.push(c.trim(c(this).text()))}),g.variables=[],b.find(".variable_definitions_holder .variable_definitions tbody tr").each(function(){var a=c(this).getTemplateData({textValues:["name","min","max","scale"]});g.variables.push(a)}),g.answers=[],b.find(".equation_combinations tbody tr").each(function(){var a={};a.variables=[],c(this).find("td:not(.final_answer)").each(function(b){var d={};d.name=g.variables[b].name,d.value=parseFloat(c(this).text(),10)||0,a.variables.push(d)}),a.answer_text=parseFloat(c(this).find(".final_answer").text(),10)||0,g.answers.push(a)}),g.formula_decimal_places=parseInt(b.find(".formula_decimal_places").text(),10)||0,g.answer_tolerance=parseFloat(b.find(".answer_tolerance").text(),10)||0),g.position=a,g.question_points=parseFloat(g.question_points),isNaN(g.question_points)&&(g.question_points=0),d.points_possible+=g.question_points,d.questions.push(g)}),d}function C(a){var b={};for(var c in a)if(c.indexOf("questions[question_0]")==0){var d=c.replace("questions[question_0]","question");b[d]=a[c]}return b}function D(a){var b={};ENV.ASSIGNMENT_ID&&(b["quiz[assignment_id]"]=ENV.ASSIGNMENT_ID),b["quiz[title]"]=a.quiz_name;for(var c in a.questions){var d=a.questions[c],e="questions[question_"+c+"]";b[e+"[question_name]"]=d.question_name,b[e+"[assessment_question_id]"]=d.assessment_question_id,b[e+"[question_type]"]=d.question_type,b[e+"[points_possible]"]=d.question_points,b[e+"[correct_comments]"]=d.correct_comments,b[e+"[incorrect_comments]"]=d.incorrect_comments,b[e+"[neutral_comments]"]=d.neutral_comments,b[e+"[question_text]"]=d.question_text,b[e+"[position]"]=d.position,b[e+"[text_after_answers]"]=d.text_after_answers,b[e+"[matching_answer_incorrect_matches]"]=d.matching_answer_incorrect_matches;for(var f in d.formulas){var g=e+"[formulas][formula_"+f+"]";b[g]=d.formulas[f]}for(var f in d.variables){var g=e+"[variables][variable_"+f+"]";b[g+"[name]"]=d.variables[f].name,b[g+"[min]"]=d.variables[f].min,b[g+"[max]"]=d.variables[f].max,b[g+"[scale]"]=d.variables[f].scale}b[e+"[answer_tolerance]"]=d.answer_tolerance,b[e+"[formula_decimal_places]"]=d.formula_decimal_places;for(var f in d.answers){var h=d.answers[f],g=e+"[answers][answer_"+f+"]";b[g+"[answer_text]"]=h.answer_text,b[g+"[answer_html]"]=h.answer_html,b[g+"[answer_comments]"]=h.answer_comment,b[g+"[answer_comments_html]"]=h.answer_comment_html,b[g+"[answer_weight]"]=h.answer_weight,b[g+"[answer_match_left]"]=h.answer_match_left,b[g+"[answer_match_left_html]"]=h.answer_match_left_html,b[g+"[answer_match_right]"]=h.answer_match_right,b[g+"[numerical_answer_type]"]=h.numerical_answer_type,b[g+"[answer_exact]"]=h.answer_exact,b[g+"[answer_error_margin]"]=h.answer_error_margin,b[g+"[answer_range_start]"]=h.answer_range_start,b[g+"[answer_range_end]"]=h.answer_range_end,b[g+"[blank_id]"]=h.blank_id,b[g+"[match_id]"]=h.match_id,b[g+"[id]"]=h.id;for(var i in h.variables){var j=g+"[variables][variable_"+i+"]";b[j+"[name]"]=h.variables[i].name,b[j+"[value]"]=h.variables[i].value}}}return b}function E(a,b,c){html=b[c+"_html"],html&&html.length>0&&(a.find("."+c+"_html").html(html).css("display","inline-block"),a.find("textarea").val(html),a.find("a,textarea").hide(),a.removeClass("empty"))}function G(b){if(!ENV.QUIZZES||!ENV.QUIZZES.QUIZ)return!1;var d=c("#questions .question_holder").not(".group").length;return c("#questions .group_top").find('input[name="quiz_group[pick_count]"]').each(function(){d+=parseInt(this.value)}),(b?d>F:d>=F)?(setTimeout(function(){alert(a.t("question_limit_reached","You have reached the maximum number of questions allowed for a quiz (%{count}/%{limit}).\n\nAs a workaround, consider spreading the material across multiple quizzes.",{count:d,limit:F}))}),!0):!1}var p,q,r,s;ENV.QUIZ&&ENV.ASSIGNMENT_OVERRIDES!=null&&(ENV.QUIZ.assignment_overrides=ENV.ASSIGNMENT_OVERRIDES,r=new j(ENV.QUIZ),s=new l(ENV.SECTION_LIST),p=new k(r.get("assignment_overrides"),s,r),q=new i({el:".js-assignment-overrides",model:p,views:{"due-date-overrides":new h({model:p})}}),q.render());var u=a.t("titles.click_to_set_as_correct","Click to set this answer as correct"),v=a.t("titles.set_as_correct","This answer is set as correct"),w=a.t("titles.click_to_unset_as_correct","Click to unset this answer as correct"),x=window.quiz={};x={uniqueLocalIDStore:{},init:function(){return this.$questions=c("#questions"),this.$showDetailsWrap=c("#show_question_details_wrap").hide(),this},checkShowDetails:function(){var a=this.$questions.find("div.display_question:not(.essay_question, .file_upload_question, .text_only_question)").length;this.$showDetailsWrap[a?"show":"hide"](200)},generateUniqueLocalID:function(a){var b="object";a.attr("class")&&(a.attr("class").indexOf(" ")!=-1?b=a.attr("class").split(" ")[0]:b=a.attr("class"));var c=Math.floor(Math.random()*99999),d=b+"_"+c;while(x.uniqueLocalIDStore[d])c=Math.floor(Math.random()*99999),d=b+"_"+c;return x.uniqueLocalIDStore[d]=!0,d},updateFormAnswer:function(b,d,e){var f=d.question_type,g=e?{}:b.getFormData(),h=c.extend({},x.defaultAnswerData,g,d);b.find(".answer_type").hide().filter("."+h.answer_type).show(),h.answer_weight=parseFloat(h.answer_weight),isNaN(h.answer_weight)&&(h.answer_weight=0),b.fillFormData(h,{call_change:!1}),b.find(".select_answer input").showIf(!h.answer_html),b.find(".matching_answer .answer_match_left").showIf(!h.answer_match_left_html),b.find(".matching_answer .answer_match_left_html").showIf(h.answer_match_left_html),(h.answer_comment||h.answer_comment_html)&&b.find(".answer_comments").removeClass("empty"),h.answer_selection_type=h.answer_selection_type||x.answerSelectionType(h.question_type);if(h.answer_selection_type=="any_answer")b.addClass("correct_answer");else if(h.answer_selection_type=="matching")b.removeClass("correct_answer");else if(h.answer_selection_type!="multiple_answer"){var i=b.parent().find(".answer");i.find(".answer").filter(".correct_answer").not(":first").removeClass("correct_answer"),i.filter(".correct_answer").length===0&&i.filter(":first").addClass("correct_answer"),i.find(".select_answer_link").attr("title",u).find("img").attr("alt",u),i.filter(".correct_answer").find(".select_answer_link").attr("title",v).find("img").attr("alt",v)}else b.filter(".correct_answer").find(".select_answer_link").attr("title",w).find("img").attr("alt",w),b.filter(":not(.correct_answer)").find(".select_answer_link").attr("title",u).find("img").attr("alt",u);b.find(".numerical_answer_type").change();var j={answer_text:h.answer_text,id:h.id,match_id:h.match_id};j.comments_header=a.beforeLabel("comments_on_answer","Comments, if the user chooses this answer"),j.short_answer_header=a.beforeLabel("possible_answer","Possible Answer"),b.find(".comment_focus").attr("title",a.t("titles.click_to_enter_comments_on_answer","Click to enter comments for the student if they choose this answer")),f=="essay_question"||f=="file_upload_question"?j.comments_header=a.beforeLabel("comments_on_question","Comments for this question"):f=="matching_question"?(j.answer_match_left_html=h.answer_match_left_html,j.comments_header=a.beforeLabel("comments_on_wrong_match","Comments if the user gets this match wrong"),b.find(".comment_focus").attr("title",a.t("titles.click_to_enter_comments_on_wrong_match","Click to enter comments for the student if they miss this match"))):f=="missing_word_question"?j.short_answer_header=a.beforeLabel("answer_text","Answer text"):f=="multiple_choice_question"?j.answer_html=h.answer_html:f=="multiple_answers_question"?(j.answer_html=h.answer_html,j.short_answer_header=a.beforeLabel("answer_text","Answer text")):f=="fill_in_multiple_blanks_question"?j.blank_id=h.blank_id:f=="multiple_dropdowns_question"&&(j.short_answer_header=a.t("answer_text","Answer text"),j.blank_id=h.blank_id),h.blank_id&&h.blank_id!="0"&&b.addClass("answer_for_"+h.blank_id),h.blank_index>=0&&b.addClass("answer_idx_"+h.blank_index),b.fillTemplateData({data:j,htmlValues:["answer_html","answer_match_left_html"]}),E(b,h,"answer_comment"),h.answer_weight>0?(b.addClass("correct_answer"),h.answer_selection_type=="multiple_answer"&&b.find(".select_answer_link").attr("title",w).find("img").attr("alt",w)):h.answer_weight<0&&b.addClass("negative_answer"),f=="matching_question"&&b.removeClass("correct_answer");var k=b.find(".edit_html").data("editorToggle"),l=f==="multiple_choice_question"||f==="multiple_answers_question";k&&l?k.showAnswerText():k&&k.display()},questionContentCounter:0,showFormQuestion:function(b){return b.attr("id")||(b.show(),b.find(".question_content").attr("id","question_content_"+x.questionContentCounter++),b.find(".question_content").editorBox({tinyOptions:{aria_label:a.t("label.question.instructions","Question instructions, rich text area")}}),b.find(".text_after_answers").attr("id","text_after_answers_"+x.questionContentCounter++),b.find(".text_after_answers").editorBox(),b.hide()),b.show()},answerTypeDetails:function(a){var b,c,d="one";return a=="multiple_choice_question"?(b="select_answer",c="multiple_choice_question"):a=="true_false_question"?(b="select_answer",c="true_false_question"):a=="short_answer_question"?(b="short_answer",c="short_answer_question",d="all"):a=="fill_in_multiple_blanks_question"?(b="short_answer",c="fill_in_multiple_blanks_question",d="all"):a=="essay_question"?(b="comment",c="essay_question",d="none"):a=="file_upload_question"?(b="comment",c="file_upload_question",d="none"):a=="matching_question"?(b="matching_answer",c="matching_question",d="all"):a=="missing_word_question"?(b="select_answer",c="missing_word_question"):a=="multiple_dropdowns_question"?(b="select_answer",c="multiple_dropdowns_question",d="multiple"):a=="numerical_question"?(b="numerical_answer",c="numerical_question",d="all"):a=="multiple_answers_question"?(b="select_answer",c="multiple_answers_question",d="multiple"):a=="calculated_question"&&(b="numerical_answer",c="question_question"),{question_type:c,answer_type:b,n_correct:d}},answerSelectionType:function(a){var b="single_answer";return a!="multiple_choice_question"&&a!="true_false_question"&&(a=="short_answer_question"?b="any_answer":a=="essay_question"?b="none":a=="file_upload_question"?b="none":a=="matching_question"?b="matching":a!="missing_word_question"&&(a=="numerical_question"?b="any_answer":a=="calculated_question"?b="any_answer":a!="multiple_dropdowns_question"&&(a=="fill_in_multiple_blanks_question"?b="any_answer":a=="multiple_answers_question"?b="multiple_answer":a=="text_only_question"&&(b="none")))),b},addExistingQuestion:function(a){var b=c("#group_top_"+a.quiz_group_id),d=null;if(b.length>0){d=b.next();while(d.length>0&&!d.hasClass("group_bottom"))d=d.next();d.length==0&&(d=null)}c.extend(a,a.question_data);var e=y(a);c("#unpublished_changes_message").slideDown(),d?d.before(e):c("#questions").append(e),x.updateDisplayQuestion(e.find(".question:first"),a,!0)},updateDisplayQuestion:function(b,d,f){fillArgs={data:d,except:["answers"],htmlValues:[]},f?fillArgs.htmlValues.push("question_text"):fillArgs.except.push("question_text"),b.fillTemplateData(fillArgs),b.find(".original_question_text").fillFormData(d),b.find(".question_correct_comment").toggleClass("empty",!d.correct_comments&&!d.correct_comments_html),b.find(".question_incorrect_comment").toggleClass("empty",!d.incorrect_comments&&!d.incorrect_comments_html),b.find(".question_neutral_comment").toggleClass("empty",!d.neutral_comments&&!d.neutral_comments_html),b.find(".answers").empty(),b.find(".equation_combinations").empty(),b.find(".equation_combinations_holder_holder").css("display","none"),b.find(".multiple_answer_sets_holder").css("display","none"),b.find(".variable_definitions_holder").css("display","none").find("tbody").empty(),b.find(".formulas_holder").css("display","none").find(".formulas_list").empty(),b.find(".question_points").text(d.points_possible);var g=x.answerTypeDetails(d.question_type),h=g.answer_type,i=g.question_type,j=g.n_correct;b.attr("class","question display_question").addClass(i||"text_only_question"),d.question_type=="fill_in_multiple_blanks_question"?b.find(".multiple_answer_sets_holder").css("display",""):d.question_type=="multiple_dropdowns_question"&&b.find(".multiple_answer_sets_holder").css("display","");var k=c(document.createElement("select")).addClass("answer_select"),l=!1;if(d.question_type=="calculated_question"){c.each(d.variables,function(a,d){var e=c("<tr/>"),f=c("<td class='name'/>");f.text(d.name),e.append(f),f=c("<td class='min'/>"),f.text(d.min),e.append(f),f=c("<td class='max'/>"),f.text(d.max),e.append(f),f=c("<td class='scale'/>"),f.text(d.scale),e.append(f),b.find(".variable_definitions_holder").css("display",""),b.find(".variable_definitions tbody").append(e)}),c.each(d.formulas,function(a,d){var e=c("<div/>");e.text(d.formula),b.find(".formulas_holder").css("display","").find(".formulas_list").append(e)}),b.find(".formula_decimal_places").text(d.formula_decimal_places);if(d.answers.length>0){b.find(".equation_combinations").append(c("<thead/>")),b.find(".equation_combinations").append(c("<tbody/>"));var m=c("<tr/>");for(var n in d.answers[0].variables){var o=c("<th/>");o.text(d.answers[0].variables[n].name),m.append(o)}var o=c("<th/>");o.text(a.t("final_answer","Final Answer")),m.append(o),b.find(".equation_combinations_holder_holder").css("display",""),b.find(".equation_combinations thead").append(m).show(),c.each(d.answers,function(a,e){var f=c("<tr/>");for(var g in e.variables){var h=c("<td/>");h.text(e.variables[g].value),f.append(h)}var h=c("<td class='final_answer'/>"),i=e.answer;if(d.answerDecimalPoints||d.answer_tolerance){var j=parseFloat(d.answer_tolerance);j=j||Math.pow(.1,d.answerDecimalPoints),i=i+" <span style='font-size: 0.8em;'>+/-</span> "+j,b.find(".answer_tolerance").text(j)}h.html(i),f.append(h),b.find(".equation_combinations tbody").append(f)})}}else{var p=c(document.createElement("option"));p.val("").text(a.t("choose_option","[ Choose ]")),k.append(p),c.each(d.answers,function(a,d){d.answer_type=h,j=="all"?d.answer_weight=100:j=="one"&&l?d.answer_weight=0:j=="none"&&(d.answer_weight=0),d.answer_weight>0&&(l=!0);var e=z(d,f);b.find(".text > .answers").append(e);var g=c(document.createElement("option"));g.val("option_"+a).text(d.answer_text),k.append(g)})}b.find(".blank_id_select").empty();if(d.question_type=="missing_word_question"){var q=b.find(".question_text");q.html("<span class='text_before_answers'>"+d.question_text+"</span> "),q.append(k),q.append(" <span class='text_after_answers'>"+d.text_after_answers+"</span>")}else if(d.question_type=="multiple_dropdowns_question"||d.question_type=="fill_in_multiple_blanks_question"){var r={};c.each(d.answers,function(a,b){r[b.blank_id]=!0}),b.find(".blank_id_select").empty();for(var n in r){var s=n;if(s&&r[n]){var p=c("<option/>");p.val(s).text(s),b.find(".blank_id_select").append(p)}}}b.find(".after_answers").empty();if(d.question_type=="matching_question"){var q=b.find(".after_answers"),t=[];if(d.matches&&d.answers){var u={};for(var n in d.answers)u[d.answers[n].match_id]=!0;for(var n in d.matches)u[d.matches[n].match_id]||t.push(d.matches[n].text)}else{var t=d.matching_answer_incorrect_matches||"";typeof t=="string"&&(t=t.split("\n"))}var v="";for(var w in t)t[w]&&(v=v+"<li>"+e(t[w])+"</li>");v&&q.append(a.beforeLabel("other_incorrect_matches","Other Incorrect Match Options")+"<ul class='matching_answer_incorrect_matches_list'>"+v+"</ul>")}b.find(".blank_id_select").change(),b.fillTemplateData({question_type:i,answer_selection_type:h}),b.show();var y=b.attr("id")=="question_new";y&&i!="text_only_question"&&(x.defaultQuestionData.question_type=i,x.defaultQuestionData.answer_count=Math.min(b.find(".answers .answer").length,4)),c("html,body").scrollTo({top:b.offset().top-10,left:0}),b.find(".question_points_holder").showIf(!b.closest(".question_holder").hasClass("group")&&d.question_type!="text_only_question"),b.find(".unsupported_question_type_message").remove(),x.updateDisplayComments(),d.id&&(b.fillTemplateData({data:{id:d.id},id:"question_"+d.id,hrefValues:["id"]}),b.find(".original_question_text").fillFormData(d),x.updateDisplayComments())},updateFormQuestion:function(b){var d=b.find(".question"),e=d.find(":input[name='question_type']").val(),f={};f.answer_type="select_answer",f.answer_selection_type=x.answerSelectionType(e),f.textValues=["answer_weight","answer_text","answer_comment","blank_id","id","match_id"],f.htmlValues=["answer_html","answer_match_left_html","answer_comment_html"],f.question_type=e,d.find(".explanation").hide().filter("."+e+"_explanation").show(),d.attr("class","question").addClass("selectable"),d.find(".missing_word_after_answer").hide().end().find(".matching_answer_incorrect_matches_holder").hide().end().find(".question_comment").css("display","").end(),c("#questions").hasClass("survey_quiz")&&d.find(".question_comment").css("display","none").end().find(".question_neutral_comment").css("display",""),d.find(".question_header").text(a.t("question_colon","Question:")),d.addClass(e),d.find(".question_points_holder").showIf(!d.closest(".question_holder").hasClass("group")&&e!="text_only_question"),d.find("textarea.comments").each(function(){c(this).val(c.trim(c(this).val())),c(this).val()?c(this).parents(".question_comment").removeClass("empty"):c(this).parents(".question_comment").addClass("empty")});var g={addable:!0};if(e!="multiple_choice_question")if(e=="true_false_question"){g.addable=!1;var h=d.find(".form_answers .answer");if(h.length<2)for(var i=0;i<2-h.length;i++){var j=A({answer_type:"fixed_answer",question_type:"true_false_question"});d.find(".form_answers").append(j)}else if(h.length>2)for(var i=2;i<h.length;i++)h.eq(i).remove();var k={question_type:"true_false_question",answer_type:"fixed_answer",answer_text:a.t("true","True")};x.updateFormAnswer(d.find(".answer:first"),k),k.answer_text=a.t("false","False"),x.updateFormAnswer(d.find(".answer:last"),k),f.answer_type="fixed_answer"}else e=="short_answer_question"?(d.removeClass("selectable"),f.answer_type="short_answer"):e=="essay_question"||e=="file_upload_question"?(d.find(".answer").remove(),d.removeClass("selectable"),d.find(".answers_header").hide().end().find(".question_comment").css("display","none").end().find(".question_neutral_comment").css("display","").end(),g.addable=!1,f.answer_type="none",f.textValues=[],f.htmlValues=[]):e=="matching_question"?(d.removeClass("selectable"),b.find(".matching_answer_incorrect_matches_holder").show(),f.answer_type="matching_answer",f.textValues=["answer_match_left","answer_match_right","answer_comment"]):e=="missing_word_question"?(b.find(".missing_word_after_answer").show(),b.find(".question_header").text("Text to go before answers:"),f.answer_type="select_answer"):e=="numerical_question"?(d.removeClass("selectable"),f.answer_type="numerical_answer",f.textValues=["numerical_answer_type","answer_exact","answer_error_margin","answer_range_start","answer_range_end"],f.html_values=[]):e=="calculated_question"?(d.removeClass("selectable"),f.answer_type="numerical_answer",f.textValues=["answer_combinations"],f.html_values=[],d.formulaQuestion()):e=="multiple_dropdowns_question"?(f.answer_type="select_answer",d.multipleAnswerSetsQuestion()):e=="fill_in_multiple_blanks_question"?(f.answer_type="short_answer",d.multipleAnswerSetsQuestion()):e!="multiple_answers_question"&&e=="text_only_question"&&(g.addable=!1,d.find(".answer").remove(),d.removeClass("selectable"),d.find(".answers_header").hide().end().find(".question_comment").css("display","none"),d.find(".question_header").text(a.beforeLabel("message_text","Message Text")),b.find(":input[name='question_points']").val(0),f.answer_type="none",f.textValues=[],f.htmlValues=[]);d.find(".answer.hidden").remove(),b.find("input[name='answer_selection_type']").val(f.answer_selection_type).change(),b.find(".add_answer_link").showIf(g.addable);var h=d.find(".form_answers .answer");return h.length===0&&f.answer_type!="none"&&(d.find(".form_answers").append(A({answer_type:f.answer_type,question_type:e})),d.find(".form_answers").append(A({answer_type:f.answer_type,question_type:e})),h=d.find(".form_answers .answer")),f.answer_selection_type=="any_answer"?h.addClass("correct_answer"):f.answer_selection_type=="matching"?h.removeClass("correct_answer"):f.answer_selection_type!="multiple_answer"&&(h.filter(".correct_answer").not(":first").removeClass("correct_answer"),h.filter(".correct_answer").length===0&&h.filter(":first").addClass("correct_answer")),b.find(".answer").each(function(){var a=0;c(this).hasClass("correct_answer")&&(a=100),c(this).find(".answer_weight").text(a),x.updateFormAnswer(c(this),f)}),b.find(".answer_type").hide().filter("."+f.answer_type).show(),f},updateDisplayComments:function(){this.checkShowDetails(),c(".question_holder > .question > .question_comment").each(function(){var a=c.trim(c(this).find(".question_comment_text").html());c(this).css("display","").toggleClass("empty",!a)}),c(".question_holder .answer_comment_holder").each(function(){var a=c.trim(c(this).find(".answer_comment").html());c(this).css("display","").toggleClass("empty",!a)});var a=0;c("#questions .question_holder:not(.group) .question:not(#question_new)").each(function(){var b=parseFloat(c(this).find(".question_points,.question_points.hidden").text());isNaN(b)&&(b=0),a+=b}),c("#questions .group_top:not(#group_top_new)").each(function(){var b=parseFloat(c(this).find(".question_points").text());isNaN(b)&&(b=0);var d=parseInt(c(this).find(".pick_count").text(),10);isNaN(d)&&(d=0),a+=b*d}),a=Math.round(a*100)/100,c(".points_possible").text(a)},findContainerGroup:function(a){a=a.prev();while(a.length>0){if(a.hasClass("group_top"))return a;if(a.hasClass("group_bottom"))return null;a=a.prev()}return null},parseInput:function(a,b){if(a.val()=="")return;if(b=="int"){var c=parseInt(a.val(),10);isNaN(c)&&(c=0),a.val(c)}else if(b=="float"){var c=Math.round(parseFloat(a.val())*100)/100;isNaN(c)&&(c=0),a.val(c)}else if(b=="float_long"){var c=Math.round(parseFloat(a.val())*1e4)/1e4;isNaN(c)&&(c=0),a.val(c)}},defaultQuestionData:{question_type:"multiple_choice_question",question_text:"",question_points:1,question_name:a.t("default_question_name","Question"),answer_count:4},defaultAnswerData:{answer_type:"select_answer",answer_comment:"",answer_weight:0,numerical_answer_type:"exact_answer",answer_exact:"",answer_error_margin:"",answer_range_start:"",answer_range_end:""}};var F=1e3;c(document).ready(function(){x.init().updateDisplayComments(),c("#quiz_tabs").tabs(),c("#editor_tabs").show();var e=c("#quiz_options_form"),h=c("#quiz_edit_wrapper");c.scrollSidebar(),c(".datetime_field").datetime_field(),c("#questions").delegate(".group_top,.question,.answer_select","mouseover",function(a){c(this).addClass("hover")}).delegate(".group_top,.question,.answer_select","mouseout",function(a){c(this).removeClass("hover")}),c("#questions").delegate(".answer","mouseover",function(a){c("#questions .answer.hover").removeClass("hover"),c(this).addClass("hover")}),e.find("#extend_due_at").change(function(){c("#quiz_lock_after").showIf(c(this).attr("checked"))}).change(),e.find("#multiple_attempts_option").change(function(a){c("#multiple_attempts_suboptions").showIf(c(this).attr("checked"));var b=c("#multiple_attempts_suboptions #quiz_allowed_attempts");b.val()=="-1"&&b.val("1")}).triggerHandler("change"),e.find("#time_limit_option").change(function(a,b){c(this).attr("checked")?b||c("#quiz_time_limit").focus():c("#quiz_time_limit").val("")}).triggerHandler("change",[!0]),c("#limit_attempts_option").change(function(a,b){var d=c("#quiz_allowed_attempts");if(c(this).attr("checked")){var e=parseInt(d.data("saved_value")||d.val()||"2",10);if(e==-1||isNaN(e))e=1;d.val(e),b||d.focus()}else d.data("saved_value",c(this).val()),d.val("--")}).triggerHandler("change",[!0]),c("#protect_quiz").change(function(){var a=c(this).attr("checked");c(".protected_options").showIf(a).find(":checkbox").each(function(){a||c(this).attr("checked",!1).change()})}).triggerHandler("change"),c("#quiz_require_lockdown_browser").change(function(){c("#lockdown_browser_suboptions").showIf(c(this).attr("checked")),c("#quiz_require_lockdown_browser_for_results").attr("checked",!0).change()}),c("#lockdown_browser_suboptions").showIf(c("#quiz_require_lockdown_browser").attr("checked")),c("#ip_filter").change(function(a,b){c("#ip_filter_suboptions").showIf(c(this).attr("checked")),c(this).attr("checked")?b||c("#quiz_ip_filter").focus():c("#quiz_ip_filter").val("")}).triggerHandler("change",[!0]),c("#ip_filters_dialog").delegate(".ip_filter","click",function(a){a.preventDefault();var b=c(this).getTemplateData({textValues:["filter"]}).filter;c("#protect_quiz").attr("checked",!0).triggerHandler("change"),c("#ip_filter").attr("checked",!0).triggerHandler("change"),c("#quiz_ip_filter").val(b),c("#ip_filters_dialog").dialog("close")}),c(".ip_filtering_link").click(function(b){b.preventDefault();var d=c("#ip_filters_dialog");d.dialog({width:400,title:a.t("titles.ip_address_filtering","IP Address Filtering")});if(!d.hasClass("loaded")){d.find(".searching_message").text(a.t("retrieving_filters","Retrieving Filters..."));var e=ENV.QUIZZES_URL;c.ajaxJSON(e,"GET",{},function(b){d.addClass("loaded");if(b.length){for(var c in b){var e=b[c],f=d.find(".ip_filter.blank:first").clone(!0).removeClass("blank");f.fillTemplateData({data:e}),d.find(".filters tbody").append(f.show())}d.find(".searching_message").hide().end().find(".filters").show()}else d.find(".searching_message").text(a.t("no_filters_found","No filters found"))},function(b){d.find(".searching_message").text(a.t("errors.retrieving_filters_failed","Retrieving Filters Failed"))})}}),c("#require_access_code").change(function(a,b){c("#access_code_suboptions").showIf(c(this).attr("checked")),c(this).attr("checked")?b||c("#quiz_access_code").focus():c("#quiz_access_code").val("")}).triggerHandler("change",[!0]),c("#never_hide_results").change(function(){var a=c(this);c(".show_quiz_results_options").showIf(a.attr("checked")),a.attr("checked")||(c("#hide_results_only_after_last").attr("checked",!1),c("#quiz_show_correct_answers").attr("checked",!1))}).triggerHandler("change"),c("#quiz_one_question_at_a_time").change(function(){var a=c(this);c("#one_question_at_a_time_options").showIf(a.attr("checked")),a.attr("checked")||c("#quiz_cant_go_back").attr("checked",!1)}).triggerHandler("change"),c("#multiple_attempts_option,#limit_attempts_option,#quiz_allowed_attempts").change(function(){var b=c("#multiple_attempts_option").prop("checked")&&c("#limit_attempts_option").prop("checked");if(b){c("#hide_results_only_after_last_holder").show();var d=c("#quiz_allowed_attempts"),e=d.val();isNaN(e)?(alert(a.t("quiz_attempts_nan_error","Quiz attempts can only be specified in numbers")),d.val("")):e.length>3&&(alert(a.t("quiz_attempts_length_error","Quiz attempts are limited to 3 digits, if you would like to give your students unlimited attempts, do not check Allow Multiple Attempts box to the left")),d.val(""))}else c("#hide_results_only_after_last").attr("checked",!1),c("#hide_results_only_after_last_holder").hide()}).triggerHandler("change");var i=!1;e.formSubmit({object_name:"quiz",processData:function(d){c(this).attr("method","PUT");var f=c("#quiz_title").val();if(f.length==0){var g=c("#quiz_title").errorBox(a.t("errors.field_is_required","This field is required")).offset();return c("html,body").scrollTo({top:g.top,left:0}),!1}d["quiz[title]"]=f,d["quiz[description]"]=c("#quiz_description").editorBox("get_code"),c("#quiz_notify_of_update").is(":checked")&&(d["quiz[notify_of_update]"]=c("#quiz_notify_of_update").val());var h=1;if(d.multiple_attempts){h=parseInt(d.allowed_attempts,10);if(isNaN(h)||!d.limit_attempts)h=-1}d.allowed_attempts=h,d["quiz[allowed_attempts]"]=h,q.updateOverrides();var j=q.getOverrides(),k=q.getDefaultDueDate();k?k=k.toJSON().assignment_override:k={};var l={assignment_overrides:q.getAllDates(k)},n=q.validateBeforeSave(l,{});if(b.keys(n).length>0)return!1;if(q.containsSectionsWithoutOverrides()&&!i){sections=q.sectionsWithoutOverrides();var o=new m({validationFn:function(){return sections},labelFn:function(a){return a.get("name")},success:function(){o.$dialog.dialog("close").remove(),o.remove(),i=!0,e.trigger("submit")}});return o.cancel=function(){o.$dialog.dialog("close").remove()},o.render(),!1}var p=q.getDefaultDueDate();return p?(p=p.toJSON().assignment_override,t([p]),d["quiz[due_at]"]=p.due_at||"",d["quiz[unlock_at]"]=p.unlock_at||"",d["quiz[lock_at]"]=p.lock_at||""):(d["quiz[due_at]"]="",d["quiz[unlock_at]"]="",d["quiz[lock_at]"]=""),t(j),j.length===0&&(j=!1),d["quiz[assignment_overrides]"]=j,d},beforeSubmit:function(b){h.find(".btn.save_quiz_button").attr("disabled",!0).text(a.t("buttons.saving","Saving..."))},success:function(b){var d=c(this);h.find(".btn.save_quiz_button").text(a.t("buttons.saved","Saved!"));if(b.quiz.assignment){var e=b.quiz.assignment;if(c("#assignment_option_"+e.id).length===0){if(e.assignment_group&&c("#assignment_group_optgroup_"+e.assignment_group_id).length===0){var f=e.assignment_group,g=c(document.createElement("optgroup"));g.attr("label",f.name).attr("id","assignment_group_optgroup_"+f.id)}var i=c("#assignment_group_optgroup_"+e.assignment_group_id),j=c(document.createElement("option"));j.attr("id","assignment_option_"+e.id).val(e.id).text(e.title),i.append(j)}}c(".show_rubric_link").showIf(b.quiz.assignment),c("#quiz_assignment_id").val(b.quiz.quiz_type||"practice_quiz").change(),location.href=c(this).attr("action"),x.updateDisplayComments()},error:function(a){c(this).formErrors(a),h.find(".btn.save_quiz_button").attr("disabled",!1)}}),h.find(".save_quiz_button").click(function(a){a.preventDefault(),a.stopPropagation(),e.data("submit_type","save_only").submit()}).end(),c("#show_question_details").change(function(a){c("#questions").toggleClass("brief",!c(this).attr("checked"))}).triggerHandler("change"),c(".start_over_link").click(function(b){b.preventDefault();var c=confirm(a.t("confirms.scrap_and_restart","Scrap this quiz and start from scratch?"));c&&(location.href=location.href+"?fresh=1")}),c("#quiz_assignment_id").change(function(b){var d=c("#quiz_options").getTemplateData({textValues:["assignment_id","title"]}),e=c("#quiz_assignment_id").val(),f=c("#quiz_title_input").val();if(e){var g=c("#quiz_assignment_id")[0];f=c(g.options[g.selectedIndex]).text()}else d.assignment_id&&(f=a.t("default_quiz_title","Quiz"));var h={"quiz[assignment_id]":e,"quiz[title]":f};c("#quiz_title").showIf(!0),c("#quiz_options_form .quiz_survey_setting").showIf(e&&e.match(/survey/)),c("#quiz_points_possible").showIf(e=="graded_survey"),c("#survey_instructions").showIf(e=="survey"||e=="graded_survey"),c("#quiz_assignment_group_id").closest(".control-group").showIf(e=="assignment"||e=="graded_survey"),c("#questions").toggleClass("survey_quiz",e=="survey"||e=="graded_survey"),c("#quiz_display_points_possible").showIf(e!="survey"&&e!="graded_survey"),c("#quiz_options_holder").toggleClass("survey_quiz",e=="survey"||e=="graded_survey");var i=c("#quiz_urls .update_quiz_url").attr("href");c("#quiz_title_input").val(f),c("#quiz_title_text").text(f)}).change(),c(".question_form :input").keycodes("esc",function(b){c(this).parents("form").find("input[value='"+a.t("#buttons.cancel","Cancel")+"']").click()}),c(document).delegate(".blank_id_select","change",function(){var a=c(this).val(),b=c(this)[0].selectedIndex;c(this).closest(".question").find(".answer").css("display","none"),a?(a!="0"&&c(this).closest(".question").find(".answer.answer_idx_"+b).filter(":not(.answer_for_"+a+")").each(function(){c(this).attr("class",c(this).attr("class").replace(/answer_for_[A-Za-z0-9]+/g,"")),c(this).addClass("answer_for_"+a)}),c(this).closest(".question").find(".answer.answer_for_"+a).css("display","")):(c(this).closest(".question").find(".answer").css("display",""),c(this).closest(".question").find(".answer.answer_idx_"+b).css("display",""))}),c(".blank_id_select").change(),c(document).delegate(".delete_question_link","click",function(b){b.preventDefault(),c(this).parents(".question_holder").confirmDelete({url:c(this).parents(".question_holder").find(".update_question_url").attr("href"),message:a.t("confirms.delete_question","Are you sure you want to delete this question?"),success:function(a){c(this).remove(),x.updateDisplayComments()}})}),c(document).delegate(".edit_question_link","click",function(b){b.preventDefault();var d=c(this).parents(".question"),e=d.getTemplateData({textValues:["question_type","correct_comments","incorrect_comments","neutral_comments","question_name","question_points","answer_selection_type","blank_id"],htmlValues:["question_text","correct_comments_html","incorrect_comments_html","neutral_comments_html"]});e.question_text=d.find("textarea[name='question_text']").val();var f=[];d.find(".matching_answer_incorrect_matches_list li").each(function(){f.push(c(this).text())}),e.matching_answer_incorrect_matches=f.join("\n"),e.question_points=parseFloat(e.question_points,10),isNaN(e.question_points)&&(e.question_points=0);var g=c("#question_form_template").clone(!0).attr("id",""),h=g.find(".question");g.fillFormData(e),E(g.find(".question_correct_comment"),e,"correct_comments"),E(g.find(".question_incorrect_comment"),e,"incorrect_comments"),E(g.find(".question_neutral_comment"),e,"neutral_comments"),h.addClass("selectable"),g.find(".answer_selection_type").change().show(),e.question_type!="missing_word_question"&&g.find("option.missing_word").remove();if(d.hasClass("missing_word_question")||e.question_type=="missing_word_question")e=d.getTemplateData({textValues:["text_before_answers","text_after_answers"]}),answer_data=d.find(".original_question_text").getFormData(),e.text_before_answers=answer_data.question_text,e.text_after_answers=answer_data.text_after_answers,e.question_text=e.text_before_answers,g.fillFormData(e);var i=x.updateFormQuestion(g);g.find(".form_answers").empty();if(i.question_type=="calculated_question"){var e=B(d).questions[0];g.find(".combinations_holder .combinations thead tr").empty();for(var j in e.variables){var k=c(g.find(".variables .variable."+e.variables[j].name));e.variables[j].name=="variable"&&(k=c(g.find(".variables .variable").get(j))),k&&k.length>0&&(k.find(".min").val(e.variables[j].min),k.find(".max").val(e.variables[j].max),k.find(".round").val(e.variables[j].scale));var l=c("<th/>");l.text(e.variables[j].name),l.attr("id","possible_solution_"+e.variables[j].name),g.find(".combinations_holder .combinations thead tr").append(l)}var l=c("<th class='final_answer'/>");l.text(a.t("final_answer","Final Answer")),l.attr("id","possible_solution_final"),g.find(".combinations_holder .combinations thead tr").append(l);for(var j in e.formulas)g.find(".supercalc").val(e.formulas[j]),g.find(".decimal_places .round").val(e.formula_decimal_places),g.find(".save_formula_button").click();e.answer_tolerance&&g.find(".combination_answer_tolerance").val(e.answer_tolerance),g.find(".combination_count").val(e.answers.length);for(var j in e.answers){var m=c("<tr/>");for(var n in e.answers[j].variables){var o=c("<td/>");o.text(e.answers[j].variables[n].value),o.attr("aria-labelledby","possible_solution_"+e.answers[j].variables[n].name),m.append(o)}var p=e.answers[j].answer_text;e.answer_tolerance&&(p=p+" <span style='font-size: 0.8em;'>+/-</span> "+e.answer_tolerance);var o=c("<td class='final_answer'/>");o.html(p),o.attr("aria-labelledby","possible_solution_final"),m.append(o),g.find(".combinations tbody").append(m),g.find(".combinations_holder").show()}g.triggerHandler("settings_change",!1),h.triggerHandler("recompute_variables",!0)}else d.find(".text > .answers .answer").each(function(){var a=c(this).getTemplateData({textValues:i.textValues,htmlValues:i.htmlValues});a.answer_type=i.answer_type,a.question_type=i.question_type;var b=A(a);g.find(".form_answers").append(b)});(d.hasClass("essay_question")||d.hasClass("file_upload"))&&h.find(".comments_header").text(a.beforeLabel("comments_on_question","Comments for this question")),d.hide().after(g),x.showFormQuestion(g),g.attr("action",d.find(".update_question_url").attr("href")).attr("method","POST").find(".submit_button").text(a.t("buttons.update_question","Update Question")),g.find(":input:visible:first").focus().select(),c("html,body").scrollTo({top:g.offset().top-10,left:0}),setTimeout(function(){h.find(".question_content").triggerHandler("change"),h.addClass("ready")},100)}),c(".question_form :input[name='question_type']").change(function(){x.updateFormQuestion(c(this).parents(".question_form"))}),c("#question_form_template .cancel_link").click(function(a){a.preventDefault();var b=c(this).parents("form").prev(),d=b.attr("id")=="question_new";d||c(this).parents("form").remove(),b.show(),c("html,body").scrollTo({top:b.offset().top-10,left:0}),d&&(b.parent().remove(),x.updateDisplayComments()),x.updateDisplayComments()}),c(document).delegate("a.comment_focus","focus click",function(a){a.preventDefault(),c(this).parents(".question_comment,.answer_comments").removeClass("empty").find("textarea.comments").focus().select()}),c(document).delegate("textarea.comments","focus",function(){c(this).parents(".question_comment,.answer_comments").removeClass("empty")}).delegate("textarea.comments","blur",function(){c(this).val(c.trim(c(this).val())),c(this).val()==""&&c(this).parents(".question_comment,.answer_comments").addClass("empty")}),c(document).delegate(".numerical_answer_type","change",function(){var a=c(this).val(),b=c(this).parents(".numerical_answer");b.find(".numerical_answer_text").hide(),b.find("."+a).show()}).change(),c(document).delegate(".select_answer_link","click",function(a){a.preventDefault();var b=c(this).parents(".question");if(!b.hasClass("selectable"))return;b.find(":input[name='question_type']").val()!="multiple_answers_question"?(b.find(".answer:visible").removeClass("correct_answer").find(".select_answer_link").attr("title",u).find("img").attr("alt",u),c(this).attr("title",v).find("img").attr("alt",v).closest(".answer").addClass("correct_answer")):(c(this).parents(".answer").toggleClass("correct_answer"),c(this).parents(".answer").hasClass("correct_answer")?c(this).attr("title",w).find("img").attr("alt",w):c(this).attr("title",u).find("img").attr("alt",u))}),c(".question_form :input").change(function(){if(c(this).parents(".answer").length>0){var a=c(this).parents(".answer");a.find(":input[name='"+c(this).attr("name")+"']").val(c(this).val())}}),c(".question_form select.answer_selection_type").change(function(){c(this).val()=="single_answer"?c(this).parents(".question").removeClass("multiple_answers"):c(this).parents(".question").addClass("multiple_answers")}).change(),c(".delete_answer_link").click(function(a){a.preventDefault();var b=c(this).parents(".answer"),d=b.closest(".question").find(".answers_header");b.remove(),d.focus()}),c(".add_question_group_link").click(function(b){b.preventDefault();if(G())return;c(".question_form .submit_button:visible,.quiz_group_form .submit_button:visible").each(function(){c(this).parents("form").submit()});var d=c("#group_top_template").clone(!0).attr("id","group_top_new"),e=c("#group_bottom_template").clone(!0).attr("id","group_bottom_new");c("#questions").append(d.show()).append(e.show()),d.find(".edit_group_link").click(),d.find(".quiz_group_form").attr("action",c("#quiz_urls .add_group_url").attr("href")).attr("method","POST"),d.find(".submit_button").text(a.t("buttons.create_group","Create Group"))}),c(".add_question_link").click(function(b){b.preventDefault();if(G())return;c(".question_form:visible,.group_top.editing .quiz_group_form:visible").submit();var d=y();if(c(this).parents(".group_top").length>0){var e=c(this).parents(".group_top").next();while(e.length>0&&!e.hasClass("group_bottom"))e=e.next();e.before(d.addClass("group"))}else c("#questions").append(d);d.find(".edit_question_link:first").click();var f=d.parents(".question_holder").children("form");f.attr("action",c("#quiz_urls .add_question_url,#bank_urls .add_question_url").attr("href")).attr("method","POST").find(".submit_button").html(a.t("buttons.create_question","Create Question")),f.find("option.missing_word").remove(),d.find(".question_type").change(),c("html,body").scrollTo({top:d.offset().top-10,left:0}),d.find(":input:first").focus().select()}),x.$questions.delegate('.group_top input[name="quiz_group[pick_count]"]',{focus:function(){c(this).data("prev-value",this.value)},change:function(){G(!0)&&(this.value=c(this).data("prev-value"))}});var j=c("#find_bank_dialog");c(".find_bank_link").click(function(b){b.preventDefault();var d=j;d.data("form",c(this).closest(".quiz_group_form"));if(!d.hasClass("loaded")){d.data("banks",{}),d.find(".find_banks").hide(),d.find(".message").show().text(a.t("loading_question_banks","Loading Question Banks..."));var e=d.find(".find_question_banks_url").attr("href");c.ajaxJSON(e,"GET",{},function(a){d.find(".message").hide(),d.find(".find_banks").show(),d.addClass("loaded");for(idx in a){var b=a[idx].assessment_question_bank;b.title=o.truncateText(b.title);var c=d.find(".bank.blank:first").clone(!0).removeClass("blank");c.fillTemplateData({data:b,dataValues:["id","context_type","context_id"]}),d.find(".bank_list").append(c),c.data("bank_data",b),c.show()}},function(b){d.find(".message").text(a.t("errors.loading_banks_failed","Question Banks failed to load, please try again"))})}d.find(".bank.selected").removeClass("selected"),d.find(".submit_button").attr("disabled",!0),d.dialog({title:a.t("titles.find_question_bank","Find Question Bank"),width:600,height:400})}),j.delegate(".bank","click",function(){j.find(".bank.selected").removeClass("selected"),c(this).addClass("selected"),j.find(".submit_button").attr("disabled",!1)}).delegate(".submit_button","click",function(){var a=j.find(".bank.selected:first"),b=a.getTemplateData({textValues:["title"],dataValues:["id","context_id","context_type"]}),d=j.data("form");d.find(".bank_id").val(b.id),b.bank_name=b.title;var e=d.closest(".group_top").next(".assessment_question_bank");e.length==0&&(e=c("#group_top_template").next(".assessment_question_bank").clone(!0),d.closest(".group_top").after(e)),e.show().fillTemplateData({data:b}).data("bank_data",b),j.dialog("close")}).delegate(".cancel_button","click",function(){j.dialog("close")});var k=c("#find_question_dialog");c(".find_question_link").click(function(b){b.preventDefault();var d=k;if(!d.hasClass("loaded")){d.data("banks",{}),d.find(".side_tabs_table").hide(),d.find(".message").show().text(a.t("loading_question_banks","Loading Question Banks..."));var e=d.find(".find_question_banks_url").attr("href");c.ajaxJSON(e,"GET",{},function(a){d.find(".message").hide(),d.find(".side_tabs_table").show(),d.addClass("loaded");for(idx in a){var b=a[idx].assessment_question_bank;b.title=o.truncateText(b.title);var c=d.find(".bank.blank:first").clone(!0).removeClass("blank");c.fillTemplateData({data:b}),d.find(".bank_list").append(c),c.data("bank_data",b),c.show()}d.find(".bank:not(.blank):first").click()},function(b){d.find(".message").text(a.t("errors.loading_banks_failed","Question Banks failed to load, please try again"))})}d.data("add_source",""),d.dialog({title:a.t("titles.find_quiz_question","Find Quiz Question"),open:function(){d.find(".selected_side_tab").length==0&&d.find(".bank:not(.blank):first").click()},width:600,height:400})});var l=function(a){var b=[];k.find(".quiz_group_select").find("option.group").remove(),k.find(".quiz_group_select_holder").show(),c("#questions .group_top:visible").each(function(){var a={};a.id=c(this).attr("id").substring(10),a.name=c(this).getTemplateData({textValues:["name"]}).name;var b=c("<option/>");b.text(o.truncateText(a.name)),b.val(a.id),b.addClass("group"),k.find(".quiz_group_select option.bottom").before(b)}),a&&c("#quiz_group_select").val(a),c("#quiz_group_select").val()=="new"&&c("#quiz_group_select").val("none"),c("#quiz_group_select").change()};c("#quiz_group_select").change(function(){if(c(this).val()=="new"){var b=c("#add_question_group_dialog"),d=[];k.find(".question_list :checkbox:checked").each(function(){d.push(c(this).parents(".found_question").data("question_data").id)}),b.find(".questions_count").text(d.length),b.find("button").attr("disabled",!1).filter(".submit_button").text(a.t("buttons.create_group","Create Group")),b.dialog({width:400})}}),c("#add_question_group_dialog .submit_button").click(function(b){var d=c("#add_question_group_dialog");d.find("button").attr("disabled",!0).filter(".submit_button").text(a.t("buttons.creating_group","Creating Group..."));var e=d.getFormData(),f=d.find(".add_question_group_url").attr("href");c.ajaxJSON(f,"POST",e,function(b){d.find("button").attr("disabled",!1).filter(".submit_button").text(a.t("buttons.create_group","Create Group"));var e=c("#group_top_template").clone(!0).attr("id","group_top_new"),f=c("#group_bottom_template").clone(!0).attr("id","group_bottom_new");c("#questions").append(e.show()).append(f.show());var g=b.quiz_group;e.fillTemplateData({data:g,id:"group_top_"+g.id,hrefValues:["id"]}),e.fillFormData(b,{object_name:"quiz_group"}),c("#unpublished_changes_message").slideDown(),f.attr("id","group_bottom_"+g.id),x.updateDisplayComments(),l(b.quiz_group.id),d.dialog("close")},function(b){d.find("button").attr("disabled",!1).filter(".submit_button").text(a.t("errors.creating_group_failed","Create Group Failed, Please Try Again"))})}),c("#add_question_group_dialog .cancel_button").click(function(a){c("#add_question_group_dialog").dialog("close"),c("#quiz_group_select").val("none")});var n=function(a){var b=a.questions,d=k.find(".bank.selected_side_tab"),e=d.data("bank_data"),f=k.data("banks")[e.id];if(!d.hasClass("selected_side_tab"))return;var g={};c(".display_question:visible").each(function(){var a=parseInt(c(this).getTemplateData({textValues:["assessment_question_id"]}).assessment_question_id,10);a&&(g[a]=!0)}),k.find(".page_link").showIf(f.pages&&f.last_page&&f.pages>f.last_page),l();var h=c("<div/>");for(var i in b){var j=b[i].assessment_question;if(!g[j.id]||!0){h.html(j.question_data.question_text),j.question_text=o.truncateText(h.text(),{max:75}),j.question_name=j.question_data.question_name;var m=k.find(".found_question.blank").clone(!0).removeClass("blank");m.toggleClass("already_added",!!g[j.id]),m.fillTemplateData({data:j}),m.find(":checkbox").attr("id","find_bank_question_"+j.id),m.find("label").attr("for","find_bank_question_"+j.id),m.data("question_data",j),k.find(".question_list").append(m),m.show()}}};c("#find_question_dialog").delegate(".bank","click",function(b){b.preventDefault();var d=c(this).getTemplateData({textValues:["id"]}).id,e=k.data("banks")[d];k.find(".bank").removeClass("selected"),k.find(".selected_side_tab").removeClass("selected_side_tab"),c(this).addClass("selected_side_tab"),k.find(".page_link").data("page",0),e&&e.last_page&&k.find(".page_link").data("page",e.last_page),e?(k.find(".found_question:visible").remove(),n(e)):(k.find(".found_question:visible").remove(),k.find(".page_link").click(),k.find(".question_list_holder").hide(),k.find(".question_message").show().text(a.t("loading_questions","Loading Questions...")))}).delegate(".page_link","click",function(b){b.preventDefault();var d=c(this);if(d.hasClass("loading"))return;d.addClass("loading"),k.find(".page_link").text(a.t("loading_more_questions","loading more questions..."));var e=k.find(".bank.selected_side_tab"),f=e.data("bank_data"),g=k.find(".question_bank_questions_url").attr("href");g=c.replaceTags(g,"question_bank_id",f.id);var h=(k.find(".page_link").data("page")||0)+1;g+="&page="+h,c.ajaxJSON(g,"GET",{},function(b){d.removeClass("loading"),k.find(".page_link").data("page",h),k.find(".page_link").text(a.t("more_questions","more questions"));var c=b.questions,e=k.data("banks")||{},g=e[f.id]||{};g.pages=b.pages,g.questions=(g.questions||[]).concat(b.questions),g.last_page=h,e[f.id]=g,k.data("banks",e),k.find(".question_message").hide(),k.find(".question_list_holder").show(),n(b)},function(b){d.removeClass("loading"),k.find(".question_message").text(a.t("errors.loading_questions_failed","Questions failed to load, please try again")),k.find(".page_link").text(a.t("errors.loading_more_questions_failed","loading more questions failed"))})}).delegate(".select_all_link","click",function(a){a.preventDefault(),k.find(".question_list .found_question:not(.blank) :checkbox").attr("checked",!0)}).delegate(".clear_all_link","click",function(a){a.preventDefault(),k.find(".question_list .found_question:not(.blank) :checkbox").attr("checked",!1)}).delegate(".cancel_button","click",function(a){k.dialog("close")}).delegate(".group_button","click",function(b){var d=c("#add_found_questions_as_group_dialog"),e=[];k.find(".question_list :checkbox:checked").each(function(){e.push(c(this).parents(".found_question").data("question_data").id)}),d.find(".questions_count").text(e.length),d.dialog({autoOpen:!1,title:a.t("titles.add_questions_as_group","Add Questions as a Group")})}).delegate(".submit_button","click",function(b){var d=[];k.find(".question_list :checkbox:checked").each(function(){d.push(c(this).parents(".found_question").data("question_data").id)});var e={};e.quiz_group_id=k.find(".quiz_group_select").val(),e.assessment_question_bank_id=k.find(".bank.selected_side_tab:first").data("bank_data").id,e.assessment_questions_ids=d.join(","),e.existing_questions="1";var f=k.find(".add_questions_url").attr("href");k.find("button").attr("disabled",!0).filter(".submit_button").text(a.t("buttons.adding_questions","Adding Questions...")),c.ajaxJSON(f,"POST",e,function(b){function d(){c++;var a=b.shift();a&&(x.addExistingQuestion(a.quiz_question),c>5?setTimeout(d,50):d())}k.find("button").attr("disabled",!1).filter(".submit_button").text(a.t("buttons.add_selected_questions","Add Selected Questions")),k.find(".selected_side_tab").removeClass("selected_side_tab");var c=0;setTimeout(d,10),k.dialog("close")},function(b){k.find("button").attr("disabled",!1).filter(".submit_button").text(a.t("errors.adding_questions_failed","Adding Questions Failed, please try again"))})}),c(".add_answer_link").bind("click",function(b,d){b.preventDefault();var e=c(this).parents(".question"),f=[],g=null,h=null,i="single_answer";if(e.hasClass("multiple_choice_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="select_answer",h="multiple_choice_question"}else{if(e.hasClass("true_false_question"))return;if(e.hasClass("short_answer_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="short_answer",h="short_answer_question",i="any_answer"}else if(e.hasClass("essay_question")){var f=[{comments:a.t("default_response_to_essay","Response to show student after they submit an answer")}];g="comment",h="essay_question"}else if(e.hasClass("file_upload_question")){var f=[{comments:a.t("default_response_to_file_upload","Response to show student after they submit an answer")}];g="comment",h="file_upload_question"}else if(e.hasClass("matching_question")){var f=[{comments:a.t("default_comments_on_wrong_match","Response if the user misses this match")}];g="matching_answer",h="matching_question",i="matching"}else if(e.hasClass("missing_word_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="short_answer",h="missing_word_question"}else if(e.hasClass("numerical_question")){var f=[{numerical_answer_type:"exact_answer",answer_exact:"#",answer_error_margin:"#",comments:a.t("default_answer_comments_on_match","Response if the student matches this answer")}];g="numerical_answer",h="numerical_question",i="any_answer"}else if(e.hasClass("multiple_answers_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="select_answer",h="multiple_answers_question",i="multiple_answers"}else if(e.hasClass("multiple_dropdowns_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="select_answer",h="multiple_dropdowns_question"}else if(e.hasClass("fill_in_multiple_blanks_question")){var f=[{comments:a.t("default_answer_comments","Response if the student chooses this answer")}];g="short_answer",h="fill_in_multiple_blanks_question",i="any_answer"}}for(var j=0;j<f.length;j++){var k=f[j];k.answer_type=g,k.question_type=h,k.blank_id=e.find(".blank_id_select").val(),k.blank_index=e.find(".blank_id_select")[0].selectedIndex,$answer=A(k),i=="any_answer"?$answer.addClass("correct_answer"):i=="matching"&&$answer.removeClass("correct_answer"),e.find(".form_answers").append($answer.show()),d||(c("html,body").scrollTo($answer),$answer.find(":text:visible:first").focus().select())}}),c(document).delegate(".answer_comment_holder","click",function(a){c(this).find(".answer_comment").slideToggle()}),c("#question_form_template").submit(function(d){d.preventDefault(),d.stopPropagation();var e=c(this).prev(),f=c(this),g=f.find(".answer"),h=c(this).find(".question"),i=[],j=h.getFormData({values:["question_type","question_name","question_points","correct_comments","incorrect_comments","neutral_comments","question_text","answer_selection_type","text_after_answers","matching_answer_incorrect_matches"]});f.find(".edit_html_done").trigger("click"),j.assessment_question_bank_id=c(".question_bank_id").text()||"";var k=null;if(j.question_type=="calculated_question")f.find(".combinations_holder .combinations tbody tr").length===0&&(k=a.t("errors.no_possible_solution","Please generate at least one possible solution"));else if(g.length===0||g.filter(".correct_answer").length===0)g.length===0&&!b.contains(["essay_question","file_upload_question","text_only_question"],j.question_type)?k=a.t("errors.no_answer","Please add at least one answer"):g.filter(".correct_answer").length===0&&(j.question_type=="multiple_choice_question"||j.question_type=="true_false_question"||j.question_tyep=="missing_word_question")&&(k=a.t("errors.no_correct_answer","Please choose a correct answer"));var l=c("#quiz_assignment_id").length==0||!c("#quiz_assignment_id").val().match(/survey/i);if(l&&k){f.find(".answers_header").errorBox(k,!0);return}var m=c.extend({},j);m.points_possible=parseFloat(m.question_points),m.answers=[],e.find(".blank_id_select").empty();var n={},o=!1;if(m.question_type=="multiple_dropdowns_question"||m.question_type=="fill_in_multiple_blanks_question")o=!0,h.find(".blank_id_select option").each(function(){n[c(this).text()]=!0});h.find(".blank_id_select option").each(function(){e.find(".blank_id_select").append(c(this).clone())});var g=h.find(".answer").each(function(b){var d=c(this);d.show();var e=d.getFormData();e.blank_id=d.find(".blank_id").text(),e.answer_text=d.find("input[name='answer_text']:visible").val(),e.answer_html=d.find(".answer_html").html(),j.question_type=="true_false_question"&&(e.answer_text=b==0?a.t("true","True"):a.t("false","False")),d.hasClass("correct_answer")?e.answer_weight=100:e.answer_weight=0;if(o&&e.blank_id&&!n[e.blank_id])return;m.answers.push(e)});if(h.hasClass("calculated_question")){m.answers=[],m.variables=[];var p={};h.find(".variables .variable").each(function(a){var b={};b.scale="0",b.name=c(this).find(".name").text(),b.scale=parseFloat(c(this).find(".round").val(),10)||0,b.min=parseFloat(c(this).find(".min").val(),10)||0,b.max=parseFloat(c(this).find(".max").val(),10)||0,p[b.name]=a,m.variables.push(b)}),m.formulas=[],h.find(".formulas .formula").each(function(){var a={};a.formula=c.trim(c(this).text()),m.formulas.push(a)}),m.formula_decimal_places=parseInt(h.find(".decimal_places .round").val(),10)||0,m.answer_tolerance=parseFloat(h.find(".combination_answer_tolerance").val(),10)||0,m.answerDecimalPoints=parseFloat(h.find(".combination_error_margin").val(),10)||0;var q=h.find(".combinations thead th");h.find(".combinations tbody tr").each(function(){var a={};a.variables=[],a.answer=parseFloat(c(this).find("td.final_answer").text(),10)||0,c(this).find("td:not(.final_answer)").each(function(b){var d={};d.name=c.trim(q.eq(b).text()),d.value=parseFloat(c(this).text(),10)||0,a.variables.push(d)}),a.variables=a.variables.sort(function(a,b){return p[a.name]-p[b.name]}),m.answers.push(a)})}x.updateDisplayQuestion(e,m);var r=x.answerTypeDetails(m.question_type),s=r.answer_type,t=r.question_type,u=r.n_correct;f.remove(),c("html,body").scrollTo({top:e.offset().top-10,left:0});var v=c("#quiz_urls .add_question_url,#bank_urls .add_question_url").attr("href"),w="POST",y=e.attr("id")=="question_new";y||(v=e.find(".update_question_url").attr("href"),w="PUT");var j=B(e),z=D(j),j=C(z);if(e.parent(".question_holder").hasClass("group")){var A=x.findContainerGroup(e.parent(".question_holder"));A&&(j["question[quiz_group_id]"]=A.attr("id").substring(10))}c("#assessment_question_bank_id").length>0&&(j["assessment_question[assessment_question_bank_id]"]=c("#assessment_question_bank_id").text()),e.loadingImage(),x.updateDisplayComments(),c.ajaxJSON(v,w,j,function(a){e.loadingImage("remove"),e.find(".question_name").focus();var b=a.quiz_question||a.assessment_question,d=c.extend({},b,b.question_data);d.assessment_question_id=d.assessment_question_id||b.assessment_question_id||b.id,x.updateDisplayQuestion(e,d,!0),e.trigger("saved"),c("#unpublished_changes_message").slideDown()},function(a){e.formErrors(a)})}),c("#sort_questions").sortable({revert:!1,update:function(a,b){var d=c(this).sortable("toArray");for(var e in d){var f=d[e];f&&f!="sort_question_blank"&&c("#"+f.substring(5)).appendTo(c("#questions"))}}}),c(document).delegate("input.float_value","keydown",function(a){a.keyCode>57&&a.keyCode<91&&a.preventDefault()}).delegate("input.float_value","change blur focus",function(a){x.parseInput(c(this),c(this).hasClass("long")?"float_long":"float")}),c("#questions").delegate(".question_teaser_link","click",function(b){function f(a){var b=c("#question_template").clone().removeAttr("id"),e=a,f=c.extend({},e,e.question_data);d.after(b),d.remove(),b.show(),b.find(".question_points").text(f.points_possible),x.updateDisplayQuestion(b.find(".display_question"),f,!0),d.hasClass("to_edit")&&b.find(".edit_question_link").click()}b.preventDefault();var d=c(this).parents(".question_teaser"),e=d.data("question");e?f(e):(d.find(".teaser.question_text").text(a.t("loading_question","Loading Question...")),c.ajaxJSON(d.find(".update_question_url").attr("href"),"GET",{},function(a){f(a.quiz_question)},function(){d.find(".teaser.question_text").text(a.t("errors.loading_question_failed","Loading Question Failed..."))}))}).delegate(".teaser.question_text","click",function(a){a.preventDefault(),c(this).parents(".question_teaser").find(".question_teaser_link").click()}).delegate(".edit_teaser_link","click",function(a){a.preventDefault(),c(this).parents(".question_teaser").addClass("to_edit"),c(this).parents(".question_teaser").find(".question_teaser_link").click()}),c(".keep_editing_link").click(function(a){a.preventDefault(),c(".question_generated,.question_preview").hide(),c(".question_editing").show(),c("html,body").scrollTo(c("#questions"))}),c(".quiz_group_form").formSubmit({object_name:"quiz_group",beforeSubmit:function(a){var b=c(this),d=b.parents(".group_top");d.fillTemplateData({data:a}).removeClass("editing"),b.loadingImage()},success:function(a){var b=c(this),d=b.parents(".group_top"),e=a.quiz_group;b.loadingImage("remove"),d.removeClass("editing"),d.fillTemplateData({data:e,id:"group_top_"+e.id,hrefValues:["id"]}),d.toggleClass("question_bank_top",!!e.assessment_question_bank_id);var g=d.next(".assessment_question_bank");if(!e.assessment_question_bank_id)g.remove();else if(g.data("bank_data")){var h=g.data("bank_data");h.bank_id=h.id,h.context_type_string=f(c.underscore(h.context_type)),d.next(".assessment_question_bank").fillTemplateData({data:h,hrefValues:["bank_id","context_type_string","context_id"]}).find(".bank_name").hide().filter(".bank_name_link").show()}d.find(".find_bank_link").hide(),d.fillFormData(a,{object_name:"quiz_group"});var i=d.next();while(i.length>0&&!i.hasClass("group_bottom"))i=i.next();c("#unpublished_changes_message").slideDown(),i.attr("id","group_bottom_"+e.id),x.updateDisplayComments()},error:function(a){var b=c(this),d=b.parents(".group_top");d.addClass("editing"),b.loadingImage("remove"),b.formErrors(a)}}),c("#questions").sortable({handle:".move_icon",helper:function(a,b){return b.clone().removeClass("group")},items:".group_top,.group_bottom,.question_holder",tolerance:"pointer",start:function(a,b){b.placeholder.css("visibility","visible");if(b.item.hasClass("group_top")){b.helper.addClass("dragging");var c=b.item,d=[];while(c.length>0&&!c.hasClass("group_bottom"))c=c.next(),c.hasClass("ui-sortable-placeholder")||(d.push(c),c.hide());b.item.data("take_with",d),b.placeholder.show()}else x.findContainerGroup(b.placeholder)?b.placeholder.addClass("group"):b.placeholder.removeClass("group"),b.placeholder.append("<div class='question_placeholder' style='height: "+(b.helper.height()-10)+"px;'>&nbsp;</div>")},change:function(a,b){var d=x.findContainerGroup(b.placeholder);b.item.hasClass("group_top")?d&&(d.before(b.placeholder),c("html,body").scrollTo(b.placeholder)):(d?d.attr("id")=="group_top_new"?(d.before(b.placeholder),c("html,body").scrollTo(b.placeholder)):d.hasClass("question_bank_top")?d.before(b.placeholder).addClass("group"):b.placeholder.addClass("group"):b.placeholder.removeClass("group"),b.placeholder.height(b.helper.height()).find(".question_placeholder").height(b.helper.height()-10))},stop:function(a,b){if(b.item.hasClass("group_top")){var d=b.item.data("take_with");if(d){var e=b.item;for(var f in d){var g=d[f];e.after(g.show()),e=g}}}else if(x.findContainerGroup(b.item)){b.item.addClass("group");var e=b.item.prev();while(e.length>0&&!e.hasClass("group_top"))e=e.prev();e.find(".expand_link").click()}else b.item.removeClass("group");var h=c("#quiz_urls .reorder_questions_url, #bank_urls .reorder_questions_url").attr("href"),i={},j=c("#questions"),k=[];if(x.findContainerGroup(b.item)){j=x.findContainerGroup(b.item),$list=[],h=j.find(".reorder_group_questions_url").attr("href");var e=j.next();while(e.length>0&&!e.hasClass("group_bottom"))k.push(e),e=e.next()}else j.children(".question_holder:not(.group),.group_top").each(function(){k.push(c(this))});j.loadingImage();var l=[],m=c("#questions.question_bank").length>0;c.each(k,function(a,b){if(m){var c=b.find(".assessment_question_id").text();l.push(c)}else if(b.hasClass("question_holder")){var d=b.find(".question"),e=d.attr("id"),c=e?e.substring(9):d.find(".id").text();l.push("question_"+c)}else{var c="group_"+b.attr("id").substring(10);l.push(c)}});var i={order:l.join(",")};c.ajaxJSON(h,"POST",i,function(a){j.loadingImage("remove")})}}),c(document).delegate(".edit_group_link","click",function(b){if(c(this).closest(".group_top").length==0)return;b.preventDefault();var d=c(this).parents(".group_top"),e=d.getTemplateData({textValues:["name","pick_count","question_points"]});d.fillFormData(e,{object_name:"quiz_group"}),d.addClass("editing"),d.find(":text:visible:first").focus().select(),d.find(".quiz_group_form").attr("action",d.find(".update_group_url").attr("href")).attr("method","PUT"),d.find(".submit_button").text(a.t("buttons.update_group","Update Group"))}).delegate(".delete_group_link","click",function(a){if(c(this).closest(".group_top").length==0)return;a.preventDefault();var b=c(this).parents(".group_top"),d=c("nothing").add(b),e=b.next();while(e.length>0&&!e.hasClass("group_bottom"))d=d.add(e),e=e.next();d=d.add(e),b.confirmDelete({url:b.find(".update_group_url").attr("href"),confirmed:function(){d.dim()},success:function(){d.fadeOut(function(){c(this).remove(),x.updateDisplayComments()})}})}).delegate(".group_edit.cancel_button","click",function(a){if(c(this).closest(".group_top").length==0)return;var b=c(this).parents(".group_top");b.removeClass("editing");if(b.attr("id")=="group_top_new"){var d=b.next();while(d.length>0&&!d.hasClass("group_bottom")){var e=d;d.removeClass("group"),d=d.next(),e.hasClass("assessment_question_bank")&&e.remove()}d.remove(),b.remove()}x.updateDisplayComments()}).delegate(".collapse_link","click",function(a){if(c(this).closest(".group_top").length==0)return;a.preventDefault(),c(this).parents(".group_top").find(".collapse_link").addClass("hidden").end().find(".expand_link").removeClass("hidden");var b=c(this).parents(".group_top").next();while(b.length>0&&b.hasClass("question_holder"))b.hide(),b=b.next()}).delegate(".expand_link","click",function(a){if(c(this).closest(".group_top").length==0)return;a.preventDefault(),c(this).parents(".group_top").find(".collapse_link").removeClass("hidden").end().find(".expand_link").addClass("hidden");var b=c(this).parents(".group_top").next();while(b.length>0&&b.hasClass("question_holder"))b.show(),b=b.next()}),g&&(g.init(),g.attachToEditor(c("#quiz_description"))),c("#quiz_description").editorBox({tinyOptions:{aria_label:a.t("label.quiz.instructions","Quiz instructions, rich text area")}}),c(".toggle_description_views_link").click(function(a){a.preventDefault(),c("#quiz_description").editorBox("toggle")}),c(".toggle_question_content_views_link").click(function(a){a.preventDefault(),c(this).parents(".question_form").find(".question_content").editorBox("toggle")}),c(".toggle_text_after_answers_link").click(function(a){a.preventDefault(),c(this).parents(".question_form").find(".text_after_answers").editorBox("toggle")}),c(document).bind("editor_box_focus",function(a,b){g.attachToEditor(b)}),c("#calc_helper_methods").change(function(){var a=c(this).val();c("#calc_helper_method_description").text(d.functionDescription(a));var b="<pre>"+d.functionExamples(a).join("</pre><pre>")+"</pre>";c("#calc_helper_method_examples").html(b)}),c("#equations_dialog_tabs").tabs(),c(".delete_quiz_link").click(function(b){b.preventDefault(),c(this).parents(".quiz").confirmDelete({message:a.t("confirms.delete_quiz","Are you sure you want to delete this quiz?"),url:c(this).attr("href"),success:function(){window.location.replace(ENV.QUIZZES_URL)}})})}),c.fn.multipleAnswerSetsQuestion=function(){var b=c(this),d=b.find(".question_content"),e=b.find(".blank_id_select"),f=b.find(".question_type");if(b.data("multiple_sets_question_bindings"))return;b.data("multiple_sets_question_bindings",!0),d.bind("keypress",function(a){setTimeout(function(){c(a.target).triggerHandler("change")},50)}),d.bind("change",function(){var b=f.val();if(b!="multiple_dropdowns_question"&&b!="fill_in_multiple_blanks_question")return;var d=c(this).editorBox("get_code"),g=d.match(/\[[A-Za-z0-9_\-.]+\]/g);e.find("option.shown_when_no_other_options_available").remove(),e.find("option").addClass("to_be_removed");var h={};if(g)for(var i=0;i<g.length;i++)if(g[i]){var j=g[i].substring(1,g[i].length-1);if(!h[j]){var k=e.find("option").eq(i);k.length||(k=c("<option/>").appendTo(e)),k.removeClass("to_be_removed").val(j).text(j),h[j]=!0}}e.find("option:not(.shown_when_no_other_options_available)").length||e.append("<option class='shown_when_no_other_options_available' value='0'>"+a.t("enter_answer_variable_above","[ Enter Answer Variables Above ]")+"</option>"),e.find("option.to_be_removed").remove(),e.change()}).change(),e.change(function(){var a=f.val();if(a!="multiple_dropdowns_question"&&a!="fill_in_multiple_blanks_question")return;b.find(".form_answers .answer").hide().addClass("hidden"),e.find("option").each(function(a){var d=c(this);b.find(".form_answers .answer_for_"+c(this).val()).each(function(){c(this).attr("class",c(this).attr("class").replace(/answer_idx_\d+/g,""))}).addClass("answer_idx_"+a)});if(e.val()!=="0"){var d=e.val(),g=e[0].selectedIndex;g>=0&&b.find(".form_answers .answer").each(function(){var a=c(this);if(!a.attr("class").match(/answer_idx_/))if(a.attr("class").match(/answer_for_/)){var b=null,d=a.attr("class").match(/answer_for_[^\s]+/);d&&d[0]&&(d=d[0].substring(11)),e.find("option").each(function(a){c(this).text()==d&&(b=a)}),b===null&&(b=g),a.addClass("answer_idx_"+b)}else a.addClass("answer_idx_"+g)}),e.find("option").each(function(a){var d=c(this).text();b.find(".form_answers .answer.answer_idx_"+a).find(".blank_id").each(function(){c(this).text(d)})});var h=b.find(".form_answers .answer.answer_idx_"+g).show().removeClass("hidden");if(!h.length&&d&&d!=="0"){for(var i=0;i<2;i++)b.find(".add_answer_link").triggerHandler("click",!0);h=b.find(".form_answers .answer.answer_idx_"+g).show().removeClass("hidden")}h.filter(".correct_answer").length||h.filter(":first").addClass("correct_answer"),h.each(function(){c(this).find(".blank_id").text(d)})}}).change()},c.fn.formulaQuestion=function(){var b=c(this);if(b.data("formula_question_bindings"))return;b.data("formula_question_bindings",!0),b.find(".supercalc").superCalc({pre_process:function(){var a=[];return b.find(".variables .variable").each(function(){var b={name:c(this).attr("data-name"),value:c(this).attr("data-value")};a.push(b.name+" = "+b.value)}),a},formula_added:function(){b.triggerHandler("settings_change",!0)}}),b.find(".compute_combinations").click(function(){var d=c(this);d.text(a.t("buttons.generating","Generating...")).attr("disabled",!0);var e=b.find(".question_type").val();if(e!="calculated_question")return;var f=b.find(".combinations");f.find("thead tr").empty(),b.find(".variables .variable").each(function(){var a=c("<th/>");a.text(c(this).find(".name").text()),f.find("thead tr").append(a)});var g=c("<th/>");g.text(a.t("final_answer","Final Answer")),g.addClass("final_answer"),f.find("thead tr").append(g),f.find("tbody").empty();var h=parseInt(b.find(".combination_count").val(),10)||10;h<0?h=10:h>maxCombinations&&(h=maxCombinations),b.find(".combination_count").val(h);var i=0,j={},k=0,l=function(){b.find(".supercalc").superCalc("clear_cached_finds"),d.text("Generate").attr("disabled",!1),i==0?alert(a.t("alerts.no_valid_combinations","The system could not generate any valid combinations for the parameters given")):i<h&&alert(a.t("alerts.only_n_valid_combinations",{one:"The system could only generate 1 valid combination for the parameters given",other:"The system could only generate %{count} valid combinations for the parameters given"},{count:i})),b.triggerHandler("settings_change",!1)},m=0,n=0,o=b.find(".formulas .formula_row:last .status"),p=b.find(".variables .variable"),q=f.find("tbody");b.find(".supercalc").superCalc("cache_finds");var r=parseFloat(b.find(".combination_answer_tolerance").val(),10),s=function(){d.text(a.t("buttons.generating_combinations_progress","Generating... (%{done}/%{total})",{done:i,total:h}));var e=document.createDocumentFragment();for(var f=0;f<5&&i<h&&n<25;f++){p.each(function(){c(this).find(".variable_setting:first").trigger("change",{cache:!0})}),b.find(".supercalc").superCalc("recalculate",!0);var g=o.attr("data-res"),k=[];p.each(function(){k.push(c(this).attr("data-value"))});var t=parseFloat(g.substring(1),10);if(!j[k]||!0){if(g.match(/^=/)&&g!="= NaN"&&g!="= Infinity"&&t){var u=c("<tr/>");p.each(function(){var a=c("<td/>");a.html(c(this).attr("data-value")),u.append(a)});var v=c("<td/>");v.addClass("final_answer");var w=c.trim(g.substring(1)),x=r;x&&(w+=" <span style='font-size: 0.8em;'>+/-</span> "+x),v.html(w),u.append(v),i++,n=0,e.appendChild(u[0])}else n++;j[k]=!0}else n++}q[0].appendChild(e),d.text(a.t("buttons.generating_combinations_progress","Generating... (%{done}/%{total})",{done:i,total:h}));if(m>=h||i>=h||n>=25){l();return}m++,setTimeout(function(){s()},500)};setTimeout(s,100)}),b.find(".recompute_variables").click(function(){var a=b.find(".question_type").val();if(a!="calculated_question")return;b.triggerHandler("recompute_variables",!0)}),b.bind("recompute_variables",function(a,d){b.find(".variables .variable").each(function(){c(this).find(".variable_setting:first").trigger("change",d?null:{recompute:!0})})}),b.bind("settings_change",function(a,c){var d=b.find(".question_type").val();if(d!="calculated_question")return;var e=b.find(".variables tbody tr.variable").length>0,f=b.find(".formulas .formula").length>0;b.find(".combinations_option").attr("disabled",!e||!f),b.find(".variables_specified").showIf(e),b.find(".formulas_specified").showIf(f),b.hasClass("ready")&&c&&b.find(".combinations_holder .combinations tbody tr").remove(),b.find(".combinations_holder").showIf(b.find(".combinations tbody tr").length>0)}),b.find(".variables").delegate(".variable_setting","change",function(a,d){var e=b.find(".question_type").val();if(e!="calculated_question")return;var f=c(a.target).parents(".variable"),g=f.data("cached_data");if(!g||!d||!d.cache)g=f.getFormData(),g.min=parseFloat(g.min)||0,g.max=Math.max(g.min,parseFloat(g.max)||0),g.round=parseInt(g.round,10)||0,g.range=g.max-g.min,g.rounder=Math.pow(10,g.round)||1;d&&d.cache&&f.data("cached_data",g);var h=Math.random()*g.range+g.min;h=Math.round(h*g.rounder)/g.rounder,f.attr("data-value",h),(!d||d.template)&&f.find(".value").html(h);if(!d||d.recompute)b.find(".supercalc").superCalc("recalculate"),b.triggerHandler("settings_change",!0)}),b.find(".help_with_equations_link").click(function(b){b.preventDefault(),c("#calc_helper_methods").empty();var e=d.functionList();for(var f in e){var g=e[f][0],h=c("<option/>");h.val(g).text(g),c("#calc_helper_methods").append(h)}c("#calc_helper_methods").change(),c("#help_with_equations_dialog").dialog({title:a.t("titles.help_with_formulas","Help with Quiz Question Formulas"),width:500})}),b.find(".combinations_option").attr("disabled",!0),b.find(".question_content").bind("keypress",function(a){setTimeout(function(){c(a.target).triggerHandler("change")},50)}),b.find(".question_content").bind("change",function(a){var d=c(this).editorBox("get_code"),e=d.match(/\[[A-Za-z][A-Za-z0-9]*\]/g);b.find(".variables").find("tr.variable").addClass("to_be_removed"),b.find(".variables").showIf(e&&e.length>0);var f={};if(e)for(var g=0;g<e.length;g++)if(e[g]){var h=e[g].substring(1,e[g].length-1);if(!f[h]){var i=b.find(".variables tr.variable").eq(g);i.length===0&&(i=c("<tr class='variable'><td aria-labelledby='equation_var_name' class='name'></td><td aria-labelledby='equation_var_minimum'><input aria-labelledby='equation_var_minimum' type='text' name='min' class='min variable_setting' style='width: 30px;' value='1'/></td><td aria-labelledby='equation_var_maximum'><input aria-labelledby='equation_var_maximum' type='text' name='max' class='max variable_setting' style='width: 30px;' value='10'/></td><td aria-labelledby='equation_var_precision'><select aria-labelledby='equation_var_precision' name='round' class='round variable_setting'><option>0</option><option>1</option><option>2</option><option>3</option></td><td aria-labelledby='equation_var_example' class='value'></td></tr>"),b.find(".variables tbody").append(i),i.find(".variable_setting:first").triggerHandler("change")),i.removeClass("to_be_removed"),i.addClass(h),i.attr("data-name",h),i.find("td.name").text(h),f[h]=!0}}b.find(".variables").find("tr.to_be_removed").remove(),b.find(".supercalc").superCalc("recalculate",!0),b.triggerHandler("settings_change",!1)}).change()},c("#questions").delegate(".edit_html","click",function(b){b.preventDefault();var d=c(this),e=d.data("editorToggle");e||(e=new n(d,{editorBoxLabel:a.t("label.answer.text","Answer text, rich text area")}),d.data("editorToggle",e)),e.toggle()})})