define(["jquery","jqueryui/core","vendor/usher/scrollIntoView"],function(a){function b(c,d){return this instanceof b?(this.options=a.extend({},this.defaults,d),this.bindMethods(),this.$el=jQuery(c),this.eventProxy=a({}),this.initPopups(),this.attachEvents(),this.$el.hide(),this.constructor.addInstance(this),this):new b(c)}return b.prototype.defaults={position:!0,resetStyles:{opacity:0},offset:{x:20,y:20},animations:{left:{left:"-=20px",opacity:1},right:{left:"+=20px",opacity:1},bottom:{top:"+=20px",opacity:1},top:{top:"-=20px",opacity:1}}},b.prototype.start=function(){if(this.$popup)return;var a=this.getIndexFromHash(),b=a>-1?a:0;this.$el.show(),this.show(b)},b.prototype.show=function(a){return this.$el.show(),this.hideCurrent(),this.$popup=this.popups[a],this.beforeShow(),this.$popup.show(),this.$popup.css(this.options.resetStyles),this.options.position&&this.position(),this.scroll(this.animate),this.trigger(this.$popup.attr("id")),this},b.prototype.on=function(a,b){this.eventProxy.on(a,b)},b.prototype.off=function(a,b){this.eventProxy.off(a,b)},b.prototype.close=function(a){return this.$el.hide(),a&&a.preventDefault(),window.location.hash="",this.trigger("hide"),this},b.prototype.beforeShow=function(){this.trigger(this.$popup.attr("id")+":before"),this.appendHash()},b.prototype.appendHash=function(){var b=this.$popup.data();if(!b.appendHash||!b.pointsTo)return;var c=a(b.pointsTo),d=b.appendHash.replace(/^#/,"");c.attr("href",c.attr("href")+"#"+d)},b.prototype.removeHash=function(){var b=this.$popup.data();if(!b.appendHash||!b.pointsTo)return;var c=a(b.pointsTo),d=c.attr("href").replace(/#.+$/,"");c.attr("href",d)},b.prototype.animate=function(){this.$popup.animate(this.getPopupAnimation(),200)},b.prototype.getPopupAnimation=function(){var a=this.$popup.data("position")||"bottom";return this.options.animations[a]},b.prototype.trigger=function(a){this.eventProxy.trigger.apply(this.eventProxy,arguments),this.$el.trigger.apply(this.$el,arguments)},b.prototype.bindMethods=function(){this.initPopup=a.proxy(this,"initPopup"),this.close=a.proxy(this,"close"),this.animate=a.proxy(this,"animate")},b.prototype.attachEvents=function(){this.$el.on("click.usher",".usher-close",this.close)},b.prototype.removeEvents=function(){this.$el.off(".usher")},b.prototype.getIndexFromHash=function(){var a=window.location.hash.replace(/^#/,"");if(a==="")return-1;for(var b=0;b<this.popups.length;b++)if(this.popups[b].attr("id")==a)return b;return-1},b.prototype.initPopups=function(){this.popups=this.$el.children().map(this.initPopup)},b.prototype.initPopup=function(b,c){return a(c).hide().css("position","absolute")},b.prototype.hideCurrent=function(){if(!this.$popup)return;this.$popup.hide(),this.removeHash(),this.trigger(this.$popup.attr("id")+":hide")},b.prototype.position=function(){var a=this.$popup.data("points-to");a?this.pointTo(a):this.positionDefault()},b.prototype.positionDefault=function(){this.$popup.position(this.constructor.positions["default"])},b.prototype.pointTo=function(b){var c=this.$popup.data("position")||"bottom",d=this.constructor.positions[c];d.of=a(b),this.$popup.position(d)},b.prototype.scroll=function(a){this.$popup.scrollIntoView({offset:this.getScrollOffset(),complete:a})},b.prototype.getScrollOffset=function(){return{x:parseInt(this.$popup.data("offset-x")||this.options.offset.x,10),y:parseInt(this.$popup.data("offset-y")||this.options.offset.y,10)}},b.instances=[],b.positions={left:{my:"right",at:"left",collision:"none"},right:{my:"left",at:"right",collision:"none"},top:{my:"bottom",at:"top",collision:"none"},bottom:{my:"top",at:"bottom",collision:"none"},"default":{my:"center",at:"center",of:window,collision:"none"}},b.addInstance=function(a){this.instances.push(a),this.instances.length==1&&(this.attachEvents(),this.checkHash())},b.attachEvents=function(){a(window).on("hashchange",a.proxy(this,"checkHash"))},b.checkHash=function(a){for(var b=0;b<this.instances.length;b++){var c=this.instances[b].getIndexFromHash();if(c==-1)continue;this.instances[b].show(c);break}},b})