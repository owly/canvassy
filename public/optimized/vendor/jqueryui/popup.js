define(["jquery","jqueryui/core","jqueryui/widget","jqueryui/position"],function(a){var b=0,c=!1;a.widget("ui.popup",{version:"@VERSION",options:{position:{my:"left top",at:"left bottom"},managed:!1,expandOnFocus:!1,show:{effect:"slideDown",duration:0},hide:{effect:"fadeOut",duration:0}},_create:function(){this.options.trigger||(this.options.trigger=this.element.prev()),this.element.attr("id")||(this.element.attr("id","ui-popup-"+b++),this.generatedId=!0),this.element.attr("role")||this.options.managed||(this.element.attr("role","dialog"),this.generatedRole=!0),this.options.trigger.attr("aria-haspopup","true").attr("aria-owns",this.element.attr("id")),this.element.addClass("ui-popup"),this._beforeClose(),this.element.hide(),this._on(this.options.trigger,{keydown:function(b){switch(b.keyCode){case a.ui.keyCode.TAB:this.element.hide(),this.close(b);break;case a.ui.keyCode.ESCAPE:this.isOpen&&this.close(b);break;case a.ui.keyCode.SPACE:this.options.trigger.is("a:ui-button")?b.preventDefault():this.options.trigger.is("a:not(:ui-button)")&&this.options.trigger.trigger("click",b);break;case a.ui.keyCode.DOWN:case a.ui.keyCode.UP:b.preventDefault(),clearTimeout(this.closeTimer),this._delay(function(){this.open(b),this.focusPopup(b)},1)}},click:function(a){a.stopPropagation(),a.preventDefault()},mousedown:function(b){var d=!1;a(b.target).is("input")&&(d=!0);if(this.isOpen){c=!0,this.close();return}this.open(b),clearTimeout(this.closeTimer),this._delay(function(){d||this.focusPopup()},1)}}),this.options.expandOnFocus&&this._on(this.options.trigger,{focus:function(a){c||this._delay(function(){this.isOpen||this.open(a)},1),this._delay(function(){c=!1},100)},blur:function(a){c=!1}}),this.options.managed||this._on({keydown:function(b){if(b.keyCode!==a.ui.keyCode.TAB)return;var c=a(":tabbable",this.element),d=c.first(),e=c.last();b.target===e[0]&&!b.shiftKey?(d.focus(1),b.preventDefault()):b.target===d[0]&&b.shiftKey&&(e.focus(1),b.preventDefault())}}),this._on({focusout:function(a){this.closeTimer=this._delay(function(){this.close(a)},150)},focusin:function(a){clearTimeout(this.closeTimer)},mouseup:function(a){clearTimeout(this.closeTimer)}}),this._on({keyup:function(b){b.keyCode===a.ui.keyCode.ESCAPE&&this.element.is(":visible")&&(this.close(b),this.focusTrigger())}}),this._on(this.document,{click:function(b){this.isOpen&&!a(b.target).closest(this.element.add(this.options.trigger)).length&&this.close(b)}})},_destroy:function(){this.element.show().removeClass("ui-popup").removeAttr("aria-hidden").removeAttr("aria-expanded").unbind("keypress.ui-popup"),this.options.trigger.removeAttr("aria-haspopup").removeAttr("aria-owns"),this.generatedId&&this.element.removeAttr("id"),this.generatedRole&&this.element.removeAttr("role")},open:function(b){var c=a.extend({},{of:this.options.trigger},this.options.position);this._show(this.element,this.options.show),this.element.attr("aria-hidden","false").attr("aria-expanded","true").position(c),this.options.trigger.attr("tabindex",-1),this.isOpen=!0,this._trigger("open",b)},focusPopup:function(a){if(!this.options.managed){var b=this.element.find(":tabbable");this.removeTabIndex=!1,b.length||(this.element.is(":tabbable")||(this.element.attr("tabindex","0"),this.removeTabIndex=!0),b=b.add(this.element[0])),b.first().focus(1)}this._trigger("focusPopup",a)},focusTrigger:function(a){c=!0,this.options.trigger.focus(),this._trigger("focusTrigger",a)},close:function(a){this._beforeClose(),this._hide(this.element,this.options.hide),this.options.trigger.attr("tabindex",0),this.removeTabIndex&&this.element.removeAttr("tabindex"),this.isOpen=!1,this._trigger("close",a)},_beforeClose:function(){this.element.attr("aria-hidden","true").attr("aria-expanded","false")}})})