define(["vendor/slickgrid-googlecode/slick.globaleditorlock","jquery","jqueryui/sortable","jqueryui/resizable","vendor/jquery.getScrollbarWidth"],function(a,b){return function(d,e,f,g){function O(){g=b.extend({},h,g),d.empty().attr("tabIndex",0).attr("hideFocus",!0).css("overflow","hidden").css("outline",0).css("position","relative").addClass(l),n=b("<div class='grid-header' style='overflow:hidden;position:relative;' />").appendTo(d),o=b("<div style='width:10000px' />").appendTo(n),p=b("<div tabIndex='0' hideFocus style='width:100%;overflow:scroll;outline:0;position:relative;outline:0px;'>").appendTo(d),q=b("<div class='grid-canvas' tabIndex='0' hideFocus />").appendTo(p),p.height(d.innerHeight()-n.outerHeight());for(var a=0;a<f.length;a++){var c=f[a];H[c.id]=a,c.width||(c.width=g.defaultColumnWidth),c.formatter||(c.formatter=X);var e=b("<div class='h c"+a+"' cell="+a+" id='"+c.id+"' />").html(c.name).width(c.width).appendTo(o);c.rerenderOnResize&&e.append(" <img src='images/help.png' align='absmiddle' title='This column has an adaptive formatter.  Resize to a smaller size to see alternative data representation.'>")}o.find(".h").each(function(){var a=parseInt(b(this).attr("cell")),c=f[a];if(c.resizable===!1)return;b(this).resizable({handles:"e",minWidth:c.minWidth?c.minWidth:null,maxWidth:c.maxWidth?c.maxWidth:null,stop:function(a,c){var d=b(this).attr("id"),e=H[d];f[e].width=b(this).width(),b("body").append("<style class='slick-style'> ."+l+" .grid-canvas .c"+e+"{width: "+f[e].width+"px;} </style>"),fb(),f[e].rerenderOnResize&&ab(),ib()}})}),g.enableColumnReorder&&o.sortable({axis:"x",cancel:".ui-resizable-handle",update:function(a,b){console.time("column reorder");var c=o.sortable("toArray"),d={};for(var e=0;e<f.length;e++)d[f[e].id]=f[e];for(var e=0;e<c.length;e++)H[c[e]]=e,f[e]=d[c[e]];ab(),Q(),P(),ib(),m.onColumnsReordered&&m.onColumnsReordered(),a.stopPropagation(),console.timeEnd("column reorder")}}),o.bind("click",function(a){if(!b(a.target).hasClass(".h"))return;var c=b(a.target).attr("id");m.onColumnHeaderClick&&m.onColumnHeaderClick(f[H[c]])}),P(),fb(),ib(),g.manualScrolling||p.bind("scroll",jb),q.bind("keydown",kb),q.bind("click",lb),q.bind("dblclick",mb),b.browser.msie&&(p[0].onselectstart=function(){if(event.srcElement.tagName!="INPUT"&&event.srcElement.tagName!="TEXTAREA")return!1})}function P(){for(var a=0;a<f.length;a++)b("body").append("<style class='slick-style'> ."+l+" .grid-canvas .c"+a+" { width:"+f[a].width+"px } </style>")}function Q(){b("body").find("style.slick_style").remove()}function R(){w&&yb(),o.sortable("destroy"),o.find(".h").resizable("destroy"),Q(),d.empty().removeClass(l)}function S(a,b,c){o.find(".h[id="+a+"]").removeClass(c).addClass(b)}function T(a){return H[a]}function U(){return F.concat()}function V(c){if(a.isEditing()&&!a.hasLock(m))throw"Grid : setSelectedRows : cannot set selected rows when somebody else has an edit lock";var d={};for(var e=0;e<c.length;e++)d[c[e]]=!0;for(var e=0;e<F.length;e++){var f=F[e];x[f]&&!d[f]&&b(x[f]).removeClass("selected")}for(var e=0;e<c.length;e++){var f=c[e];x[f]&&!G[f]&&b(x[f]).addClass("selected")}F=c.concat(),G=d}function W(a){if(w&&!xb())return;ob(null),g.enableAddRow!=a.enableAddRow&&bb(e.length),g=b.extend(g,a),ib()}function X(a,b,c,d,e){return c==null||c==undefined?"":c}function Y(a,b){var c=e[b],d=b<e.length&&!c,g="r"+(d?" loading":"")+(G[b]?" selected":"");a.push("<div class='"+g+"' row='"+b+"' style='top:"+i*b+"px'>");for(var h=0,j=f.length;h<j;h++){var k=f[h],l;!k.active||!c.active,a.push("<div "+(k.unselectable?"":"hideFocus tabIndex=0 ")+"class='c c"+h+(k.cssClass?" "+k.cssClass:"")+(k.active&&c.active?" active-col-and-row":"")+"' cell="+h+">"),c&&b<e.length&&a.push(k.formatter(b,h,c[k.field],k,c)),a.push("</div>")}a.push("</div>")}function Z(a){var b=[];return Y(b,a),b.join("")}function _(a,b){console.time("cleanupRows");var c=y,d=q[0];for(var e in x)(e<a||e>b)&&e!=t&&(d.removeChild(x[e]),delete x[e],y--,L++);console.log("removed "+(c-y)+" rows"),console.timeEnd("cleanupRows")}function ab(){console.log("removeAllRows"),q[0].innerHTML="",x={},L+=y,y=0}function bb(a){var b=x[a];if(!b)return;if(w&&t==a)throw"Grid : removeRow : Cannot remove a row that is currently in edit mode";D=0,b.parentNode.removeChild(b),b=null,delete x[a],y--,L++}function cb(a){console.time("removeRows");if(!a||!a.length)return;D=0;var b=[];for(var c=0,d=a.length;c<d;c++){if(w&&t==c)throw"Grid : removeRow : Cannot remove a row that is currently in edit mode";var e=x[a[c]];if(!e)continue;b.push(a[c])}if(y>10&&b.length==y)q[0].innerHTML="",x={},L+=y,y=0;else for(var c=0,f=b.length;c<f;c++){var e=x[b[c]];e.parentNode.removeChild(e),delete x[b[c]],y--,L++}console.timeEnd("removeRows")}function db(a,c){if(!x[a])return;var d=b(x[a]).find(".c[cell="+c+"]");if(d.length===0)return;var g=f[c],h=e[a];w&&t==a&&u==c?w.setValue(h[g.field]):d[0].innerHTML=h?g.formatter(a,c,h[g.field],g,h):""}function eb(a){if(!x[a])return;b(x[a]).find(".c").each(function(b){var c=f[b];a==t&&b==u&&w?w.setValue(e[t][c.field]):e[a]?this.innerHTML=c.formatter(a,b,e[a][c.field],c,e[a]):this.innerHTML=""})}function fb(){s=p.innerWidth(),r=p.innerHeight(),k=z=Math.ceil(r/i),j=Math.max(j,z+2*k);var a=0;for(var c=0;c<f.length;c++)a+=f[c].width+5;q.width(a);var d=q[0],h=g.enableAddRow?e.length:e.length-1;for(var c in x)c>=h&&(d.removeChild(x[c]),delete x[c],y--,L++);var l=Math.max(i*(e.length+z-2),r-b.getScrollbarWidth());p.scrollTop()>l-p.height()+b.getScrollbarWidth()&&p.scrollTop(l-p.height()+b.getScrollbarWidth()),q.height(l)}function gb(){return{top:Math.floor(B/i),bottom:Math.floor((B+r)/i)}}function hb(a,b){console.time("renderRows");var c=q[0],d=y,e=[],f=[],g=new Date;for(var h=a;h<=b;h++){if(x[h])continue;y++,f.push(h),Y(e,h),K++}var i=document.createElement("div");i.innerHTML=e.join("");for(var h=0,j=i.childNodes.length;h<j;h++)x[f[h]]=c.appendChild(i.firstChild);y-d>5&&(E=(new Date-g)/(y-d)),console.log("rendered "+(y-d)+" rows"),console.timeEnd("renderRows")}function ib(){var a=gb(),b=Math.max(0,a.top-(D>=0?5:k)),c=Math.min(g.enableAddRow?e.length:e.length-1,a.bottom+(D>0?k:5));y>10&&Math.abs(A-B)>i*j?ab():_(b,c),hb(b,c),A=B,J=null}function jb(){B=p[0].scrollTop;var a=Math.abs(A-B),b=p[0].scrollLeft;b!=C&&(n[0].scrollLeft=C=b);if(a<5*i)return;A==B?D=0:A<B?D=1:D=-1,J&&window.clearTimeout(J),a<z*i?ib():J=window.setTimeout(ib,50),m.onViewportChanged&&m.onViewportChanged()}function kb(b){switch(b.which){case 27:a.isEditing()&&a.hasLock(m)&&yb(m),v&&v.focus();break;case 9:b.shiftKey?vb(0,-1,!0):vb(0,1,!0);break;case 37:vb(0,-1);break;case 39:vb(0,1);break;case 38:vb(-1,0);break;case 40:case 13:vb(1,0);break;default:if(m.onKeyDown&&e[t]&&!w&&m.onKeyDown(b,t,u))return b.stopPropagation(),b.preventDefault(),!1;return}return b.stopPropagation(),b.preventDefault(),!1}function lb(a){var c=b(a.target).closest(".c");if(c.length===0)return;if(v==c[0]&&w!=null)return;var d=parseInt(c.parent().attr("row")),h=parseInt(c.attr("cell")),i=null;if(e[d]&&m.onClick&&(!w||(i=xb()))&&m.onClick(a,d,h))return a.stopPropagation(),a.preventDefault(),!1;g.enableCellNavigation&&!f[h].unselectable&&(i==1||i==null&&xb())&&pb(c[0])}function mb(a){var c=b(a.target).closest(".c");if(c.length===0)return;if(v==c[0]&&w!=null)return;g.editOnDoubleClick&&tb()}function nb(a,b){var c=Math.floor(b/i),d=0,e=0;for(var g=0;g<f.length&&e<b;g++)e+=f[g].width,d++;return{row:c,cell:d-1}}function ob(a,c){v!=null&&(sb(),b(v).removeClass("selected")),v=a,v!=null?(t=parseInt(b(v).parent().attr("row")),u=parseInt(b(v).attr("cell")),b(v).addClass("selected"),ub(),g.editable&&!g.editOnDoubleClick&&(e[t]||t==e.length)&&(window.clearTimeout(I),c?I=window.setTimeout(tb,100):tb())):(t=null,u=null)}function pb(a,b){ob(a,b),a?V([t]):V([]),m.onSelectedRowsChanged&&m.onSelectedRowsChanged()}function qb(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var a=window.getSelection();a&&a.removeAllRanges&&a.removeAllRanges()}}function rb(a,b){return a<e.length&&!e[a]?!1:f[b].cannotTriggerInsert&&a>=e.length?!1:f[b].editor?!0:!1}function sb(){if(!w)return;w.destroy(),b(v).removeClass("editable invalid"),e[t]&&(v.innerHTML=f[u].formatter(t,u,e[t][f[u].field],f[u],e[t])),w=null,b.browser.msie&&qb(),a.leaveEditMode(m)}function tb(){if(!v)return;if(!g.editable)throw"Grid : makeSelectedCellEditable : should never get called when options.editable is false";window.clearTimeout(I);if(!rb(t,u))return;a.enterEditMode(m),b(v).addClass("editable");var c=null;e[t]&&(c=e[t][f[u].field]),v.innerHTML="",w=new f[u].editor(b(v),f[u],c,e[t])}function ub(){if(!v)return;var a=p[0].scrollTop;(t+2)*i>a+r?(p[0].scrollTop=t*i,jb()):t*i<a&&(p[0].scrollTop=(t+2)*i-r,jb())}function vb(c,d,e){if(!v)return;if(!g.enableCellNavigation)return;if(!a.commitCurrentEdit())return;var f=x[t+c],h=f?b(f).find(".c[cell="+(u+d)+"][tabIndex=0]"):null;e&&c==0&&!(f&&h&&h.length)&&(!h||!h.length)&&(d>0?(f=x[t+c+1],h=f?b(f).find(".c[cell][tabIndex=0]:first"):null):(f=x[t+c-1],h=f?b(f).find(".c[cell][tabIndex=0]:last"):null)),f&&h&&h.length?(pb(h[0],g.asyncEditorLoading),w||v.focus()):v.focus()}function wb(c,d){if(c>e.length||c<0||d>=f.length||d<0)return;if(!g.enableCellNavigation||f[d].unselectable)return;if(!a.commitCurrentEdit())return;x[c]||hb(c,c);var d=b(x[c]).find(".c[cell="+d+"][tabIndex=0]")[0];pb(d),w||v.focus()}function xb(){if(w){if(w.isValueChanged()){var a=w.validate();if(a.valid){var c=w.getValue();return t<e.length?f[u].setValueHandler?f[u].setValueHandler(c,f[u],e[t]):e[t][f[u].field]=c:m.onAddNewRow&&m.onAddNewRow(f[u],c),sb(),!0}return b(v).addClass("invalid"),b(v).stop(!0,!0).effect("highlight",{color:"red"},300),m.onValidationError&&m.onValidationError(v,a,t,u,f[u]),w.focus(),!1}sb()}return!0}function yb(){sb()}var h={enableAddRow:!0,manualScrolling:!1,editable:!0,editOnDoubleClick:!1,enableCellNavigation:!0,defaultColumnWidth:80,enableColumnReorder:!0,asyncEditorLoading:!0},i=24,j=50,k=5,l="slickgrid_"+Math.round(1e6*Math.random()),m=this,n,o,p,q,r,s,t,u,v=null,w=null,x={},y=0,z,A=0,B=0,C=0,D=1,E=10,F=[],G={},H={},I=null,J=null,K=0,L=0,M=document.createDocumentFragment(),N=!1;this.debug=function(){var a="";a+="\ncounter_rows_rendered:  "+K,a+="\ncounter_rows_removed:  "+L,a+="\nrenderedRows:  "+y,a+="\nnumVisibleRows:  "+z,a+="\nCAPACITY:  "+j,a+="\nBUFFER:  "+k,a+="\navgRowRenderTime:  "+E,alert(a)},this.benchmark_render_200=function(){ab(),hb(0,200),_()},this.stressTest=function(){console.time("benchmark-stress"),hb(0,500),_(),console.timeEnd("benchmark-stress"),window.setTimeout(m.stressTest,50)},this.benchmarkFn=function(a){var b=new Date,c=new Array(arguments);c.splice(0,1),m[a].call(this,c),alert("Grid : benchmarkFn : "+a+" : "+(new Date-b)+"ms")},O(),b.extend(this,{onColumnHeaderClick:null,onClick:null,onKeyDown:null,onAddNewRow:null,onValidationError:null,onViewportChanged:null,onSelectedRowsChanged:null,onColumnsReordered:null,destroy:R,getColumnIndex:T,updateCell:db,updateRow:eb,removeRow:bb,removeRows:cb,removeAllRows:ab,render:ib,getViewport:gb,resizeCanvas:fb,scroll:scroll,getCellFromPoint:nb,gotoCell:wb,editCurrentCell:tb,getSelectedRows:U,setSelectedRows:V,setColumnHeaderCssClass:S,commitCurrentEdit:xb,cancelCurrentEdit:yb})}})