define(["i18n!media_comments","underscore","vendor/jquery.ba-tinypubsub","jquery","str/htmlEscape","compiled/jquery/mediaComment","jquery.ajaxJSON","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jqueryui/progressbar","jqueryui/tabs"],function(a,b,c,d,e){function g(a){var b=d.mediaComment.contextCode(),e={2:"image",5:"audio"}[a.mediaType]||"video";b&&d.ajaxJSON("/media_objects","POST",{id:a.entryId,type:e,context_code:b,title:a.title,user_entered_title:a.userTitle},function(a){c.publish("media_object_created",a)},d.noop),c.publish("media_comment_created",{id:a.entryId,mediaType:e})}d.mediaComment=function(a,b,c){var e=d("<div/>");d("body").append(e.hide()),d.fn.mediaComment.apply(e,arguments)};var f;d.mediaComment.partnerData=function(a){return JSON.stringify({context_code:d.mediaComment.contextCode(),root_account_id:f||(f=Number(d("#domain_root_account_id").text()))})},d.mediaComment.contextCode=function(){return ENV.context_asset_string||"user_"+ENV.current_user_id};var h={};d.mediaComment.entryAdded=function(a,b,c,d){if(!a||h[a])return;h[a]=!0;var e={mediaType:b,entryId:a,title:c,userTitle:d};g(e)},d.mediaComment.audio_delegate={readyHandler:function(){d("#audio_upload")[0].setMediaType("audio")},selectHandler:function(){d.mediaComment.upload_delegate.selectHandler("audio")},singleUploadCompleteHandler:function(a){d.mediaComment.upload_delegate.singleUploadCompleteHandler("audio",a)},allUploadsCompleteHandler:function(){d.mediaComment.upload_delegate.allUploadsCompleteHandler("audio")},entriesAddedHandler:function(a){d.mediaComment.upload_delegate.entriesAddedHandler("audio",a)},progressHandler:function(a){d.mediaComment.upload_delegate.progressHandler("audio",a[0],a[1],a[2])},uploadErrorHandler:function(){d.mediaComment.upload_delegate.uploadErrorHandler("audio")}},d.mediaComment.video_delegate={readyHandler:function(){d("#video_upload")[0].setMediaType("video")},selectHandler:function(){d.mediaComment.upload_delegate.selectHandler("video")},singleUploadCompleteHandler:function(a){d.mediaComment.upload_delegate.singleUploadCompleteHandler("video",a)},allUploadsCompleteHandler:function(){d.mediaComment.upload_delegate.allUploadsCompleteHandler("video")},entriesAddedHandler:function(a){d.mediaComment.upload_delegate.entriesAddedHandler("video",a)},progressHandler:function(a){d.mediaComment.upload_delegate.progressHandler("video",a[0],a[1],a[2])},uploadErrorHandler:function(){d.mediaComment.upload_delegate.uploadErrorHandler("video")}},d.mediaComment.upload_delegate={currentType:"audio",submit:function(){var b=d.mediaComment.upload_delegate.currentType,c=d("#"+b+"_upload")[0].getFiles();c.length>1&&d("#"+b+"_upload")[0].removeFiles(0,c.length-2),c=d("#"+b+"_upload")[0].getFiles();if(c.length==0)return;d("#media_upload_progress").css("visibility","visible").progressbar({value:1}),d("#media_upload_submit").attr("disabled",!0).text(a.t("messages.submitting","Submitting Media File...")),d("#"+b+"_upload")[0].upload()},selectHandler:function(b){d.mediaComment.upload_delegate.currentType=b;var c=d("#"+b+"_upload")[0].getFiles();c.length>1&&d("#"+b+"_upload")[0].removeFiles(0,c.length-2);var e=d("#"+b+"_upload")[0].getFiles()[0];d("#media_upload_settings .icon").attr("src","/images/file-"+b+".png"),d("#media_upload_submit").show(),d("#media_upload_submit").attr("disabled",e?!1:!0),d("#media_upload_settings").css("visibility",e?"visible":"hidden"),d("#media_upload_title").val(e.title),d("#media_upload_display_title").text(e.title),d("#media_upload_file_size").text(d.fileSize(e.bytesTotal)),d("#media_upload_feedback_text").html(""),d("#media_upload_feedback").css("visibility","hidden");if(e.bytesTotal>INST.kalturaSettings.max_file_size_bytes){d("#media_upload_feedback_text").html(a.t("errors.file_too_large","*This file is too large.* The maximum size is %{size}MB.",{size:INST.kalturaSettings.max_file_size_bytes/1048576,wrapper:"<b>$1</b>"})),d("#media_upload_feedback").css("visibility","visible"),d("#media_upload_submit").hide();return}d("#media_upload_submit").click()},singleUploadCompleteHandler:function(a,b){d("#media_upload_progress").progressbar("option","value",100)},allUploadsCompleteHandler:function(a){d("#media_upload_progress").progressbar("option","value",100),d("#"+a+"_upload")[0].addEntries()},entriesAddedHandler:function(b,c){d("#media_upload_progress").progressbar("option","value",100);var e=c[0];d("#media_upload_submit").text(a.t("messages.submitted","Submitted Media File!")),setTimeout(function(){d("#media_comment_dialog").dialog("close")},1500),b=="audio"?e.entryType=5:b=="video"&&(e.entryType=1),d.mediaComment.entryAdded(e.entryId,e.entryType,e.title)},progressHandler:function(a,b,c,e){var f=100*b/c;d("#media_upload_progress").progressbar("option","value",f)},uploadErrorHandler:function(b){var c=d("#"+b+"_upload")[0].getError();d("#media_upload_errors").text(a.t("errors.upload_failed","Upload failed with error:")+" "+c),d("#media_upload_progress").hide()}};var i=!1,j=null;d.mediaComment.init=function(b,c){j=j||new Date,b=b||"any",c=c||{};var e=d.trim(d("#identity .user_name").text()||"");e&&(e=e+": "+(new Date).toString("ddd MMM d, yyyy"));var f=c.defaultTitle||e||a.t("titles.media_contribution","Media Contribution"),g=function(){d("#video_record_title,#audio_record_title").val(f),k.dialog({title:a.t("titles.record_upload_media_comment","Record/Upload Media Comment"),width:560,height:475,modal:!1}),k.dialog("option","close",function(){d("#audio_record").before("<div id='audio_record'/>").remove(),d("#video_record").before("<div id='video_record'/>").remove(),c&&c.close&&d.isFunction(c.close)&&c.close.call(k)}),d("#audio_record").before("<div id='audio_record'/>").remove(),d("#video_record").before("<div id='video_record'/>").remove();var e=k.data("ks");b=="video"?(d("#video_record_option").click(),d("#media_record_option_holder").hide(),d("#audio_upload_holder").hide(),d("#video_upload_holder").show()):b=="audio"?(d("#audio_record_option").click(),d("#media_record_option_holder").hide(),d("#audio_upload_holder").show(),d("#video_upload_holder").hide()):(d("#video_record_option").click(),d("#audio_upload_holder").show(),d("#video_upload_holder").show()),d(document).triggerHandler("reset_media_comment_forms");var g=d.trim(d("#identity .user_name").text())+" "+(new Date).toISOString();setTimeout(function(){var b={host:location.protocol+"//"+INST.kalturaSettings.domain,rtmpHost:"rtmp://"+(INST.kalturaSettings.rtmp_domain||INST.kalturaSettings.domain),kshowId:"-1",pid:INST.kalturaSettings.partner_id,subpid:INST.kalturaSettings.subpartner_id,uid:k.data("uid")||"ANONYMOUS",ks:e,themeUrl:"/media_record/skin.swf",localeUrl:"/media_record/locale.xml",thumbOffset:"1",licenseType:"CC-0.1",showUi:"true",useCamera:"0",maxFileSize:INST.kalturaSettings.max_file_size_bytes/1048576,maxUploads:1,partnerData:d.mediaComment.partnerData(),partner_data:d.mediaComment.partnerData(),entryName:g},c={align:"middle",quality:"high",bgcolor:"#ffffff",name:"KRecordAudio",allowScriptAccess:"sameDomain",type:"application/x-shockwave-flash",pluginspage:"http://www.adobe.com/go/getflashplayer",wmode:"opaque"};d("#audio_record").text(a.t("messages.flash_required_record_audio","Flash required for recording audio.")),swfobject.embedSWF("/media_record/KRecord.swf","audio_record","400","300","9.0.0",!1,b,c);var c=d.extend({},c,{name:"KRecordVideo"}),b=d.extend({},b,{useCamera:"1"});d("#video_record").html("Flash required for recording video."),swfobject.embedSWF("/media_record/KRecord.swf","video_record","400","300","9.0.0",!1,b,c)},INST.browser.ie?500:10);var h={host:location.protocol+"//"+INST.kalturaSettings.domain,partnerId:INST.kalturaSettings.partner_id,subPId:INST.kalturaSettings.subpartner_id,uid:k.data("uid")||"ANONYMOUS",entryId:"-1",ks:e,thumbOffset:"1",licenseType:"CC-0.1",maxFileSize:INST.kalturaSettings.max_file_size_bytes/1048576,maxUploads:1,uiConfId:INST.kalturaSettings.upload_ui_conf,jsDelegate:"$.mediaComment.audio_delegate"},j={align:"middle",quality:"high",bgcolor:"#ffffff",name:"KUpload",allowScriptAccess:"always",type:"application/x-shockwave-flash",pluginspage:"http://www.adobe.com/go/getflashplayer",wmode:"transparent"};d("#audio_upload").text(a.t("messages.flash_required_upload_audio","Flash required for uploading audio."));var l="180",m="50";swfobject.embedSWF("//"+INST.kalturaSettings.domain+"/kupload/ui_conf_id/"+INST.kalturaSettings.upload_ui_conf,"audio_upload",l,m,"9.0.0",!1,h,j),h=d.extend({},h,{jsDelegate:"$.mediaComment.video_delegate"}),d("#video_upload").text(a.t("messages.flash_required_upload_video","Flash required for uploading video."));var l="180",m="50";swfobject.embedSWF("//"+INST.kalturaSettings.domain+"/kupload/ui_conf_id/"+INST.kalturaSettings.upload_ui_conf,"video_upload",l,m,"9.0.0",!1,h,j);var n,o,p,q,r,s,t,u,v,w,x,y=!1;i=!0,setInterval(function(){i&&(n=d("#audio_record_holder"),o=d("#audio_record"),p=d("#audio_record_meter"),q=0,r=0,t=d("#video_record_holder"),u=d("#video_record"),v=d("#video_record_meter"),w=0,x=0,i=!1),q++,w++;var a=null,b=null;o&&o[0]&&o[0].getMicophoneActivityLevel&&o.parent().length?a=o[0].getMicophoneActivityLevel():o=d("#audio_record"),u&&u[0]&&u[0].getMicophoneActivityLevel&&u.parent().length?b=u[0].getMicophoneActivityLevel():u=d("#video_record");if(a!=null){a=Math.max(a,r),a>-1&&!n.hasClass("with_volume")&&(p.css("display","none"),d("#audio_record_holder").addClass("with_volume").animate({width:420},function(){p.css("display","")}));if(q>4){r=0,q=0;var c=(a-a%10)/10;p.attr("class","volume_meter band_"+c)}else r=a}if(b!=null){b=Math.max(b,x),b>-1&&!t.hasClass("with_volume")&&(v.css("display","none"),d("#video_record_holder").addClass("with_volume").animate({width:420},function(){v.css("display","")}));if(w>4){x=0,w=0;var c=(b-b%10)/10;v.attr("class","volume_meter band_"+c)}else x=b}},20)},h=new Date;h-j>3e5&&d("#media_comment_dialog").dialog("close").remove(),j=h;var k=d("#media_comment_dialog");if(k.length==0){var l=d("<div/>").attr("id","media_comment_dialog");l.text(a.t("messages.loading","Loading...")),l.dialog({title:a.t("titles.record_upload_media_comment","Record/Upload Media Comment"),resizable:!1,width:470,height:300,modal:!1}),d.ajaxJSON("/api/v1/services/kaltura_session","POST",{},function(a){l.data("ks",a.ks),l.data("uid",a.uid)},function(b){b.logged_in==0?l.data("ks-error",a.t("errors.must_be_logged_in","You must be logged in to record media.")):l.data("ks-error",a.t("errors.load_failed","Media Comment Application failed to load.  Please try again."))}),d.get("/partials/_media_comments.html",function(a){var b=function(){l.data("ks")?(l.html(a),l.find("#media_record_tabs").tabs(),g()):l.data("ks-error")?l.html(l.data("ks-error")):setTimeout(b,500)};b(),k=d("#media_comment_dialog")}),k=l}else g()},d(document).ready(function(){d(document).bind("reset_media_comment_forms",function(){d("#audio_record_holder_message,#video_record_holder_message").removeClass("saving").find(".recorder_message").html("Saving Recording...<img src='/images/media-saving.gif'/>"),d("#audio_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),d("#video_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),d("#media_upload_submit").text(a.t("buttons.submit","Submit Media File")).attr("disabled",!0),d("#media_upload_settings").css("visibility","hidden"),d("#media_upload_progress").css("visibility","hidden").progressbar().progressbar("option","value",1),d("#media_upload_title").val("");var b=d("#audio_upload")[0]&&d("#audio_upload")[0].getFiles&&d("#audio_upload")[0].getFiles();b&&d("#audio_upload")[0].removeFiles&&b.length>0&&d("#audio_upload")[0].removeFiles(0,b.length-1),b=d("#video_upload")[0]&&d("#video_upload")[0].getFiles&&d("#video_upload")[0].getFiles(),b&&d("#video_upload")[0].removeFiles&&b.length>0&&d("#video_upload")[0].removeFiles(0,b.length-1)}),d("#media_upload_submit").live("click",function(a){d.mediaComment.upload_delegate.submit()}),d("#video_record_option,#audio_record_option").live("click",function(a){a.preventDefault(),d("#video_record_option,#audio_record_option").removeClass("selected_option"),d(this).addClass("selected_option"),d("#audio_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),d("#video_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),d(this).attr("id")=="audio_record_option"?(d("#video_record_holder_holder").hide(),d("#audio_record_holder_holder").show()):(d("#video_record_holder_holder").show(),d("#audio_record_holder_holder").hide())})}),d(document).bind("media_recording_error",function(){d("#audio_record_holder_message,#video_record_holder_message").find(".recorder_message").html(e(a.t("errors.save_failed","Saving appears to have failed.  Please close this popup to try again."))+"<div style='font-size: 0.8em; margin-top: 20px;'>"+e(a.t("errors.persistent_problem","If this problem keeps happening, you may want to try recording your media locally and then uploading the saved file instead."))+"</div>")}),window.mediaCommentCallback=function(a){b.each(a,g),d("#media_comment_create_dialog").empty().dialog("close")},window.beforeAddEntry=function(){var a=Math.random();d.mediaComment.lastAddAttemptId=a,setTimeout(function(){d.mediaComment.lastAddAttemptId==a&&d(document).triggerHandler("media_recording_error")},3e4),d("#audio_record_holder_message,#video_record_holder_message").addClass("saving")},window.addEntryFail=function(){d(document).triggerHandler("media_recording_error")},window.addEntryFailed=function(){d(document).triggerHandler("media_recording_error")},window.addEntryComplete=function(b){d.mediaComment.lastAddAttemptId=null,d("#audio_record_holder_message,#video_record_holder_message").removeClass("saving");try{var c=null;d.isArray(b)||(b=[b]);for(var e=0;e<b.length;e++){var f=b[e];d("#media_record_tabs").tabs("option","selected")==0?c=d("#video_record_title,#audio_record_title").filter(":visible:first").val():d("#media_record_tabs").tabs("option","selected")!=1,f.entryType==1&&d("#audio_record_option").hasClass("selected_option")&&(f.entryType=5),d.mediaComment.entryAdded(f.entryId,f.entryType,f.entryName,c),d("#media_comment_dialog").dialog("close")}}catch(g){console.log(g),alert(a.t("errors.save_failed_try_again","Entry failed to save.  Please try again."))}}})