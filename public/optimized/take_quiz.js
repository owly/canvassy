define(["compiled/views/quizzes/FileUploadQuestionView","compiled/models/File","i18n!quizzes.take_quiz","jquery","quiz_timing","compiled/behaviors/autoBlurActiveInput","underscore","jquery.ajaxJSON","jquery.toJSON","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","compiled/jquery.rails_flash_notifications","compiled/tinymce","tinymce.editor_box","vendor/jquery.scrollTo","compiled/behaviors/quiz_selectmenu"],function(a,b,c,d,e,f,g){var h=null,i=null,j=function(){var a=0,b=d(".started_at"),f=d(".end_at"),h=b.text(),k=f.text(),l=k&&new Date(k),m=d(".countdown_seconds"),n=d(".time_running,.time_remaining"),o=d("#last_saved_indicator");return{referenceDate:null,countDown:null,isDeadline:!0,fiveMinuteDeadline:!1,oneMinuteDeadline:!1,submitting:!1,dialogged:!1,contentBoxCounter:0,lastSubmissionUpdate:new Date,currentlyBackingUp:!1,started_at:b,end_at:f,time_limit:parseInt(d(".time_limit").text(),10)||null,oneAtATime:d("#submit_quiz_form").hasClass("one_question_at_a_time"),cantGoBack:d("#submit_quiz_form").hasClass("cant_go_back"),finalSubmitButtonClicked:!1,updateSubmission:function(a,b){if(j.submitting&&!a)return;var e=new Date;if(e-j.lastSubmissionUpdate<1e3)return;if(j.currentlyBackingUp)return;j.currentlyBackingUp=!0,j.lastSubmissionUpdate=new Date;var f=d("#submit_quiz_form").getFormData();d(".question_holder .question").each(function(){value=d(this).hasClass("marked")?"1":"",f[d(this).attr("id")+"_marked"]=value}),o.text(c.t("saving","Saving..."));var h=d(".backup_quiz_submission_url").attr("href");b?(d.flashMessage(c.t("saving","Saving...")),d.ajax({url:h,data:f,type:"PUT",dataType:"json",async:!1})):function(b){var e=g.clone(b);if(a&&g.isEqual(b,i)){j.currentlyBackingUp=!1,setTimeout(function(){j.updateSubmission(!0)},3e4);return}d.ajaxJSON(h,"PUT",b,function(b){i=e,o.text(c.t("saved_at","Quiz saved at %{t}",{t:d.friendlyDatetime(new Date)})),j.currentlyBackingUp=!1,a&&setTimeout(function(){j.updateSubmission(!0)},3e4);if(b&&b.end_at){var f=Date.parse(b.end_at),g=Date.parse(j.end_at.text()),h=f.getTime(),m=g.getTime();j.referenceDate=null,h!==m&&(h>m?d.flashMessage(c.t("notices.extra_time","You have been given extra time on this attempt")):d.flashMessage(c.t("notices.less_time","Your time for this quiz has been reduced.")),j.end_at.text(b.end_at),k=b.end_at,l=new Date(b.end_at))}},function(b,e){var f=d("#identity .user_id").text()||"none";j.currentlyBackingUp=!1;if(!!ENV.LOCKDOWN_BROWSER||e.status!=401&&b["status"]!="unauthorized")d.ajaxJSON(location.protocol+"//"+location.host+"/simple_response.json?user_id="+f+"&rnd="+Math.round(Math.random()*9999999),"GET",{},function(){},function(){d.flashError(c.t("errors.connection_lost","Connection to %{host} was lost.  Please make sure you're connected to the Internet before continuing.",{host:location.host}))});else{var g=d("#deauthorized_dialog");g.is(":data(dialog)")?g.dialog("isOpen")||g.dialog("open"):g.dialog({modal:!0,buttons:[{text:c.t("#buttons.cancel","Cancel"),"class":"dialog_closer",click:function(){d(this).dialog("close")}},{text:c.t("#buttons.login","Login"),"class":"btn-primary relogin_button button_type_submit",click:function(){j.navigatingToRelogin=!0,d("#deauthorized_dialog").submit()}}]})}a&&setTimeout(function(){j.updateSubmission(!0)},3e4)},{timeout:5e3})}(f)},updateTime:function(){var b=new Date,f=j.time_limit?k:null;a=(a+1)%120;if(a==0&&!f&&!j.twelveHourDeadline){j.referenceDate=null;var g=l;!j.time_limit&&g-b<432e5&&(f=k)}j.referenceDate||d.extend(j,e.setReferenceDate(h,f,b));if(j.countDown){var i=j.countDown.getTime()-b.getTime()-j.clientServerDiff;i<=0&&(i=0);var n=new Date(i);m.text(n.getUTCSeconds()),i<=0&&!j.submitting&&(j.submitting=!0,j.submitQuiz())}var i=j.referenceDate.getTime()-b.getTime()-j.clientServerDiff;j.isDeadline&&(i<1e3&&(i=0),i<1e3&&!j.dialogged?(j.dialogged=!0,j.countDown=new Date(b.getTime()+1e4),d("#times_up_dialog").show().dialog({title:c.t("titles.times_up","Time's Up!"),width:"auto",height:"auto",modal:!0,overlay:{backgroundColor:"#000",opacity:.7},close:function(){j.submitting||(j.submitting=!0,j.submitQuiz())}})):i>3e4&&i<6e4&&!j.oneMinuteDeadline?(j.oneMinuteDeadline=!0,d.flashMessage(c.t("notices.one_minute_left","One Minute Left"))):i>25e4&&i<3e5&&!j.fiveMinuteDeadline?(j.fiveMinuteDeadline=!0,d.flashMessage(c.t("notices.five_minutes_left","Five Minutes Left"))):i>18e5&&i<177e4&&!j.thirtyMinuteDeadline?(j.thirtyMinuteDeadline=!0,d.flashMessage(c.t("notices.thirty_minutes_left","Thirty Minutes Left"))):i>432e5&&i<4317e4&&!j.twelveHourDeadline&&(j.twelveHourDeadline=!0,d.flashMessage(c.t("notices.twelve_hours_left","Twelve Hours Left")))),j.updateTimeString(i)},updateTimeString:function(a){var b=new Date(Math.abs(a)),d=b.getUTCFullYear()-1970,e=b.getUTCMonth(),f=b.getUTCDate()-1,g=b.getUTCHours(),h=b.getUTCMinutes(),i=b.getUTCSeconds(),j=[];d&&j.push(c.t("years_count","Year",{count:d})),e&&j.push(c.t("months_count","Month",{count:e})),f&&j.push(c.t("days_count","Day",{count:f})),g&&j.push(c.t("hours_count","Hour",{count:g})),j.push(c.t("minutes_count","Minute",{count:h})),j.push(c.t("seconds_count","Second",{count:i})),n.text(j.join(", "))},updateFinalSubmitButtonState:function(){var a=d("#question_list li:not(.answered)").length==0,b=d("#submit_quiz_form").hasClass("last_page"),c=d("div.question.answered").length>0,e=j.oneAtATime,f=e&&b&&c||a;j.toggleActiveButtonState("#submit_quiz_button",f)},updateQuestionIndicators:function(a,b){var e="#list_"+b,f="#"+b,g=e+", "+f,h=d(e+"> i.placeholder");a?(d(g).addClass("answered"),h.addClass("icon-check").removeClass("icon-question"),h.siblings("div.icon-text").text(c.t("question_answered","Answered"))):(d(g).removeClass("answered"),h.addClass("icon-question").removeClass("icon-check"),h.siblings("div.icon-text").text(c.t("question_unanswered","Haven't Answered Yet")))},updateNextButtonState:function(a){var b=d("#"+a);j.toggleActiveButtonState("button.next-question",b.hasClass("answered"))},toggleActiveButtonState:function(a,b){var c=b?"btn-primary":"btn-secondary",e=b?"btn-secondary":"btn-primary";d(a).addClass(c).removeClass(e)},submitQuiz:function(){var a=d("#submit_quiz_button").data("action");d("#submit_quiz_form").attr("action",a).submit()}}}();d(document).mousedown(function(a){h=d(a.target).parents(".answer")[0]}).keydown(function(){h=null}),d(function(){d.scrollSidebar(),f(),d("#preview_mode_link").length==0&&(window.onbeforeunload=function(){if(!j.navigatingToRelogin){j.updateSubmission(!1,!0);if(!j.submitting&&!j.alreadyAcceptedNavigatingAway)return c.t("confirms.unfinished_quiz","You're about to leave the quiz unfinished.  Continue anyway?")}},d(document).delegate("a","click",function(a){if(d(this).closest(".ui-dialog,.mceToolbar,.ui-selectmenu").length>0)return;if(d(this).hasClass("no-warning")){j.alreadyAcceptedNavigatingAway=!0;return}if(!a.isDefaultPrevented()){var b=d(this).attr("href")||"",e=location.href;e.indexOf("#")&&(e=e.substring(0,e.indexOf("#")));if(b.indexOf("#")==0||b.indexOf(e+"#")==0)return;var f=confirm(c.t("confirms.navigate_away","You're about to navigate away from this page.  Continue anyway?"));f?j.alreadyAcceptedNavigatingAway=!0:a.preventDefault()}}));var a=d("#questions");d("#question_list").delegate(".jump_to_question_link","click",function(a){a.preventDefault();var b=d(d(this).attr("href")),c=ENV.MOBILE_UI?"#content":"html,body";d(c).scrollTo(b.parent()),b.find(":input:first").focus().select()}).find(".list_question").bind({mouseenter:function(a){var b=d(this),e=b.data(),f=c.t("titles.not_answered","Haven't Answered yet");b.hasClass("marked")?f=c.t("titles.come_back_later","You marked this question to come back to later"):b.hasClass("answered")&&(f=c.t("titles.answered","Answered")),b.attr("title",f),j.oneAtATime||(e.relatedQuestion||(e.relatedQuestion=d("#"+b.attr("id").substring(5))),e.relatedQuestion.addClass("related"))},mouseleave:function(a){if(!j.oneAtATime){var b=d(this).data("relatedQuestion");b&&b.removeClass("related")}}}),a.find(".group_top,.answer_select").bind({mouseenter:function(a){d(this).addClass("hover")},mouseleave:function(a){d(this).removeClass("hover")}}),a.delegate(":checkbox,:radio,label","change mouseup",function(a){var b=d(this).parents(".answer");h==b[0]&&(b.find(":checkbox,:radio").blur(),j.updateSubmission())}).delegate(":text,textarea,select","change",function(a,b){var c=d(this);if(c.hasClass("numerical_question_input")){var e=parseFloat(c.val());c.val(isNaN(e)?"":e.toFixed(4))}b!==!1&&j.updateSubmission()}).delegate(".numerical_question_input",{keyup:function(a){var b=d(this).val();b===""||!isNaN(parseFloat(b))?d(this).triggerHandler("focus"):d(this).errorBox(c.t("errors.only_numerical_values","only numerical values are accepted"))}}).delegate(".flag_question","click",function(){var a=d(this).parents(".question");a.toggleClass("marked"),d("#list_"+a.attr("id")).toggleClass("marked"),j.updateSubmission()}).delegate(".question_input","change",function(a,b,c){var e=d(this),f=this.tagName.toUpperCase(),g=e.parents(".question").attr("id"),h="";if(f=="A")return;if(c){if(c[g])return;c[g]=!0}if(f=="TEXTAREA")h=e.editorBox("get_code");else if(e.attr("type")=="text"||e.attr("type")=="hidden")h=e.val();else if(f=="SELECT"){var i=e.parents(".question").find("select.question_input");h=!i.filter(function(){return!d(this).val()}).length}else e.parents(".question").find(".question_input").each(function(){if(d(this).attr("checked")||d(this).attr("selected"))h=!0});j.updateQuestionIndicators(h,g),j.updateFinalSubmitButtonState(),j.updateNextButtonState(g)}),a.find(".question_input").trigger("change",[!1,{}]),setInterval(function(){d("textarea.question_input").each(function(){d(this).triggerHandler("change",!1)})},2500),d(".hide_time_link").click(function(a){a.preventDefault(),d(".time_running").css("visibility")!="hidden"?(d(".time_running").css("visibility","hidden"),d(this).text(c.t("show_time_link","Show"))):(d(".time_running").css("visibility","visible"),d(this).text(c.t("hide_time_link","Hide")))}),setTimeout(function(){d("#question_list .list_question").each(function(){var a=d(this);a.find(".jump_to_question_link").text()=="Spacer"&&a.remove()})},1e3),d("#submit_quiz_form input[type=text]").keypress(function(a){if(a.keyCode==13)return!1}),d(".quiz_submit").click(function(a){j.finalSubmitButtonClicked=!0}),d("#submit_quiz_form").submit(function(a){d(".question_holder textarea.question_input").each(function(){d(this).change()});var b,e;j.cantGoBack&&(d(".question").hasClass("answered")||(e=c.t("confirms.cant_go_back_blank","You can't come back to this question once you hit next. Are you sure you want to leave it blank?"))),j.finalSubmitButtonClicked&&(j.finalSubmitButtonClicked=!1,j.cantGoBack?(unseen=d("#question_list .list_question:not(.seen)").length,unseen>0&&(e=c.t("confirms.unseen_questions",{one:"There is still 1 question you haven't seen yet.  Submit anyway?",other:"There are still %{count} questions you haven't seen yet.  Submit anyway?"},{count:unseen}))):(b=d("#question_list .list_question:not(.answered)").length,b>0&&(e=c.t("confirms.unanswered_questions",{one:"You have 1 unanswered question (see the right sidebar for details).  Submit anyway?",other:"You have %{count} unanswered questions (see the right sidebar for details).  Submit anyway?"},{count:b}))));if(e!=undefined&&!j.submitting){var f=confirm(e);if(!f)return a.preventDefault(),a.stopPropagation(),!1}j.submitting=!0}),d(".submit_quiz_button").click(function(a){a.preventDefault(),d("#times_up_dialog").dialog("close")}),setTimeout(function(){d(".question_holder textarea.question_input").each(function(){d(this).attr("id","question_input_"+j.contentBoxCounter++),d(this).editorBox()})},2e3),setInterval(j.updateTime,400),setTimeout(function(){j.updateSubmission(!0)},15e3);var b=d("#submit_quiz_form button[type=submit]");b.click(function(a){j.updateSubmission(!1,!0);var b=d(this).data("action");b!=undefined&&d("#submit_quiz_form").attr("action",b)}),b.removeAttr("disabled")}),d(".file-upload-question-holder").each(function(c,e){var f=d(e),g=parseInt(f.find("input.attachment-id").val(),10);g&&g!==0&&f.find(".file-upload-box").addClass("file-upload-box-with-file");var h=new b(ENV.ATTACHMENTS[g],{preflightUrl:ENV.UPLOAD_URL});(new a({el:e,model:h})).render()})})