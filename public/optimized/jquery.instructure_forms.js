define(["INST","i18n!instructure","jquery","underscore","compiled/xhr/FakeXHR","jquery.ajaxJSON","jquery.disableWhileLoading","jquery.google-analytics","jquery.instructure_date_and_time","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","compiled/jquery.rails_flash_notifications","tinymce.editor_box","vendor/jquery.scrollTo"],function(a,b,c,d,e){c.fn.formSubmit=function(b){return this.submit(function(f){var g=c(this),h=b.onSubmit;if(g.data("submitting"))return;g.data("trigger_event",f),g.hideErrors();var i=!1,j=g.validateForm(b);if(!j)return!1;var k=g.getFormData(b);if(b.processData&&c.isFunction(b.processData)){var l=null;try{l=b.processData.call(g,k)}catch(m){i=m}if(l===!1)return!1;l&&(k=l)}var n=g.data("method")||g.find("input[name='_method']").val()||g.attr("method"),o=g.attr("id"),p=g.attr("action"),q=null;if(c.isFunction(b.beforeSubmit)){q=null;try{q=b.beforeSubmit.call(g,k)}catch(m){i=m}if(q===!1)return!1}if(b.disableWhileLoading){var r=h;h=function(a){if(b.disableWhileLoading==="spin_on_success"){var d=a;a=c.Deferred(),d.fail(function(){a.reject()})}g.disableWhileLoading(a),r&&r.apply(this,arguments)}}if(h){var s=c.Deferred(),t={};h(s,k),c.each(["success","error"],function(a,d){t[d]=b[d],b[d]=function(){s[d==="success"?"resolve":"reject"].apply(s,arguments);if(c.isFunction(t[d]))return t[d].apply(this,arguments)}})}var u=b.fileUpload;if(c.isFunction(b.fileUpload))try{u=b.fileUpload.call(g,k)}catch(m){i=m}u&&b.fileUploadOptions&&c.extend(b,b.fileUploadOptions),g.attr("action")&&(p=g.attr("action"));if(i&&!b.preventDegradeToFormSubmit){s&&s.reject(),a&&a.environment=="development"&&c.flashError("formSubmit error, trying to gracefully degrade. See console for details");return}f.preventDefault(),f.stopPropagation();var v=function(a,d){c.isFunction(b.success)&&b.success.call(g,a,q,d)},w=function(a,d){var e=g,f=!0;if(c.isFunction(b.error)){var h=b.error.call(g,a.errors||a,q,d);h&&(e=h),f=!1}e.parents("html").get(0)==c("html").get(0)&&b.formErrors!==!1?(c.isFunction(b.errorFormatter)&&(a=b.errorFormatter(a.errors||a)),e.formErrors(a,b)):f&&c.ajaxJSON.unhandledXHRs.push(d)};if(b.noSubmit)v.call(this,k,{});else if(u&&b.preparedFileUpload&&b.context_code)c.ajaxJSONPreparedFiles.call(this,{handle_files:b.upload_only?v:b.handle_files,single_file:b.singleFile,context_code:c.isFunction(b.context_code)?b.context_code.call(g):b.context_code,asset_string:b.asset_string,intent:b.intent,folder_id:c.isFunction(b.folder_id)?b.folder_id.call(g):b.folder_id,file_elements:g.find("input[type='file']:visible"),url:b.upload_only?null:p,method:b.method,uploadDataUrl:b.uploadDataUrl,formData:k,formDataTarget:b.formDataTarget,success:v,error:w});else if(u&&c.handlesHTML5Files&&g.hasClass("handlingHTML5Files")){var x=c.extend({},k);g.find("input[type='file']").each(function(){var a=c(this),b=a.data("file_list");b&&b instanceof FileList&&(x[a.attr("name")]=b)}),c.toMultipartForm(x,function(a){c.sendFormAsBinary({url:p,body:a.body,content_type:a.content_type,form_data:a.form_data,method:n,success:v,error:w})})}else if(u){var y=d.uniqueId(o+"_"),z=c("<div style='display: none;' id='box_"+y+"'><iframe id='frame_"+y+"' name='frame_"+y+"' src='about:blank' onload='$(\"#frame_"+y+'").triggerHandler("form_response_loaded");\'></iframe>').appendTo("body").find("#frame_"+y),A=n,B=g.attr("target"),C=g.attr("ENCTYPE"),D=new e;g.attr({method:n,action:p,ENCTYPE:"multipart/form-data",encoding:"multipart/form-data",target:"frame_"+y}),b.onlyGivenParameters&&(g.find("input[name='_method']").remove(),g.find("input[name='authenticity_token']").remove()),c.ajaxJSON.storeRequest(D,p,n,k),z.bind("form_response_loaded",function(){var a=z[0],b=a.contentDocument||a.contentWindow.document;if(b.location.href=="about:blank")return;D.setResponse(c(b).text()),c.httpSuccess(D)?v.call(this,D.response,D):(w.call(this,D.response,D),c.fn.defaultAjaxError.func.call(c.fn.defaultAjaxError.object,null,D,"0",null)),setTimeout(function(){g.attr({ENCTYPE:C,encoding:C,target:B}),c("#box_"+y).remove()},5e3)}),g.data("submitting",!0).submit().data("submitting",!1)}else c.ajaxJSON(p,n,k,v,w)}),this},c.ajaxJSONPreparedFiles=function(a){var b=[],d=this,e=a.files||a.file_elements||[];for(var f=0;f<e.length;f++){var g=e[f];g.name=(g.value||g.name).split(/(\/|\\)/).pop(),b.push(g)}var h=[],i=function(){var b=a.formDataTarget=="url"?a.formData:{};if(a.handle_files){var d=h;a.single_file&&(d=h[0]),b=a.handle_files.call(this,d,b)}a.url&&a.success&&b!==!1&&c.ajaxJSON(a.url,a.method,b,a.success,a.error)},j=function(b,e){c.ajaxJSON(a.uploadDataUrl||"/files/pending","POST",b,function(b){try{if(b&&b.upload_url){var f=b.upload_params,g=c(e).attr("name");c(e).attr("name",b.file_param),c.ajaxJSONFiles(b.upload_url,"POST",f,c(e),function(a){h.push(a),c(e).attr("name",g),k.call(d)},function(b){c(e).attr("name",g),(a.upload_error||a.error).call(d,b)},{onlyGivenParameters:!0})}else(a.upload_error||a.error).call(d,b)}finally{}},function(){return(a.upload_error||a.error).apply(this,arguments)})},k=function(){var e=b.shift();e?j.call(d,c.extend({name:e.name,on_duplicate:"rename","attachment[folder_id]":a.folder_id,"attachment[intent]":a.intent,"attachment[asset_string]":a.asset_string,"attachment[filename]":e.name,"attachment[context_code]":a.context_code},a.formDataTarget=="uploadDataUrl"?a.formData:{}),e):i.call(d)};k.call(d)},c.ajaxJSONFiles=function(a,b,d,e,f,g,h){var i=c(document.createElement("form"));i.attr("action",a).attr("method",b),d.authenticity_token||(d.authenticity_token=ENV.AUTHENTICITY_TOKEN);var j={};e.each(function(){j[c(this).attr("name")]=!0});for(var k in d)if(!j[k]){var l=c(document.createElement("input"));l.attr("type","hidden").attr("name",k).attr("value",d[k]),i.append(l)}e.each(function(){var a=c(this).clone(!0);c(this).after(a),i.append(c(this)),c(this).removeAttr("id")}),c("body").append(i.hide()),i.formSubmit({fileUpload:!0,success:f,onlyGivenParameters:h?h.onlyGivenParameters:!1,error:g}),i.submit()},c.handlesHTML5Files=!!(window.File&&window.FileReader&&window.FileList&&XMLHttpRequest),c.handlesHTML5Files&&c("input[type='file']").live("change",function(a){var b=this.files;b&&(c(this).data("file_list",b),c(this).parents("form").addClass("handlingHTML5Files"))}),c.ajaxFileUpload=function(a){a.data.authenticity_token||(a.data.authenticity_token=ENV.AUTHENTICITY_TOKEN),c.toMultipartForm(a.data,function(b){c.sendFormAsBinary({url:a.url,body:b.body,content_type:b.content_type,form_data:b.form_data,method:a.method,success:function(b){a.success&&c.isFunction(a.success)&&a.success.call(this,b)},progress:function(b){a.progress&&c.isFunction(a.progress)&&a.progress.call(this,b)},error:function(b,d){if(a.error&&c.isFunction(a.error)){b=b||{};var e=a.error.call(this,b.errors||b)}else c.ajaxJSON.unhandledXHRs.push(d)}},a.binary===!1)})},c.httpSuccess=function(a){try{return!a.status&&location.protocol=="file:"||a.status>=200&&a.status<300||a.status==304||jQuery.browser.safari&&a.status==undefined}catch(b){}return!1},c.sendFormAsBinary=function(a,b){var d=a.body,e=a.url,f=a.method,g=new XMLHttpRequest;g.upload&&(g.upload.addEventListener("progress",function(b){a.progress&&c.isFunction(a.progress)&&a.progress.call(this,b)},!1),g.upload.addEventListener("error",function(b){a.error&&c.isFunction(a.error)&&a.error.call(this,"uploading error",g,b)},!1),g.upload.addEventListener("abort",function(b){a.error&&c.isFunction(a.error)&&a.error.call(this,"aborted by the user",g,b)},!1),g.onreadystatechange=function(b){if(g.readyState==4){var d=null;try{d=c.parseJSON(g.responseText)}catch(e){}c.httpSuccess(g)?d&&!d.errors?a.success&&c.isFunction(a.success)&&a.success.call(this,d,g,b):a.error&&c.isFunction(a.error)&&a.error.call(this,d||g.responseText,g,b):a.error&&c.isFunction(a.error)&&a.error.call(this,d||g.responseText,g,b)}}),g.open(f,e),g.setRequestHeader("Accept","application/json, text/javascript, */*"),g.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.form_data?g.send(a.form_data):(g.overrideMimeType(a.content_type||"multipart/form-data"),g.setRequestHeader("Content-Type",a.content_type||"multipart/form-data"),g.setRequestHeader("Content-Length",d.length),b?g.send(d):g.sendAsBinary?g.sendAsBinary(d):console.log("xhr.sendAsBinary not supported"))},c.fileData=function(a){return{name:a.name||a.fileName,size:a.size||a.fileSize,type:a.type,forced_type:a.type||"application/octet-stream"}},c.toMultipartForm=function(a,b){function n(a){return a.replace(/\"/g,"")}function o(){f.body=g.substring(0,g.length-2)+"--",b(f)}function p(){if(h.length===0){o();return}var a=h.shift(),b=a[0],f=a[1];window.FileList&&f instanceof FileList&&(f=f[0]);if(window.FileList&&f instanceof FileList){var i="-----BbC04y"+d.uniqueId(),j=[];g+='Content-Disposition: form-data; name="'+n(b)+"\r\n"+"Content-Type: multipart/mixed; boundary="+i+"\r\n\r\n";for(var k in f)j.push(f);function l(){g+="--"+i+"--\r\n"+"--"+e+"\r\n",p()}function m(){if(j.length===0){l();return}var a=j.shift(),b=c.fileData(a),d=new FileReader;d.onloadend=function(){g+="--"+i+"\r\n"+'Content-Disposition: file; filename="'+n(b.name)+'"\r\n'+"Content-Type: "+b.forced_type+"\r\n"+"Content-Transfer-Encoding: binary\r\n"+"\r\n"+d.result,m()},d.readAsBinaryString(a)}m()}else if(window.File&&f instanceof File){var q=c.fileData(f),r=new FileReader;r.onloadend=function(){g+='Content-Disposition: file; name="'+n(b)+'"; filename="'+q.name+'"\r\n'+"Content-Type: "+q.forced_type+"\r\n"+"Content-Transfer-Encoding: binary\r\n"+"\r\n"+r.result+"\r\n--"+e+"\r\n",p()},r.readAsBinaryString(f)}else f&&f.fake_file?(g+='Content-Disposition: file; name="'+n(b)+'"; filename="'+f.name+'"\r\n'+"Content-Type: "+f.content_type+"\r\n"+"Content-Transfer-Encoding: binary\r\n"+"\r\n"+f.content+"\r\n--"+e+"\r\n",p()):(g+='Content-Disposition: form-data; name="'+n(b)+'"\r\n'+"\r\n"+(f||"").toString()+"\r\n"+"--"+e+"\r\n",p())}var e="-----AaB03x"+d.uniqueId(),f={content_type:"multipart/form-data; boundary="+e},g="--"+e+"\r\n",h=[],i=!1;for(var j in a)h.push([j,a[j]]),a[j]&&a[j].fake_file&&(i=!0);if(window.FormData&&!i){var k=new FormData;for(var j in a){var l=a[j];window.FileList&&l instanceof FileList&&(l=l[0]);if(l instanceof Array)for(var m=0;m<l.length;m++)k.append(j,l[m]);else k.append(j,l)}f.form_data=k,b(f);return}p()},c.fn.fillFormData=function(a,b){if(this.length){a=a||[];var d=c.extend({},c.fn.fillFormData.defaults,b);d.object_name&&(a=c._addObjectName(a,d.object_name,!0)),this.find(":input").each(function(){var b=c(this),e=b.attr("name"),f=b.attr("type");if(e in a&&e){if(f!="hidden"||b.next("input:checkbox").attr("name")!=e)if(f!="checkbox"&&f!="radio"){var g=a[e];if(typeof g=="undefined"||g===null)g="";b.val(g.toString())}else b.val()==a[e]?b.attr("checked",!0):b.attr("checked",!1);b&&b.change&&d.call_change&&b.change()}})}return this},c.fn.fillFormData.defaults={object_name:null,call_change:!0},c.fn.getFormData=function(a){var a=c.extend({},c.fn.getFormData.defaults,a),b={},d=this;return d.find(":input").not(":button").each(function(){var e=c(this),f=e.attr("type");if((f=="radio"||f=="checkbox")&&!e.attr("checked"))return;var g=e.val();if(e.hasClass("datetime_field_enabled")){var h=e.parent().children(".datetime_suggest").text();h&&(g=h)}try{e.data("rich_text")&&(g=e.editorBox("get_code",!1))}catch(i){}var j=e.prop("name")||"",k=j.match(/\[\]$/);if(f=="hidden"&&!k&&d.find("[name='"+j+"']").filter("textarea,:radio:checked,:checkbox:checked,:text,:password,select,:hidden")[0]!=e[0])return;j&&j!==""&&(f=="checkbox"||typeof b[j]=="undefined"||k)&&(!a.values||c.inArray(j,a.values)!=-1)&&(k?(b[j]=b[j]||[],b[j].push(g)):b[j]=g);var l=j}),a.object_name&&(b=c._stripObjectName(b,a.object_name,!0)),b},c.fn.getFormData.defaults={object_name:null},c._addObjectName=function(a,b,c){if(!a)return a;var d={};a instanceof Array&&(d=[]);var e,f,g;for(var h in a)a instanceof Array?e=a[h]:e=h,g=e.indexOf("["),g>=0?f=b+"["+e.substring(0,g)+"]"+e.substring(g):f=b+"["+e+"]",typeof e=="string"&&e.indexOf("=")===0&&(f=e.substring(1),e=f),a instanceof Array?(d.push(f),c&&d.push(e)):(d[f]=a[h],c&&(d[e]=a[h]));return d},c._stripObjectName=function(a,b,c){var d={},e;a instanceof Array&&(d=[]);for(var f in a){var g,h;a instanceof Array?g=a[f]:g=f;if(h=g.indexOf(b+"[")===0)e=g.replace(b+"[",""),closing=e.indexOf("]"),e=e.substring(0,closing)+e.substring(closing+1),a instanceof Array?d.push(e):d[e]=a[f];if(!h||c)a instanceof Array?d.push(a[f]):d[f]=a[f]}return d},c.fn.validateForm=function(a){if(this.length===0)return!1;var a=c.extend({},c.fn.validateForm.defaults,a),e=this,f={},g=a.data||e.getFormData(a);a.object_name&&(a.required=c._addObjectName(a.required,a.object_name),a.date_fields=c._addObjectName(a.date_fields,a.object_name),a.dates=c._addObjectName(a.dates,a.object_name),a.times=c._addObjectName(a.times,a.object_name),a.numbers=c._addObjectName(a.numbers,a.object_name),a.property_validations=c._addObjectName(a.property_validations,a.object_name));if(a.required){var h=d.result(a,"required");c.each(h,function(a,c){g[c]||(f[c]||(f[c]=[]),f[c].push(b.t("errors.field_is_required","This field is required")))})}a.date_fields&&c.each(a.date_fields,function(a,c){var d=e.find("input[name='"+c+"']").filter(".datetime_field_enabled");d.length&&d.parent().children(".datetime_suggest").hasClass("invalid_datetime")&&(f[c]||(f[c]=[]),f[c].push(b.t("errors.invalid_datetime","Invalid date/time value")))}),a.numbers&&c.each(a.numbers,function(a,c){var d=parseFloat(g[c]);isNaN(d)&&(f[c]||(f[c]=[]),f[c].push(b.t("errors.invalid_number","This should be a number.")))}),a.property_validations&&c.each(a.property_validations,function(a,d){if(c.isFunction(d)){var h=d.call(e,g[a],g);h&&(typeof h!="string"&&(h=b.t("errors.invalid_entry_for_field","Invalid entry: %{field}",{field:a})),f[a]||(f[a]=[]),f[a].push(h))}});var i=!1;for(var j in f){i=!0;break}return i?(e.formErrors(f,a),c.trackEvent("Form Errors",this.attr("id")||this.attr("class")||document.title,JSON.stringify(f)),!1):!0},c.fn.validateForm.defaults={object_name:null,required:null,dates:null,times:null},c.fn.formErrors=function(a,b){if(this.length===0)return;var d=this,e={},f=[];a&&a.errors&&(a=a.errors),typeof a=="string"&&(a={base:a}),c.each(a,function(a,b){if(typeof b=="string"){var g=[];g.push(b),b=g}else{if(typeof a=="number"&&b.length==2&&b[0]instanceof jQuery&&typeof b[1]=="string"){f.push(b);return}if(typeof a=="number"&&b.length==2&&typeof b[1]=="string")g=[],g.push(b[1]),a=b[0],b=g;else try{g=[];for(var h in b)typeof b[h]=="object"&&b[h].message?g.push(b[h].message.toString()):g.push(b[h].toString());b=g}catch(i){b=b.toString()}}d.find(":input[name='"+a+"'],:input[name*='["+a+"]']").length>0?c.each(b,function(b,c){e[a]?e[a]+="<br/>"+c:e[a]=c}):c.each(b,function(a,b){e.general?e.general+="<br/>"+b:e.general=b})});var g=!1,h=0,i=c(document).scrollTop(),j={};c("#aria_alerts").empty(),c.each(e,function(a,b){var c=d.find(":input[name='"+a+"'],:input[name*='["+a+"]']").filter(":first");if(!c||c.length===0||a=="general")c=d;c[0].tagName=="TEXTAREA"&&c.next(".mceEditor").length&&(c=c.next().find(".mceIframeContainer")),j[a]={object:c,message:b},g=!0;var e=c.errorBox(b).offset();e.top>h&&(h=e.top)});for(var k in f){var l=f[k][0],m=f[k][1];g=!0;var n=l.errorBox(m).offset();n.top>h&&(h=n.top)}return g&&(b&&b.onFormError&&b.onFormError.call(d,j),c("html,body").scrollTo({top:h,left:0})),this},c.fn.errorBox=function(a,b){if(this.length){var d=this,e=d.data("associated_error_box");e&&e.remove();var f=c("#error_box_template");f.length||(f=c("<div id='error_box_template' class='error_box errorBox' style=''><div class='error_text' style=''></div><img src='/images/error_bottom.png' class='error_bottom'/></div>").appendTo("body"));var g=f.clone(!0).attr("id","").css("zIndex",d.zIndex()+1).appendTo("body");g.find(".error_text").html(a),c("#aria_alerts").append(c("<div/>").html(a));var h=d.offset(),i=g.outerHeight(),j=Math.round(d.outerWidth()/5);return d[0].tagName=="FORM"&&(j=Math.min(j,50)),g.hide().css({top:h.top-i+2,left:h.left+j}).fadeIn("fast"),d.data({associated_error_box:g,associated_error_object:d}).focus(function(){g.fadeOut("slow",function(){g.remove()})}),g.click(function(){c(this).fadeOut("fast",function(){c(this).remove()})}),c.fn.errorBox.errorBoxes.push(d),c.fn.errorBox.isBeingAdjusted||c.moveErrorBoxes(),b&&c("html,body").scrollTo(g),g}},c.fn.errorBox.errorBoxes=[],c.moveErrorBoxes=function(){var a=[],b=c.fn.errorBox.errorBoxes;for(var d in b){var e=b[d],f=e.data("associated_error_box");if(f&&f.length&&f[0].parentNode){a.push(e);if(e.filter(":visible").length){var g=e.offset(),h=f.outerHeight(),i=Math.round(e.outerWidth()/5);e[0].tagName=="FORM"&&(i=Math.min(i,50)),f.css({top:g.top-h+2,left:g.left+i}).show()}else f.hide()}}c.fn.errorBox.errorBoxes=a,a.length?c.fn.errorBox.isBeingAdjusted=setTimeout(c.moveErrorBoxes,500):delete c.fn.errorBox.isBeingAdjusted},c.fn.hideErrors=function(a){if(this.length){var b=this.data("associated_error_box");b&&(b.remove(),this.data("associated_error_box",null)),this.find(":input").each(function(){var a=c(this),b=a.data("associated_error_box");b&&(b.remove(),a.data("associated_error_box",null))})}return this}})