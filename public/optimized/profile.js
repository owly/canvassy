define(["INST","i18n!profile","jquery","compiled/models/Pseudonym","compiled/util/AvatarWidget","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","compiled/jquery/fixDialogButtons","jquery.instructure_misc_plugins","jquery.loadingImg","jquery.templateData","jqueryui/sortable","compiled/jquery.rails_flash_notifications"],function(a,b,c,d,e){var f=c(".edit_settings_link"),g=c(".profile_table"),h=c("#update_profile_form"),i=c("#default_email_id"),j="/api/v1/users/self/avatars";f.click(function(a){return c(this).hide(),g.addClass("editing").find(".edit_data_row").show().end().find(":text:first").focus().select(),!1}),g.find(".cancel_button").click(function(a){return f.show(),g.removeClass("editing").find(".change_password_row,.edit_data_row,.more_options_row").hide().end().find("#change_password_checkbox").attr("checked",!1),!1}),g.find("#change_password_checkbox").change(function(a){c(this).attr("checked")?(c(this).addClass("showing"),g.find(".change_password_row").show().find("#old_password").focus().select()):g.find(".change_password_row").hide().find(":password").val("")}).attr("checked",!1).change(),h.attr("method","PUT").formSubmit({formErrors:!1,required:h.find("#user_name").length?["name"]:[],object_name:"user",property_validations:{"=default_email_id":function(a,d){if(c("#default_email_id").length&&(!a||a=="new"))return b.t("please_select_an_option","Please select an option")}},beforeSubmit:function(a){h.loadingImage()},success:function(a){var b=a.user,d={short_name:b.short_name,full_name:b.name,sortable_name:b.sortable_name,time_zone:b.time_zone,locale:c("#user_locale option[value='"+b.locale+"']").text()};if(d.locale!=h.find(".locale").text()){location.reload();return}h.loadingImage("remove");if(i.length>0){var e=i.find("option:selected").text();c(".default_email.display_data").text(e)}c(".channel").removeClass("default"),c("#channel_"+b.communication_channel.id).addClass("default"),h.fillTemplateData({data:d}).find(".cancel_button").click()},error:function(a){if(a.password){var b=c(this).find("#profile_pseudonym_id").val();a=d.prototype.normalizeErrors(a,ENV.PASSWORD_POLICIES[b]||ENV.PASSWORD_POLICY)}h.loadingImage("remove").formErrors(a),f.click()}}).find(".more_options_link").click(function(){return h.find(".more_options_link_row").hide(),h.find(".more_options_row").show(),!1}),c("#default_email_id").change(function(){c(this).val()=="new"&&c(".add_email_link:first").click()}),c("#unregistered_services li.service").click(function(a){a.preventDefault(),c("#"+c(this).attr("id")+"_dialog").dialog({width:350})}),c(".create_user_service_form").formSubmit({object_name:"user_service",beforeSubmit:function(a){c(this).loadingImage()},success:function(a){c(this).loadingImage("remove").parents(".content").dialog("close"),document.location.reload()},error:function(a){c(this).loadingImage("remove").errorBox(b.t("errors.registration_failed","Registration failed. Check the user name and password, and try again."))}}),c("#unregistered_services li.service .content form .cancel_button").click(function(a){c(this).parents(".content").dialog("close")}),c("#registered_services li.service .delete_service_link").click(function(a){a.preventDefault(),c(this).parents("li.service").confirmDelete({message:b.t("confirms.unregister_service","Are you sure you want to unregister this service?"),url:c(this).attr("href"),success:function(a){c(this).slideUp(function(){c("#unregistered_services").find("#unregistered_"+c(this).attr("id")).slideDown()})}})}),c(".service").hover(function(){c(this).addClass("service-hover")},function(){c(this).removeClass("service-hover")}),c("#show_user_services").change(function(){c.ajaxJSON(c("#update_profile_form").attr("action"),"PUT",{"user[show_user_services]":c(this).prop("checked")},function(a){},function(a){})}),c(".delete_pseudonym_link").click(function(a){a.preventDefault(),c(this).parents(".pseudonym").confirmDelete({url:c(this).attr("href"),message:b.t("confirms.delete_login","Are you sure you want to delete this login?")})}),c(".datetime_field").datetime_field(),c(".expires_field").bind("change keyup",function(){c(this).closest("td").find(".hint").showIf(!c(this).val())}),c(".delete_key_link").click(function(a){a.preventDefault(),c(this).closest(".access_token").confirmDelete({url:c(this).attr("rel"),message:b.t("confirms.delete_access_key","Are you sure you want to delete this access key?"),success:function(){c(this).remove(),c(".access_token:visible").length||c("#no_approved_integrations,#access_tokens_holder").toggle()}})}),c("#add_access_token_dialog .cancel_button").click(function(){c("#add_access_token_dialog").dialog("close")}),c("#access_token_form").formSubmit({object_name:"access_token",required:["purpose"],beforeSubmit:function(){c(this).find("button").attr("disabled",!0).filter(".submit_button").text(b.t("buttons.generating_token","Generating Token..."))},success:function(a){c(this).find("button").attr("disabled",!1).filter(".submit_button").text(b.t("buttons.generate_token","Generate Token")),c("#add_access_token_dialog").dialog("close"),c("#no_approved_integrations").hide(),c("#access_tokens_holder").show();var d=c(".access_token.blank:first").clone(!0).removeClass("blank");a.created=c.parseFromISO(a.created_at).datetime_formatted||"--",a.expires=c.parseFromISO(a.expires_at).datetime_formatted||b.t("token_never_expires","never"),a.used="--",d.fillTemplateData({data:a,hrefValues:["id"]}),d.data("token",a),c("#access_tokens > tbody").append(d.show()),d.find(".show_token_link").click()},error:function(){c(this).find("button").attr("disabled",!1).filter(".submit_button").text(b.t("errors.generating_token_failed","Generating Token Failed"))}}),c("#token_details_dialog .regenerate_token").click(function(){var a=confirm(b.t("confirms.regenerate_token","Are you sure you want to regenerate this token?  Anything using this token will have to be updated."));if(!a)return;var d=c("#token_details_dialog"),e=d.data("token"),f=d.data("token_url"),g=c(this);g.text(b.t("buttons.regenerating_token","Regenerating token...")).attr("disabled",!0),c.ajaxJSON(f,"PUT",{"access_token[regenerate]":"1"},function(a){a.created=c.parseFromISO(a.created_at).datetime_formatted||"--",a.expires=c.parseFromISO(a.expires_at).datetime_formatted||b.t("token_never_expires","never"),a.used=c.parseFromISO(a.last_used_at).datetime_formatted||"--",a.visible_token=a.visible_token||"protected",d.fillTemplateData({data:a}).find(".full_token_warning").showIf(a.visible_token.length>10),e.data("token",a),g.text(b.t("buttons.regenerate_token","Regenerate Token")).attr("disabled",!1)},function(){g.text(b.t("errors.regenerating_token_failed","Regenerating Token Failed")).attr("disabled",!1)})}),c(".show_token_link").click(function(a){function g(a){d.fillTemplateData({data:a}),d.data("token_url",e),d.find(".refresh_token").showIf(a.visible_token&&a.visible_token!=="protected").find(".regenerate_token").text(b.t("buttons.regenerate_token","Regenerate Token")).attr("disabled",!1),d.find(".loading_message,.error_loading_message").hide().end().find(".results").show().end().find(".full_token_warning").showIf(a.visible_token.length>10)}a.preventDefault();var d=c("#token_details_dialog"),e=c(this).attr("rel");d.dialog({width:600});var f=c(this).parents(".access_token");d.data("token",f),d.find(".loading_message").show().end().find(".results,.error_loading_message").hide();var h=f.data("token");h?g(h):c.ajaxJSON(e,"GET",{},function(a){a.created=c.parseFromISO(a.created_at).datetime_formatted||"--",a.expires=c.parseFromISO(a.expires_at).datetime_formatted||b.t("token_never_expires","never"),a.used=c.parseFromISO(a.last_used_at).datetime_formatted||"--",a.visible_token=a.visible_token||"protected",f.data("token",a),g(a)},function(){d.find(".error_loading_message").show().end().find(".results,.loading_message").hide()})}),c(".add_access_token_link").click(function(a){a.preventDefault(),c("#access_token_form").find("button").attr("disabled",!1).filter(".submit_button").text(b.t("buttons.generate_token","Generate Token")),c("#add_access_token_dialog").find(":input").val("").end().dialog({width:500}).fixDialogButtons()}),c(document).fragmentChange(function(a,b){var d=b.substring(1);d.match(/^register/)&&(d=d.substring(9)),c("#unregistered_service_"+d+":visible").length>0&&c("#unregistered_service_"+d+":visible").click()}).fragmentChange(),new e(".profile_pic_link"),c("#disable_mfa_link").click(function(a){var d=c(this);c.ajaxJSON(d.attr("href"),"DELETE",null,function(){c.flashMessage(b.t("notices.mfa_disabled","Multi-factor authentication disabled")),d.remove()}),a.preventDefault()})})