define(["underscore","INST","i18n!files","jquery","str/htmlEscape","compiled/tinymce","tinymce.editor_box","jqueryui/draggable","jquery.ajaxJSON","jquery.doc_previews","jquery.inst_tree","jquery.instructure_date_and_time","jquery.instructure_forms","jqueryui/dialog","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.keycodes","jquery.loadingImg","jquery.scrollToVisible","jquery.templateData","media_comments","vendor/jquery.scrollTo","jqueryui/droppable","jqueryui/progressbar","vendor/scribd.view"],function(a,b,c,d,e){var f={},g=[];(function(){var i=d("#files_content"),j=d("#swfupload_holder"),k=d("#add_file_link"),l=d("#files_structure"),m=d("#files_structure_list");d.extend(f,{canManageAContext:!1,init:function(){i=d("#files_content"),j=d("#swfupload_holder"),k=d("#add_file_link"),l=d("#files_structure"),m=d("#files_structure_list"),i.prepend(j),f.clearDataCache.cacheIndex=0;for(var a in contexts){var b={context:contexts[a],context_name:contexts[a].name,context_string:contexts[a].asset_string};if(contexts[a].asset_string){var n=contexts[a].asset_string.replace(/_\d+$/,"");b[n]=contexts[a]}g.push([b,{}])}for(var a in g)if(g[a]){var o=g[a][0],n=null,p=null,q=null;for(var r in o)o[r]&&r!="context_string"&&r!="context_name"&&r!="context"&&(n=r,p=o[r].name,q=o[r]);g[a][0].context_string=n+"_"+o[n].id,g[a][0].context_name=p,g[a][0].context=q,q&&q.permissions&&q.permissions.manage_files&&(f.canManageAContext=!0)}i.append(d("#drag_n_drop_panel")),i.append(d("#content_templates .content_panel").hide()),d.handlesHTML5Files&&i.bind("dragenter dragover",function(a){a.preventDefault(),a.stopPropagation();var b=f.currentItemData();if(!b||b.mime_class!="folder")return;d(this).addClass("file_drag"),d("#drag_n_drop_panel").css("top",i.scrollTop())}).bind("dragleave dragout",function(a){d(this).closest(".drag_panel").length||d(this).removeClass("file_drag")}).bind("drop",function(a){var b=a.originalEvent.dataTransfer;if(b){var g=f.currentItemData();a.preventDefault(),a.stopPropagation(),d(this).removeClass("file_drag");if(!g||g.mime_class!="folder")return;var i=[],j=b.files;for(var k=0;k<j.length;k++)j[k]&&j[k].size>0&&i.push(j[k]);if(i.length===0){alert(c.t("messages.no_files_selected","No valid files were selected"));return}var l=!1;i.length==1&&i[0].type.match(/application\/(x-)?zip/)&&(l=confirm(c.t("prompts.extract_zip","This file is a zip file.  Do you want to extract its contents into this folder?")));if(l){var m=i[0];g.context_string;var n=d("."+g.context_string+"_zip_import_url").attr("href"),o={folder_id:g.id,zip_file:i[0],format:"json"},p=null,q=d("<div/>");q.append("Uploading and extracting <b>"+e(m.name)+"</b><br/>to "+e(g.name)+"..."),q.append("<div class='progress'/>");var r=q.find(".progress");r.css("margin","10px"),r.progressbar(),q.dialog({title:c.t("titles.extracting","Extracting Files into Folder"),close:function(){q.data("closed",!0),setTimeout(function(){q.detach()},500)}});var s=function(a){q.text(c.t("errors.extracting","There were errors extracting the zip file.  Please try again."));var b=d("<ul/>");for(var e in a){var f=a[e],g=d("<li/>");g.text(f),b.append(g)}q.append(b)},t=function(a){var b=d("#file_context_links ."+g.context_string+"_zip_import_status_url").attr("href");b=d.replaceTags(b,"id",a),d.ajaxJSON(b,"GET",{},function(b){var d=b.zip_file_import;if(q.data("closed"))return;d&&d.data&&d.data.errors?s(d.data.errors):d&&d.workflow_state=="imported"?(r.progressbar("value",100),q.append(c.t("messages.extraction_complete","Extraction complete!  Updating...")),f.refreshContext(g.context_string,function(){q.dialog("close")})):d?d&&d.workflow_state=="failed"?s([]):(t.errorCount=0,setTimeout(function(){t(a)},2e3),r.progressbar("value",(d.progress||0)*100)):(t.blankCount=t.blankCount||0,t.blankCount++,t.blankCount>30?s([c.t("errors.server_returned_invalid_status","The server stopped returning a valid status")]):setTimeout(function(){t(a)},2e3))},function(b){t.errorCount=t.errorCount||0,t.errorCount++,t.errorCount>5?s([c.t("errors.server_unresponsive","The server stopped responding to status requests")]):setTimeout(function(){t(a)},2e3)})};d.ajaxFileUpload({url:n,data:o,method:"POST",success:function(a){zip_import_id=a.zip_file_import.id,t(zip_import_id)},error:function(a){q.text(c.t("errors.uploading_zip","There were errors uploading the zip file."))}})}else{var g=f.currentItemData(),u=[];for(k in i)u.push(i[k].name);f.preflight(g.id,g.context_string,u,function(a){for(k in i)i[k].duplicate_handling=a},function(){for(var a in i)h.queueAjaxUpload(i[a])},function(){})}return!1}})},preflight:function(a,b,f,g,h,i){var j={folder_id:a,context_code:b,filenames:f};d.ajaxJSON("/files/preflight","GET",j,function(a){if(a.duplicates&&a.duplicates.length>0){var b=d("#duplicate_filename_dialog");b.find(".duplicate_filename_prompt").text(c.t("prompts.duplicate_filenames","Files with the following names already exist in this folder. Do you want to replace them, or rename the new files with unique names?"));var f="";for(idx in a.duplicates)f+="<span class='duplicate_filename'>"+e(a.duplicates[idx])+"</span>";b.find(".duplicate_filenames").html(f),b.dialog({title:"",width:500}),b.find("button").unbind("click"),b.find(".cancel_button").click(function(){i(),b.dialog("close")}),b.find(".rename_button").click(function(){g("rename"),h(),b.dialog("close")}),b.find(".overwrite_button").click(function(){g("overwrite"),h(),b.dialog("close")})}else h()},function(a){i()})},context_page_view_ids:{},updatePageView:function(a){return},viewInlinePingUrl:function(a,b){var c=d("#file_context_links ."+a+"_inline_view_attachment_url").attr("href");return c=d.replaceTags(c,"id",b),c},selectFolder:function(a){if(!f.selectFolder.forceRefresh&&(a.hasClass("active-node")||a.hasClass("active-leaf")))return;f.selectFolder.forceRefresh=!1;var b=a;while(b.parent("ul").parent("li").length>0)b=b.parent("ul").parent("li"),f.expandFolder(b);a.children(".text:visible:first").click(),l.find("li.node.active-node,li.leaf.active-leaf").length===0&&l.find("li.node:visible:first").children(".text:visible:first").click();if(!f.currentItemData()){setTimeout(function(){f.selectFolder(a)},250);return}!f.currentItemData().includes_files&&f.currentItemData().full_name&&f.getFilesForFolder(f.currentItemData())},deleteAttachmentIds:function(a){for(var b in a){var c=a[b],e=d("#files_structure .file_"+c);e.prev("li.separator").remove(),e.remove(),f.refreshView(),f.updateQuota()}},gettingFiles:{},getFilesForFolder:function(b,c){var e=b.context_string+"_"+b.id;if(f.gettingFiles[e])return;var g=l.find("li.folder_"+b.id);if(g.hasClass("folder_locked")&&(!b.context||!b.context.permissions||!b.context.permissions.manage_files))return;if(b.false_folder){f.refreshContext(b.context_string,function(){f.getFilesForFolder(b,c)});return}f.gettingFiles[e]=!0;var h=d.replaceTags(d("#file_context_links ."+b.context_string+"_folder_url").attr("href"),"id",b.id);d.ajaxJSON(h,"GET",{},function(g){f.gettingFiles[e]=!1;var h=g.actual_folder.folder;h.includes_files=!0,f.updateFolder(b.context_string,{folder:h,already_in_place:!0},!1),g.files=a.sortBy(g.files,function(a){return(a.attachment.display_name||"").toLowerCase()});for(var j in g.files){var m=g.files[j].attachment;m&&f.updateFile(b.context_string,{attachment:m,definitely_new:!0},!1)}l.find(".folder_"+h.id).triggerHandler("files_load");var n=i.find(".message.no_content:visible").length>0;if(c!==!1||n)c&&d.isFunction(c)?c(g):f.refreshView();k.triggerHandler("show")},function(a){f.gettingFiles[e]=!1})},expandFolder:function(a){m[0]&&m[0].ExpandNode&&m[0].ExpandNode(d("#files_structure_list"),a)},collapseFolder:function(a){m[0]&&m[0].CollapseNode&&m[0].CollapseNode(d("#files_structure_list"),a)},fullPath:function(a){var b=[],c=f.itemData(a);b.unshift(c.name.replace(/\//g,"//"));while(a.parent("ul").parent("li").length>0)a=a.parent("ul").parent("li"),c=f.itemData(a),b.unshift(c.name.replace(/\//g,"//"));return b.join("/")},selectNodeFromPath:function(a){var b=f.nodeFromPath(a);f.selectFolder(b);var c=function(){b.unbind("files_load",c),b.hasClass("active-node")&&f.selectNodeFromPath(a)};b.bind("files_load",c),l.find(".node.active-node,.leaf.active-leaf").length===0&&f.selectFolder(l.find(".node:visible:first"))},nodeFromPath:function(a){var b=a.replace(/\/\//g,"\\").split("/"),c=l,e=!0;for(var f in b){var g=b[f].replace(/\\\\/g,"/"),h=!1;e&&c.children("ul").children("li").each(function(){if(d(this).children(".text.name").text()==g)return c=d(this),h=!0,!1}),e=h}return c},draggable_helper:function(a,b){if(!d(this).hasClass("folder_item")){var c=b.width();return b.clone().css("backgroundColor","#eeeeee").css("height",50).css("borderWidth",1).css("borderStyle","solid").css("borderColor","#ccc").css("width",c-50)}b=d(this);var e=b.clone().attr("id","file_drag");e.find(".header .sub_header").remove(),e.find(".header").append("<div class='sub_header'/>"),e.find(".header .sub_header").html("&nbsp;"),e.addClass("file_drag"),e.find(".links").remove(),e.css("width",100);var f=d("<ul/>");return f.addClass("files_content"),f.append(e),f.addClass("true-draggable"),f.css("width",200),f.css("height",50),d("#content").append(f),f},updateQuota:function(){if(!d("#quota").length)return;var a=d(".quota_url").attr("href");d.ajaxJSON(a,"GET",{},function(a){d("#quota").text(a.quota),d("#quota_used").text(a.quota_used)},function(){})}}),d.extend(f,{draggable_options:{handle:".draggable.item_icon",distance:5,helper:f.draggable_helper,start:function(a,b){i.addClass("dragging")},stop:function(){setTimeout(function(){i.removeClass("dragging")},500)}},droppable_options:{accept:".file,.folder",hoverClass:"drop_target",tolerance:"pointer",drop:function(a,b){if(!d(b.helper).hasClass("true-draggable"))return;var c=d(b.draggable),e=f.itemData(c),g=d(this),h=f.itemData(d(this).parent(".folder"));h=h||f.itemData(d(this)),l.loadingImage();if(c.hasClass("file"))if(d(b.helper).hasClass("copy_drag")){var i=d("#file_context_links ."+h.context_string+"_attachments_url").attr("href"),j={"attachment[source_attachment_id]":e.id,"attachment[folder_id]":h.id};d.ajaxJSON(i,"POST",j,function(a){l.loadingImage("remove"),f.updateFile(h.context_string,a,!1),f.selectFolder(g),f.refreshView()},function(a){l.loadingImage("remove")})}else{var i=d("#file_context_links ."+h.context_string+"_attachment_url").attr("href");i=d.replaceTags(i,"id",e.id),d.ajaxJSON(i,"PUT",{"attachment[folder_id]":h.id},function(a){l.loadingImage("remove"),f.updateFile(h.context_string,a,!1),f.selectFolder(g),f.refreshView()},function(a){l.loadingImage("remove")})}else if(d(b.helper).hasClass("copy_drag")){var i=d("#file_context_links ."+h.context_string+"_folders_url").attr("href"),j={"folder[source_folder_id]":e.id,"folder[parent_folder_id]":h.id};d.ajaxJSON(i,"POST",j,function(a){l.loadingImage("remove"),f.refreshContext(h.root_context_string)},function(a){l.loadingImage("remove")})}else{var i=d("#file_context_links ."+h.context_string+"_folder_url").attr("href");i=d.replaceTags(i,"id",e.id),d.ajaxJSON(i,"PUT",{"folder[parent_folder_id]":h.id},function(a){l.loadingImage("remove"),f.refreshContext(e.root_context_string)},function(a){l.loadingImage("remove")})}},over:function(a,b){d(b.helper).hasClass("true-draggable")||d(this).removeClass("drop_target");var c=f.itemData(d(b.draggable)),g=f.itemData(d(this).parent(".folder"));g=g||f.itemData(d(this)),d(b.helper).find(".header .sub_header").text("move to "+g.name),c&&g&&c.context_string!=g.context_string&&(d(b.helper).addClass("copy_drag"),d(b.helper).find(".header .sub_header").html("<strong>copy</strong> to "+e(g.name)))},out:function(a,b){d(b.helper).removeClass("copy_drag"),d(b.helper).find(".header .sub_header").html("&nbsp;")}},breadcrumb:function(){var a=location.hash.substring(1).replace(/\/\//g,"\\").split("/"),b=d("<div/>"),c=[];for(var e=0;e<a.length-1;e++){var f=d("<a/>");c.push(a[e].replace(/\\\\/g,"/")),f.attr("href","#"+c.join("/")),f.text(a[e]),b.append(f)}return b},refreshContext:function(b,c){f.refreshContext.refreshing=f.refreshContext.refreshing||{};if(f.refreshContext.refreshing[b])return;f.refreshContext.refreshing[b]=!0;var e=d("#file_context_links ."+b+"_attachments_url").attr("href");d.ajaxJSON(e,"GET",{},function(e){f.clearDataCache(),f.refreshContext.refreshing[b]=!1;var h=l.scrollTop(),i=null;for(var j in g){var k=g[j][0];if(k.context_string==b){i=k.context_name,g[j][0].context.includes_files=!0;for(var n in e.folders)for(var o in g[j][1].folders)g[j][1].folders[o].id==e.folders[n].id&&(e.folders[n].includes_files=g[j][1].folders[o].includes_files);e.files=e.files||[];for(var n in g[j][1].files)e.files.push(g[j][1].files[n]);g[j][1]=e}}var p=d("#files_structure > ul > li.context."+b).filter(":first");p.length===0&&(p=null);var q=[],r=!1;if(p){r=p.hasClass("open");var s=p.find("li.node.open");s.each(function(){q.push(f.itemData(d(this)).id)})}var t=null;for(var j in e.contexts)for(var n in e.contexts[j])t||(t=n,i=e.contexts[j][n].name);var u=null;!e.folders&&e[0]&&e[0][1]&&e[0][1].folders&&(e.folders=e[0][1].folders);for(var j in e.folders)!u&&e.folders[j].folder&&e.folders[j].folder.parent_folder_id===null&&(u=e.folders[j].folder);var v=p;if(!v||v.length===0)v=l.find(".folder_blank").clone(!0).removeClass("folder_blank");v.children(".name").text(i),v.children(".id").text(u.id),v.addClass("context folder folder_"+u.id+" "+b),v.find("li").addClass("to_be_removed");var w=v.children("ul"),x=function(a,b){for(var c in e.folders)if(b.id&&e.folders[c].folder.parent_folder_id==b.id){var d=a.children("ul").children(".folder_"+e.folders[c].folder.id);d.length===0&&(d=l.find(".folder_blank").clone(!0).removeClass("folder_blank"),d.addClass("folder folder_"+e.folders[c].folder.id),d.children(".id").text(e.folders[c].folder.id),d.children(".name").text(e.folders[c].folder.name)),d.removeClass("to_be_removed"),x(d,e.folders[c].folder),d.parents("body").length===0&&a.children("ul").append(d.show())}};e.folders=a.sortBy(e.folders,function(a){return(a.folder.name||"").toLowerCase()});for(var j in e.folders)if(e.folders[j].folder.parent_folder_id==u.id){var y=w.find(".folder_"+e.folders[j].folder.id);y.length===0&&(y=l.find(".folder_blank").clone(!0).removeClass("folder_blank"),y.addClass("folder folder_"+e.folders[j].folder.id),y.children(".name").text(e.folders[j].folder.name),y.children(".id").text(e.folders[j].folder.id)),y.removeClass("to_be_removed"),x(y,e.folders[j].folder),y.parents("body").length===0&&w.append(y.show())}var z={};for(var j in e.groups)z[(e.groups[j].group||e.groups[j].course_assigned_group).category]=!0;for(var j in z){var A=l.find(".folder_blank").clone(!0).removeClass("folder_blank");A.fillTemplateData({data:{name:j}}),A.addClass("groups");for(var n in e.groups){var B=e.groups[n].group||e.groups[n].course_assigned_group;if(B.category==j){var C=null;for(var o in e.folders)!C&&!e.folders[o].folder.parent_folder_id===null&&(C=e.folders[o].folder);if(C){var D=A.children("ul").children(".group_"+B.id);D.length===0&&(D=l.find(".folder_blank").clone(!0).removeClass("folder_blank"),D.addClass("group context folder folder_"+C.id),D.addClass("group_"+B.id),D.fillTemplateData({data:{name:B.name,id:C.id}})),D.removeClass("to_be_removed"),x(D,C),D.parents("body").length===0&&A.children("ul").append(D.show())}}}w.append(A.show())}var E=!1;v.find(".to_be_removed").remove(),l.find("#files_structure_list > .folder").each(function(){var a=f.itemData(d(this));a&&a.root_context_string==b&&(d(this)[0]!=v[0]&&(d(this).after(v.show()),d(this).remove()),E=!0)}),E||l.find("#files_structure_list").append(v.show()),v.children(".text").droppable(f.droppable_options),v.find(".folder > .text").droppable(f.droppable_options);for(var j in q)f.expandFolder(v.find(".folder_"+q[j]));r&&f.expandFolder(v),l.scrollTop(h),m.instTree.InitInstTree(m),l.find("li.node.active-node,li.leaf.active-leaf").filter(":first").children(".name").click(),c&&d.isFunction(c)&&c()},function(){f.refreshContext.refreshing[b]=!1})},refreshContentListeners:function(){var a=f.currentContext();a&&a.permissions&&a.permissions.manage_files&&i.find(".folder.draggable_droppable").droppable(f.droppable_options),f.canManageAContext&&(i.find(".folder.draggable_droppable").draggable(f.draggable_options),i.find(".file").draggable(f.draggable_options))},nodeClumpSize:25,addScrollCatcher:function(){var a=function(){var a=i.scrollTop(),b=!1,c=0;i.find(".catcher").remove();var d=i.find(".folder_item:visible:last"),e=d.data("node");if(e){e=e.next();var g=!1;while(e.length>0)e.hasClass("separator")||(c++,c<=f.nodeClumpSize?f.addContentItem(e):g=!0),e=e.next();f.refreshContentListeners(),g&&f.addScrollCatcher()}i.scrollTop(a)},b=d("<li class='catcher'>&nbsp;</li>");f.watchingScroll||(i.bind("scroll",function(b){var c=i.find(".catcher:visible:first");if(c.length>0){var d=c.offset().top,e=i.offset().top+i.height();d<e&&a()}}),f.watchingScroll=!0),i.append(b)},addContentItem:function(b,e){var h=f.itemData(b);if(!h||!h.id)return;var j=!1;if(b.hasClass("node")){var k=i.find(".folder_"+h.id);if(k.length===0){var l=d.replaceTags(d("."+h.context_string+"_folder_url").attr("href"),"id",h.id);j=!0,k=d("#content_templates .folder:first").clone(!0),e&&k.hide(),k.fillTemplateData({data:h}).data({node:b,parent_node:b.parent().parent()}).addClass("folder_"+h.id),k.find(".rename_item_link,.delete_item_link,.folder_url").attr("href",l),k.find(".item_icon.draggable").attr("title",c.t("titles.click_and_drag","Click and drag to move folder to another folder"))}k.toggleClass("editable_folder_item",!b.hasClass("context")&&!!(h.context&&h.context.permissions&&h.context.permissions.manage_files||h.permissions&&h.permissions.update)),k.removeClass("to_be_removed"),k.find(".item_icon").toggleClass("draggable",k.hasClass("editable_folder_item")),k.find(".item_icon").attr("alt",c.t("alts.folder","Folder")).attr("src",d("#content_blank_icon").attr("src")),h&&h.currently_locked&&k.find(".item_icon").attr("alt",c.t("alts.folder_locked","Locked Folder")).attr("src",d("#content_locked_icon").attr("src")),k.find(".lock_item_link").showIf(!h.currently_locked),k.find(".unlock_item_link").showIf(h.currently_locked),k.toggleClass("folder_locked",!!h&&!!h.currently_locked).toggleClass("draggable_droppable",b.hasClass("folder")&&!b.hasClass("context"));if(j){var m=a.filter(g[0][1].folders,function(a){return a.folder.parent_folder_id===h.parent_folder_id}),n=a.find(m,function(a){return a.folder.name==h.name}),o=a.indexOf(m,n);$target=i.find("li.folder_item.folder").eq(o),$files=i.children("li.folder_item.file"),$target.length?$target.before(k):$files&&$files.length?$files.first().before(k):i.append(k)}}else{var k=i.find(".file_"+h.id);if(k.length===0){j=!0,k=d("#content_templates .file:first").clone(!0),e&&k.hide();var p=d.replaceTags(d("#file_context_links ."+h.context_string+"_attachment_url").attr("href"),"id",h.id),q=d.replaceTags(d("#file_context_links ."+h.context_string+"_download_attachment_url").attr("href"),"id",h.id);k.fillTemplateData({data:h}).data({parent_node:b.parent().parent(),node:b}).addClass(h.mime_class+" file_"+h.id),k.find(".attachment_url").attr("href",p),k.find(".download_url").attr("href",q),k.find(".item_icon.draggable").attr("title","Click and drag to move file to another folder")}k.toggleClass("editable_folder_item",!!(h.context&&h.context.permissions&&h.context.permissions.manage_files||h.permissions&&h.permissions.update)).removeClass("to_be_removed").find(".item_icon").attr({alt:c.t("alts.file","File"),src:d("#content_blank_icon").attr("src")}),h&&h.currently_locked&&k.find(".item_icon").attr({alt:c.t("alts.locked_file","Locked File"),src:d("#content_locked_icon").attr("src")}),k.find(".lock_item_link").showIf(!h.currently_locked),k.find(".unlock_item_link").showIf(h.currently_locked),k.find(".preview_item_link").showIf(h.scribd_doc||h.content_type.match(/image/)||h.content_type.match(/(video|audio)/)&&h.media_entry_id),k.find(".edit_item_content_link_holder").showIf(k.hasClass("editable_folder_item")&&h.context_type!="User"&&(k.hasClass("text")||k.hasClass("html")||k.hasClass("code"))),k.find(".item_icon").toggleClass("draggable",k.hasClass("editable_folder_item"));if(j){var r=a.filter(g[0][1].files,function(a){return a.attachment.folder_id===h.folder_id}),s=a.find(r,function(a){return a.attachment.display_name===h.display_name}),o=a.indexOf(r,s);$target=i.find("li.folder_item.file").eq(o),$target.length?$target.before(k):i.append(k)}}return j},updateFile:function(b,c,e){f.clearDataCache();var h=d.underscore(c.attachment.context_type)+"_"+c.attachment.context_id;for(var i in g){var j=g[i]&&(g[i][0].context_string==b||g[i][0].context_string==h);if(j){var k=!1,n=!1;if(!c.definitely_new)for(var o in g[i][1].files){var p=g[i][1].files[o].attachment;p.id==c.attachment.id&&(g[i][1].files[o]=c,l.find(".file_"+p.id).each(function(){var a=f.itemData(d(this).parent("ul").parent("li"));a.id==c.attachment.folder_id?(d(this).fillTemplateData({data:{name:c.attachment.display_name}}),c.attachment.display_name&&d(this).find(".name").attr("title",c.attachment.display_name)):n=!0}),k=!0,n&&l.find(".file_"+p.id).remove())}if(!k||n){k||(c.definitely_new=!1,g[i][1].files.push(c));var q=g[i][1].files;g[i][1].files=a.sortBy(q,function(a){return(a.attachment.display_name||"").toLowerCase()});var r=c.attachment;r.name=r.display_name;var s=l.find(".file_blank").clone(!0).removeClass("file_blank").addClass("file_"+r.id).addClass(r.mime_class).fillTemplateData({data:r});r.name&&s.find(".name").attr("title",r.name);var t=function(){l.find(".folder_"+r.folder_id).children("ul").append(s.show())},u=a.filter(g[i][1].files,function(a){return a.attachment.folder_id===c.attachment.folder_id}),v=a.find(u,function(a){return a.attachment.display_name===c.attachment.display_name}),w=a.indexOf(u,v),x=l.find(".folder_"+r.folder_id).children("ul").find("> li.file").eq(w);x.length?x.before(s.show()):t()}}}e!==!1&&(f.refreshView(c.attachment),m.instTree.InitInstTree(m))},updateFolder:function(a,b,c){f.clearDataCache();var e=d.underscore(b.folder.context_type)+"_"+b.folder.context_id,h=b.already_in_place;b.already_in_place=null;for(var i in g)if(g[i]&&(g[i][0].context_string==a||g[i][0].context_string==e)){var j=!1,k=!1;for(var m in g[i][1].folders){var n=g[i][1].folders[m].folder;n.id==b.folder.id&&(n.includes_files&&(b.folder.includes_files=n.includes_files),g[i][1].folders[m]=b,l.find(".folder_"+n.id).each(function(){var a=f.itemData(d(this).parent("ul").parent("li"));a=a||{parent_folder_id:null};if(a.id==b.folder.parent_folder_id){d(this).hasClass("context")||d(this).children(".name").text(b.folder.name).attr("title",b.folder.name);if(!h){d(this).prev("li.separator").remove();var c=d(this).parent("ul").parent("li"),e=null,g=d(this),i=d(this)[0],j=f.itemData(d(this)).name||"";c.children("ul").children("li:not(.separator)").each(function(){var a=f.itemData(d(this)).name||"",b=d(this),c=b[0];if(c!=i&&(!b.hasClass("folder")||j.toLowerCase()<a.toLowerCase()))return e=b,!1}),e?e.before(g.show()).before("<li class='separator'/>"):c.children("ul").append("<li class='separator'/>").append(g.show())}}else k=!0}),j=!0,k&&l.find(".folder_"+n.id).remove())}if(!j||k)f.foldersStillLoading=f.foldersStillLoading||{},f.foldersStillLoading[b.folder.id]=b,f.refreshContext(a),a!=e&&f.refreshContext(e)}c!==!1&&f.refreshView(b.folder)},refreshView:function(a){l.find("li.node.active-node,li.leaf.active-leaf").filter(":first").children(".text:visible:first").click(),a&&a.id&&(i.find(".file_"+a.id).mouseover(),i.find(".folder_"+a.id).mouseover()),k.triggerHandler("show")},currentItemData:function(){return f.itemData(l.find("li.node.active-node,#files_structure li.leaf.active-leaf"))},currentContext:function(){var a=f.currentItemData().context_string;for(var b in g)if(g[b][0].context_string==a)return g[b][0].context;return null},clearDataCache:function(){f.clearDataCache.cacheIndex++},itemData:function(a){var b=a.data("item_data");if(b&&b.cacheIndex==f.clearDataCache.cacheIndex)return b;var b=f.uncachedItemData(a);return b&&(b.cacheIndex=f.clearDataCache.cacheIndex,a.data("item_data",b)),b},uncachedItemData:function(a){if(a.closest("#files_content").length>0)return f.itemData(a.data("node"));var b=a.getTemplateData({textValues:["id"]}).id;for(var c in g){var e=g[c],h=null;if(a.hasClass("file")){var i=e[1].files;for(var j in i){var k=i[j].attachment;if(k.id==b)return k.context_string=d.underscore(k.context_type)+"_"+k.context_id,k.root_context_string=e[0].context_string,k.context=e[0].context,k.name=k.display_name,k}}else if(a.hasClass("groups")){if(a.parents("li.context:last").hasClass(e[0].context_string))return res=a.getTemplateData({textValues:["name"]}),res.context_string=e[0].context_string,res.context=e[0].context,res}else if(a.hasClass("folder")){var l=e[1].folders;for(var j in l){var m=l[j].folder;if(m.id==b)return m.context_string=d.underscore(m.context_type)+"_"+m.context_id,m.root_context_string=e[0].context_string,a.hasClass("context")&&(m.name=a.getTemplateData({textValues:["name"]}).name),m.context=e[0].context,m}}else if(a.hasClass("group")){var n=e[1].groups;for(var j in n){var o=n[j].group||n[j].course_assigned_group;o.context_string=d.underscore(o.context_type)+"_"+o.context_id,o.root_context_string=e[0].context_string;if(o.id==b)return o}}}if(a.hasClass("folder")){var e=null;for(var c in g)a.closest(".context").hasClass(g[c][0].context_string)&&(e=g[c]);for(var c in f.foldersStillLoading)if(f.foldersStillLoading[c].folder.id==b){var m=f.foldersStillLoading[c].folder;return m.name=a.getTemplateData({textValues:["name"]}).name,m.context_string=e[0].context_string,m.context=e[0].context,m}if(e){var m={};return m.name=a.getTemplateData({textValues:["name"]}).name,m.id=b,m.context_string=e[0].context_string,m.permissions={read_contents:!0},m.context=e[0].context,m.false_folder=!0,m}}return null}}),d(document).ready(function(){function e(){var a=d("#edit_content_dialog");a.find("button").attr("disabled",!1).filter(".save_button").text(c.t("buttons.update_file","Update File")),a.find("button").attr("disabled",!0).filter(".save_button").text(c.t("messages.updating_file","Updating File..."));var b=f.currentItemData().context_string,e=a.find("textarea"),g=e.data("tinyIsVisible")?e.editorBox("get_code"):e.val();d.ajaxFileUpload({url:a.data("update_url"),method:"PUT",binary:!1,data:{"attachment[uploaded_data]":{fake_file:!0,name:a.data("filename"),content_type:a.data("content_type"),content:g}},success:function(d){a.find("button").attr("disabled",!1).filter(".save_button").text(c.t("buttons.update_file","Update File")),f.updateFile(b,d),a.dialog("close")},error:function(){a.find("button").attr("disabled",!1).filter(".save_button").text(c.t("errors.update_file_failed","Updating File Failed, please try again"))}})}f.init(),setInterval(function(){k.triggerHandler("show")},1e3),d(".folder_item").live("mousedown",function(a){a.preventDefault()}),d(".folder_item.ui-draggable").live("mouseover",function(){d(this).find(".item_icon").attr("title",c.t("titles.drag_to_move","Drag to move to a different folder"))}),j.hover(function(a){k.css("text-decoration","underline")},function(a){k.css("text-decoration","none")}),k.bind("show",function(){var a=k.width(),b=k.height(),c=k.offset(),d=i.offset();c.left=c.left-d.left,c.top=c.top-d.top,j.css({width:a+5,height:b+5,top:c.top-5,left:c.left-5})}),d("#file_uploads_dialog_link").click(function(a){a.preventDefault(),d("#file_uploads").dialog({title:c.t("titles.file_uplaods_queue","File Uploads Queue")})}),setTimeout(function(){l.find(".folder > .text").droppable(f.droppable_options),d("#files_structure_list > li").hide(),m.instTree({autoclose:!1,multi:!1,dragdrop:!1,onExpand:function(a){if(a.hasClass("folder")){var b=f.itemData(a);b&&!b.includes_files&&f.getFilesForFolder(b,!1)}},onCollapse:function(a){a.find(".node.active-node,.leaf.active-leaf").length>0&&a.find(".text:visible:first").click()},onClick:function(a,e){i.find(".content_panel").addClass("to_be_hidden"),i.find(".folder_item").addClass("to_be_removed"),i.find(".catcher").addClass("to_be_removed"),i.find(".file_preview").remove(),i.find(".message").remove();var g=function(){i.find(".content_panel.to_be_hidden").hide(),i.find(".catcher.to_be_removed").remove(),i.find(".folder_item.to_be_removed").remove()},h=f.itemData(e),j=encodeURIComponent(f.fullPath(e));location.hash!="#"+j&&location.replace("#"+j),!h.includes_files&&h.full_name&&f.getFilesForFolder(h),h.context_string&&(b&&(b.interaction_context=h.context_string),f.updatePageView(h.context_string));if(e.hasClass("node")){var l=d.replaceTags(d("."+h.context_string+"_folder_url").attr("href"),"id",h.id),m=!1,n=d("<li class='message'>"+c.t("messages.folder_empty","Nothing in this Folder")+"</li>");if(e.hasClass("folder"))if(!h||!h.permissions||!h.permissions.read_contents)i.find(".content_panel:last").after("<li class='message'>"+c.t("messages.access_denied","You cannot read the contents of this folder.")+"</li>"),m=!0;else{var o=d("#folder_panel");o.find(".rename_item_link,.delete_item_link,.folder_url").attr("href",l),o.find(".breadcrumb").empty().append(f.breadcrumb()),o.toggleClass("editable_content_panel",!!(h.context&&h.context.permissions&&h.context.permissions.manage_files||h.permissions&&h.permissions.update)).toggleClass("addable_content_panel",!!(h.context&&h.context.permissions&&h.context.permissions.manage_files||h.permissions&&h.permissions.update)).toggleClass("downloadable_content_panel",!o.hasClass("editable_content_panel")&&!o.hasClass("addable_content_panel")&&!!h.permissions&&!!h.permissions.read_contents),o.removeClass("to_be_hidden"),o.find(".download_zip,.upload_zip").hide(),(e.hasClass("context")||!(h&&h.permissions&&h.permissions.update))&&o.removeClass("editable_content_panel");var p=d.replaceTags(d("."+h.context_string+"_folder_url").attr("href")+"/download","id",h.id);d(".download_zip_link").attr("href",p),d(".upload_zip_link").attr("href",d("."+h.context_string+"_import_url").attr("href")+"?return_to="+encodeURIComponent(location.href)+"&folder_id="+h.id),h.unlock_at_string=d.parseFromISO(h.unlock_at).datetime_formatted,h.lock_at_string=d.parseFromISO(h.lock_at).datetime_formatted,o.find(".lock_after").showIf(h.lock_at),o.find(".lock_until").showIf(h.unlock_at),o.find(".currently_locked_box").showIf(h.currently_locked),o.find(".lock_item_link").showIf(h.parent_folder_id&&!h.currently_locked),o.find(".unlock_item_link").showIf(h.parent_folder_id&&h.currently_locked),o.find(".download_zip").showIf(h.permissions&&h.permissions.read_contents),o.find(".upload_zip").showIf(h.context&&h.context.permissions&&h.context.permissions.manage_files),o.find(".edit_link").showIf(h.context&&h.context.permissions&&h.context.permissions.manage_files),o.fillTemplateData({data:h}),o.data("node",e),o.show(),k.triggerHandler("show")}else if(e.hasClass("groups")){var o=d("#groups_panel"),q=h.context,r=d("."+h.context_string+"_groups_url").attr("href");o.find(".category_name").text(h.name),o.find(".context_name").text(q.name),o.find(".breadcrumb").empty().append(f.breadcrumb()),o.find(".groups_link").attr("href",r),o.removeClass("to_be_hidden"),q&&q.permissions&&q.permissions.read_roster&&o.toggleClass("addable_content_panel",!0),o.show()}if(!m){var s=0,t=e.children("ul").children("li.node,li.leaf").length;g.already_cleared=!0,setTimeout(function(){var a=!1;e.children("ul").children("li.node,li.leaf").each(function(){s++,s<f.nodeClumpSize&&(newItem=f.addContentItem(d(this),!0),newItem&&(a=!0))}),i.find("li.folder_item").show(),t>=f.nodeClumpSize&&f.addScrollCatcher(),a&&f.refreshContentListeners();if(e.children("ul").children("li.node,li.leaf").length===0||e.hasClass("folder")&&!h.includes_files)e.hasClass("folder")&&!h.includes_files&&(n.addClass("no_content"),n.text(c.t("messages.loading_files","Loading Files...")),f.getFilesForFolder(h,function(a){a.files.length>0?f.refreshView():i.find(".message.no_content").remove()})),i.find(".message.no_content").length===0&&i.append(n);g()},10)}}else if(e.hasClass("file")){var o=d("#file_panel"),u=null;h.unlock_at_string=d.parseFromISO(h.unlock_at).datetime_formatted,h.lock_at_string=d.parseFromISO(h.lock_at).datetime_formatted,o.find(".lock_after").showIf(h.lock_at),o.find(".lock_until").showIf(h.unlock_at),o.find(".currently_locked_box").showIf(h.currently_locked),o.find(".lock_item_link").showIf(!h.currently_locked),o.find(".unlock_item_link").showIf(h.currently_locked),o.removeClass("to_be_hidden"),o.fillTemplateData({data:h});var v=d.replaceTags(d("#file_context_links ."+h.context_string+"_attachment_url").attr("href"),"id",h.id),w=d.replaceTags(d("#file_context_links ."+h.context_string+"_download_attachment_url").attr("href"),"id",h.id);o.find(".breadcrumb").empty().append(f.breadcrumb()),o.find(".attachment_url").attr("href",v).end().find(".download_item_link").attr("href",w),o.removeClass("editable_content_panel"),h&&h.permissions&&h.permissions.update&&o.addClass("editable_content_panel"),o.removeClass("panel_locked");if(!h||!h.permissions||!h.permissions.download)o.addClass("panel_locked");else if(h&&h.permissions&&h.permissions.download&&d.isPreviewable(h.content_type))u=d("#content_templates .file_scribd_preview").clone(!0),u.append("<div id='doc_preview_holder'/>");else if(h&&h.content_type.match(/image/)){u=d("#content_templates .file_image_preview").clone(!0);var x=d.replaceTags(d("#file_context_links ."+h.context_string+"_preview_attachment_url").attr("href"),"id",h.id);u.find("a").attr("href",w),u.find("img").attr("src",d(".preview_loading_image").attr("src")).attr("src",x||"").attr("title",h.display_name)}else if(h&&h.content_type.match(/(video|audio)/)&&h.media_entry_id){u=d("#content_templates .file_media_preview").clone(!0),u.fillTemplateData({data:h});var y=h.content_type.match(/video/)?"video":"audio";u.find(".media_preview").mediaComment("show_inline","maybe",y,w),u.find("a").attr("href",w)}else u=d("#content_templates .file_no_preview").clone(!0),u.fillTemplateData({data:h}),u.find("a").attr("href",w);o.data("node",e),o.show();if(u){u.addClass("file_preview"),i.append(u);var z=function(){d("#doc_preview_holder").loadDocPreview({mimeType:h.content_type,attachment_id:h.id,height:"100%",crocodoc_session_url:h.crocodocSession,scribd_doc_id:h.scribd_doc&&h.scribd_doc.attributes&&h.scribd_doc.attributes.doc_id,scribd_access_key:h.scribd_doc&&h.scribd_doc.attributes&&h.scribd_doc.attributes.access_key,attachment_view_inline_ping_url:f.viewInlinePingUrl(h.context_string,h.id)})};h.permissions&&h.permissions.download&&d.isPreviewable(h.content_type)&&(h["crocodoc_available?"]&&!h.crocodocSession?u.disableWhileLoading(d.ajaxJSON("/attachments/"+h.id+"/crocodoc_sessions/","POST",{annotations:!1},function(a){h.crocodocSession=a.session_url,z()},function(){h["crocodoc_available?"]=!1,z()})):z())}d(window).triggerHandler("resize")}g.already_cleared||g()}}),d("#files_structure_list > li.context").show(),d("#files_structure_list .context").length==1&&f.expandFolder(d("#files_structure_list .context"))},500),d(window).bind("resize",function(){var a=l.offset().top,b=d(window).height()-a,c=142,e=d("#section-tabs").height();l.height(Math.max(e,b-c)),i.height(Math.max(e,b-c));var f=i.height(),g=d("#file_panel").outerHeight();d("#doc_preview_holder").height(f-g)}),d("#folder_panel .download_zip").click(function(a){a.preventDefault(),b.downloadFolderFiles(d(this).find(".download_zip_link").attr("href"))}),d(".folder_item .edit_item_content_link").click(function(a){a.preventDefault(),a.stopPropagation();var b=d(this).parents(".folder_item,#file_panel,#folder_panel"),g=f.itemData(b),h=b.find(".download_url").attr("href"),i=b.find(".name:first").text(),j=d("#edit_content_dialog");j.data("update_url",b.find(".rename_item_link").attr("href")).data("content_type",g.content_type||"").data("filename",g.filename||"file_to_update"),j.find(".display_name").text(i),j.find(".loading_message").text("Loading File Contents...").show().end().find(".content").hide(),j.dialog({width:600,height:410,buttons:[{text:c.t("cancel","Cancel"),click:function(){d("#edit_content_dialog").dialog("close")}},{text:c.t("update_file","Update File"),click:e,"class":"btn-primary"}],close:function(){var a=d(this).find("textarea");a.data("tinyIsVisible")&&(a.editorBox("toggle"),a.data("tinyIsVisible",!1))}}),d.ajax({dataType:"json",error:function(){j.find(".loading_message").text(c.t("errors.loading_file","Error Loading File Contents.  Please try again."))},success:function(a){var c=a.body,d=j.find("textarea").val(c),e=d.data("rich_text"),f=d.data("tinyIsVisible");d.css("width","100%"),j.find(".loading_message").hide().end().find(".content").show(),b.hasClass("html")&&(j.css("height","380px"),j.find(".switch_views").show().unbind("click").bind("click",function(a){a.preventDefault(),e?(d.editorBox("toggle"),d.data("tinyIsVisible",!f)):(e=!0,setTimeout(function(){j.find(".html_edit_warning").fadeIn()},250),d.editorBox({tinyOptions:{valid_elements:"*[*]",extended_valid_elements:"*[*]",plugins:"autolink,instructure_external_tools,instructure_contextmenu,instructure_links,instructure_image,instructure_equation,instructure_equella,media,paste,table,inlinepopups"}}),d.data("tinyIsVisible",!f))})),j.find(".textarea").focus()},url:h.replace(/\/download/,"/contents")})}),d(".folder_item .preview_item_link").click(function(a){a.preventDefault(),a.stopPropagation(),f.selectFolder(d(this).parents(".folder_item").data("node"))}),d(".folder_item .rename_item_link,#file_panel .rename_item_link,#folder_panel .rename_item_link").click(function(a){a.preventDefault(),a.stopPropagation();var b=d(this).parents(".folder_item,#file_panel,#folder_panel"),c=b.getTemplateData({textValues:["name"]}).name;b.find(".name").hide().after(d("#rename_entry_field")),d("#rename_entry_field").val(c).focus().select(),d(this).blur()}),d("#rename_entry_field").bind("blur",function(a,b){var c=d(this).parents(".folder_item,#file_panel,#folder_panel");if(c.length===0)return;var e=c.getTemplateData({textValues:["name"]}).name,g=d(this).val();if(b!==!1&&g!=""&&e!=g){c.find(".name").text(g);var h=f.itemData(c.data("node")),i=h.root_context_string;if(c.hasClass("folder")||c.attr("id")=="folder_panel"){var j=d.replaceTags(d("#file_context_links ."+i+"_folder_url").attr("href"),"id",h.id);d.ajaxJSON(j,"PUT",{"folder[name]":g},function(a){f.updateFolder(i,{folder:a.folder,already_in_place:!0})},function(){})}else{var j=d.replaceTags(d("#file_context_links ."+i+"_attachment_url").attr("href"),"id",h.id);d.ajaxJSON(j,"PUT",{"attachment[display_name]":g},function(a){f.updateFile(i,a)},function(){})}}c.find(".name").show(),d(this).val("").appendTo(d("#file_context_links")),d(this).triggerHandler("blur",!1)}),d("#rename_entry_field").keycodes("return esc",function(a){d(this).triggerHandler("blur",a.keyString=="return")}),d(".folder_item .delete_item_link,#folder_panel .delete_item_link,#file_panel .delete_item_link").click(function(a){a.preventDefault(),a.stopPropagation();var b=f.itemData(d(this).parents(".folder_item"));b=b||f.itemData(d(this).parents("#folder_panel,#file_panel").data("node"));var e=d(this).parents(".folder_item").hasClass("file")?"file":"folder";d(this).parents(".folder_item").confirmDelete({message:d(this).parents(".folder_item").hasClass("folder")||d(this).hasClass("folder_url")?c.t("prompts.delete_folder","Are you sure you want to delete this folder and all of its contents?"):c.t("prompts.delete_file","Are you sure you want to delete this file?"),url:d(this).attr("href"),success:function(){l.find(".file_"+b.id+",.folder_"+b.id).filter(".active-node,.active-leaf").length>0&&f.selectFolder(l.find(".file_"+b.id+",.folder_"+b.id).filter(".active-node,.active-leaf").parent("ul").parent("li")),l.find(".file_"+b.id).prev("li.separator").remove(),l.find(".file_"+b.id).remove(),l.find(".folder_"+b.id).prev("li.separator").remove(),l.find(".folder_"+b.id).remove(),f.refreshView(),f.updateQuota(),d(this).slideUp(function(){d(this).remove()})}})}),d(".folder_item:not(.add_item)").click(function(a){var b=d(this);a.preventDefault();if(i.filter(".dragging").length>0)return;if(d(this).find("#rename_entry_field").length>0)return;a.stopPropagation(),b.data("parent_node")&&f.expandFolder(b.data("parent_node")),setTimeout(function(){if(b.hasClass("folder")){f.expandFolder(b.data("node"));var a=function(){f.refreshView(),d(this).unbind("files_load",a)};b.data("node").bind("files_load",a),b.data("node").children(".text").click()}else b.find(".name").focus(),location.href=b.find(".download_url").attr("href")},50)}),d(".folder_item").hover(function(a,b){d(".folder_item_hover").removeClass("folder_item_hover"),d(this).addClass("folder_item_hover")},function(){}),d("#folder_panel .add_file_link").click(function(a){a.preventDefault();if(i.find(".add_form:visible").length>0)return;var b=d("#add_file_form").clone(!0).removeAttr("id");i.children(".message").remove(),i.append(b),i.scrollToVisible(b);var c=f.currentItemData();b.fillFormData({folder_id:c.id},{object_name:"attachment"}),b.find("form").attr("action",d("#file_context_links ."+c.context_string+"_attachments_url").attr("href")+".text"),b.mouseover(),b.find(":text:first").focus().select()}),d("#folder_panel .add_folder_link").click(function(a){a.preventDefault();if(i.find(".add_form:visible").length>0)return;var b=d("#add_folder_form").clone(!0).removeAttr("id");i.children(".message").remove(),i.find("#folder_panel.addable_content_panel").after(b),i.scrollToVisible(b);var c=f.currentItemData();b.fillFormData({parent_folder_id:c.id},{object_name:"folder"}),b.find("form").attr("action",d("#file_context_links ."+c.context_string+"_folders_url").attr("href")),b.mouseover(),b.find(":text:first").focus().select()}),d("#add_folder_form :text").keycodes("esc",function(a){a.keyString=="esc"&&d(this).trigger("blur",!0)}),d("#add_folder_form :text").bind("blur",function(a,b){b?d(this).parents("li").remove():d.trim(d(this).val())&&d(this).parents("form").trigger("submit")}),d("#add_folder_form .add_folder_form").formSubmit({beforeSubmit:function(a){if(d(this).hasClass("submitting"))return!1;d(this).addClass("submitting"),d(this).find(".name").show().text(a["folder[name]"]),d(this).find(":text").hide(),d(this).data("root_context_string",f.currentItemData().root_context_string)},success:function(b){d(this).removeClass("submitting");for(var c in g)g[c][0].context_string==d(this).data("root_context_string")&&g[c][1].folders.push(b);var e=g[0][1].folders;g[0][1].folders=a.sortBy(e,function(a){return(a.folder.name||"").toLowerCase()});var h=b.folder,i=l.find(".folder_blank").clone(!0).removeClass("folder_blank");i.addClass("folder folder_"+h.id),i.fillTemplateData({data:{name:h.name,id:h.id}});var j=l.find(".folder_"+h.parent_folder_id);j.children("ul").append("<li class='separator'/>"),j.children("ul").append(i.show()),f.updateFolder(d(this).data("root_context_string"),b),d(this).parents("li").remove(),i.find("span").droppable(f.droppable_options),f.refreshView(h)},error:function(a){d(this).removeClass("submitting"),d(this).formErrors(a)}}),d("#add_file_form .add_file_form").formSubmit({fileUpload:!0,beforeSubmit:function(a){d(this).data("context_string",f.currentItemData().context_string),d(this).find(".loading_message").slideDown()},success:function(a){d(this).parents("li").remove(),f.updateFile(d(this).data("context_string"),a),f.updateQuota()},error:function(a){d(this).find(".loading_message").slideUp(),d(this).formErrors(a)}}),d("#add_file_form .cancel_button").click(function(){d(this).parents("li").remove()}),d(".folder_item .lock_item_link,#file_panel .lock_item_link,#folder_panel .lock_item_link").click(function(a){a.preventDefault(),a.stopPropagation();var b="attachment",e=d("#lock_attachment_form"),g=d(this).parents(".folder_item,#file_panel,#folder_panel"),h=f.itemData(g)||f.itemData(g.data("node")),i=d(this).attr("href");if(g.hasClass("folder")||d(this).parents("#folder_panel").length>0)b="folder",e=d("#lock_folder_form");e.attr("action",i),e.data("context_string",h.context_string),d("#lock_item_dialog form").hide(),e.show(),h.lock_at=d.parseFromISO(h.last_lock_at).datetime_formatted,h.unlock_at=d.parseFromISO(h.last_unlock_at).datetime_formatted,h.locked=!h.lock_at&&!h.unlock_at?"1":"0",d("#lock_item_dialog").fillTemplateData({data:{name:h.name}}),e.fillFormData(h,{object_name:b}),e.find("#folder_just_hide,#attachment_just_hide").attr("checked",!1).change(),e.find(".item_type").text(b),d("#lock_item_dialog").dialog({modal:!0,width:350,title:b=="folder"?c.t("titles.lock_folder","Lock Folder"):c.t("titles.lock_file","Lock File")})}),d("#folder_just_hide,#attachment_just_hide").change(function(){d(this).parents("form").find(".full_lock").showIf(!d(this).attr("checked")),d(this).parents("form").find(".lock_checkbox").change()}).change(),d("#lock_item_dialog .cancel_button").click(function(){d("#lock_item_dialog").dialog("close")}),d("#lock_item_dialog .lock_checkbox").change(function(){d(this).parents("table").find(".lock_range").showIf(!d(this).attr("checked"))}).change(),d("#lock_attachment_form").formSubmit({processData:function(a){return a},beforeSubmit:function(a){d(this).loadingImage()},success:function(a){d(this).loadingImage("remove"),d("#lock_item_dialog").dialog("close"),f.updateFile(d(this).data("context_string"),a)}}),d("#lock_folder_form").formSubmit({processData:function(a){return a},beforeSubmit:function(a){d(this).loadingImage()},success:function(a){d(this).loadingImage("remove"),d("#lock_item_dialog").dialog("close"),f.updateFolder(d(this).data("context_string"),{folder:a.folder,already_in_place:!0})}}),d(".folder_item .unlock_item_link,#file_panel .unlock_item_link,#folder_panel .unlock_item_link").click(function(a){a.preventDefault(),a.stopPropagation();var b="attachment",c=d("#lock_attachment_form"),e=d(this).parents(".folder_item,#file_panel,#folder_panel"),g=f.itemData(e)||f.itemData(e.data("node")),h=d(this).attr("href");if(e.hasClass("folder")||d(this).parents("#folder_panel").length>0)b="folder",c=d("#lock_folder_form"),h=e.find(".folder_url").attr("href");e.loadingImage();var i={};i["["+b+"][locked]"]="",i["["+b+"][hidden]"]="",i["["+b+"][lock_at]"]="",i["["+b+"][unlock_at]"]="",e.loadingImage(),d.ajaxJSON(h,"PUT",i,function(a){e.loadingImage("remove"),b=="attachment"?f.updateFile(g.context_string,a):f.updateFolder(g.context_string,{folder:a.folder,already_in_place:!0})},function(a){e.loadingImage("remove")})});if(location.hash===""||location.hash=="#"){var n=d("#files_structure_list .context:first .name:first").text();location.href="#"+encodeURIComponent(n)}d(document).fragmentChange(function(a,b){setTimeout(function(){f.selectNodeFromPath(b.substring(1)),l.scrollToVisible(d("li.active-node,li.active-leaf").find("span.name").filter(":first"))},100)}).fragmentChange(),setTimeout(function(){d(window).triggerHandler("resize"),d("#file_swf").uploadify({fileObjName:"file",swf:"/flash/uploadify/uploadify.swf",uploader:"s3_url",multi:!0,auto:!1,fileSizeLimit:10737418240,buttonText:"",hideButton:!0,width:60,height:22,cancelImg:"/images/blank.png",onInit:function(){k.text(c.t("links.add_files","Add Files")).triggerHandler("show")},onSelect:h.swfFileQueue,onCancel:h.swfCancel,onUploadError:h.swfFileError,onUploadStart:h.swfFileOpen,onUploadProgress:h.swfFileProgress,onUploadSuccess:h.swfFileSuccess})},1e3)})})();var h={ajaxUploadCount:0,swfUploadCount:0,queuedAjaxUploads:[],currentlyUploading:!1,status_status:"hidden",status_request:"hidden",showStatus:function(){h.status_request="shown",h.status_status=="hidden"&&(h.status_status="showing",d("#file_uploads_progress").slideDown(null,null,function(){setTimeout(function(){h.status_status="shown",h.status_request=="hidden"&&h.hideStatus()},3e3)}))},hideStatus:function(){h.status_request="hidden",h.status_status=="shown"&&(h.status_status="hiding",d("#file_uploads_progress").slideUp(null,null,function(){h.status_status="hidden",h.status_request=="shown"&&h.showStatus()}))},queueAjaxUpload:function(a,b){h.ajaxUploadCount=h.queuedAjaxUploads.length;var c={file:a,folder_id:b,name:a.name},d=h.initFile(c);d.data("folder",f.currentItemData()),d.find(".status").text("Queued"),h.queuedAjaxUploads.push(c),h.updateUploadCount(),h.uploadAjaxFiles()},uploadAjaxFiles:function(a){if(h.currentlyUploading&&!a)return;var b=h.queuedAjaxUploads.shift();if(!b)h.currentlyUploading=!1,h.ajaxUploadCount=0,h.updateUploadCount();else{h.currentlyUploading=!0;var e=h.initFile(b);e.find(".status").text("Uploading"),e.find(".progress_bar").progressbar("value",10);var g=e.data("folder"),i=b.file;d.ajaxFileUpload({url:d("."+g.context_string+"_attachments_url").attr("href"),data:{"attachment[uploaded_data]":i,"attachment[display_name]":i.name,"attachment[folder_id]":g.id,duplicate_handling:b.file.duplicate_handling},method:"POST",success:function(a){setTimeout(function(){h.uploadAjaxFiles(!0)},500);var b=a.attachment,g=d.underscore(b.context_type)+"_"+b.context_id;e.find(".cancel_upload_link").hide().end().find(".status").text(c.t("messages.done_uploading","Done uploading")),e.addClass("done"),setTimeout(function(){e.slideUp(function(){e.remove()})},5e3),a.deleted_attachment_ids&&f.deleteAttachmentIds(a.deleted_attachment_ids),f.updateFile(b.context_code,a)},error:function(a){setTimeout(function(){h.uploadAjaxFiles(!0)},500),e.find(".status").text(c.t("#errors.failed","Failed")).end().find(".cancel_upload_link").hide()}})}},updateUploadCount:function(){h.ajaxUploadCount=h.queuedAjaxUploads.length,h.currentlyUploading&&h.ajaxUploadCount++;var a=h.swfPreQueued.length+h.swfFiles.length+h.ajaxUploadCount,b=d("#file_uploads .file_upload.errored:visible").length;if(a===0&&b==0){h.hideStatus();var e=d("#file_upload_blank").clone(!0).removeAttr("id").addClass("finished_message").empty();e.text("Finished uploading all files"),d("#file_uploads .file_upload:visible:first").hasClass("finished_message")||(d("#file_uploads").prepend(e),e.slideDown("fast")),e.addClass("finished_message"),e.click(function(){d(this).slideUp(function(){d(this).remove()})}),setTimeout(function(){e.slideUp(function(){e.remove()})},5e3)}else d("#file_uploads_dialog_link").text(c.t("messages.uploading_files",{one:"Uploading 1 File...",other:"Uploading %{count} Files..."},{count:a})),a===0&&d("#file_uploads_dialog_link").text(c.t("messages.error_count",{one:"1 Error",other:"%{count} Errors"},{count:b})),h.showStatus()},fileDialogComplete:function(a,b){try{b>0&&this.startUpload()}catch(c){this.debug(c)}},swfPreQueued:[],swfQueuedAndPendingFiles:[],swfFiles:[],swfFileQueueOnce:function(a,b){var c=h.swfPreQueued,e=f.currentItemData(),g=[];for(idx in c)g.push(c[idx].name);f.preflight(e.id,e.context_string,g,function(a){for(idx in c)c[idx].duplicate_handling=a},h.swfFileQueueNext,function(){for(idx in c)d("#file_swf").uploadify("cancel",c[idx].id)})},swfFileQueue:function(a){h.swfPreQueued.push(a),clearTimeout(h.swfFileQueueOnceTimeout),h.swfFileQueueOnceTimeout=setTimeout(h.swfFileQueueOnce,500)},swfFileQueueNext:function(){var a=h.swfPreQueued.shift();a?h.swfFileQueueReal(a):h.swfQueueComplete()},swfFileQueueReal:function(a){var b=h.initFile(a);b.data("folder",f.currentItemData()),b.find(".status").text(c.t("messages.queued","Queued")),h.swfFiles.push(a);var e=b.data("folder"),g={"attachment[folder_id]":e.id,"attachment[filename]":a.name,"attachment[context_code]":e.context_string,no_redirect:!0,"attachment[duplicate_handling]":a.duplicate_handling};h.updateUploadCount(),d.ajaxJSON("/files/pending","POST",g,function(c){a.upload_url=c.proxied_upload_url||c.upload_url,a.upload_params=c.upload_params,b.data("success_url",c.success_url),b.hasClass("done")||(h.swfQueuedAndPendingFiles.push(a),h.swfUploadNext()),h.updateUploadCount()},function(e){d.flashError(e&&e.base&&e.base.match(/quota/)?e.base:c.t("upload_error","There was an error uploading your file")),d("#file_swf").uploadify("cancel",a.id),b.find(".cancel_upload_link").hide().end().find(".status").text("Upload Failed")},{skipDefaultError:!0})},swfUploadNext:function(){h.swfQueuedAndPendingFiles.length>0&&(file=h.swfQueuedAndPendingFiles.shift(),file&&(d("#file_swf").uploadify("settings","uploader",file.upload_url),d("#file_swf").uploadify("settings","formData",file.upload_params),d("#file_swf").uploadify("upload",file.id))),h.updateUploadCount()},swfCancel:function(a){var b=h.initFile(a);d("#file_uploads_dialog_link").text(c.t("errors.uploading","Uploading Error")),b.addClass("done"),!b.hasClass("errored")&&!b.hasClass("error_cancelled")&&(b.find(".cancel_upload_link").hide().end().find(".status").text("Canceled"),h.swfFiles=d.grep(h.swfFiles,function(b){return b.id!=a.id}))},swfFileError:function(a,b,e,f,g){g=typeof g!="undefined"?g:!0;if(b==SWFUpload.UPLOAD_ERROR.HTTP_ERROR&&e=="201"){h.s3Success(a);return}var i=h.initFile(a);setTimeout(function(){i.addClass("error_cancelled")},50),h.swfFiles=d.grep(h.swfFiles,function(b){return b.id!=a.id}),d("#file_uploads_dialog_link").text(c.t("errors.uploading","Uploading Error")),h.showStatus(),i.find(".cancel_upload_link").hide().end().find(".status").text(c.t("errors.failed_uploading","Failed uploading: %{error_info}",{error_info:f})),i.addClass("done").addClass("errored"),h.swfFileQueueNext()},swfFileOpen:function(a){var b=h.initFile(a);a.upload_url&&d("#file_swf").uploadify("settings","uploader",a.upload_url),a.upload_params&&d("#file_swf").uploadify("settings","formData",a.upload_params),h.swfQueuedAndPendingFiles=d.grep(h.swfQueuedAndPendingFiles,function(b){return b.id!=a.id}),b.find(".progress_bar").progressbar("value",1),b.find(".status").text(c.t("messages.uploading","Uploading"))},swfFileProgress:function(a,b,d,e,f){var g=h.initFile(a);g.find(".status").text(c.t("messages.uploading","Uploading")),g.find(".cancel_upload_link").showIf(e<f),g.find(".progress_bar").progressbar("value",100*e/f)},s3Success:function(a){var b=h.initFile(a);b.find(".status").text(c.t("messages.finalizing","Finalizing"));var e=function(){h.swfFileError(a,"","",c.t("errors.unexpected_response","didn't get back expected response"))};d.ajaxJSON(b.data("success_url"),"GET",{},function(b){b&&b.attachment?(h.swfFileSuccess(a,JSON.stringify(b),!0),b.deleted_attachment_ids&&f.deleteAttachmentIds(b.deleted_attachment_ids)):e()},e)},swfFileSuccess:function(a,b,e){if(b.indexOf("<PostResponse>")>=0){h.s3Success(a);return}var g=h.initFile(a);h.swfFiles=d.grep(h.swfFiles,function(b){return b.id!=a.id}),g.find(".status").text(c.t("messages.upload_complete","Done uploading")),g.find(".cancel_upload_link").remove(),g.find(".progress_bar").progressbar("value",100),g.addClass("done");var i=g.data("folder").context_string;setTimeout(function(){g.slideUp(function(){g.remove()})},5e3);if(b)try{b=d.parseJSON(b);if("errors"in b&&!jQuery.isEmptyObject(b.errors)){h.swfFileError(a,"","",JSON.stringify(b.errors),!1);return}b.swf=!0,setTimeout(function(){b.deleted_attachment_ids&&f.deleteAttachmentIds(b.deleted_attachment_ids),f.updateFile(i,b)},500)}catch(j){h.swfFileError(a,"","",j.toString(),!1);return}else g.find(".status").text(c.t("warnings.file_uploaded_without_response","File may have uploaded, but the server failed to respond.  Reload the page to confirm."));h.swfFileQueueNext()},swfQueueComplete:function(){h.updateUploadCount()},initFile:function(a){a.id||(a.id="tmp_"+Math.round(Math.random()*9999));var b=d("#file_upload_"+a.id);return b.length===0&&(b=d("#file_upload_blank").clone(!0).attr("id","file_upload_"+a.id),d("#file_uploads").append(b),b.find(".progress_bar").progressbar(),b.click(function(a){d(this).find(".cancel_upload_link:visible").length===0&&d(this).hasClass("done")&&(a.preventDefault(),d(this).slideUp(function(){d(this).remove(),h.updateUploadCount()}))}),b.find(".cancel_upload_link").click(function(b){b.preventDefault();var c=(d(this).parents(".file_upload").attr("id")||"").substring(12);d("#file_swf").uploadify("cancel",a.id)})),b.find(".file_name").text(a.name),b.slideDown("fast"),b},attempt:0,file_details:{}}})