define(["i18nObj","jquery","compiled/editor/editorAccessibility","jqueryui/draggable","jquery.instructure_misc_plugins","vendor/jquery.scrollTo","vendor/jquery.ba-tinypubsub","vendor/scribd.view"],function(a,b,c){function e(){this._textareas={},this._editors={},this._editor_boxes={}}function g(a,c){var d=b("#"+a+"_ifr");if(d.length){var e=b(window).height()-(d.offset().top+c.height()+1);d.height(e)}b("#"+a+"_tbl").css("height","")}function h(a,e,h,i,j){j=b.extend({},j),j.fullHeight&&b(window).resize(function(){g(a,j.elementToLeaveInViewport)}).triggerHandler("resize");var k=b("#"+a);k.data("enable_bookmarking",d);var l=k.width();l==0&&(l=k.closest(":visible").width());var m=",instructure_image,instructure_equation";for(var n in INST.editorButtons)INST.editorButtons.length<=INST.maxVisibleEditorButtons||n<INST.maxVisibleEditorButtons-1?m=m+",instructure_external_button_"+INST.editorButtons[n].id:m.match(/instructure_external_button_clump/)||(m+=",instructure_external_button_clump");INST&&INST.allowMediaComments&&(m+=",instructure_record");var o=INST&&INST.equellaEnabled?",instructure_equella":"";m+=o;var p="bold,italic,underline,forecolor,backcolor,removeformat,justifyleft,justifycenter,justifyright,bullist,outdent,indent,numlist,table,instructure_links,unlink"+m+",fontsizeselect,formatselect",q="",r="";l<359&&l>0?(p="bold,italic,underline,forecolor,backcolor,removeformat,justifyleft,justifycenter,justifyright",q="outdent,indent,bullist,numlist,table,instructure_links,unlink"+m,r="fontsizeselect,formatselect"):l<600&&(p="bold,italic,underline,forecolor,backcolor,removeformat,justifyleft,justifycenter,justifyright,outdent,indent,bullist,numlist",q="table,instructure_links,unlink"+m+",fontsizeselect,formatselect");var s="/javascripts/tinymce/jscripts/tiny_mce/themes/advanced/skins/default/ui.css,/stylesheets/compiled/tiny_like_ck_with_external_tools.css",t=b.extend({mode:"exact",elements:a,theme:"advanced",plugins:"autolink,instructure_external_tools,instructure_contextmenu,instructure_links,instructure_embed,instructure_image,instructure_equation,instructure_record,instructure_equella,media,paste,table,inlinepopups",dialog_type:"modal",language_load:!1,relative_urls:!1,remove_script_host:!0,theme_advanced_buttons1:p,theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"center",theme_advanced_buttons2:q,theme_advanced_buttons3:r,theme_advanced_resize_horizontal:!1,theme_advanced_resizing:!0,theme_advanced_blockformats:"p,h2,h3,h4,pre",theme_advanced_more_colors:!1,extended_valid_elements:"iframe[src|width|height|name|align|style|class|sandbox]",content_css:"/stylesheets/compiled/instructure_style.css,/stylesheets/compiled/tinymce.editor_box.css",editor_css:s,onchange_callback:function(c){b("#"+a).trigger("change")},setup:function(a){var e=b("#"+a.editorId),f=function(){b(document).triggerHandler("editor_box_focus",e),b.publish("editorBox/focus",e)};a.onClick.add(f),a.onKeyPress.add(f),a.onActivate.add(f),a.onEvent.add(function(){d&&a.selection&&k.data("last_bookmark",a.selection.getBookmark(1))}),a.onInit.add(function(){(new c(a)).accessiblize()}),a.onInit.add(function(){b(window).triggerHandler("resize"),b(a.contentDocument).bind("DOMNodeInserted",function(a){var c=a.target,d;c.nodeType===1&&c.nodeName==="IMG"&&(d=b(c).data("url"))&&b(c).attr("src",tinyMCE.activeEditor.documentBaseURI.toAbsolute(d))}),"onfocusout"in a.contentWindow||b(a.contentWindow).blur(function(b){!a.removed&&a.undoManager.typing&&(a.undoManager.typing=!1,a.undoManager.add())})})}},j.tinyOptions||{});tinyMCE.init(t),this._textarea=k,this._editor=null,this._id=a,this._searchURL=e,this._submitURL=h,this._contentURL=i,f._addEditorBox(a,this),k.bind("blur change",function(){f._getEditor(a)&&f._getEditor(a).isHidden()&&b(this).editorBox("set_code",f._getTextArea(a).val())})}var d=b("body").hasClass("ie");b(document).ready(function(){d=b("body").hasClass("ie")}),b.extend(e.prototype,{_addEditorBox:function(a,c){b.publish("editorBox/add",a,c),this._editor_boxes[a]=c,this._editors[a]=tinyMCE.get(a),this._textareas[a]=b("textarea#"+a)},_removeEditorBox:function(a){delete this._editor_boxes[a],delete this._editors[a],delete this._textareas[a],b.publish("editorBox/remove",a),b.isEmptyObject(this._editors)&&b.publish("editorBox/removeAll")},_getTextArea:function(a){return this._textareas[a]||(this._textareas[a]=b("textarea#"+a)),this._textareas[a]},_getEditor:function(a){return this._editors[a]||(this._editors[a]=tinyMCE.get(a)),this._editors[a]},_getEditorBox:function(a){return this._editor_boxes[a]}});var f=new e,i={getSelection:function(){var a=this.jquery?this[0]:this;return("selectionStart"in a&&function(){var b=a.selectionEnd-a.selectionStart;return{start:a.selectionStart,end:a.selectionEnd,length:b,text:a.value.substr(a.selectionStart,b)}}||document.selection&&function(){a.focus();var b=document.selection.createRange();if(b==null)return{start:0,end:a.value.length,length:0};var c=a.createTextRange(),d=c.duplicate();return c.moveToBookmark(b.getBookmark()),d.setEndPoint("EndToStart",c),{start:d.text.length,end:d.text.length+b.text.length,length:b.text.length,text:b.text}}||function(){return{start:0,end:a.value.length,length:0}})()},replaceSelection:function(){var a=this.jquery?this[0]:this,b=arguments[0]||"";return("selectionStart"in a&&function(){return a.value=a.value.substr(0,a.selectionStart)+b+a.value.substr(a.selectionEnd,a.value.length),this}||document.selection&&function(){return a.focus(),document.selection.createRange().text=b,this}||function(){return a.value+=b,this})()}};b.extend(b.fn,i);var j=1;b.fn.editorBox=function(a,c){var d=arguments;if(this.length>1)return this.each(function(){var a=b(this);a.editorBox.apply(a,d)});var e=this.attr("id");if(typeof a=="string"&&a!="create"){if(a=="get_code")return this._getContentCode(c);if(a=="set_code")this._setContentCode(c);else if(a=="insert_code")this._insertHTML(c);else{if(a=="selection_offset")return this._getSelectionOffset();if(a=="selection_link")return this._getSelectionLink();if(a=="create_link")this._linkSelection(c);else{if(a=="focus")return this._editorFocus(c);if(a=="toggle")this._toggleView();else{if(a=="execute"){var g=[];for(var i=1;i<arguments.length;i++)g.push(arguments[i]);return b.fn._execCommand.apply(this,g)}a=="destroy"&&this._removeEditor(c)}}}return this}this.data("rich_text",!0),e||(e="editor_box_unique_id_"+j++,this.attr("id",e));if(f._getEditor(e))return this._setContentCode(this.val()),this;var k="";a&&a.search_url&&(k=a.search_url);var l=new h(e,k,"","",a);return this},b.fn._execCommand=function(){var a=b(this).attr("id"),c=f._getEditor(a);return c&&c.execCommand&&c.execCommand.apply(c,arguments),this},b.fn._justGetCode=function(){var a=this.attr("id")||"",b="";try{f._getEditor(a).isHidden()?b=f._getTextArea(a).val():b=f._getEditor(a).getContent()}catch(c){tinyMCE&&tinyMCE.getInstanceById(a)?b=tinyMCE.getInstanceById(a).getContent():b=this.val()||""}return b},b.fn._getContentCode=function(a){if(a==1){var b=this._justGetCode();this._setContentCode(b)}return this._justGetCode()},b.fn._getSearchURL=function(){return f._getEditorBox(this.attr("id"))._searchURL},b.fn._getSubmitURL=function(){return f._getEditorBox(this.attr("id"))._submitURL},b.fn._getContentURL=function(){return f._getEditorBox(this.attr("id"))._contentURL},b.fn._getSelectionOffset=function(){var a=this.attr("id"),c=f._getEditor(a).getContainer(),d=b(c).find("iframe").offset(),e=f._getEditor(a).selection.getNode(),g=b(e).offset(),h=b(c).scrollTop(),i={left:d.left+g.left+10,top:d.top+g.top+10-h};return i},b.fn._getSelectionNode=function(){var a=this.attr("id"),b=f._getEditor(a).getContainer(),c=f._getEditor(a).selection.getNode();return c},b.fn._getSelectionLink=function(){var a=this.attr("id"),c=tinyMCE.get(a).selection.getNode();while(c.nodeName!="A"&&c.nodeName!="BODY"&&c.parentNode)c=c.parentNode;if(c.nodeName=="A"){var d=b(c).attr("href"),e=b(c).attr("title");if(!e||e=="")e=d;var f={url:d,title:e};return f}return null},b.fn._toggleView=function(){var a=this.attr("id");this._setContentCode(this._getContentCode()),tinyMCE.execCommand("mceToggleEditor",!1,a)},b.fn._removeEditor=function(){var a=this.attr("id");this.data("rich_text",!1),tinyMCE&&tinyMCE.execCommand&&(tinyMCE.execCommand("mceRemoveControl",!1,a),f._removeEditorBox(a))},b.fn._setContentCode=function(a){var c=this.attr("id");f._getTextArea(c).val(a),tinyMCE.get(c)&&b.isFunction(tinyMCE.get(c).execCommand)&&tinyMCE.get(c).execCommand("mceSetContent",!1,a)},b.fn._insertHTML=function(a){var b=this.attr("id");f._getEditor(b).isHidden()?this.replaceSelection(a):tinyMCE.get(b).execCommand("mceInsertContent",!1,a)},b.fn._editorFocus=function(a){var c=this,d=c.attr("id"),e=f._getEditor(d);return a&&(!e||!e.dom.doc.hasFocus())&&setTimeout(function(){c.editorBox("focus",!0)},50),e?(f._getEditor(d).isHidden()?f._getTextArea(d).focus().select():(tinyMCE.execCommand("mceFocus",!1,d),b.publish("editorBox/focus",c)),!0):!1},b.fn._linkSelection=function(a){typeof a=="string"&&(a={url:a});var c=a.title,e=a.url||"";e.match(/@/)&&!e.match(/\//)&&!e.match(/^mailto:/)?e="mailto:"+e:!e.match(/^\w+:\/\//)&&!e.match(/^mailto:/)&&!e.match(/^\//)&&(e="http://"+e);var g=a.classes||"",h=a.text||a.title||"Link",i=a.target||null,j=b(this).attr("id");e.indexOf("@")!=-1?(a.file=!1,a.image=!1,e.indexOf("mailto:")!=0&&(e="mailto:"+e)):e.indexOf("/")==-1&&(c=e,e=e.replace(/\s/g,""),e=location.href+e),a.file&&(g+="instructure_file_link "),a.scribdable&&(g+="instructure_scribd_file ");var k="";a.kaltura_entry_id&&a.kaltura_media_type&&(k="media_comment_"+a.kaltura_entry_id,a.kaltura_media_type=="video"?g+="instructure_video_link ":g+="instructure_audio_link "),a.image&&(g+="instructure_image_thumbnail "),g=b.unique(g.split(/\s+/)).join(" ");var l="";d&&this.data("last_bookmark")&&tinyMCE.get(j).selection.moveToBookmark(this.data("last_bookmark"));var m=tinyMCE.get(j).selection,n=m.getNode();while(n.nodeName!="A"&&n.nodeName!="BODY"&&n.parentNode)n=n.parentNode;n.nodeName!="A"&&(n=null);var o=m.getContent();if(f._getEditor(j).isHidden()){l=h;var p=b("<div><a/></div>");p.find("a")[k?"attr":"removeAttr"]("id",k).attr({title:c,href:e,target:i})[g?"attr":"removeAttr"]("class",g).text(l);var q=p.html();b(this).replaceSelection(q)}else if(!o||o=="")if(n)b(n).attr({href:e,_mce_href:e,title:c||"",id:k,"class":g,target:i});else{l=h;var p=b("<div/>");p.append(b("<a/>",{id:k,target:i,title:c,href:e,"class":g}).text(l)),tinyMCE.get(j).execCommand("mceInsertContent",!1,p.html())}else tinyMCE.get(j).execCommand("mceInsertLink",!1,{target:i||"",title:c||"",href:e,"class":g,id:k});var r=tinyMCE.get(j),s=r.selection.getNode();s.nodeName!="A"&&(s=b(s).children("a:last")[0]);if(s){var t={top:s.offsetTop,left:s.offsetLeft},u=s;while((u=u.offsetParent)&&u.tagName!="BODY")t.top=t.top+u.offsetTop||0,t.left=t.left+u.offsetLeft||0;var v=r.getContainer(),w=b(v).find("iframe").offset(),x=b(r.dom.doc).find("html").scrollTop()||b(r.dom.doc).find("body").scrollTop(),y={left:w.left+t.left,top:w.top+t.top-x};b(s).indicate({offset:y,singleFlash:!0,scroll:!0,container:b(v).find("iframe")})}}})