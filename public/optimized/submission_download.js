define(["INST","i18n!submissions","jquery","jquery.ajaxJSON","jqueryui/dialog","jqueryui/progressbar"],function(a,b,c){a.downloadSubmissions=function(a){var d=!1,e=ENV.SUBMISSION_DOWNLOAD_DIALOG_TITLE;e=e||b.t("#submissions.download_submissions","Download Assignment Submissions"),c("#download_submissions_dialog").dialog({title:e,close:function(){d=!0}}),c("#download_submissions_dialog .progress").progressbar({value:0});var f=function(){if(d||c("#download_submissions_dialog:visible").length==0)return;c("#download_submissions_dialog .status_loader").css("visibility","visible");var e=null;c.ajaxJSON(a,"GET",{},function(d){if(d&&d.attachment){var g=d.attachment;if(g.workflow_state=="zipped"){c("#download_submissions_dialog .progress").progressbar("value",100);var h=b.t("#submissions.finished_redirecting","Finished!  Redirecting to File..."),i='<a href="'+a+'"><b> '+b.t("#submissions.click_to_download","Click here to download %{size_of_file}",{size_of_file:g.readable_size})+"</b></a>";c("#download_submissions_dialog .status").html(h+"<br>"+i),c("#download_submissions_dialog .status_loader").css("visibility","hidden"),location.href=a;return}var j=parseInt(g.file_state,10);isNaN(j)&&(j=0),j+=5,c("#download_submissions_dialog .progress").progressbar("value",j);var h=null;j>=95?h=b.t("#submissions.creating_zip","Creating zip file..."):h=b.t("#submissions.gathering_files_progress","Gathering Files (%{progress})...",{progress:b.toPercentage(j)}),c("#download_submissions_dialog .status").text(h),(j<=5||j==e)&&c.ajaxJSON(a+"&compile=1","GET",{},function(){},function(){}),e=j}c("#download_submissions_dialog .status_loader").css("visibility","hidden"),setTimeout(f,3e3)},function(a){c("#download_submissions_dialog .status_loader").css("visibility","hidden"),setTimeout(f,1e3)})};f()}})