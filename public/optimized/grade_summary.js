define(["INST","i18n!gradebook","jquery","underscore","compiled/grade_calculator","compiled/util/round","jquery.ajaxJSON","jquery.instructure_forms","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.templateData","media_comments"],function(a,b,c,d,e,f){function g(){var a=c("#only_consider_graded_assignments").attr("checked"),g=a?"current":"final",h=e.calculate(ENV.submissions,ENV.assignment_groups,ENV.group_weighting_scheme);c(".student_assignment").find(".points_possible").attr("aria-label",""),d.chain(h.group_sums).map(function(a){return a[g].submissions}).flatten().each(function(a){c("#submission_"+a.submission.assignment_id).toggleClass("dropped",!!a.drop)}),c(".dropped").attr("aria-label",b.t("titles.dropped_assignment_no_total","This assignment will not be considered in the total calculation"));var i=function(a,b){return b===0||isNaN(a)?grade="N/A":grade=Math.round(a/b*1e3)/10,grade};for(var j=0;j<h.group_sums.length;j++){var k=h.group_sums[j],l=c("#submission_group-"+k.group.id),m=k[g];l.find(".grade").text(i(m.score,m.possible)),l.find(".score_teaser").text(f(m.score,2)+" / "+f(m.possible,2))}var n=h[g].score,o=h[g].possible,p=i(n,o),q=c(".student_assignment.final_grade");q.find(".grade").text(p),q.find(".score_teaser").text(f(n,2)+" / "+f(o,2)),window.grading_scheme&&c(".final_letter_grade .grade").text(e.letter_grade(grading_scheme,p)),c(".revert_all_scores").showIf(c("#grades_summary .revert_score_link").length>0)}function h(a,b){var c=d.find(ENV.submissions,function(b){return b.assignment_id==a});c&&(c.score=b)}c(document).ready(function(){g(),c(".revert_all_scores_link").click(function(a){a.preventDefault(),c("#grades_summary .revert_score_link").each(function(){c(this).trigger("click",!0)}),c("#.show_guess_grades.exists").show(),g()}),c("tr.student_assignment").mouseover(function(){c(this).hasClass("dropped")?c(this).attr("title",b.t("titles.dropped_assignment_no_total","This assignment will not be considered in the total calculation")):c(this).attr("title","")}),c(".toggle_comments_link").click(function(a){a.preventDefault();var b=c("#"+c(this).attr("aria-controls"));b.toggle(),b.attr("aria-expanded",b.is(":visible"))}),c(".toggle_rubric_assessments_link").click(function(a){a.preventDefault(),c(this).parents("tr.student_assignment").next("tr.comments").next("tr.rubric_assessments").toggle()}),c(".student_assignment.editable .assignment_score").click(function(a){if(c("#grades_summary.editable").length===0||c(this).find("#grade_entry").length>0||c(a.target).closest(".revert_score_link").length>0)return;c(this).find(".grade").data("originalValue")||c(this).find(".grade").data("originalValue",c(this).find(".grade").html()),c(this).find(".grade").empty().append(c("#grade_entry")),c(this).find(".score_value").hide();var b=c(this).parents(".student_assignment").find(".score").text();c("#grade_entry").val(parseFloat(b)||"0").show().focus().select()}),c("#grade_entry").keydown(function(a){if(a.keyCode==13)c(this)[0].blur();else if(a.keyCode==27){var b=c(this).parents(".student_assignment").addClass("dont_update").find(".original_score").text();c(this).val(b||"")[0].blur()}}),c("#grades_summary .student_assignment").bind("score_change",function(a,d){var e=c(this),i=e.find(".original_score").text(),j=parseFloat(i),k=parseFloat(e.find("#grade_entry").val()||c(this).find(".score").text()),l;isNaN(j)&&(j=null),isNaN(k)&&(k=null),!k&&k!==0&&(k=j),l=j!=k;if(k||k===0)k=f(k,2);k==parseInt(k,10)&&(k+=".0"),e.find(".score").text(k),e.hasClass("dont_update")&&(d=!1,e.removeClass("dont_update"));if(d){var m=e.getTemplateData({textValues:["assignment_id"]}).assignment_id,n=c.replaceTags(c(".update_submission_url").attr("href"),"assignment_id",m);l||(k=null),c.ajaxJSON(n,"PUT",{"submission[student_entered_score]":k},function(a){a={student_entered_score:a.submission.student_entered_score},e.fillTemplateData({data:a})},c.noop),l||(k=j)}c("#grade_entry").hide().appendTo(c("body"));if(l)e.find(".assignment_score").attr("title","").find(".score_teaser").text(b.t("titles.hypothetical_score","This is a What-If score")).end().find(".score_holder").append(c("#revert_score_template").clone(!0).attr("id","").show()).find(".grade").addClass("changed");else{var o=e.data("muted")?b.t("student_mute_notification","Instructor is working on grades"):b.t("click_to_change","Click to test a different score");e.find(".assignment_score").attr("title",b.t("click_to_change","Click to test a different score")).find(".score_teaser").text(o).end().find(".grade").removeClass("changed"),e.find(".revert_score_link").remove()}k===0&&(k="0.0"),k===j&&(k=i),e.find(".grade").html(k||e.find(".grade").data("originalValue")),d&&h(m,k),g()}),c("#grade_entry").blur(function(){var a=c(this).parents(".student_assignment");a.triggerHandler("score_change",!0)}),c("#grades_summary").delegate(".revert_score_link","click",function(a,d){a.preventDefault(),a.stopPropagation();var e=c(this).parents(".student_assignment"),f=e.find(".original_score").text(),i=e.data("muted")?b.t("student_mute_notification","Instructor is working on grades"):b.t("click_to_change","Click to test a different score");e.find(".score").text(f),e.data("muted")?e.find(".grade").html('<img alt="Muted" class="muted_icon" src="/images/sound_mute.png?1318436336">'):e.find(".grade").text(f||"-"),e.find(".assignment_score").attr("title",b.t("click_to_change","Click to test a different score")).find(".score_teaser").text(i).end().find(".grade").removeClass("changed"),e.find(".revert_score_link").remove(),e.find(".score_value").text(f);var j=e.getTemplateValue("assignment_id");h(j,f),d||g()}),c("#grades_summary:not(.editable) .assignment_score").css("cursor","default"),c("#grades_summary tr").hover(function(){c(this).find("th.title .context").addClass("context_hover")},function(){c(this).find("th.title .context").removeClass("context_hover")}),c(".show_guess_grades_link").click(function(a){c("#grades_summary .student_entered_score").each(function(){var a=parseFloat(c(this).text(),10);if(!isNaN(a)&&(a||a===0)){var b=c(this).parents(".student_assignment");b.find(".score").text(a),b.find(".score_value").hide(),b.triggerHandler("score_change",!1)}}),c(".show_guess_grades").hide()}),c("#grades_summary .student_entered_score").each(function(){var a=parseFloat(c(this).text(),10);!isNaN(a)&&(a||a===0)&&c(".show_guess_grades").show().addClass("exists")}),c(".comments .play_comment_link").mediaCommentThumbnail("normal"),c(".play_comment_link").live("click",function(a){a.preventDefault();var b=c(this).parents(".comment_media"),d=b.getTemplateData({textValues:["media_comment_id"]}).media_comment_id;if(d){var e="any";c(this).hasClass("video_comment")?e="video":c(this).hasClass("audio_comment")&&(e="audio"),b.children(":not(.media_comment_content)").remove(),b.find(".media_comment_content").mediaComment("show_inline",d,e)}}),c("#only_consider_graded_assignments").change(function(){g()}).triggerHandler("change"),c("#show_all_details_link").click(function(a){a.preventDefault(),c("tr.comments").show(),c("tr.rubric_assessments").show()}),c.scrollSidebar(),c("#observer_user_url").change(function(){location.href!=c(this).val()&&(location.href=c(this).val())})})})